# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤

## ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### 1. **–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø–∞–Ω–µ–ª—å ‚Üí API**
- –ü–∞—Ä—Ç–Ω—ë—Ä –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ `updateOrderStatus(orderId, newStatus)`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è API endpoint: `POST /api/partner/orders/{order_id}/status?status={status}`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è UnifiedOrderService –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –ë–î

### 2. **API ‚Üí –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**
```python
# –í partner_panel_simple.py —Å—Ç—Ä–æ–∫–∞ 1157
@router.post("/orders/{order_id}/status")
async def update_order_status(...):
    if status == "ready":
        ok = await unified_service.mark_ready(order_id, "order")
    elif status == "delivering":
        ok = await unified_service.start_delivery(order_id)
    elif status == "completed":
        ok = await unified_service.complete_order(order_id, "order")
```

### 3. **API ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É**
```python
# –í unified_order_service.py —Å—Ç—Ä–æ–∫–∞ 1869
async def mark_ready(...):
    return await self.update_status(
        entity_id=entity_id,
        entity_type=entity_type,
        new_status=OrderStatus.READY,
        notify_customer=True,  # ‚Üê –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    )
```

### 4. **–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket**
```javascript
// YanaPage.jsx —Å—Ç—Ä–æ–∫–∞ 150
ws.onmessage = (event) => {
  const data = JSON.parse(event.data)
  if (data.type === 'order_status_changed' || data.type === 'order_created') {
    loadOrders(true)  // ‚Üê –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–∫–∞–∑—ã
    return
  }
}
```

### 5. **–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è**
```javascript
// OrderTrackingPage.jsx —Å—Ç—Ä–æ–∫–∞ 38
useEffect(() => {
  loadOrderData(true);
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
  const interval = setInterval(() => loadOrderData(false), 30000);
  return () => clearInterval(interval);
}, [bookingId]);
```

---

## ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω**
**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
WebSocket connection established
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ YanaPage.jsx, —á—Ç–æ:
- userId —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- notifications –≤–∫–ª—é—á–µ–Ω—ã
- WebSocket URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

### 2. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è**
**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:**
```bash
# –í Railway Deploy Logs –∏—Å–∫–∞—Ç—å:
"üì® Sending notification to user"
"‚úÖ WebSocket message sent"
```

### 3. **–°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è, –Ω–æ UI –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è**
**–ü—Ä–∏—á–∏–Ω—ã:**
- WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
- –ö–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ò–Ω—Ç–µ—Ä–≤–∞–ª 30 —Å–µ–∫ –µ—â–µ –Ω–µ –ø—Ä–æ—à–µ–ª

---

## üîç –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –¢–µ—Å—Ç 1: –ü–∞—Ä—Ç–Ω—ë—Ä –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å ‚Üí –ö–ª–∏–µ–Ω—Ç –≤–∏–¥–∏—Ç
1. **–ü–∞—Ä—Ç–Ω—ë—Ä:** –û—Ç–∫—Ä—ã—Ç—å –∑–∞–∫–∞–∑, –Ω–∞–∂–∞—Ç—å "–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑" (preparing)
2. **–û–∂–∏–¥–∞–Ω–∏–µ:** –í –ª–æ–≥–∞—Ö –ø–æ—è–≤–∏—Ç—Å—è:
   ```
   üìä get_orders result for user Y: X orders, Y bookings
   üì® Sending notification to user Y
   ```
3. **–ö–ª–∏–µ–Ω—Ç:** 
   - –ß–µ—Ä–µ–∑ WebSocket –ø–æ–ª—É—á–∏—Ç `order_status_changed`
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
   - –£–≤–∏–¥–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å

### –¢–µ—Å—Ç 2: –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ WebSocket
1. –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
2. –ü–∞—Ä—Ç–Ω—ë—Ä –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å
3. –ß–µ—Ä–µ–∑ –º–∞–∫—Å–∏–º—É–º 30 —Å–µ–∫—É–Ω–¥ —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –¢–µ—Å—Ç 3: Optimistic UI Update
1. –ü–∞—Ä—Ç–Ω—ë—Ä –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å
2. UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è **–º–≥–Ω–æ–≤–µ–Ω–Ω–æ** (optimistic update)
3. –ó–∞—Ç–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞
4. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ

---

## ‚úÖ –í—ã–≤–æ–¥—ã

**–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–µ—Ä–µ–∑:**
1. ‚úÖ WebSocket (real-time) - –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
2. ‚úÖ Polling (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫) - fallback
3. ‚úÖ Optimistic UI - –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞

**–ü—Ä–æ–±–ª–µ–º –ù–ï –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ** - –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞!

---

## üêõ –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–î–æ–±–∞–≤—å –≤ –ª–æ–≥–∏:
```python
# –í unified_order_service.py –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
logger.info(f"üì® Status changed: order_id={entity_id}, status={new_status}, user_id={user_id}")
```

–ü—Ä–æ–≤–µ—Ä—å –≤ Railway Deploy Logs –ø–æ—è–≤–ª—è—é—Ç—Å—è –ª–∏ —ç—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.
