<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fudly Partner v20.3</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Onest:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Modular CSS Architecture -->
    <link rel="stylesheet" href="/partner-panel/styles/variables.css?v=21.0">
    <link rel="stylesheet" href="/partner-panel/styles/base.css?v=21.0">
    <link rel="stylesheet" href="/partner-panel/styles/header.css?v=21.0">
    <link rel="stylesheet" href="/partner-panel/styles/navigation.css?v=21.0">
    <link rel="stylesheet" href="/partner-panel/styles/buttons.css?v=21.0">
    <link rel="stylesheet" href="/partner-panel/styles/products.css?v=21.0">
    <link rel="stylesheet" href="/partner-panel/styles/main.css?v=21.0">
    <link rel="stylesheet" href="/partner-panel/styles/utilities.css?v=21.0">
    <link rel="stylesheet" href="/partner-panel/styles/states.css?v=21.0">
    <link rel="stylesheet" href="/partner-panel/styles/design-fixes.css?v=21.0">
    <link rel="stylesheet" href="/partner-panel/styles/product-form-improvements.css?v=1.4">

</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="store-info">
                <div class="store-avatar">
                    <i data-lucide="store"></i>
                </div>
                <div class="store-details">
                    <h1 id="storeName">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                    <div class="store-status">
                        <div class="status-dot"></div>
                        <span>–û—Ç–∫—Ä—ã—Ç–æ</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="refreshAll()" aria-label="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ">
                    <i data-lucide="refresh-cw"></i>
                </button>
                <button class="icon-btn" aria-label="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
                    <i data-lucide="bell"></i>
                    <span class="notification-badge" id="notificationCount">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Container -->
    <main class="content">
        <div class="loading">
            <div class="spinner"></div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchView('dashboard')">
            <span class="nav-icon"><i data-lucide="home"></i></span>
            <span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span>
        </button>
        <button class="nav-item" onclick="switchView('products')">
            <span class="nav-icon"><i data-lucide="package"></i></span>
            <span class="nav-label">–¢–æ–≤–∞—Ä—ã</span>
        </button>
        <button class="nav-item" onclick="switchView('stats')">
            <span class="nav-icon"><i data-lucide="bar-chart-3"></i></span>
            <span class="nav-label">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
        </button>
        <button class="nav-item" onclick="switchView('settings')">
            <span class="nav-icon"><i data-lucide="settings"></i></span>
            <span class="nav-label">–ï—â–µ</span>
        </button>
    </nav>

    <!-- Main Application JavaScript -->
    <script>
        // ============================================
        // GLOBALS & STATE
        // ============================================
        const tg = window.Telegram?.WebApp;
        const API_BASE = window.location.origin;

        const state = {
            currentView: 'dashboard',
            store: null,
            products: [],
            orders: [],
            stats: null,
            loading: false
        };

        // ============================================
        // AUTH & API
        // ============================================
        function isLocalhost() {
            return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        }

        function getAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('uid');
            const urlAuthDate = urlParams.get('auth_date');
            const urlSig = urlParams.get('sig');

            let finalData = '';
            let source = 'none';

            if (tg?.initData && tg.initData.length > 0) {
                finalData = tg.initData;
                source = 'sdk';
            } else if (window.location.hash.slice(1) && window.location.hash.slice(1).includes('user=')) {
                finalData = window.location.hash.slice(1);
                source = 'hash';
            }

            const tgUser = tg?.initDataUnsafe?.user;
            const userId = tgUser?.id || urlUserId || 'none';

            return { data: finalData, userId, urlUserId, urlAuthDate, urlSig, source };
        }

        async function apiFetch(endpoint, options = {}) {
            const { data: initData, urlUserId, urlAuthDate, urlSig } = getAuth();

            // Determine authorization header
            let authHeader = '';
            if (initData) {
                authHeader = `tma ${initData}`;
            } else if (urlUserId && urlAuthDate && urlSig) {
                authHeader = `tma uid=${urlUserId}&auth_date=${urlAuthDate}&sig=${urlSig}`;
            } else if (isLocalhost() && urlUserId) {
                // Local development fallback ONLY (backend must also be in dev mode)
                authHeader = `tma uid=${urlUserId}`;
            } else {
                throw new Error('Missing Telegram authorization. Please open this panel from the Telegram bot.');
            }

            const headers = { 'Authorization': authHeader, ...options.headers };
            const isFormData = typeof FormData !== 'undefined' && options.body instanceof FormData;
            if (!isFormData && !headers['Content-Type']) {
                headers['Content-Type'] = 'application/json';
            }

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers
                });

                if (!response.ok) {
                    const err = await response.json().catch(() => ({ detail: `HTTP ${response.status}` }));
                    throw new Error(err.detail || `HTTP ${response.status}`);
                }

                return response.json();
            } catch (error) {
                throw error;
            }
        }

        // ============================================
        // UI HELPERS
        // ============================================
        // HAPTIC FEEDBACK
        // ============================================
        function haptic(type = 'light') {
            if (window.Telegram?.WebApp?.HapticFeedback) {
                switch(type) {
                    case 'light':
                        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                        break;
                    case 'medium':
                        window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                        break;
                    case 'heavy':
                        window.Telegram.WebApp.HapticFeedback.impactOccurred('heavy');
                        break;
                    case 'success':
                        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                        break;
                    case 'error':
                        window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                        break;
                    case 'warning':
                        window.Telegram.WebApp.HapticFeedback.notificationOccurred('warning');
                        break;
                    case 'selection':
                        window.Telegram.WebApp.HapticFeedback.selectionChanged();
                        break;
                }
            }
        }

        function toast(message, type = 'info', options = {}) {
            haptic(type === 'success' ? 'success' : type === 'error' ? 'error' : 'light');

            const toast = document.createElement('div');
            toast.className = `toast ${type} slide-up`;

            const icon = document.createElement('span');
            icon.style.fontSize = '20px';
            icon.textContent = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : type === 'warning' ? '‚ö†' : '‚Ñπ';

            const contentDiv = document.createElement('div');
            contentDiv.style.flex = '1';

            const text = document.createElement('span');
            text.textContent = message;
            contentDiv.appendChild(text);

            // Add description if provided
            if (options.description) {
                const desc = document.createElement('div');
                desc.style.fontSize = '13px';
                desc.style.opacity = '0.8';
                desc.style.marginTop = '4px';
                desc.textContent = options.description;
                contentDiv.appendChild(desc);
            }

            toast.appendChild(icon);
            toast.appendChild(contentDiv);

            // Add action button if provided
            if (options.action && options.actionLabel) {
                const actionBtn = document.createElement('button');
                actionBtn.textContent = options.actionLabel;
                actionBtn.className = 'toast-action';
                actionBtn.onclick = () => {
                    options.action();
                    toast.remove();
                };
                toast.appendChild(actionBtn);
            }

            document.body.appendChild(toast);

            const duration = options.duration || 3000;
            setTimeout(() => {
                toast.style.animation = 'toastOut 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function showLoading(type = 'default') {
            const loaders = {
                default: `<div class="loading fade-in"><div class="spinner"></div></div>`,
                dashboard: `
                    <div class="container fade-in">
                        <div class="stats-grid">
                            ${[1,2,3,4].map(() => `
                                <div class="stat-card skeleton">
                                    <div class="skeleton-line w-60p h-20 mb-12"></div>
                                    <div class="skeleton-line w-40p h-32"></div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="skeleton-line w-200 h-24 mt-xl mb-md"></div>
                        ${[1,2,3].map(() => `<div class="skeleton skeleton-block tall-100"></div>`).join('')}
                    </div>
                `,
                products: `
                    <div class="container fade-in">
                        <div class="products-grid">
                            ${[1,2,3,4,5,6].map(() => `
                                <div class="product-card skeleton">
                                    <div class="skeleton skeleton-block tall-240"></div>
                                    <div class="skeleton-pad">
                                        <div class="skeleton-line w-70p h-20 mb-sm"></div>
                                        <div class="skeleton-line w-100p h-16 mb-12"></div>
                                        <div class="skeleton-line w-40p h-24"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `,
                stats: `
                    <div class="container fade-in">
                        <div class="skeleton skeleton-block tall-300"></div>
                        <div class="stats-grid">
                            ${[1,2,3,4].map(() => `
                                <div class="stat-card skeleton">
                                    <div class="skeleton-line w-60p h-18 mb-10"></div>
                                    <div class="skeleton-line w-50p h-28"></div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `,
                settings: `
                    <div class="container fade-in">
                        ${[1,2,3,4,5].map(() => `
                            <div class="skeleton skeleton-block tall-72"></div>
                        `).join('')}
                    </div>
                `
            };
            document.querySelector('.content').innerHTML = loaders[type] || loaders.default;
        }

        // ============================================
        // VIEW SWITCHING
        // ============================================
        function switchView(view) {
            console.log(`üìç Switching to view: ${view}`);
            haptic('selection');
            state.currentView = view;

            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event?.target?.closest('.nav-item')?.classList.add('active');

            // Smooth transition
            const content = document.querySelector('.content');
            content.classList.add('fade-out');

            setTimeout(() => {
                content.classList.remove('fade-out');

                // Load view
                switch(view) {
                    case 'dashboard':
                        loadDashboard();
                        break;
                    case 'orders':
                        loadOrders();
                        break;
                    case 'products':
                        loadProducts();
                        break;
                    case 'stats':
                        loadStats();
                        break;
                    case 'settings':
                        loadSettings();
                        break;
                }

                // Scroll to top smoothly
                content.scrollTo({ top: 0, behavior: 'smooth' });
            }, 150);
        }

        // ============================================
        // DASHBOARD
        // ============================================
        async function loadDashboard() {
            showLoading('dashboard');

            try {
                const [store, orders, products] = await Promise.all([
                    apiFetch('/api/partner/store'),
                    apiFetch('/api/partner/orders'),
                    apiFetch('/api/partner/products')
                ]);

                state.store = store;
                state.orders = orders;
                state.products = normalizeProducts(products);

                // Connect WebSocket after store info is loaded
                if (!websocket && store.store_id) {
                    connectWebSocket();
                }

                renderDashboard();
            } catch (error) {
                console.error('‚ùå Dashboard load error:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    API_BASE
                });
                toast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
            }
        }

        function renderDashboard() {
            // Update store name in header
            if (state.store?.name) {
                document.getElementById('storeName').textContent = state.store.name;
            }

            const activeOrders = state.orders.filter(o => o.status !== 'completed' && o.status !== 'cancelled');
            const newOrders = activeOrders.filter(o => o.status === 'new');
            const preparingOrders = activeOrders.filter(o => ['preparing', 'ready'].includes(o.status));

            const todayRevenue = state.orders
                .filter(o => o.status === 'completed' && isToday(o.created_at))
                .reduce((sum, o) => sum + (o.price || 0), 0);

            const yesterdayRevenue = state.orders
                .filter(o => o.status === 'completed' && isYesterday(o.created_at))
                .reduce((sum, o) => sum + (o.price || 0), 0);

            const revenueTrend = yesterdayRevenue ? ((todayRevenue - yesterdayRevenue) / yesterdayRevenue * 100).toFixed(0) : 0;

            const currentHour = new Date().getHours();
            const greeting = currentHour < 12 ? '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ' : currentHour < 18 ? '–î–æ–±—Ä—ã–π –¥–µ–Ω—å' : '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä';
            const currentDate = new Date().toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });

            // Smart insights
            const dailyGoal = 11000;
            const goalProgress = (todayRevenue / dailyGoal * 100).toFixed(0);
            const lowStockProducts = state.products.filter(p => p.stock_quantity < 5 && p.stock_quantity > 0);
            const outOfStockProducts = state.products.filter(p => p.stock_quantity === 0);

            // Peak hours logic (11-14, 18-21)
            const isPeakHour = (currentHour >= 11 && currentHour < 14) || (currentHour >= 18 && currentHour < 21);
            const hoursUntilPeak = currentHour < 11 ? 11 - currentHour : currentHour < 18 ? 18 - currentHour : null;

            document.querySelector('.content').innerHTML = `
                <div class="container">
                    <!-- Hero Section -->
                    <div class="hero-section">
                        <div class="hero-greeting">
                            <div class="hero-text">
                                <h2>${greeting}!</h2>
                                <p>${currentDate} ‚Ä¢ ${state.store?.name || '–ú–æ–π –º–∞–≥–∞–∑–∏–Ω'}</p>
                            </div>
                            <button class="status-toggle ${state.store?.is_open ? 'open' : 'closed'}" onclick="toggleStoreStatus()">
                                <span class="status-indicator"></span>
                                ${state.store?.is_open ? '–û—Ç–∫—Ä—ã—Ç–æ' : '–ó–∞–∫—Ä—ã—Ç–æ'}
                            </button>
                        </div>

                        <!-- Smart Insights -->
                        ${hoursUntilPeak && hoursUntilPeak <= 2 ? `
                            <div class="smart-insight">
                                <div class="smart-insight-icon">üî•</div>
                                <div class="smart-insight-content">
                                    <div class="smart-insight-title">–ü–∏–∫ –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ ${hoursUntilPeak}—á</div>
                                    <div class="smart-insight-text">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</div>
                                </div>
                            </div>
                        ` : ''}

                        ${outOfStockProducts.length > 0 ? `
                            <div class="smart-insight warning">
                                <div class="smart-insight-icon">‚ö†Ô∏è</div>
                                <div class="smart-insight-content">
                                    <div class="smart-insight-title">–¢–æ–≤–∞—Ä—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å (${outOfStockProducts.length})</div>
                                    <div class="smart-insight-text">${outOfStockProducts[0]?.name || '–¢–æ–≤–∞—Ä'} –∏ –µ—â–µ ${outOfStockProducts.length - 1}</div>
                                </div>
                            </div>
                        ` : lowStockProducts.length > 0 ? `
                            <div class="smart-insight warning">
                                <div class="smart-insight-icon">üì¶</div>
                                <div class="smart-insight-content">
                                    <div class="smart-insight-title">–ù–∏–∑–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫ (${lowStockProducts.length})</div>
                                    <div class="smart-insight-text">${lowStockProducts.map(p => p.name).join(', ')}</div>
                                </div>
                            </div>
                        ` : ''}

                        ${goalProgress < 100 && todayRevenue > 0 ? `
                            <div class="goal-progress">
                                <div class="goal-header">
                                    <span class="goal-label">–¶–µ–ª—å –Ω–∞ –¥–µ–Ω—å</span>
                                    <span class="goal-values">${formatPrice(todayRevenue)} / ${formatPrice(dailyGoal)}</span>
                                </div>
                                <div class="goal-bar">
                                    <div class="goal-fill" style="width: ${Math.min(goalProgress, 100)}%"></div>
                                </div>
                            </div>
                        ` : goalProgress >= 100 ? `
                            <div class="smart-insight success">
                                <div class="smart-insight-icon">üéâ</div>
                                <div class="smart-insight-content">
                                    <div class="smart-insight-title">–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!</div>
                                    <div class="smart-insight-text">–í—ã—Ä—É—á–∫–∞ –ø—Ä–µ–≤—ã—Å–∏–ª–∞ ${formatPrice(dailyGoal)}</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="openProductModal()">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                        <button class="btn btn-outline" onclick="switchView('orders')">–í—Å–µ –∑–∞–∫–∞–∑—ã</button>
                    </div>

                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card primary">
                            ${revenueTrend != 0 ? `<span class="stat-trend ${revenueTrend > 0 ? 'up' : 'down'}">
                                <i data-lucide="${revenueTrend > 0 ? 'trending-up' : 'trending-down'}"></i>
                                ${Math.abs(revenueTrend)}%
                            </span>` : ''}
                            ${todayRevenue > 0 ? `
                                <div class="stat-value">${formatPrice(todayRevenue)}</div>
                                <div class="stat-label">–í—ã—Ä—É—á–∫–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                            ` : `
                                <div class="stat-value empty-revenue">–ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ —Å–∫–æ—Ä–æ! üöÄ</div>
                                <div class="stat-hint">–ù–∞—á–Ω–∏—Ç–µ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤</div>
                            `}
                        </div>

                        <div class="stat-card success">
                            <div class="stat-value">${activeOrders.length}</div>
                            <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-value">${state.products.length}</div>
                            <div class="stat-label">–¢–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-value">4.8</div>
                            <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥</div>
                        </div>
                    </div>

                    <!-- Urgent Orders -->
                    ${newOrders.length > 0 ? `
                        <div class="urgent-section">
                            ${newOrders.map(order => `
                                <div class="urgent-order" onclick="viewOrderDetails(${order.order_id || order.id})">
                                    <div class="urgent-header">
                                        <h3 class="urgent-title">üîî –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #${order.order_id || order.id}</h3>
                                        <span class="urgent-badge">${formatTime(order.created_at)}</span>
                                    </div>
                                    <div class="pl-md">
                                        <p class="order-summary">${order.order_type === 'pickup' ? 'üèÉ –°–∞–º–æ–≤—ã–≤–æ–∑' : 'üöó –î–æ—Å—Ç–∞–≤–∫–∞'} ‚Ä¢ ${formatPrice(order.price)}</p>
                                    </div>
                                    <div class="urgent-actions" onclick="event.stopPropagation()">
                                        <button class="btn btn-success" onclick="updateOrderStatus(${order.order_id || order.id}, 'preparing')">‚úì –ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑</button>
                                        <button class="btn btn-outline" onclick="cancelOrder(${order.order_id || order.id})">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- Active Orders with Grouping -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h2>
                            <button class="btn btn-sm btn-outline" onclick="switchView('orders')">–í—Å–µ –∑–∞–∫–∞–∑—ã</button>
                        </div>

                        ${activeOrders.length > 0 ? `
                            ${newOrders.length > 0 ? `
                                <div class="order-section" id="newOrdersSection">
                                    <div class="order-section-header" onclick="toggleOrderSection('newOrdersSection')">
                                        <h3 class="order-section-title">
                                            ‚ö° –¢—Ä–µ–±—É—é—Ç –¥–µ–π—Å—Ç–≤–∏—è
                                            <span class="order-section-badge">${newOrders.length}</span>
                                        </h3>
                                        <div class="order-section-toggle">
                                            <i data-lucide="chevron-down"></i>
                                        </div>
                                    </div>
                                    <div class="order-section-content">
                                        <div class="orders-list">
                                            ${newOrders.map(order => renderOrderCard(order)).join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            ${preparingOrders.length > 0 ? `
                                <div class="order-section collapsed" id="preparingOrdersSection">
                                    <div class="order-section-header" onclick="toggleOrderSection('preparingOrdersSection')">
                                        <h3 class="order-section-title">
                                            üì¶ –í —Ä–∞–±–æ—Ç–µ
                                            <span class="order-section-badge muted">${preparingOrders.length}</span>
                                        </h3>
                                        <div class="order-section-toggle">
                                            <i data-lucide="chevron-down"></i>
                                        </div>
                                    </div>
                                    <div class="order-section-content">
                                        <div class="orders-list">
                                            ${preparingOrders.map(order => renderOrderCard(order)).join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        ` : `
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i data-lucide="inbox" class="icon-muted"></i>
                                </div>
                                <p class="empty-title">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</p>
                                <p class="empty-subtitle">–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                            </div>
                        `}
                    </div>
                </div>
            `;

            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') lucide.createIcons();
            if (typeof window.initUXImprovements === 'function') {
                window.initUXImprovements();
            }
        }

        function renderOrderCard(order) {
            const orderId = order.order_id || order.id;
            return `
                <div class="order-card ripple" data-order-id="${orderId}" data-status="${order.status}" onclick="haptic('light'); viewOrderDetails(${orderId})">
                    <div class="order-header">
                        <div class="order-id">#${orderId || '‚Äî'}</div>
                        <div class="order-status status-${order.status}">${getStatusText(order.status)}</div>
                    </div>
                    <div class="order-meta">
                        <span class="order-type">${order.order_type === 'pickup' ? 'üèÉ –°–∞–º–æ–≤—ã–≤–æ–∑' : 'üöó –î–æ—Å—Ç–∞–≤–∫–∞'}</span>
                    </div>
                    <div class="order-footer">
                        <div class="order-time">${formatTime(order.created_at)}</div>
                        <div class="order-total">${formatPrice(order.price)}</div>
                    </div>
                    ${order.status === 'new' ? `
                        <div class="order-actions" onclick="event.stopPropagation()">
                            <button class="btn btn-sm btn-success ripple" onclick="updateOrderStatus(${orderId}, 'preparing')">–ü—Ä–∏–Ω—è—Ç—å</button>
                            <button class="btn btn-sm btn-danger ripple" onclick="openCancelModal(${orderId})">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                        </div>
                    ` : ''}
                    ${order.status === 'preparing' ? `
                        <div class="order-actions" onclick="event.stopPropagation()">
                            <button class="btn btn-sm btn-success ripple" onclick="updateOrderStatus(${orderId}, 'ready')">–ì–æ—Ç–æ–≤</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function toggleOrderSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.toggle('collapsed');
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        }

        // ============================================
        // ORDERS
        // ============================================
        async function loadOrders() {
            showLoading();
            try {
                state.orders = await apiFetch('/api/partner/orders');
                renderOrders();
                updateNotificationBadge(); // Update badge with new orders count
            } catch (error) {
                toast('\u041e\u0448\u0438\u0431\u043a\u0430 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u044f \u043d\u0430\u0441\u0442\u0440\u043e\u0435\u043a', 'error');
            }
        }

        function renderOrders() {
            const grouped = groupOrdersByStatus(state.orders);

            document.querySelector('.content').innerHTML = `
                <div class="container">
                    <h2 class="section-title">–ó–∞–∫–∞–∑—ã</h2>

                    <div class="tabs">
                        <button class="tab active" data-status="active" onclick="filterOrderTab('active')">
                            –ê–∫—Ç–∏–≤–Ω—ã–µ <span class="badge">${grouped.active.length}</span>
                        </button>
                        <button class="tab" data-status="completed" onclick="filterOrderTab('completed')">
                            –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
                        </button>
                        <button class="tab" data-status="cancelled" onclick="filterOrderTab('cancelled')">
                            –û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ
                        </button>
                    </div>

                    <div id="ordersContainer">
                        ${renderOrdersList(grouped.active)}
                    </div>
                </div>
            `;

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function groupOrdersByStatus(orders) {
            return {
                active: orders.filter(o => ['pending', 'new', 'preparing', 'ready'].includes(o.status)),
                completed: orders.filter(o => o.status === 'completed'),
                cancelled: orders.filter(o => o.status === 'cancelled')
            };
        }

        function renderOrdersList(orders) {
            if (!orders.length) {
                return `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i data-lucide="package-x"></i>
                        </div>
                        <p class="empty-title">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>
                        <p class="empty-subtitle">–ö–æ–≥–¥–∞ –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã, –æ–Ω–∏ –æ—Ç–æ–±—Ä–∞–∑—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                    </div>
                `;
            }

            return `
                <div class="orders-list">
                    ${orders.map(order => {
                        const orderId = order.order_id || order.id;
                        const photoUrl = order.offer_photo_url || order.photo_url;
                        return `
                        <div class="order-card ripple"
                             data-order-id="${orderId}"
                             data-status="${order.status}"
                             onclick="viewOrderDetails(${orderId})">
                            ${photoUrl ? `
                                <div class="order-image">
                                    <img src="${photoUrl}" alt="${order.offer_title || '–¢–æ–≤–∞—Ä'}" loading="lazy"
                                         onerror="this.parentElement.innerHTML=''; this.remove();">
                                </div>
                            ` : ''}
                            <div class="order-header">
                                <div class="order-id">#${orderId || '‚Äî'}</div>
                                <div class="order-status status-${order.status}">${getStatusText(order.status)}</div>
                            </div>
                            <div class="order-meta">
                                <span>${order.order_type === 'pickup' ? 'üèÉ –°–∞–º–æ–≤—ã–≤–æ–∑' : 'üöó –î–æ—Å—Ç–∞–≤–∫–∞'}</span>
                                <span>${order.customer_name || ''}</span>
                            </div>
                            <div class="order-footer">
                                <span class="order-time">${formatTime(order.created_at)}</span>
                                <span class="order-total">${formatPrice(order.price)}</span>
                            </div>
                            ${order.status === 'pending' || order.status === 'new' ? `
                                <div class="order-actions" onclick="event.stopPropagation()">
                                    <button class="btn btn-sm btn-success ripple" onclick="handleStatusUpdate(${orderId}, 'preparing', this)">‚úì –ü—Ä–∏–Ω—è—Ç—å</button>
                                    <button class="btn btn-sm btn-danger ripple" onclick="handleCancelOrder(${orderId}, this)">‚úï –û—Ç–º–µ–Ω–∏—Ç—å</button>
                                </div>
                            ` : ''}
                            ${order.status === 'preparing' ? `
                                <div class="order-actions" onclick="event.stopPropagation()">
                                    <button class="btn btn-sm btn-success ripple" onclick="handleStatusUpdate(${orderId}, 'ready', this)">‚úì –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤</button>
                                </div>
                            ` : ''}
                            ${order.status === 'ready' ? `
                                <div class="order-actions" onclick="event.stopPropagation()">
                                    <button class="btn btn-sm btn-success ripple" onclick="handleStatusUpdate(${orderId}, 'completed', this)">‚úì –í—ã–¥–∞–Ω –∫–ª–∏–µ–Ω—Ç—É</button>
                                </div>
                            ` : ''}
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        function filterOrderTab(status) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.status === status);
            });

            const grouped = groupOrdersByStatus(state.orders);
            const ordersMap = {
                'active': grouped.active,
                'completed': grouped.completed,
                'cancelled': grouped.cancelled
            };

            document.getElementById('ordersContainer').innerHTML = renderOrdersList(ordersMap[status]);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        async function viewOrderDetails(orderId) {
            const order = state.orders.find(o => (o.order_id || o.id) === orderId);
            if (!order) return;

            const oid = order.order_id || order.id;
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content modal-md">
                    <div class="modal-header">
                        <h3>–ó–∞–∫–∞–∑ #${oid}</h3>
                        <button class="btn-icon" onclick="this.closest('.modal-overlay').remove()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="order-status status-${order.status} modal-status">
                            ${getStatusText(order.status)}
                        </div>

                        <div class="order-detail-section">
                            <h4>–¢–æ–≤–∞—Ä</h4>
                            <p>${order.offer_title || '–¢–æ–≤–∞—Ä'} √ó ${order.quantity || 1}</p>
                        </div>

                        <div class="order-detail-section">
                            <h4>–ö–ª–∏–µ–Ω—Ç</h4>
                            <p>${order.customer_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                            <p>${order.customer_phone || ''}</p>
                        </div>

                        <div class="order-detail-section">
                            <h4>–¢–∏–ø –∑–∞–∫–∞–∑–∞</h4>
                            <p>${order.order_type === 'pickup' ? 'üèÉ –°–∞–º–æ–≤—ã–≤–æ–∑' : 'üöó –î–æ—Å—Ç–∞–≤–∫–∞'}</p>
                            ${order.delivery_address ? `<p>${order.delivery_address}</p>` : ''}
                        </div>

                        <div class="order-detail-section modal-total">
                            <div class="modal-total-row">
                                <span>–ò—Ç–æ–≥–æ</span>
                                <span>${formatPrice(order.price)}</span>
                            </div>
                        </div>

                        ${order.status !== 'completed' && order.status !== 'cancelled' ? `
                            <div class="modal-actions">
                                ${order.status === 'pending' || order.status === 'new' ? `
                                    <button class="btn btn-success ripple" onclick="handleModalStatusUpdate(${oid}, 'preparing', this)">
                                        ‚úì –ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑
                                    </button>
                                ` : ''}
                                ${order.status === 'preparing' ? `
                                    <button class="btn btn-success ripple" onclick="handleModalStatusUpdate(${oid}, 'ready', this)">
                                        ‚úì –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤
                                    </button>
                                ` : ''}
                                ${order.status === 'ready' ? `
                                    <button class="btn btn-success ripple" onclick="handleModalStatusUpdate(${oid}, 'completed', this)">
                                        ‚úì –í—ã–¥–∞–Ω –∫–ª–∏–µ–Ω—Ç—É
                                    </button>
                                ` : ''}
                                <button class="btn btn-danger ripple" onclick="handleModalCancelOrder(${oid}, this)">
                                    ‚úï –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            if (typeof lucide !== 'undefined') lucide.createIcons();

            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        async function updateOrderStatus(orderId, newStatus) {
            let order = null;
            let oldStatus = null;

            try {
                haptic('medium');

                // Optimistic UI update
                order = state.orders.find(o => (o.order_id || o.id) === orderId);
                oldStatus = order?.status;

                if (order) {
                    order.status = newStatus;

                    // Update UI immediately
                    const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
                    if (orderCard) {
                        orderCard.classList.add('optimistic-update');
                        orderCard.setAttribute('data-status', newStatus);

                        // Update status badge
                        const statusBadge = orderCard.querySelector('.order-status');
                        if (statusBadge) {
                            statusBadge.className = `order-status status-${newStatus}`;
                            statusBadge.textContent = getStatusText(newStatus);
                        }

                        // Hide action buttons during update
                        const actions = orderCard.querySelector('.order-actions');
                        if (actions) actions.style.display = 'none';
                    }
                }

                await apiFetch(`/api/partner/orders/${orderId}/status?status=${newStatus}`, {
                    method: 'POST'
                });

                haptic('success');
                toast('\u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u0434\u043e\u0441\u0442\u0430\u0432\u043a\u0438 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u044b', 'success');

                // Reload to get fresh data and correct button states
                if (state.currentView === 'orders') {
                    setTimeout(() => loadOrders(), 500);
                }
            } catch (error) {
                console.error('Status update error:', error);
                haptic('error');
                toast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');

                // Revert optimistic update
                if (order && oldStatus) {
                    order.status = oldStatus;
                }
                loadOrders();
            }
        }

        async function handleStatusUpdate(orderId, newStatus, button) {
            if (!button) return updateOrderStatus(orderId, newStatus);

            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="opacity-60">‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</span>';

            try {
                await updateOrderStatus(orderId, newStatus);
            } catch (error) {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        async function cancelOrder(orderId) {
            if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑?')) return;

            haptic('heavy');
            await updateOrderStatus(orderId, 'cancelled');
        }

        // Open cancel order modal with reason selection
        function openCancelModal(orderId) {
            haptic('light');

            const modal = document.createElement('div');
            modal.className = 'modal-overlay scale-in';
            modal.innerHTML = `
                <div class="modal-content modal-sm">
                    <div class="modal-header">
                        <h3>–û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞ #${orderId}</h3>
                        <button class="btn-icon ripple" onclick="this.closest('.modal-overlay').remove()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <form onsubmit="submitCancelOrder(event, ${orderId})">
                        <div class="modal-body">
                            <p class="modal-text">
                                –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞
                            </p>

                            <div class="form-group">
                                <label class="modal-section-label">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã *</label>
                                <div class="d-flex flex-column gap-sm">
                                    <label class="cancel-reason-option">
                                        <input type="radio" name="cancel_reason" value="out_of_stock" required>
                                        <span>üî¥ –¢–æ–≤–∞—Ä –∑–∞–∫–æ–Ω—á–∏–ª—Å—è</span>
                                    </label>
                                    <label class="cancel-reason-option">
                                        <input type="radio" name="cancel_reason" value="cant_fulfill">
                                        <span>‚è±Ô∏è –ù–µ —É—Å–ø–µ–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å</span>
                                    </label>
                                    <label class="cancel-reason-option">
                                        <input type="radio" name="cancel_reason" value="customer_request">
                                        <span>üìû –ü–æ –ø—Ä–æ—Å—å–±–µ –∫–ª–∏–µ–Ω—Ç–∞</span>
                                    </label>
                                    <label class="cancel-reason-option">
                                        <input type="radio" name="cancel_reason" value="technical_issue">
                                        <span>‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ–ø–æ–ª–∞–¥–∫–∏</span>
                                    </label>
                                    <label class="cancel-reason-option">
                                        <input type="radio" name="cancel_reason" value="other">
                                        <span>‚ùì –î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                <textarea name="cancel_comment" rows="3" placeholder="–î–æ–±–∞–≤—å—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é..."
                                          class="search-input textarea-resizable" maxlength="200"></textarea>
                                <div class="form-hint">
                                    <span id="commentCounter">0/200</span>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary ripple" onclick="this.closest('.modal-overlay').remove()">
                                –ù–∞–∑–∞–¥
                            </button>
                            <button type="submit" class="btn btn-danger ripple">
                                <i data-lucide="x-circle" class="icon-16"></i>
                                –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // Character counter for comment
            const textarea = modal.querySelector('textarea[name="cancel_comment"]');
            const counter = modal.querySelector('#commentCounter');
            if (textarea && counter) {
                textarea.addEventListener('input', () => {
                    counter.textContent = `${textarea.value.length}/200`;
                });
            }

            // Close on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Submit cancel order with reason
        async function submitCancelOrder(event, orderId) {
            event.preventDefault();
            haptic('heavy');

            const formData = new FormData(event.target);
            const reason = formData.get('cancel_reason');
            const comment = formData.get('cancel_comment') || '';

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="opacity-60">‚è≥ –û—Ç–º–µ–Ω–∞...</span>';

            try {
                // Call API with cancel reason
                await apiFetch(`/api/partner/orders/${orderId}/cancel`, {
                    method: 'POST',
                    body: JSON.stringify({
                        reason: reason,
                        comment: comment
                    })
                });

                // Update local state
                const order = state.orders.find(o => (o.order_id || o.id) === orderId);
                if (order) {
                    order.status = 'cancelled';
                    order.cancel_reason = reason;
                    order.cancel_comment = comment;
                }

                haptic('success');
                toast('–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω—ë–Ω', 'success');

                // Close modal
                event.target.closest('.modal-overlay').remove();

                // Reload orders
                if (state.currentView === 'orders') {
                    setTimeout(() => loadOrders(), 500);
                }
            } catch (error) {
                console.error('Cancel order error:', error);
                haptic('error');
                toast('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        async function handleCancelOrder(orderId, button) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑?')) return;

            if (!button) return cancelOrder(orderId);

            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="opacity-60">‚è≥ –û—Ç–º–µ–Ω–∞...</span>';

            try {
                haptic('heavy');
                await updateOrderStatus(orderId, 'cancelled');
            } catch (error) {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        async function handleModalStatusUpdate(orderId, newStatus, button) {
            const modal = button.closest('.modal-overlay');
            const originalText = button.innerHTML;

            button.disabled = true;
            button.innerHTML = '<span class="opacity-60">‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</span>';

            try {
                await updateOrderStatus(orderId, newStatus);
                if (modal) modal.remove();
            } catch (error) {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        async function handleModalCancelOrder(orderId, button) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑?')) return;

            const modal = button.closest('.modal-overlay');
            const originalText = button.innerHTML;

            button.disabled = true;
            button.innerHTML = '<span class="opacity-60">‚è≥ –û—Ç–º–µ–Ω–∞...</span>';

            try {
                haptic('heavy');
                await updateOrderStatus(orderId, 'cancelled');
                if (modal) modal.remove();
            } catch (error) {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // ============================================
        // PRODUCTS
        // ============================================
        function normalizeProducts(products) {
            if (!Array.isArray(products)) return [];

            return products.map((p) => {
                const stock = Number(p.stock ?? p.stock_quantity ?? p.quantity ?? 0) || 0;
                const price = Number(p.price ?? p.discount_price ?? 0) || 0;
                const originalPrice = Number(p.original_price ?? 0) || 0;

                const discount =
                    originalPrice > 0 && price > 0
                        ? Math.max(0, Math.min(99, Math.round((1 - price / originalPrice) * 100)))
                        : 0;

                const status = p.status || (stock > 0 ? 'active' : 'out_of_stock');
                const photoUrl = p.photo_url || p.image || '';

                return {
                    ...p,
                    stock,
                    stock_quantity: p.stock_quantity ?? stock,
                    quantity: p.quantity ?? stock,
                    price,
                    discount,
                    status,
                    is_available: status === 'active',
                    photo_url: photoUrl,
                };
            });
        }

        async function loadProducts() {
            showLoading('products');
            try {
                const products = await apiFetch('/api/partner/products');
                state.products = normalizeProducts(products);
                renderProducts();
            } catch (error) {
                toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤', 'error');
            }
        }

        function renderProducts() {
            document.querySelector('.content').innerHTML = `
                <div class="container">
                    <div class="section-header">
                        <h2 class="section-title">–¢–æ–≤–∞—Ä—ã (${state.products.length})</h2>
                        <button class="btn btn-primary" onclick="openProductModal()">
                            <i data-lucide="plus" class="icon-18"></i>
                            –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>

                    <div class="filters-bar">
                        <div class="filters-group">
                            <select class="filter-select" id="categoryFilter" onchange="filterProducts()">
                                <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                                <option value="bakery">ü•ñ –•–ª–µ–± –∏ –≤—ã–ø–µ—á–∫–∞</option>
                                <option value="dairy">üßà –ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã</option>
                                <option value="meat">ü•© –ú—è—Å–æ –∏ –ø—Ç–∏—Ü–∞</option>
                                <option value="fruits">üçé –§—Ä—É–∫—Ç—ã</option>
                                <option value="vegetables">ü•ï –û–≤–æ—â–∏</option>
                                <option value="drinks">ü•§ –ù–∞–ø–∏—Ç–∫–∏</option>
                                <option value="snacks">üçø –°–Ω–µ–∫–∏</option>
                                <option value="frozen">‚ùÑÔ∏è –ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω–æ–µ</option>
                                <option value="other">üì¶ –î—Ä—É–≥–æ–µ</option>
                            </select>

                            <select class="filter-select" id="statusFilter" onchange="filterProducts()">
                                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                <option value="available">‚úÖ –í –Ω–∞–ª–∏—á–∏–∏</option>
                                <option value="unavailable">‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</option>
                            </select>

                            <select class="filter-select" id="discountFilter" onchange="filterProducts()">
                                <option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
                                <option value="discount">üî• –°–æ —Å–∫–∏–¥–∫–æ–π</option>
                                <option value="no-discount">–ë–µ–∑ —Å–∫–∏–¥–∫–∏</option>
                            </select>

                            <button class="btn-icon-secondary" onclick="resetFilters()" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">
                                <i data-lucide="x" class="icon-18"></i>
                            </button>
                        </div>
                    </div>

                    <div class="search-bar">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." oninput="searchProducts(this.value)">
                    </div>

                    <div class="products-grid" id="productsGrid">
                        ${state.products.map(product => `
                            <div class="product-card" data-product-id="${product.id}">
                                <div class="product-image">
                                    ${product.photo_url ? `
                                        <img src="${product.photo_url}" alt="${product.name}" loading="lazy"
                                             onerror="this.parentElement.innerHTML='<div class=\\'product-placeholder\\'><i data-lucide=\\'image\\'></i><span>–ù–µ—Ç —Ñ–æ—Ç–æ</span></div>'; lucide.createIcons();">
                                    ` : `
                                        <div class="product-placeholder">
                                            <i data-lucide="image"></i>
                                            <span>–ù–µ—Ç —Ñ–æ—Ç–æ</span>
                                        </div>
                                    `}
                                    ${product.is_available ? '' : '<div class="product-overlay"><span class="product-overlay-text">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span></div>'}
                                </div>
                                <div class="product-actions">
                                    <button class="product-action-btn ripple" onclick="editProduct(${product.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        <i data-lucide="edit"></i>
                                    </button>
                                    <button class="product-action-btn ripple" onclick="toggleProductAvailability(${product.id})" title="${product.is_available ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å'}">
                                        <i data-lucide="${product.is_available ? 'eye-off' : 'eye'}"></i>
                                    </button>
                                    <button class="product-action-btn ripple" onclick="deleteProduct(${product.id})" title="–£–¥–∞–ª–∏—Ç—å">
                                        <i data-lucide="trash-2"></i>
                                    </button>
                                </div>
                                <div class="product-info">
                                    <div class="product-header">
                                        <h3 class="product-title">${product.name}</h3>
                                        ${product.discount > 0 ? `<div class="badge-discount">-${product.discount}%</div>` : ''}
                                    </div>
                                    <p class="product-description">${product.description || ''}</p>
                                    <div class="product-meta">
                                        <div class="meta-item">
                                            <i data-lucide="package"></i>
                                            <span class="meta-value">${product.stock || 0} ${product.unit || '—à—Ç'}</span>
                                        </div>
                                        <div class="meta-item">
                                            <i data-lucide="eye"></i>
                                            <span class="meta-value">${product.views || 0}</span>
                                        </div>
                                    </div>
                                    <div class="product-footer">
                                        <div class="product-price">
                                            ${product.discount > 0 ? `<div class="price-old">${formatPrice(product.original_price)}</div>` : ''}
                                            <div class="price-current">${formatPrice(product.price)}</div>
                                        </div>
                                        <button class="product-cta" onclick="editProduct(${product.id})">
                                            <i data-lucide="edit"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('') || '<div class="empty-state"><div class="empty-icon">üì¶</div><p class="empty-title">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</p><button class="btn btn-primary" onclick="openProductModal()">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä</button></div>'}
                    </div>
                </div>
            `;

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function searchProducts(query) {
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                const title = card.querySelector('.product-title').textContent.toLowerCase();
                const match = title.includes(query.toLowerCase());
                card.style.display = match ? '' : 'none';
            });
        }

        // Filter products by category, status, discount
        function filterProducts() {
            const categoryFilter = document.getElementById('categoryFilter')?.value || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            const discountFilter = document.getElementById('discountFilter')?.value || '';

            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                const productId = parseInt(card.dataset.productId);
                const product = state.products.find(p => p.id === productId);
                if (!product) {
                    card.style.display = 'none';
                    return;
                }

                let show = true;

                // Category filter
                if (categoryFilter && product.category !== categoryFilter) {
                    show = false;
                }

                // Status filter
                if (statusFilter === 'available' && !product.is_available) {
                    show = false;
                } else if (statusFilter === 'unavailable' && product.is_available) {
                    show = false;
                }

                // Discount filter
                if (discountFilter === 'discount' && (!product.discount || product.discount <= 0)) {
                    show = false;
                } else if (discountFilter === 'no-discount' && product.discount > 0) {
                    show = false;
                }

                card.style.display = show ? '' : 'none';
            });

            haptic('light');
        }

        // Reset all filters
        function resetFilters() {
            const categoryFilter = document.getElementById('categoryFilter');
            const statusFilter = document.getElementById('statusFilter');
            const discountFilter = document.getElementById('discountFilter');
            const searchInput = document.querySelector('.search-input');

            if (categoryFilter) categoryFilter.value = '';
            if (statusFilter) statusFilter.value = '';
            if (discountFilter) discountFilter.value = '';
            if (searchInput) searchInput.value = '';

            // Show all products
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                card.style.display = '';
            });

            haptic('light');
            toast('–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã', 'info');
        }

        
        function openProductModal(productId = null) {
            haptic('light');
            const product = productId ? state.products.find(p => p.id === productId) : null;
            const isEdit = Boolean(product);
            const today = new Date().toISOString().split('T')[0];

            const modal = document.createElement('div');
            modal.className = 'modal-overlay scale-in';
            modal.innerHTML = `
                <div class="modal-content modal-lg">
                    <div class="modal-header">
                        <h3>${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä' : '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä'}</h3>
                        <button class="btn-icon ripple" onclick="this.closest('.modal-overlay').remove()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <form id="productForm" onsubmit="saveProduct(event, ${productId ?? 'null'})">
                        <div class="modal-body">
                            <div class="form-section">
                                <div class="form-section-header">
                                    <div class="form-section-icon">üì¶</div>
                                    <div>
                                        <h4 class="form-section-title">–ù–∞–ª–∏—á–∏–µ –∏ —Å—Ä–æ–∫</h4>
                                        <p class="form-section-subtitle">\u041e\u043f\u0446\u0438\u043e\u043d\u0430\u043b\u044c\u043d\u043e \u0434\u043b\u044f \u043b\u0443\u0447\u0448\u0435\u0433\u043e \u0432\u0438\u0434\u0430</p>
                                    </div>
                                </div>
                                <input type="hidden" name="photo_id" value="${product?.photo_id || ''}">
                                <input type="file" id="photoFile" accept="image/*" class="hidden" onchange="handlePhotoUpload(this, event)">
                                <div class="photo-upload-card photo-upload-area ${product?.photo_url ? 'has-photo' : ''}" onclick="document.getElementById('photoFile').click()">
                                    ${product?.photo_url ? `
                                        <div class="photo-preview">
                                            <img src="${product.photo_url}" alt="Preview">
                                            <button type="button" class="photo-preview-remove" onclick="event.stopPropagation(); removePhoto()">
                                                <i data-lucide="x" class="icon-16"></i>
                                            </button>
                                        </div>
                                    ` : `
                                        <div class="photo-upload-icon">üì∑</div>
                                        <div class="photo-upload-title">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</div>
                                        <div class="photo-upload-subtitle">PNG/JPG –¥–æ 5 –ú–ë</div>
                                    `}
                                </div>
                            </div>

                            <div class="form-section">
                                <div class="form-section-header">
                                   <div class="form-section-icon">üìå</div>>
                                    <div>
                                        <h4 class="form-section-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ</h4>
                                        <p class="form-section-subtitle">\u041d\u0430\u0437\u0432\u0430\u043d\u0438\u0435, \u043a\u0430\u0442\u0435\u0433\u043e\u0440\u0438\u044f, \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u0435</p>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                                    <input type="text" name="name" id="productName" value="${product?.name || ''}" required
                                           class="search-input" minlength="3" maxlength="100"
                                           oninput="validateField(this)" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –•–ª–µ–±, 450–≥">
                                    <div class="form-error hidden">–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å > 0</div>
                                </div>

                                <div class="form-group">
                                    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                                    <select name="category" id="productCategory" required class="search-input">

                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                        <option value="bakery" ${product?.category === 'bakery' ? 'selected' : ''}>ü•ê –í—ã–ø–µ—á–∫–∞</option>
                                        <option value="dairy" ${product?.category === 'dairy' ? 'selected' : ''}>ü•õ –ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã</option>
                                        <option value="meat" ${product?.category === 'meat' ? 'selected' : ''}>ü•© –ú—è—Å–æ –∏ —Ä—ã–±–∞</option>
                                        <option value="fruits" ${product?.category === 'fruits' ? 'selected' : ''}>üçé –§—Ä—É–∫—Ç—ã</option>
                                        <option value="vegetables" ${product?.category === 'vegetables' ? 'selected' : ''}>ü•ï –û–≤–æ—â–∏</option>
                                        <option value="drinks" ${product?.category === 'drinks' ? 'selected' : ''}>ü•§ –ù–∞–ø–∏—Ç–∫–∏</option>
                                        <option value="sweets" ${product?.category === 'sweets' ? 'selected' : ''}>üç∞ –°–ª–∞–¥–æ—Å—Ç–∏</option>
                                        <option value="frozen" ${product?.category === 'frozen' ? 'selected' : ''}>‚ùÑÔ∏è –ó–∞–º–æ—Ä–æ–∑–∫–∞</option>
                                        <option value="other" ${!product?.category || product?.category === 'other' ? 'selected' : ''}>üì¶ –î—Ä—É–≥–æ–µ</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                    <textarea name="description" rows="3" class="search-input" maxlength="500"
                                              oninput="updateCharCounter(this)" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ –ø—Ä–æ–¥—É–∫—Ç–µ">${product?.description || ''}</textarea>
                                    <div class="char-counter">${product?.description?.length || 0}/500</div>
                                </div>
                            </div>

                            <div class="form-section">
                                <div class="form-section-header">
                                   <div class="form-section-icon">üìå</div>>
                                    <div>
                                        <h4 class="form-section-title">–¶–µ–Ω–∞ –∏ —Å–∫–∏–¥–∫–∞</h4>
                                        <p class="form-section-subtitle">\u0426\u0435\u043d\u0430 \u0438 \u0441\u043a\u0438\u0434\u043a\u0430 \u043f\u043e \u0436\u0435\u043b\u0430\u043d\u0438\u044e</p>
                                    </div>
                                </div>

                                <div class="form-grid-2">
                                    <div class="form-group">
                                        <label>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ *</label>
                                        <input type="number" name="original_price" id="originalPrice"
                                               value="${product?.original_price || ''}" min="1" step="1" required
                                               class="search-input" oninput="calculateFinalPrice('percent'); validateField(this)" placeholder="15000">
                                        <div class="form-error hidden">–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å > 0</div>
                                    </div>
                                    <div class="form-group">
                                        <label>–°–∫–∏–¥–∫–∞ (%)</label>
                                        <input type="number" name="discount" id="discountPercent" value="${product?.discount || 0}"
                                               min="0" max="90" class="search-input"
                                               oninput="calculateFinalPrice('percent'); validateField(this)" placeholder="30">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>–¶–µ–Ω–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π</label>
                                    <input type="number" name="discount_price" id="discountPrice" value="${product?.price || product?.discount_price || ''}"
                                           min="0" step="1" class="search-input"
                                           oninput="calculateFinalPrice('price'); validateField(this)" placeholder="10500">
                                </div>

                                <div class="price-preview-card hidden" id="pricePreview">
                                    <div class="price-preview-row">
                                        <span class="price-preview-label">–¶–µ–Ω–∞:</span>
                                        <span id="priceOriginal" class="price-preview-value original">?</span>
                                    </div>
                                    <div class="price-preview-row">
                                        <span class="price-preview-label price-preview-label-strong">–ò—Ç–æ–≥:</span>
                                        <span id="priceFinal" class="price-preview-value final">?</span>
                                    </div>
                                    <div class="price-preview-savings">
        <span class="price-preview-savings-label">–≠–∫–æ–Ω–æ–º–∏—è</span>
                                        <span id="priceSavings" class="price-preview-savings-value">?</span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <div class="form-section-header">
                                   <div class="form-section-icon">üìå</div>>
                                    <div>
                                        <h4 class="form-section-title">–ù–∞–ª–∏—á–∏–µ –∏ —Å—Ä–æ–∫</h4>
                                        <p class="form-section-subtitle">\u041e\u0441\u0442\u0430\u0442\u043e\u043a \u0438 \u0441\u0440\u043e\u043a \u0433\u043e\u0434\u043d\u043e\u0441\u0442\u0438</p>
                                    </div>
                                </div>

                                <div class="form-grid-2">
                                    <div class="form-group">
                                        <label>–ï–¥–∏–Ω–∏—Ü–∞ *</label>
                                        <select name="unit" required class="search-input">

                                            <option value="—à—Ç" ${product?.unit === '—à—Ç' ? 'selected' : ''}>–®—Ç—É–∫–∏ (—à—Ç)</option>
                                            <option value="–∫–≥" ${product?.unit === '–∫–≥' ? 'selected' : ''}>–ö–∏–ª–æ–≥—Ä–∞–º–º—ã (–∫–≥)</option>
                                            <option value="–ª" ${product?.unit === '–ª' ? 'selected' : ''}>–õ–∏—Ç—Ä—ã (–ª)</option>
                                            <option value="—É–ø" ${product?.unit === '—É–ø' ? 'selected' : ''}>–£–ø–∞–∫–æ–≤–∫–∏ (—É–ø)</option>
                                            <option value="–≥" ${product?.unit === '–≥' ? 'selected' : ''}>–ì—Ä–∞–º–º—ã (–≥)</option>
                                            <option value="–º–ª" ${product?.unit === '–º–ª' ? 'selected' : ''}>–ú–∏–ª–ª–∏–ª–∏—Ç—Ä—ã (–º–ª)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                                        <div class="d-flex align-center gap-sm">
                                            <button type="button" class="btn btn-sm btn-secondary btn-square-sm" onclick="changeQuantity(-1)">?</button>
                                            <input type="number" name="stock_quantity" id="stockQuantity"
                                                   value="${product?.stock_quantity ?? product?.stock ?? product?.quantity ?? 0}"
                                                   min="0" max="9999" required class="search-input text-center flex-1">
                                            <button type="button" class="btn btn-sm btn-secondary btn-square-sm" onclick="changeQuantity(1)">+</button>
                                        </div>
                                        <div class="d-flex gap-sm mt-sm">
                                            <button type="button" class="btn btn-sm btn-ghost flex-1" onclick="setQuantity(5)">5</button>
                                            <button type="button" class="btn btn-sm btn-ghost flex-1" onclick="setQuantity(10)">10</button>
                                            <button type="button" class="btn btn-sm btn-ghost flex-1" onclick="setQuantity(20)">20</button>
                                            <button type="button" class="btn btn-sm btn-ghost flex-1" onclick="setQuantity(50)">50</button>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ *</label>
                                    <input type="date" name="expiry_date" id="expiryDate"
                                           value="${product?.expiry_date ? product.expiry_date.split('T')[0] : ''}"
                                           min="${today}" required class="search-input">
                                    <div class="d-flex gap-sm mt-sm">
                                        <button type="button" class="btn btn-sm btn-ghost flex-1" onclick="setExpiry(0)">–°–µ–≥–æ–¥–Ω—è</button>
                                        <button type="button" class="btn btn-sm btn-ghost flex-1" onclick="setExpiry(1)">–ó–∞–≤—Ç—Ä–∞</button>
                                        <button type="button" class="btn btn-sm btn-ghost flex-1" onclick="setExpiry(2)">2 –¥–Ω—è</button>
                                        <button type="button" class="btn btn-sm btn-ghost flex-1" onclick="setExpiry(3)">3 –¥–Ω—è</button>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="is_available" ${product?.is_available !== false ? 'checked' : ''}>
                                        <span>–î–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary ripple">
                                <i data-lucide="check" class="icon-16"></i>
                                ${isEdit ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'}
                            </button>
                            <button type="button" class="btn btn-secondary ripple" onclick="this.closest('.modal-overlay').remove()">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);
            if (typeof lucide !== 'undefined') lucide.createIcons();

            calculateFinalPrice('percent');
            setTimeout(() => modal.querySelector('input[name="name"]').focus(), 80);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    haptic('light');
                    modal.remove();
                }
            });
        }

        function editProduct(productId) {
            openProductModal(productId);
        }

        function handlePhotoUpload(input, event) {
            const file = input.files?.[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                toast('\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435', 'error');
                input.value = '';
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                toast('\u041c\u0430\u043a\u0441\u0438\u043c\u0443\u043c 5 \u041c\u0411', 'error');
                input.value = '';
                return;
            }

            const uploadArea = document.querySelector('.photo-upload-area');
            uploadArea.classList.add('has-photo');
            uploadArea.innerHTML = '<div class="upload-placeholder"><i data-lucide="loader" class="icon-spin"></i><div>\u0417\u0430\u0433\u0440\u0443\u0437\u043a\u0430...</div></div>';
            if (typeof lucide !== 'undefined') lucide.createIcons();

            const reader = new FileReader();
            reader.onload = (e) => {
                const photoUrl = e.target.result;
                document.querySelector('input[name="photo_id"]').value = '';
                uploadArea.innerHTML = `
                    <div class="photo-preview">
                        <img src="${photoUrl}" alt="Preview">
                        <button type="button" class="photo-preview-remove" onclick="event.stopPropagation(); removePhoto()">
                            <i data-lucide="x" class="icon-16"></i>
                        </button>
                    </div>
                `;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            };
            reader.readAsDataURL(file);
        }

        function removePhoto() {
            const uploadArea = document.querySelector('.photo-upload-area');
            uploadArea.classList.remove('has-photo');
            uploadArea.innerHTML = `
                <div class="photo-upload-icon">üì∑</div>
                <div class="photo-upload-title">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</div>
                <div class="photo-upload-subtitle">PNG/JPG –¥–æ 5 –ú–ë</div>
            `;
            document.querySelector('input[name="photo_id"]').value = '';
            const fileInput = document.getElementById('photoFile');
            if (fileInput) fileInput.value = '';
        }

        function calculateFinalPrice(source = 'percent') {
            const originalInput = document.getElementById('originalPrice');
            const discountPercentInput = document.getElementById('discountPercent');
            const discountPriceInput = document.getElementById('discountPrice');
            const preview = document.getElementById('pricePreview');
            const priceOriginal = document.getElementById('priceOriginal');
            const priceFinal = document.getElementById('priceFinal');
            const priceSavings = document.getElementById('priceSavings');

            const original = parseInt(originalInput.value, 10) || 0;
            let percent = parseInt(discountPercentInput.value, 10);
            let discounted = parseInt(discountPriceInput.value, 10);

            if (source === 'percent') {
                percent = Number.isFinite(percent) ? Math.min(90, Math.max(0, percent)) : 0;
                discountPercentInput.value = percent;
                discounted = Math.round(original * (1 - percent / 100));
                discountPriceInput.value = discounted || '';
            } else {
                discounted = Number.isFinite(discounted) ? discounted : 0;
                if (discounted > original && original > 0) discounted = original;
                discountPriceInput.value = discounted || '';
                percent = original > 0 ? Math.round((1 - discounted / original) * 100) : 0;
                discountPercentInput.value = percent;
            }

            if (original > 0) {
                preview.classList.remove('hidden');
                priceOriginal.textContent = `${original.toLocaleString()} \u0441\u0443\u043c`;
                priceFinal.textContent = `${(discounted || original).toLocaleString()} \u0441\u0443\u043c`;
                const savings = Math.max(0, original - (discounted || original));
                priceSavings.textContent = `${savings.toLocaleString()} \u0441\u0443\u043c (${percent}%)`;
            } else {
                preview.classList.add('hidden');
            }
        }

        function changeQuantity(delta) {
            const input = document.getElementById('stockQuantity');
            const current = parseInt(input.value, 10) || 0;
            input.value = Math.max(0, current + delta);
        }

        function setQuantity(value) {
            const input = document.getElementById('stockQuantity');
            input.value = value;
        }

        function setExpiry(days) {
            const dateInput = document.getElementById('expiryDate');
            const date = new Date();
            date.setDate(date.getDate() + days);
            dateInput.value = date.toISOString().split('T')[0];
        }

        function updateCharCounter(textarea) {
            const counter = textarea.nextElementSibling;
            if (counter) counter.textContent = `${textarea.value.length}/500`;
        }

        async function saveProduct(event, productId) {
            event.preventDefault();
            haptic('medium');

            const form = event.target;
            const formData = new FormData(form);
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner spinner-small spinner-center"></div>';

            try {
                const title = String(formData.get('name') || '').trim();
                const category = String(formData.get('category') || 'other').trim() || 'other';
                const description = String(formData.get('description') || '').trim();
                const unit = String(formData.get('unit') || '??').trim();
                const stockQty = Math.max(0, parseInt(formData.get('stock_quantity'), 10) || 0);
                const originalPrice = parseInt(formData.get('original_price'), 10);
                const discountPercent = Math.max(0, Math.min(90, parseInt(formData.get('discount'), 10) || 0));
                const discountPriceInput = parseInt(formData.get('discount_price'), 10);
                const expiryDate = String(formData.get('expiry_date') || '');
                const isAvailable = formData.get('is_available') === 'on';

                if (!title || title.length < 3) throw new Error('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ (–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞)');
                                if (!productId && stockQty <= 0) throw new Error('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0');
if (!originalPrice || originalPrice <= 0) throw new Error('–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞');
                if (!expiryDate) throw new Error('–£–∫–∞–∂–∏—Ç–µ —Å—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏');

                let discountPrice = Number.isFinite(discountPriceInput) && discountPriceInput > 0
                    ? discountPriceInput
                    : Math.round(originalPrice * (1 - discountPercent / 100));

                if (discountPrice > originalPrice) discountPrice = originalPrice;

                let photoId = String(formData.get('photo_id') || '').trim();
                const fileInput = document.getElementById('photoFile');
                const photoFile = fileInput?.files?.[0] || null;

                if (photoFile) {
                    try {
                        const uploadForm = new FormData();
                        uploadForm.append('photo', photoFile, photoFile.name || 'photo.jpg');
                        const uploaded = await apiFetch('/api/partner/upload-photo', { method: 'POST', body: uploadForm });
                        if (!uploaded?.file_id) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ');
                        photoId = uploaded.file_id;
                    } catch (uploadError) {
                        console.error('Photo upload error:', uploadError);
                        toast('–§–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å. –°–æ—Ö—Ä–∞–Ω—è—é –±–µ–∑ —Ñ–æ—Ç–æ', 'warning');
                    }
                }

                const payload = new FormData();
                payload.append('title', title);
                payload.append('category', category);
                payload.append('original_price', String(originalPrice));
                payload.append('discount_price', String(discountPrice));
                payload.append('quantity', String(stockQty));
                payload.append('stock_quantity', String(stockQty));
                payload.append('unit', unit);
                payload.append('expiry_date', expiryDate);
                if (description) payload.append('description', description);
                if (photoId) payload.append('photo_id', photoId);
                if (productId) payload.append('status', stockQty <= 0 ? 'out_of_stock' : (isAvailable ? 'active' : 'hidden'));

                if (productId) {
                    await apiFetch(`/api/partner/products/${productId}`, { method: 'PUT', body: payload });
                    toast('–¢–æ–≤–∞—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
                } else {
                    await apiFetch('/api/partner/products', { method: 'POST', body: payload });
                    toast('–¢–æ–≤–∞—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
                }

                haptic('success');
                document.querySelector('.modal-overlay')?.remove();
                await loadProducts();
            } catch (error) {
                console.error('Save product error:', error);
                haptic('error');
                toast(error?.message || '\u041e\u0448\u0438\u0431\u043a\u0430 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u044f \u0442\u043e\u0432\u0430\u0440\u0430', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

async function toggleProductAvailability(id) {
            try {
                haptic('light');

                const product = state.products.find(p => p.id === id);
                if (!product) return;

                // Optimistic UI update
                const newStatus = product.is_available ? 'hidden' : 'active';
                product.status = newStatus;
                product.is_available = newStatus === 'active';
                const card = document.querySelector(`[data-product-id="${id}"]`);
                if (card) card.classList.add('optimistic-update');

                await apiFetch(`/api/partner/products/${id}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: newStatus })
                });

                haptic('success');
                toast(
                    product.is_available ? '–¢–æ–≤–∞—Ä –¥–æ—Å—Ç—É–ø–µ–Ω' : '–¢–æ–≤–∞—Ä —Å–∫—Ä—ã—Ç',
                    'success'
                );

                if (state.currentView === 'products') {
                    loadProducts();
                }
            } catch (error) {
                haptic('error');
                toast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
                loadProducts(); // Revert on error
            }
        }

        async function deleteProduct(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;

            haptic('heavy');

            try {
                // Optimistic UI - fade out card
                const card = document.querySelector(`[data-product-id="${id}"]`);
                if (card) {
                    card.style.opacity = '0.5';
                    card.style.pointerEvents = 'none';
                }

                await apiFetch(`/api/partner/products/${id}`, { method: 'DELETE' });

                state.products = state.products.filter(p => p.id !== id);
                haptic('success');
                toast('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω', 'success');
                loadProducts();
            } catch (error) {
                haptic('error');
                toast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞', 'error');
                loadProducts(); // Restore on error
            }
        }

        // ============================================
        // STATS
        // ============================================
        async function loadStats() {
            showLoading('stats');

            try {
                // Get stats data
                const stats = await calculateStats();
                renderStats(stats);
            } catch (error) {
                document.querySelector('.content').innerHTML = `
                    <div class="container">
                        <div class="error-state">
                            <div class="error-icon">üö®</div>
                            <p class="error-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>
                            <p class="error-text">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</p>
                            <button class="btn btn-primary error-action ripple" onclick="loadStats()">
                                –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function calculateStats() {
            // Calculate statistics from orders and products
            const orders = state.orders || [];
            const products = state.products || [];

            // Revenue by day (last 7 days)
            const today = new Date();
            const last7Days = Array.from({length: 7}, (_, i) => {
                const date = new Date(today);
                date.setDate(date.getDate() - (6 - i));
                return {
                    date: date,
                    day: date.toLocaleDateString('ru-RU', { weekday: 'short' }),
                    revenue: 0,
                    orders: 0
                };
            });

            // Group orders by date
            orders.forEach(order => {
                if (order.status === 'completed') {
                    const orderDate = parseDate(order.created_at);
                    if (!orderDate) return;
                    const dayIndex = last7Days.findIndex(d =>
                        d.date.toDateString() === orderDate.toDateString()
                    );
                    if (dayIndex >= 0) {
                        last7Days[dayIndex].revenue += Number(order.price) || 0;
                        last7Days[dayIndex].orders += 1;
                    }
                }
            });

            // Top products (by order count)
            const productStats = {};
            orders.forEach(order => {
                if (order.product_id) {
                    if (!productStats[order.product_id]) {
                        const product = products.find(p => p.id === order.product_id);
                        productStats[order.product_id] = {
                            name: product?.name || '–¢–æ–≤–∞—Ä',
                            orders: 0,
                            revenue: 0
                        };
                    }
                    productStats[order.product_id].orders += 1;
                    productStats[order.product_id].revenue += Number(order.price) || 0;
                }
            });

            const topProducts = Object.values(productStats)
                .sort((a, b) => b.orders - a.orders)
                .slice(0, 5);

            // Orders by status
            const ordersByStatus = {
                new: orders.filter(o => o.status === 'new').length,
                preparing: orders.filter(o => o.status === 'preparing').length,
                ready: orders.filter(o => o.status === 'ready').length,
                completed: orders.filter(o => o.status === 'completed').length,
                cancelled: orders.filter(o => o.status === 'cancelled').length
            };

            // Peak hours
            const hourStats = Array(24).fill(0);
            orders.forEach(order => {
                const hour = parseDate(order.created_at)?.getHours();
                if (hour == null) return;
                hourStats[hour]++;
            });
            const peakHour = hourStats.indexOf(Math.max(...hourStats));

            // Total stats
            const totalRevenue = orders
                .filter(o => o.status === 'completed')
                .reduce((sum, o) => sum + (Number(o.price) || 0), 0);

            const totalOrders = orders.length;
            const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;

            return {
                last7Days,
                topProducts,
                ordersByStatus,
                peakHour,
                totalRevenue,
                totalOrders,
                avgOrderValue
            };
        }

        function renderStats(stats) {
            const maxRevenue = Math.max(...stats.last7Days.map(d => d.revenue), 1);

            document.querySelector('.content').innerHTML = `
                <div class="container fade-in">
                    <h2 class="section-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>

                    <!-- Key Metrics -->
                    <div class="stats-grid mb-xl">
                        <div class="stat-card primary">
                            <div class="stat-value">${formatPrice(stats.totalRevenue)}</div>
                            <div class="stat-label">–í—Å–µ–≥–æ –≤—ã—Ä—É—á–∫–∞</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-value">${stats.totalOrders}</div>
                            <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-value">${formatPrice(stats.avgOrderValue)}</div>
                            <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
                        </div>

                        <div class="stat-card success">
                            <div class="stat-value">${stats.peakHour}:00</div>
                            <div class="stat-label">–ü–∏–∫ –∑–∞–∫–∞–∑–æ–≤</div>
                        </div>
                    </div>

                    <!-- Revenue Chart -->
                    <div class="dashboard-card mb-lg">
                        <h3 class="card-title">
                            <i data-lucide="trending-up" class="card-icon"></i>
                            –í—ã—Ä—É—á–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é
                        </h3>
                        <div class="chart-container compact">
                            ${stats.last7Days.map(day => `
                                <div class="chart-bar-wrapper flex-1">
                                    <div class="chart-bar-value compact">
                                        ${day.revenue > 0 ? formatPrice(day.revenue).replace(' —Å—É–º', '') : '‚Äî'}
                                    </div>
                                    <div class="chart-bar-container compact">
                                        <div class="chart-bar" style="
                                            width: 100%;
                                            height: ${day.revenue > 0 ? (day.revenue / maxRevenue * 100) : 0}%;
                                            background: linear-gradient(180deg, #21A038 0%, #1a7f2c 100%);
                                            border-radius: 6px 6px 0 0;
                                            min-height: ${day.revenue > 0 ? '4px' : '0'};
                                            transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                                        "></div>
                                    </div>
                                    <div class="chart-bar-label compact">
                                        ${day.day}
                                    </div>
                                    <div class="chart-subnote">
                                        ${day.orders} –∑–∞–∫.
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Top Products -->
                    ${stats.topProducts.length > 0 ? `
                        <div class="dashboard-card mb-lg">
                            <h3 class="card-title">
                                <i data-lucide="trophy" class="card-icon"></i>
                                –¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤
                            </h3>
                            <div class="list">
                                ${stats.topProducts.map((product, index) => {
                                    const medalClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : 'default';
                                    return `
                                    <div class="list-item ripple spacious">
                                        <div class="stat-list-row">
                                            <div class="top-product-medal ${medalClass}">
                                                ${index + 1}
                                            </div>
                                            <div class="flex-1">
                                                <div class="stat-list-title">
                                                    ${product.name}
                                                </div>
                                                <div class="stat-list-meta">
                                                    <span>üì¶ ${product.orders} ${product.orders === 1 ? '–∑–∞–∫–∞–∑' : product.orders < 5 ? '–∑–∞–∫–∞–∑–∞' : '–∑–∞–∫–∞–∑–æ–≤'}</span>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="stat-list-value">
                                                    ${formatPrice(product.revenue)}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Orders by Status -->
                    <div class="dashboard-card">
                        <h3 class="card-title">
                            <i data-lucide="activity" class="card-icon"></i>
                            –ó–∞–∫–∞–∑—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
                        </h3>
                        <div class="stats-grid compact">
                            <div class="status-stat-card new ripple">
                                <div class="status-stat-header">
                                    <div class="status-stat-icon new">
                                        <span>üÜï</span>
                                    </div>
                                    <div class="status-stat-label">–ù–æ–≤—ã–µ</div>
                                </div>
                                <div class="stat-value status-stat-value new">${stats.ordersByStatus.new}</div>
                            </div>
                            <div class="status-stat-card preparing ripple">
                                <div class="status-stat-header">
                                    <div class="status-stat-icon preparing">
                                        <span>üë®‚Äçüç≥</span>
                                    </div>
                                    <div class="status-stat-label">–í —Ä–∞–±–æ—Ç–µ</div>
                                </div>
                                <div class="stat-value status-stat-value preparing">${stats.ordersByStatus.preparing}</div>
                            </div>
                            <div class="status-stat-card ready ripple">
                                <div class="status-stat-header">
                                    <div class="status-stat-icon ready">
                                        <span>‚úÖ</span>
                                    </div>
                                    <div class="status-stat-label">–ì–æ—Ç–æ–≤—ã</div>
                                </div>
                                <div class="stat-value status-stat-value ready">${stats.ordersByStatus.ready}</div>
                            </div>
                            <div class="status-stat-card completed ripple">
                                <div class="status-stat-header">
                                    <div class="status-stat-icon completed">
                                        <span>üéâ</span>
                                    </div>
                                    <div class="status-stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω—ã</div>
                                </div>
                                <div class="stat-value status-stat-value completed">${stats.ordersByStatus.completed}</div>
                            </div>
                            <div class="status-stat-card cancelled ripple">
                                <div class="status-stat-header">
                                    <div class="status-stat-icon cancelled">
                                        <span>‚ùå</span>
                                    </div>
                                    <div class="status-stat-label">–û—Ç–º–µ–Ω–µ–Ω—ã</div>
                                </div>
                                <div class="stat-value status-stat-value cancelled">${stats.ordersByStatus.cancelled}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // ============================================
        // SETTINGS
        // ============================================
        async function loadSettings() {
            showLoading('settings');

            try {
                // Load fresh store data if needed
                if (!state.store) {
                    state.store = await apiFetch('/api/partner/store');
                }

                const deliveryEnabled = Boolean(state.store?.delivery_enabled);
                const minOrderAmount = Number(state.store?.min_order_amount ?? state.store?.min_order ?? 0);
                const deliveryPrice = Number(state.store?.delivery_price ?? state.store?.delivery_cost ?? 0);

                document.querySelector('.content').innerHTML = `
                    <div class="container fade-in">
                        <h2 class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

                        <div class="dashboard-card mb-lg">
                            <h3 class="card-title">
                                <i data-lucide="store" class="card-icon"></i>
                                –ü—Ä–æ—Ñ–∏–ª—å –º–∞–≥–∞–∑–∏–Ω–∞
                            </h3>
                            <div class="list-item">
                                <div class="list-content">
                                    <div class="list-info">
                                        <div class="list-title">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                                        <div class="list-subtitle" id="settingsStoreName">${state.store?.name || '–ó–∞–≥—Ä—É–∑–∫–∞...'}</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-ghost ripple" onclick="editStoreProfile()">
                                    <i data-lucide="edit"></i>
                                </button>
                            </div>

                            <div class="list-item">
                                <div class="list-content">
                                    <div class="list-info">
                                        <div class="list-title">–ê–¥—Ä–µ—Å</div>
                                        <div class="list-subtitle">${state.store?.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="list-item">
                                <div class="list-content">
                                    <div class="list-info">
                                        <div class="list-title">–¢–µ–ª–µ—Ñ–æ–Ω</div>
                                        <div class="list-subtitle">${state.store?.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="list-item">
                                <div class="list-content">
                                    <div class="list-info">
                                        <div class="list-title">–°—Ç–∞—Ç—É—Å</div>
                                        <div class="list-subtitle">${state.store?.is_open ? 'üü¢ –û—Ç–∫—Ä—ã—Ç–æ' : 'üî¥ –ó–∞–∫—Ä—ã—Ç–æ'}</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm ${state.store?.is_open ? 'btn-danger' : 'btn-success'} ripple" onclick="toggleStoreStatus()">
                                    ${state.store?.is_open ? '–ó–∞–∫—Ä—ã—Ç—å' : '–û—Ç–∫—Ä—ã—Ç—å'}
                                </button>
                            </div>
                        </div>

                        <div class="dashboard-card mb-lg">
                            <h3 class="card-title">
                                <i data-lucide="clock" class="card-icon"></i>
                                –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
                            </h3>
                            <div class="list-item">
                                <div class="list-content">
                                    <div class="list-info">
                                        <div class="list-title">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - –ü—è—Ç–Ω–∏—Ü–∞</div>
                                        <div class="list-subtitle">09:00 - 21:00</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-ghost ripple" onclick="haptic('light'); toast('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info')">
                                    <i data-lucide="edit"></i>
                                </button>
                            </div>
                            <div class="list-item">
                                <div class="list-content">
                                    <div class="list-info">
                                        <div class="list-title">–°—É–±–±–æ—Ç–∞ - –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</div>
                                        <div class="list-subtitle">10:00 - 20:00</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-card mb-lg">
                            <h3 class="card-title">
                                <i data-lucide="truck" class="card-icon"></i>
                                –î–æ—Å—Ç–∞–≤–∫–∞
                            </h3>
                            <div class="list-item">
                                <span class="list-title">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑</span>
                                <span class="list-value">${formatPrice(state.store?.min_order || 0)}</span>
                        </div>
                        <div class="list-item">
                            <span class="list-title">–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏</span>
                            <span class="list-value">${formatPrice(state.store?.delivery_cost || 0)}</span>
                        </div>
                        <button class="btn btn-sm btn-primary mt-12" onclick="toast('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info')" >
                            –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                        </button>
                    </div>

                    <div class="dashboard-card">
                        <h3 class="card-title">
                            <i data-lucide="bell" class="card-icon"></i>
                            –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                        </h3>
                        <div class="list-item">
                            <span class="list-title">–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã</span>
                            <button class="btn btn-sm btn-success ripple" onclick="haptic('light'); toast('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã', 'success')">
                                –í–∫–ª—é—á–µ–Ω–æ
                            </button>
                        </div>
                        <div class="list-item">
                            <span class="list-title">–û—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–æ–≤</span>
                            <button class="btn btn-sm btn-success ripple" onclick="haptic('light'); toast('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã', 'success')">
                                –í–∫–ª—é—á–µ–Ω–æ
                            </button>
                        </div>
                    </div>
                </div>
            `;

            if (typeof lucide !== 'undefined') lucide.createIcons();
            } catch (error) {
                document.querySelector('.content').innerHTML = `
                    <div class="container">
                        <div class="error-state">
                            <div class="error-icon">üö®</div>
                            <p class="error-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>
                            <p class="error-text">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</p>
                            <button class="btn btn-primary error-action ripple" onclick="loadSettings()">
                                –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function editStoreProfile() {
            haptic('light');
            const modal = document.createElement('div');
            modal.className = 'modal-overlay scale-in';
            modal.innerHTML = `
                <div class="modal-content modal-md">
                    <div class="modal-header">
                        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
                        <button class="btn-icon ripple" onclick="this.closest('.modal-overlay').remove()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <form onsubmit="saveStoreProfile(event)">
                        <div class="modal-body">
                            <div class="form-group">
                                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ *</label>
                                <input type="text" name="name" value="${state.store?.name || ''}" required class="search-input"
                                       minlength="3" maxlength="50" oninput="validateField(this)">
                                <div class="form-error hidden">–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞</div>
                            </div>

                            <div class="form-group">
                                <label>–ê–¥—Ä–µ—Å</label>
                                <input type="text" name="address" value="${state.store?.address || ''}" class="search-input"
                                       maxlength="200" oninput="validateField(this)">
                            </div>

                            <div class="form-group">
                                <label>Viloyat</label>
                                <input type="text" name="region" value="${state.store?.region || ''}" class="search-input"
                                       maxlength="100" oninput="validateField(this)">
                            </div>

                            <div class="form-group">
                                <label>Tuman</label>
                                <input type="text" name="district" value="${state.store?.district || ''}" class="search-input"
                                       maxlength="100" oninput="validateField(this)">
                            </div>

                            <div class="form-group">
                                <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <input type="tel" name="phone" value="${state.store?.phone || ''}" placeholder="+998 XX XXX XX XX"
                                       class="search-input" pattern="\+998\s?\d{2}\s?\d{3}\s?\d{2}\s?\d{2}" oninput="validateField(this)">
                                <div class="form-error hidden">–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç</div>
                            </div>

                            <div class="form-group">
                                <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                <textarea name="description" rows="3" class="search-input" maxlength="300"
                                          oninput="validateField(this)">${state.store?.description || ''}</textarea>
                                <div class="form-hint text-muted">0/300</div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary ripple">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // Setup character counter for description
            const textarea = modal.querySelector('textarea[name="description"]');
            const counter = textarea.nextElementSibling;
            textarea.addEventListener('input', () => {
                counter.textContent = `${textarea.value.length}/300`;
            });
            counter.textContent = `${textarea.value.length}/300`;

            // Auto-focus first input
            setTimeout(() => modal.querySelector('input[name="name"]').focus(), 100);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    haptic('light');
                    modal.remove();
                }
            });
        }

        function editDeliverySettings() {
            haptic('light');
            const modal = document.createElement('div');
            modal.className = 'modal-overlay scale-in';
            modal.innerHTML = `
                <div class="modal-content modal-md">
                    <div class="modal-header">
                        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
                        <button class="btn-icon ripple" onclick="this.closest('.modal-overlay').remove()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <form onsubmit="saveDeliverySettings(event)">
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="delivery_enabled" ${state.store?.delivery_enabled ? 'checked' : ''}>
                                    <span>–î–æ—Å—Ç–∞–≤–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞</span>
                                </label>
                            </div>

                            <div class="form-group">
                                <label>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑ (—Å—É–º)</label>
                                <input type="number" name="min_order_amount" value="${state.store?.min_order_amount ?? state.store?.min_order ?? 0}"
                                       min="0" step="1" class="search-input" oninput="validateField(this)">
                            </div>

                            <div class="form-group">
                                <label>–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ (—Å—É–º)</label>
                                <input type="number" name="delivery_price" value="${state.store?.delivery_price ?? state.store?.delivery_cost ?? 0}"
                                       min="0" step="1" class="search-input" oninput="validateField(this)">
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary ripple">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button type="button" class="btn btn-secondary ripple" onclick="this.closest('.modal-overlay').remove()">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);
            if (typeof lucide !== 'undefined') lucide.createIcons();

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    haptic('light');
                    modal.remove();
                }
            });
        }

        async function saveDeliverySettings(event) {
            event.preventDefault();
            haptic('medium');

            const formData = new FormData(event.target);
            const deliveryEnabled = formData.get('delivery_enabled') === 'on';
            const minOrderAmount = parseInt(formData.get('min_order_amount'), 10) || 0;
            const deliveryPrice = parseInt(formData.get('delivery_price'), 10) || 0;

            try {
                await apiFetch('/api/partner/store', {
                    method: 'PUT',
                    body: JSON.stringify({
                        delivery_enabled: deliveryEnabled,
                        min_order_amount: minOrderAmount,
                        delivery_price: deliveryPrice
                    })
                });

                state.store = {
                    ...state.store,
                    delivery_enabled: deliveryEnabled,
                    min_order_amount: minOrderAmount,
                    delivery_price: deliveryPrice,
                    min_order: minOrderAmount,
                    delivery_cost: deliveryPrice
                };

                toast('\u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u0434\u043e\u0441\u0442\u0430\u0432\u043a\u0438 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u044b', 'success');
                document.querySelector('.modal-overlay').remove();
                loadSettings();
            } catch (error) {
                console.error('Delivery settings error:', error);
                toast('\u041e\u0448\u0438\u0431\u043a\u0430 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u044f \u043d\u0430\u0441\u0442\u0440\u043e\u0435\u043a', 'error');
            }
        }

        async function saveStoreProfile(event) {
            event.preventDefault();
            haptic('medium');

            const formData = new FormData(event.target);
            const data = {
                name: formData.get('name'),
                address: formData.get('address'),
                region: formData.get('region'),
                district: formData.get('district'),
                phone: formData.get('phone'),
                description: formData.get('description')
            };

            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner spinner-small spinner-center"></div>';

            try {
                await apiFetch('/api/partner/store', {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });

                // Update local state
                state.store = { ...state.store, ...data };
                document.getElementById('storeName').textContent = data.name;

                haptic('success');
                toast('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                document.querySelector('.modal-overlay').remove();
                loadSettings();
            } catch (error) {
                haptic('error');
                toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');

                // Restore button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        async function toggleStoreStatus() {
            try {
                haptic('medium');

                const newStatus = !state.store?.is_open;

                // Optimistic UI update
                state.store.is_open = newStatus;
                if (state.currentView === 'dashboard') {
                    renderDashboard();
                }

                const form = new FormData();
                form.append('is_open', newStatus ? 'true' : 'false');
                await apiFetch('/api/partner/store/status', {
                    method: 'PATCH',
                    body: form
                });

                haptic('success');
                toast(newStatus ? '–ú–∞–≥–∞–∑–∏–Ω –æ—Ç–∫—Ä—ã—Ç' : '–ú–∞–≥–∞–∑–∏–Ω –∑–∞–∫—Ä—ã—Ç', 'success');

                // Refresh store info
                state.store = await apiFetch('/api/partner/store');
                document.getElementById('storeName').textContent = state.store?.name || '–ó–∞–≥—Ä—É–∑–∫–∞...';

                if (state.currentView === 'settings') {
                    loadSettings();
                }
            } catch (error) {
                haptic('error');
                toast('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞', 'error');
                try {
                    state.store = await apiFetch('/api/partner/store');
                    document.getElementById('storeName').textContent = state.store?.name || '–ó–∞–≥—Ä—É–∑–∫–∞...';
                } catch (_) {}

                if (state.currentView === 'dashboard') {
                    renderDashboard();
                } else if (state.currentView === 'settings') {
                    loadSettings();
                }
            }
        }

        // ============================================
        // SMART UX DATA
        // ============================================
        const categoryDefaults = {
            'bakery': { unit: '—à—Ç', quantity: 10, expiry_days: 1 },
            'dairy': { unit: '–ª', quantity: 20, expiry_days: 5 },
            'meat': { unit: '–∫–≥', quantity: 5, expiry_days: 3 },
            'fruits': { unit: '–∫–≥', quantity: 10, expiry_days: 7 },
            'vegetables': { unit: '–∫–≥', quantity: 10, expiry_days: 7 },
            'drinks': { unit: '–ª', quantity: 24, expiry_days: 90 },
            'snacks': { unit: '—à—Ç', quantity: 20, expiry_days: 30 },
            'frozen': { unit: '–∫–≥', quantity: 5, expiry_days: 180 },
            'other': { unit: '—à—Ç', quantity: 10, expiry_days: 30 }
        };

        const popularProducts = {
            'bakery': ['–•–ª–µ–± –±–µ–ª—ã–π', '–õ–∞–≤–∞—à —É–∑–±–µ–∫—Å–∫–∏–π', '–ë–∞—Ç–æ–Ω', '–ë—É–ª–æ—á–∫–∞', '–°–∞–º—Å–∞'],
            'dairy': ['–ú–æ–ª–æ–∫–æ 3.2%', '–ö–µ—Ñ–∏—Ä', '–°–º–µ—Ç–∞–Ω–∞ 20%', '–¢–≤–æ—Ä–æ–≥', '–ô–æ–≥—É—Ä—Ç', '–ê–π—Ä–∞–Ω'],
            'meat': ['–ö—É—Ä–∏—Ü–∞ –æ—Ö–ª–∞–∂–¥–µ–Ω–Ω–∞—è', '–ì–æ–≤—è–¥–∏–Ω–∞', '–ë–∞—Ä–∞–Ω–∏–Ω–∞', '–ö–æ–ª–±–∞—Å–∞', '–°–æ—Å–∏—Å–∫–∏'],
            'fruits': ['–Ø–±–ª–æ–∫–∏', '–ë–∞–Ω–∞–Ω—ã', '–ê–ø–µ–ª—å—Å–∏–Ω—ã', '–ú–∞–Ω–¥–∞—Ä–∏–Ω—ã', '–í–∏–Ω–æ–≥—Ä–∞–¥', '–ì—Ä—É—à–∏'],
            'vegetables': ['–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å', '–ú–æ—Ä–∫–æ–≤—å', '–õ—É–∫', '–ü–æ–º–∏–¥–æ—Ä—ã', '–û–≥—É—Ä—Ü—ã', '–ö–∞–ø—É—Å—Ç–∞'],
            'drinks': ['–í–æ–¥–∞ –ø–∏—Ç—å–µ–≤–∞—è', '–°–æ–∫ –∞–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π', 'Coca-Cola', '–ß–∞–π —á–µ—Ä–Ω—ã–π', '–ö–æ—Ñ–µ'],
            'snacks': ['–ß–∏–ø—Å—ã', '–°—É—Ö–∞—Ä–∏–∫–∏', '–û—Ä–µ—Ö–∏', '–®–æ–∫–æ–ª–∞–¥', '–ö–æ–Ω—Ñ–µ—Ç—ã'],
            'frozen': ['–ü–µ–ª—å–º–µ–Ω–∏', '–ú–æ—Ä–æ–∂–µ–Ω–æ–µ', '–†—ã–±–∞ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω–∞—è', '–û–≤–æ—â–∏ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ'],
            'other': ['–•–ª–æ–ø–æ–∫', '–ë—É–º–∞–∂–Ω—ã–µ –ø–æ–ª–æ—Ç–µ–Ω—Ü–∞', '–ú—ã–ª–æ', '–®–∞–º–ø—É–Ω—å']
        };

        // ============================================
        // HELPERS
        // ============================================
        function formatPrice(price) {
            if (price == null || price === '' || isNaN(price)) {
                return '0 —Å—É–º';
            }

            // Convert to number and round (no decimals for uzbek som)
            const num = Math.round(Number(price));

            // Format with thousand separators
            const formatted = num.toLocaleString('ru-RU', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });

            return `${formatted} —Å—É–º`;
        }

        function parseDate(dateString) {
            if (!dateString) return null;
            const trimmed = String(dateString).trim();
            const hasTimezone = /([zZ]|[+-]\d{2}:?\d{2})$/.test(trimmed);
            const normalized = hasTimezone ? trimmed : `${trimmed}Z`;
            const date = new Date(normalized);
            return Number.isNaN(date.getTime()) ? null : date;
        }

        function formatTime(dateString) {
            const date = parseDate(dateString);
            if (!date) return '';
            return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }

        function isToday(dateString) {
            const date = parseDate(dateString);
            if (!date) return false;
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function isYesterday(dateString) {
            const date = parseDate(dateString);
            if (!date) return false;
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return date.toDateString() === yesterday.toDateString();
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '–û–∂–∏–¥–∞–µ—Ç',
                'new': '–ù–æ–≤—ã–π',
                'preparing': '–ì–æ—Ç–æ–≤–∏—Ç—Å—è',
                'ready': '–ì–æ—Ç–æ–≤',
                'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω',
                'cancelled': '–û—Ç–º–µ–Ω–µ–Ω'
            };
            return statusMap[status] || status;
        }

        function refreshAll() {
            const view = state.currentView;
            switch(view) {
                case 'dashboard': loadDashboard(); break;
                case 'orders': loadOrders(); break;
                case 'products': loadProducts(); break;
                case 'stats': loadStats(); break;
                case 'settings': loadSettings(); break;
            }
            toast('–û–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        }

        // Pull-to-Refresh
        let touchStartY = 0;
        let pullDistance = 0;
        let isPulling = false;

        document.addEventListener('touchstart', (e) => {
            if (window.scrollY === 0) {
                touchStartY = e.touches[0].clientY;
                isPulling = true;
            }
        });

        document.addEventListener('touchmove', (e) => {
            if (!isPulling) return;
            pullDistance = e.touches[0].clientY - touchStartY;
            if (pullDistance > 0 && pullDistance < 120) {
                e.preventDefault();
                document.body.style.transform = `translateY(${pullDistance * 0.5}px)`;
            }
        });

        document.addEventListener('touchend', () => {
            if (pullDistance > 80) {
                refreshAll();
                if (typeof tg?.HapticFeedback !== 'undefined') {
                    tg.HapticFeedback.impactOccurred('medium');
                }
            }
            document.body.style.transform = '';
            isPulling = false;
            pullDistance = 0;
        });

        // ============================================
        // KEYBOARD NAVIGATION - v22.0
        // ============================================
        function setupKeyboardNavigation() {
            document.addEventListener('keydown', (e) => {
                // Ignore if typing in input/textarea
                if (e.target.matches('input, textarea, select')) {
                    // ESC to blur input
                    if (e.key === 'Escape') {
                        e.target.blur();
                        haptic('light');
                    }
                    return;
                }

                // Close modal with ESC
                if (e.key === 'Escape') {
                    const modal = document.querySelector('.modal-overlay');
                    if (modal) {
                        modal.remove();
                        haptic('light');
                        e.preventDefault();
                    }
                }

                // Navigate views with Alt + Number
                if (e.altKey && !e.ctrlKey && !e.shiftKey) {
                    switch(e.key) {
                        case '1':
                            switchView('dashboard');
                            e.preventDefault();
                            break;
                        case '2':
                            switchView('products');
                            e.preventDefault();
                            break;
                        case '3':
                            switchView('stats');
                            e.preventDefault();
                            break;
                        case '4':
                            switchView('settings');
                            e.preventDefault();
                            break;
                    }
                }

                // Quick actions with Ctrl/Cmd
                if ((e.ctrlKey || e.metaKey) && !e.altKey && !e.shiftKey) {
                    switch(e.key.toLowerCase()) {
                        case 'n':
                            // New product
                            if (state.currentView === 'products') {
                                openProductModal();
                                e.preventDefault();
                            }
                            break;
                        case 'f':
                            // Focus search
                            const searchInput = document.querySelector('.search-input');
                            if (searchInput) {
                                searchInput.focus();
                                e.preventDefault();
                            }
                            break;
                        case 'r':
                            // Refresh current view
                            switch(state.currentView) {
                                case 'dashboard':
                                    loadDashboard();
                                    break;
                                case 'products':
                                    loadProducts();
                                    break;
                                case 'orders':
                                    loadOrders();
                                    break;
                                case 'stats':
                                    loadStats();
                                    break;
                            }
                            toast('–û–±–Ω–æ–≤–ª–µ–Ω–æ', 'info');
                            e.preventDefault();
                            break;
                    }
                }

                // Tab navigation enhancement
                if (e.key === 'Tab') {
                    // Let default Tab behavior work, but add visual feedback
                    const focusableElements = document.querySelectorAll(
                        'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
                    );

                    // Add keyboard-focus class to focused element
                    setTimeout(() => {
                        focusableElements.forEach(el => el.classList.remove('keyboard-focus'));
                        if (document.activeElement) {
                            document.activeElement.classList.add('keyboard-focus');
                        }
                    }, 0);
                }
            });

            // Show keyboard shortcuts hint
            const showKeyboardHints = () => {
                toast('–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏', 'info', {
                    description: 'Alt+1-4: –ù–∞–≤–∏–≥–∞—Ü–∏—è | Ctrl+N: –ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä | Ctrl+F: –ü–æ–∏—Å–∫ | Ctrl+R: –û–±–Ω–æ–≤–∏—Ç—å',
                    duration: 5000
                });
            };

            // Show hints on Ctrl+?
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                    showKeyboardHints();
                    e.preventDefault();
                }
            });

            console.log('‚å®Ô∏è Keyboard navigation enabled');
        }

        // ============================================
        // AUTO-REFRESH & NOTIFICATIONS
        // ============================================
        let autoRefreshInterval = null;
        let websocket = null;
        let wsReconnectTimeout = null;
        let wsPingInterval = null;

        function connectWebSocket() {
            // Skip if no store info yet
            if (!state.store || !state.store.store_id) {
                console.log('‚è∏Ô∏è Waiting for store info before connecting WebSocket');
                return;
            }

            const storeId = state.store.store_id;
            const { data: initData, urlUserId, urlAuthDate, urlSig } = getAuth();
            let authHeader = '';
            if (initData) {
                authHeader = `tma ${initData}`;
            } else if (urlUserId && urlAuthDate && urlSig) {
                authHeader = `tma uid=${urlUserId}&auth_date=${urlAuthDate}&sig=${urlSig}`;
            } else if (isLocalhost() && urlUserId) {
                authHeader = `tma uid=${urlUserId}`;
            } else {
                console.warn('‚ö†Ô∏è Missing Telegram authorization for WebSocket');
                return;
            }

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/partner/ws/partner/${storeId}?authorization=${encodeURIComponent(authHeader)}`;

            console.log(`üîå Connecting to WebSocket for store ${storeId}`);

            try {
                websocket = new WebSocket(wsUrl);

                websocket.onopen = () => {
                    console.log('‚úÖ WebSocket connected');
                    // Clear reconnect timeout
                    if (wsReconnectTimeout) {
                        clearTimeout(wsReconnectTimeout);
                        wsReconnectTimeout = null;
                    }
                    if (wsPingInterval) {
                        clearInterval(wsPingInterval);
                    }
                    wsPingInterval = setInterval(() => {
                        if (websocket && websocket.readyState === WebSocket.OPEN) {
                            websocket.send('ping');
                        }
                    }, 30000);
                };

                websocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('üì• WebSocket message:', data);

                        if (data.type === 'new_order') {
                            handleNewOrderNotification(data.data);
                        } else if (data.type === 'order_status_changed') {
                            handleOrderStatusChanged(data.data);
                        } else if (data.type === 'order_cancelled') {
                            handleOrderCancelled(data.data);
                        } else if (data.type === 'connected') {
                            console.log('‚úÖ WebSocket connection confirmed');
                        }
                    } catch (err) {
                        console.error('‚ùå Failed to parse WebSocket message:', err);
                    }
                };

                websocket.onerror = (error) => {
                    console.error('‚ùå WebSocket error:', error);
                };

                websocket.onclose = () => {
                    console.log('üîå WebSocket disconnected');
                    websocket = null;
                    if (wsPingInterval) {
                        clearInterval(wsPingInterval);
                        wsPingInterval = null;
                    }

                    // Reconnect after 5 seconds
                    wsReconnectTimeout = setTimeout(() => {
                        console.log('üîÑ Reconnecting WebSocket...');
                        connectWebSocket();
                    }, 5000);
                };

            } catch (error) {
                console.error('‚ùå Failed to connect WebSocket:', error);
            }
        }

        function disconnectWebSocket() {
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            if (wsReconnectTimeout) {
                clearTimeout(wsReconnectTimeout);
                wsReconnectTimeout = null;
            }
            if (wsPingInterval) {
                clearInterval(wsPingInterval);
                wsPingInterval = null;
            }
        }

        function handleNewOrderNotification(orderData) {
            console.log('üîî NEW ORDER:', orderData);

            // Play sound if supported
            try {
                if (window.Telegram?.WebApp?.HapticFeedback) {
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                }
            } catch (e) {}

            // Show toast notification
            toast(`üîî –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #${orderData.order_ids[0]}`, 'info', {
                description: `${orderData.customer_name} ‚Ä¢ ${formatPrice(orderData.total)}`
            });

            // Reload orders if on orders page
            if (state.currentView === 'orders') {
                setTimeout(() => loadOrders(), 500);
            }

            // Update badge
            updateNotificationBadge();
        }

        function handleOrderStatusChanged(data) {
            console.log('üìä Order status changed:', data);

            // Reload orders if on orders page
            if (state.currentView === 'orders') {
                setTimeout(() => loadOrders(), 500);
            }
        }

        function handleOrderCancelled(data) {
            console.log('‚ùå Order cancelled:', data);

            toast(`–ó–∞–∫–∞–∑ #${data.order_id} –æ—Ç–º–µ–Ω—ë–Ω`, 'warning');

            // Reload orders if on orders page
            if (state.currentView === 'orders') {
                setTimeout(() => loadOrders(), 500);
            }
        }

        function startAutoRefresh() {
            // Clear existing interval
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            // Auto-refresh orders every 30 seconds
            autoRefreshInterval = setInterval(() => {
                if (state.currentView === 'orders') {
                    console.log('üîÑ Auto-refreshing orders...');
                    loadOrders();
                }
            }, 30000); // 30 seconds

            console.log('‚úÖ Auto-refresh started (30s interval)');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('‚èπÔ∏è Auto-refresh stopped');
            }
        }

        function updateNotificationBadge() {
            if (!state.orders) return;

            // Count new/pending orders
            const newOrdersCount = state.orders.filter(o =>
                o.status === 'pending' || o.status === 'new'
            ).length;

            const badge = document.getElementById('notificationCount');
            if (newOrdersCount > 0) {
                badge.textContent = newOrdersCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            console.log('üöÄ Initializing Fudly Partner Panel...');

            // Initialize Telegram WebApp
            if (tg) {
                tg.ready();
                tg.expand();
                console.log('‚úÖ Telegram WebApp initialized');
            }

            // Setup keyboard navigation
            setupKeyboardNavigation();

            // Start auto-refresh for orders
            startAutoRefresh();

            // Connect WebSocket for real-time notifications
            connectWebSocket();

            // Update store info
            const { userId } = getAuth();
            document.getElementById('storeName').textContent = state.store?.name || '–ó–∞–≥—Ä—É–∑–∫–∞...';

            // Initialize icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Add haptic feedback to buttons
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.btn, .nav-item, .icon-btn, .action-btn, .product-card, .order-card');
                if (btn && typeof tg?.HapticFeedback !== 'undefined') {
                    tg.HapticFeedback.impactOccurred('light');
                }
            });

            // Smooth scroll for iOS
            if ('scrollBehavior' in document.documentElement.style) {
                document.documentElement.style.scrollBehavior = 'smooth';
            }

            // Load dashboard
            loadDashboard();

            console.log('‚úÖ App initialized successfully');
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
            disconnectWebSocket();
        });

        // Start app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>

    <!-- UX Improvements Phase 1 -->
    <script src="improvements.js"></script>
</body>
</html>
