<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fudly Partner</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Modular CSS Architecture -->
    <link rel="stylesheet" href="/partner-panel/styles/variables.css?v=16.0">
    <link rel="stylesheet" href="/partner-panel/styles/base.css?v=16.0">
    <link rel="stylesheet" href="/partner-panel/styles/header.css?v=16.0">
    <link rel="stylesheet" href="/partner-panel/styles/navigation.css?v=16.0">
    <link rel="stylesheet" href="/partner-panel/styles/buttons.css?v=16.0">
    <link rel="stylesheet" href="/partner-panel/styles/products.css?v=16.0">
    <link rel="stylesheet" href="/partner-panel/styles/main.css?v=16.0">
    <link rel="stylesheet" href="/partner-panel/styles/utilities.css?v=16.0">
    <link rel="stylesheet" href="/partner-panel/styles/states.css?v=16.0">
    <link rel="stylesheet" href="/partner-panel/styles/design-fixes.css?v=17.0">

    <style>
        /* Yandex.Lavka Style + Telegram WebApp Optimizations */
        :root {
            /* Telegram safe areas */
            --safe-area-top: env(safe-area-inset-top, 0);
            --safe-area-bottom: env(safe-area-inset-bottom, 0);
            --header-height: 56px;
            --nav-height: 56px;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            background: #F7F7F7 !important;
            color: #000000 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            overscroll-behavior-y: contain;
            overflow-x: hidden;
        }

        .app-header {
            background: #FFFFFF !important;
            border-bottom: 1px solid #E8E8E8 !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06) !important;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            padding-top: var(--safe-area-top);
            z-index: 100;
        }

        .bottom-nav {
            padding-bottom: calc(var(--safe-area-bottom) + 8px) !important;
            height: calc(var(--nav-height) + var(--safe-area-bottom)) !important;
        }

        main {
            padding-top: calc(var(--header-height) + 16px) !important;
            padding-bottom: calc(var(--nav-height) + var(--safe-area-bottom) + 16px) !important;
        }
        /* Preload animation */
        @keyframes shimmerPreload {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #FAFBFC 0%, #EEF2FF 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeOut 0.5s ease-out 1s forwards;
        }
        @keyframes fadeOut {
            to { opacity: 0; visibility: hidden; }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
        }

        .order-detail-section {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .order-detail-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .order-detail-section h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .order-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: var(--primary);
            color: white;
            font-size: 11px;
            font-weight: 700;
            border-radius: 10px;
            margin-left: 6px;
        }

        .badge-discount {
            padding: 4px 8px;
            background: linear-gradient(135deg, var(--danger), #DC2626);
            color: white;
            font-size: 11px;
            font-weight: 700;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="store-info">
                <div class="store-avatar">
                    <i data-lucide="store" style="width: 24px; height: 24px;"></i>
                </div>
                <div class="store-details">
                    <h1 id="storeName">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                    <div class="store-status">
                        <div class="status-dot"></div>
                        <span>–û—Ç–∫—Ä—ã—Ç–æ</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="refreshAll()">
                    <i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i>
                </button>
                <button class="icon-btn">
                    <i data-lucide="bell" style="width: 20px; height: 20px;"></i>
                    <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Container -->
    <main class="content" style="padding-top: 80px; padding-bottom: 80px; min-height: 100vh;">
        <div class="loading">
            <div class="spinner"></div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchView('dashboard')">
            <span class="nav-icon"><i data-lucide="home"></i></span>
            <span>–ì–ª–∞–≤–Ω–∞—è</span>
        </button>
        <button class="nav-item" onclick="switchView('products')">
            <span class="nav-icon"><i data-lucide="package"></i></span>
            <span>–¢–æ–≤–∞—Ä—ã</span>
        </button>
        <button class="nav-item" onclick="switchView('stats')">
            <span class="nav-icon"><i data-lucide="bar-chart-3"></i></span>
            <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
        </button>
        <button class="nav-item" onclick="switchView('settings')">
            <span class="nav-icon"><i data-lucide="settings"></i></span>
            <span>–ï—â–µ</span>
        </button>
    </nav>

    <!-- Main Application JavaScript -->
    <script>
        // ============================================
        // GLOBALS & STATE
        // ============================================
        const tg = window.Telegram?.WebApp;
        const API_BASE = window.location.origin;

        const state = {
            currentView: 'dashboard',
            store: null,
            products: [],
            orders: [],
            stats: null,
            loading: false
        };

        // ============================================
        // AUTH & API
        // ============================================
        function getAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('uid');

            let finalData = '';
            let source = 'none';

            if (tg?.initData && tg.initData.length > 0) {
                finalData = tg.initData;
                source = 'sdk';
            } else if (window.location.hash.slice(1) && window.location.hash.slice(1).includes('user=')) {
                finalData = window.location.hash.slice(1);
                source = 'hash';
            }

            if (urlUserId) {
                finalData = finalData ? `${finalData}&uid=${urlUserId}` : `uid=${urlUserId}`;
                source += '+url';
            }

            const tgUser = tg?.initDataUnsafe?.user;
            const userId = urlUserId || tgUser?.id || 'none';

            return { data: finalData, userId, source };
        }

        async function apiFetch(endpoint, options = {}) {
            const { data: initData } = getAuth();
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': initData ? `tma ${initData}` : '',
                ...options.headers
            };

            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            return response.json();
        }

        // ============================================
        // UI HELPERS
        // ============================================
        // HAPTIC FEEDBACK
        // ============================================
        function haptic(type = 'light') {
            if (window.Telegram?.WebApp?.HapticFeedback) {
                switch(type) {
                    case 'light':
                        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                        break;
                    case 'medium':
                        window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                        break;
                    case 'heavy':
                        window.Telegram.WebApp.HapticFeedback.impactOccurred('heavy');
                        break;
                    case 'success':
                        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                        break;
                    case 'error':
                        window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                        break;
                    case 'warning':
                        window.Telegram.WebApp.HapticFeedback.notificationOccurred('warning');
                        break;
                    case 'selection':
                        window.Telegram.WebApp.HapticFeedback.selectionChanged();
                        break;
                }
            }
        }

        function toast(message, type = 'info') {
            haptic(type === 'success' ? 'success' : type === 'error' ? 'error' : 'light');
            
            const toast = document.createElement('div');
            toast.className = `toast ${type} slide-up`;
            
            const icon = document.createElement('span');
            icon.style.fontSize = '20px';
            icon.textContent = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : type === 'warning' ? '‚ö†' : '‚Ñπ';
            
            const text = document.createElement('span');
            text.textContent = message;
            
            toast.appendChild(icon);
            toast.appendChild(text);
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'toastOut 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showLoading(type = 'default') {
            const loaders = {
                default: `<div class="loading fade-in"><div class="spinner"></div></div>`,
                dashboard: `
                    <div class="container fade-in">
                        <div class="stats-grid">
                            ${[1,2,3,4].map(() => `
                                <div class="stat-card skeleton">
                                    <div class="skeleton-line" style="width: 60%; height: 20px; margin-bottom: 12px;"></div>
                                    <div class="skeleton-line" style="width: 40%; height: 32px;"></div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="skeleton-line" style="width: 200px; height: 24px; margin: 32px 0 16px;"></div>
                        ${[1,2,3].map(() => `<div class="skeleton" style="height: 100px; margin-bottom: 16px; border-radius: 16px;"></div>`).join('')}
                    </div>
                `,
                products: `
                    <div class="container fade-in">
                        <div class="products-grid">
                            ${[1,2,3,4,5,6].map(() => `
                                <div class="product-card skeleton">
                                    <div class="skeleton" style="height: 240px;"></div>
                                    <div style="padding: 16px;">
                                        <div class="skeleton-line" style="width: 70%; height: 20px; margin-bottom: 8px;"></div>
                                        <div class="skeleton-line" style="width: 100%; height: 16px; margin-bottom: 12px;"></div>
                                        <div class="skeleton-line" style="width: 40%; height: 24px;"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `,
                stats: `
                    <div class="container fade-in">
                        <div class="skeleton" style="height: 300px; margin-bottom: 24px; border-radius: 20px;"></div>
                        <div class="stats-grid">
                            ${[1,2,3,4].map(() => `
                                <div class="stat-card skeleton">
                                    <div class="skeleton-line" style="width: 60%; height: 18px; margin-bottom: 10px;"></div>
                                    <div class="skeleton-line" style="width: 50%; height: 28px;"></div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `,
                settings: `
                    <div class="container fade-in">
                        ${[1,2,3,4,5].map(() => `
                            <div class="skeleton" style="height: 72px; margin-bottom: 12px; border-radius: 16px;"></div>
                        `).join('')}
                    </div>
                `
            };
            document.querySelector('.content').innerHTML = loaders[type] || loaders.default;
        }

        // ============================================
        // VIEW SWITCHING
        // ============================================
        function switchView(view) {
            console.log(`üìç Switching to view: ${view}`);
            haptic('selection');
            state.currentView = view;

            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event?.target?.closest('.nav-item')?.classList.add('active');

            // Smooth transition
            const content = document.querySelector('.content');
            content.classList.add('fade-out');
            
            setTimeout(() => {
                content.classList.remove('fade-out');
                
                // Load view
                switch(view) {
                    case 'dashboard':
                        loadDashboard();
                        break;
                    case 'orders':
                        loadOrders();
                        break;
                    case 'products':
                        loadProducts();
                        break;
                    case 'stats':
                        loadStats();
                        break;
                    case 'settings':
                        loadSettings();
                        break;
                }
                
                // Scroll to top smoothly
                content.scrollTo({ top: 0, behavior: 'smooth' });
            }, 150);
        }

        // ============================================
        // DASHBOARD
        // ============================================
        async function loadDashboard() {
            showLoading('dashboard');

            try {
                const [store, orders, products] = await Promise.all([
                    apiFetch('/api/partner/store'),
                    apiFetch('/api/partner/orders'),
                    apiFetch('/api/partner/products')
                ]);

                state.store = store;
                state.orders = orders;
                state.products = products;

                renderDashboard();
            } catch (error) {
                console.error('‚ùå Dashboard load error:', error);
                toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }

        function renderDashboard() {
            // Update store name in header
            if (state.store?.name) {
                document.getElementById('storeName').textContent = state.store.name;
            }

            const activeOrders = state.orders.filter(o => o.status !== 'completed' && o.status !== 'cancelled');
            const newOrders = activeOrders.filter(o => o.status === 'new');
            const preparingOrders = activeOrders.filter(o => ['preparing', 'ready'].includes(o.status));

            const todayRevenue = state.orders
                .filter(o => o.status === 'completed' && isToday(o.created_at))
                .reduce((sum, o) => sum + (o.price || 0), 0);

            const yesterdayRevenue = state.orders
                .filter(o => o.status === 'completed' && isYesterday(o.created_at))
                .reduce((sum, o) => sum + (o.price || 0), 0);

            const revenueTrend = yesterdayRevenue ? ((todayRevenue - yesterdayRevenue) / yesterdayRevenue * 100).toFixed(0) : 0;

            const currentHour = new Date().getHours();
            const greeting = currentHour < 12 ? '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ' : currentHour < 18 ? '–î–æ–±—Ä—ã–π –¥–µ–Ω—å' : '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä';
            const currentDate = new Date().toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });

            // Smart insights
            const dailyGoal = 11000;
            const goalProgress = (todayRevenue / dailyGoal * 100).toFixed(0);
            const lowStockProducts = state.products.filter(p => p.stock_quantity < 5 && p.stock_quantity > 0);
            const outOfStockProducts = state.products.filter(p => p.stock_quantity === 0);

            // Peak hours logic (11-14, 18-21)
            const isPeakHour = (currentHour >= 11 && currentHour < 14) || (currentHour >= 18 && currentHour < 21);
            const hoursUntilPeak = currentHour < 11 ? 11 - currentHour : currentHour < 18 ? 18 - currentHour : null;

            document.querySelector('.content').innerHTML = `
                <div class="container">
                    <!-- Hero Section -->
                    <div class="hero-section">
                        <div class="hero-greeting">
                            <div class="hero-text">
                                <h2>${greeting}!</h2>
                                <p>${currentDate} ‚Ä¢ ${state.store?.name || '–ú–æ–π –º–∞–≥–∞–∑–∏–Ω'}</p>
                            </div>
                            <button class="status-toggle ${state.store?.is_open ? 'open' : 'closed'}" onclick="toggleStoreStatus()">
                                <span class="status-indicator"></span>
                                ${state.store?.is_open ? '–û—Ç–∫—Ä—ã—Ç–æ' : '–ó–∞–∫—Ä—ã—Ç–æ'}
                            </button>
                        </div>

                        <!-- Smart Insights -->
                        ${hoursUntilPeak && hoursUntilPeak <= 2 ? `
                            <div class="smart-insight">
                                <div class="smart-insight-icon">üî•</div>
                                <div class="smart-insight-content">
                                    <div class="smart-insight-title">–ü–∏–∫ –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ ${hoursUntilPeak}—á</div>
                                    <div class="smart-insight-text">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</div>
                                </div>
                            </div>
                        ` : ''}

                        ${outOfStockProducts.length > 0 ? `
                            <div class="smart-insight warning">
                                <div class="smart-insight-icon">‚ö†Ô∏è</div>
                                <div class="smart-insight-content">
                                    <div class="smart-insight-title">–¢–æ–≤–∞—Ä—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å (${outOfStockProducts.length})</div>
                                    <div class="smart-insight-text">${outOfStockProducts[0]?.name || '–¢–æ–≤–∞—Ä'} –∏ –µ—â–µ ${outOfStockProducts.length - 1}</div>
                                </div>
                            </div>
                        ` : lowStockProducts.length > 0 ? `
                            <div class="smart-insight warning">
                                <div class="smart-insight-icon">üì¶</div>
                                <div class="smart-insight-content">
                                    <div class="smart-insight-title">–ù–∏–∑–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫ (${lowStockProducts.length})</div>
                                    <div class="smart-insight-text">${lowStockProducts.map(p => p.name).join(', ')}</div>
                                </div>
                            </div>
                        ` : ''}

                        ${goalProgress < 100 && todayRevenue > 0 ? `
                            <div class="goal-progress">
                                <div class="goal-header">
                                    <span class="goal-label">–¶–µ–ª—å –Ω–∞ –¥–µ–Ω—å</span>
                                    <span class="goal-values">${formatPrice(todayRevenue)} / ${formatPrice(dailyGoal)}</span>
                                </div>
                                <div class="goal-bar">
                                    <div class="goal-fill" style="width: ${Math.min(goalProgress, 100)}%"></div>
                                </div>
                            </div>
                        ` : goalProgress >= 100 ? `
                            <div class="smart-insight success">
                                <div class="smart-insight-icon">üéâ</div>
                                <div class="smart-insight-content">
                                    <div class="smart-insight-title">–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!</div>
                                    <div class="smart-insight-text">–í—ã—Ä—É—á–∫–∞ –ø—Ä–µ–≤—ã—Å–∏–ª–∞ ${formatPrice(dailyGoal)}</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Urgent Orders -->
                    ${newOrders.length > 0 ? `
                        <div class="urgent-section">
                            ${newOrders.map(order => `
                                <div class="urgent-order" onclick="viewOrderDetails(${order.order_id || order.id})">
                                    <div class="urgent-header">
                                        <h3 class="urgent-title">üîî –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #${order.order_id || order.id}</h3>
                                        <span class="urgent-badge">${formatTime(order.created_at)}</span>
                                    </div>
                                    <div style="padding-left: 16px;">
                                        <p style="margin: 0 0 4px; font-size: 14px; color: #000;">${order.order_type === 'pickup' ? 'üèÉ –°–∞–º–æ–≤—ã–≤–æ–∑' : 'üöó –î–æ—Å—Ç–∞–≤–∫–∞'} ‚Ä¢ ${formatPrice(order.price)}</p>
                                    </div>
                                    <div class="urgent-actions" onclick="event.stopPropagation()">
                                        <button class="btn btn-success" onclick="updateOrderStatus(${order.order_id || order.id}, 'preparing')">‚úì –ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑</button>
                                        <button class="btn btn-outline" onclick="cancelOrder(${order.order_id || order.id})">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card primary">
                            ${revenueTrend != 0 ? `<span class="stat-trend ${revenueTrend > 0 ? 'up' : 'down'}">
                                <i data-lucide="${revenueTrend > 0 ? 'trending-up' : 'trending-down'}"></i>
                                ${Math.abs(revenueTrend)}%
                            </span>` : ''}
                            ${todayRevenue > 0 ? `
                                <div class="stat-value">${formatPrice(todayRevenue)}</div>
                                <div class="stat-label">–í—ã—Ä—É—á–∫–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                            ` : `
                                <div class="stat-value empty-revenue">–ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ —Å–∫–æ—Ä–æ! üöÄ</div>
                                <div class="stat-hint">–ù–∞—á–Ω–∏—Ç–µ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤</div>
                            `}
                        </div>

                        <div class="stat-card success">
                            <div class="stat-value">${activeOrders.length}</div>
                            <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-value">${state.products.length}</div>
                            <div class="stat-label">–¢–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-value">4.8</div>
                            <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥</div>
                        </div>
                    </div>

                    <!-- Active Orders with Grouping -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h2>
                            <button class="btn btn-sm btn-outline" onclick="switchView('orders')">–í—Å–µ –∑–∞–∫–∞–∑—ã</button>
                        </div>

                        ${activeOrders.length > 0 ? `
                            ${newOrders.length > 0 ? `
                                <div class="order-section" id="newOrdersSection">
                                    <div class="order-section-header" onclick="toggleOrderSection('newOrdersSection')">
                                        <h3 class="order-section-title">
                                            ‚ö° –¢—Ä–µ–±—É—é—Ç –¥–µ–π—Å—Ç–≤–∏—è
                                            <span class="order-section-badge">${newOrders.length}</span>
                                        </h3>
                                        <div class="order-section-toggle">
                                            <i data-lucide="chevron-down" style="width: 16px; height: 16px;"></i>
                                        </div>
                                    </div>
                                    <div class="order-section-content">
                                        <div class="orders-list">
                                            ${newOrders.map(order => renderOrderCard(order)).join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            ${preparingOrders.length > 0 ? `
                                <div class="order-section collapsed" id="preparingOrdersSection">
                                    <div class="order-section-header" onclick="toggleOrderSection('preparingOrdersSection')">
                                        <h3 class="order-section-title">
                                            üì¶ –í —Ä–∞–±–æ—Ç–µ
                                            <span class="order-section-badge" style="background: #4A5568;">${preparingOrders.length}</span>
                                        </h3>
                                        <div class="order-section-toggle">
                                            <i data-lucide="chevron-down" style="width: 16px; height: 16px;"></i>
                                        </div>
                                    </div>
                                    <div class="order-section-content">
                                        <div class="orders-list">
                                            ${preparingOrders.map(order => renderOrderCard(order)).join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        ` : `
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i data-lucide="inbox" style="width: 48px; height: 48px; color: #C4C4C4;"></i>
                                </div>
                                <p class="empty-title">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</p>
                                <p class="empty-subtitle">–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                            </div>
                        `}
                    </div>
                </div>
            `;

            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderOrderCard(order) {
            const orderId = order.order_id || order.id;
            return `
                <div class="order-card ripple" data-order-id="${orderId}" data-status="${order.status}" onclick="haptic('light'); viewOrderDetails(${orderId})">
                    <div class="order-header">
                        <div class="order-id">#${orderId || '‚Äî'}</div>
                        <div class="order-status status-${order.status}">${getStatusText(order.status)}</div>
                    </div>
                    <div class="order-meta">
                        <span class="order-type">${order.order_type === 'pickup' ? 'üèÉ –°–∞–º–æ–≤—ã–≤–æ–∑' : 'üöó –î–æ—Å—Ç–∞–≤–∫–∞'}</span>
                    </div>
                    <div class="order-footer">
                        <div class="order-time">${formatTime(order.created_at)}</div>
                        <div class="order-total">${formatPrice(order.price)}</div>
                    </div>
                    ${order.status === 'new' ? `
                        <div class="order-actions" onclick="event.stopPropagation()">
                            <button class="btn btn-sm btn-success ripple" onclick="updateOrderStatus(${orderId}, 'preparing')">–ü—Ä–∏–Ω—è—Ç—å</button>
                            <button class="btn btn-sm btn-danger ripple" onclick="cancelOrder(${orderId})">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                        </div>
                    ` : ''}
                    ${order.status === 'preparing' ? `
                        <div class="order-actions" onclick="event.stopPropagation()">
                            <button class="btn btn-sm btn-success ripple" onclick="updateOrderStatus(${orderId}, 'ready')">–ì–æ—Ç–æ–≤</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function toggleStoreStatus() {
            // TODO: API call to toggle store status
            if (state.store) {
                state.store.is_open = !state.store.is_open;
                renderDashboard();
                toast(state.store.is_open ? '–ú–∞–≥–∞–∑–∏–Ω –æ—Ç–∫—Ä—ã—Ç' : '–ú–∞–≥–∞–∑–∏–Ω –∑–∞–∫—Ä—ã—Ç', 'success');
            }
        }

        function toggleOrderSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.toggle('collapsed');
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        }

        // ============================================
        // ORDERS
        // ============================================
        async function loadOrders() {
            showLoading();
            try {
                state.orders = await apiFetch('/api/partner/orders');
                renderOrders();
            } catch (error) {
                toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤', 'error');
            }
        }

        function renderOrders() {
            const grouped = groupOrdersByStatus(state.orders);

            document.querySelector('.content').innerHTML = `
                <div class="container">
                    <h2 class="section-title">–ó–∞–∫–∞–∑—ã</h2>

                    <div class="tabs">
                        <button class="tab active" data-status="active" onclick="filterOrderTab('active')">
                            –ê–∫—Ç–∏–≤–Ω—ã–µ <span class="badge">${grouped.active.length}</span>
                        </button>
                        <button class="tab" data-status="completed" onclick="filterOrderTab('completed')">
                            –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
                        </button>
                        <button class="tab" data-status="cancelled" onclick="filterOrderTab('cancelled')">
                            –û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ
                        </button>
                    </div>

                    <div id="ordersContainer">
                        ${renderOrdersList(grouped.active)}
                    </div>
                </div>
            `;

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function groupOrdersByStatus(orders) {
            return {
                active: orders.filter(o => ['new', 'preparing', 'ready'].includes(o.status)),
                completed: orders.filter(o => o.status === 'completed'),
                cancelled: orders.filter(o => o.status === 'cancelled')
            };
        }

        function renderOrdersList(orders) {
            if (!orders.length) {
                return `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i data-lucide="package-x" style="width: 96px; height: 96px;"></i>
                        </div>
                        <p class="empty-title">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>
                        <p class="empty-description">–ö–æ–≥–¥–∞ –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã, –æ–Ω–∏ –æ—Ç–æ–±—Ä–∞–∑—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                    </div>
                `;
            }

            return `
                <div class="orders-list">
                    ${orders.map(order => {
                        const orderId = order.order_id || order.id;
                        return `
                        <div class="order-card" onclick="viewOrderDetails(${orderId})">
                            <div class="order-header">
                                <div class="order-id">#${orderId || '‚Äî'}</div>
                                <div class="order-status status-${order.status}">${getStatusText(order.status)}</div>
                            </div>
                            <div class="order-meta">
                                <span>${order.order_type === 'pickup' ? 'üèÉ –°–∞–º–æ–≤—ã–≤–æ–∑' : 'üöó –î–æ—Å—Ç–∞–≤–∫–∞'}</span>
                                <span>${order.customer_name || ''}</span>
                            </div>
                            <div class="order-footer">
                                <span class="order-time">${formatTime(order.created_at)}</span>
                                <span class="order-total">${formatPrice(order.price)}</span>
                            </div>
                            ${order.status === 'new' ? `
                                <div class="order-actions" onclick="event.stopPropagation()">
                                    <button class="btn btn-sm btn-success" onclick="updateOrderStatus(${orderId}, 'preparing')">–ü—Ä–∏–Ω—è—Ç—å</button>
                                    <button class="btn btn-sm btn-danger" onclick="cancelOrder(${orderId})">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                                </div>
                            ` : ''}
                            ${order.status === 'preparing' ? `
                                <div class="order-actions" onclick="event.stopPropagation()">
                                    <button class="btn btn-sm btn-success" onclick="updateOrderStatus(${orderId}, 'ready')">–ì–æ—Ç–æ–≤</button>
                                </div>
                            ` : ''}
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        function filterOrderTab(status) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.status === status);
            });

            const grouped = groupOrdersByStatus(state.orders);
            const ordersMap = {
                'active': grouped.active,
                'completed': grouped.completed,
                'cancelled': grouped.cancelled
            };

            document.getElementById('ordersContainer').innerHTML = renderOrdersList(ordersMap[status]);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        async function viewOrderDetails(orderId) {
            const order = state.orders.find(o => (o.order_id || o.id) === orderId);
            if (!order) return;

            const oid = order.order_id || order.id;
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>–ó–∞–∫–∞–∑ #${oid}</h3>
                        <button class="btn-icon" onclick="this.closest('.modal-overlay').remove()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="order-status status-${order.status}" style="display: inline-block; margin-bottom: 16px;">
                            ${getStatusText(order.status)}
                        </div>

                        <div class="order-detail-section">
                            <h4>–¢–æ–≤–∞—Ä</h4>
                            <p>${order.offer_title || '–¢–æ–≤–∞—Ä'} √ó ${order.quantity || 1}</p>
                        </div>

                        <div class="order-detail-section">
                            <h4>–ö–ª–∏–µ–Ω—Ç</h4>
                            <p>${order.customer_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                            <p>${order.customer_phone || ''}</p>
                        </div>

                        <div class="order-detail-section">
                            <h4>–¢–∏–ø –∑–∞–∫–∞–∑–∞</h4>
                            <p>${order.order_type === 'pickup' ? 'üèÉ –°–∞–º–æ–≤—ã–≤–æ–∑' : 'üöó –î–æ—Å—Ç–∞–≤–∫–∞'}</p>
                            ${order.delivery_address ? `<p>${order.delivery_address}</p>` : ''}
                        </div>

                        <div class="order-detail-section" style="border-top: 2px solid var(--border); padding-top: 16px; margin-top: 16px;">
                            <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">
                                <span>–ò—Ç–æ–≥–æ</span>
                                <span>${formatPrice(order.price)}</span>
                            </div>
                        </div>

                        ${order.status !== 'completed' && order.status !== 'cancelled' ? `
                            <div style="margin-top: 24px; display: flex; gap: 12px;">
                                ${order.status === 'new' ? `
                                    <button class="btn btn-success" style="flex: 1;" onclick="updateOrderStatus(${oid}, 'preparing'); this.closest('.modal-overlay').remove();">
                                        –ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑
                                    </button>
                                ` : ''}
                                ${order.status === 'preparing' ? `
                                    <button class="btn btn-success" style="flex: 1;" onclick="updateOrderStatus(${oid}, 'ready'); this.closest('.modal-overlay').remove();">
                                        –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤
                                    </button>
                                ` : ''}
                                ${order.status === 'ready' ? `
                                    <button class="btn btn-success" style="flex: 1;" onclick="updateOrderStatus(${oid}, 'completed'); this.closest('.modal-overlay').remove();">
                                        –í—ã–¥–∞–Ω
                                    </button>
                                ` : ''}
                                <button class="btn btn-danger" onclick="cancelOrder(${oid}); this.closest('.modal-overlay').remove();">
                                    –û—Ç–º–µ–Ω–∏—Ç—å
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            if (typeof lucide !== 'undefined') lucide.createIcons();

            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                haptic('medium');

                // Optimistic UI update
                const order = state.orders.find(o => (o.order_id || o.id) === orderId);
                if (order) {
                    const oldStatus = order.status;
                    order.status = newStatus;
                    
                    // Re-render with optimistic update
                    if (state.currentView === 'orders') {
                        const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
                        if (orderCard) orderCard.classList.add('optimistic-update');
                    }
                }

                await apiFetch(`/api/partner/orders/${orderId}/status?status=${newStatus}`, {
                    method: 'POST'
                });

                haptic('success');
                toast('–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                
                // Reload to get fresh data
                if (state.currentView === 'orders') {
                    loadOrders();
                }
            } catch (error) {
                haptic('error');
                toast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞', 'error');
                
                // Revert optimistic update on error
                loadOrders();
            }
        }

        async function cancelOrder(orderId) {
            if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑?')) return;
            
            haptic('heavy');
            await updateOrderStatus(orderId, 'cancelled');
        }

        function toggleOrderSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.toggle('collapsed');
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        }

        // ============================================
        // PRODUCTS
        // ============================================
        async function loadProducts() {
            showLoading('products');
            try {
                state.products = await apiFetch('/api/partner/products');
                renderProducts();
            } catch (error) {
                toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤', 'error');
            }
        }

        function renderProducts() {
            document.querySelector('.content').innerHTML = `
                <div class="container">
                    <div class="section-header">
                        <h2 class="section-title">–¢–æ–≤–∞—Ä—ã (${state.products.length})</h2>
                        <button class="btn btn-primary" onclick="openProductModal()">
                            <i data-lucide="plus" style="width: 18px; height: 18px;"></i>
                            –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>

                    <div class="search-bar">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." oninput="searchProducts(this.value)">
                    </div>

                    <div class="products-grid" id="productsGrid">
                        ${state.products.map(product => `
                            <div class="product-card" data-product-id="${product.id}">
                                <div class="product-image">
                                    ${product.photo_url ? `
                                        <img src="${product.photo_url}" alt="${product.name}" loading="lazy" 
                                             onerror="this.parentElement.innerHTML='<div class=\\'product-placeholder\\'><i data-lucide=\\'image\\'></i><span>–ù–µ—Ç —Ñ–æ—Ç–æ</span></div>'; lucide.createIcons();">
                                    ` : `
                                        <div class="product-placeholder">
                                            <i data-lucide="image"></i>
                                            <span>–ù–µ—Ç —Ñ–æ—Ç–æ</span>
                                        </div>
                                    `}
                                    ${product.is_available ? '' : '<div class="product-overlay"><span style="color: white; font-weight: bold;">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span></div>'}
                                </div>
                                <div class="product-actions">
                                    <button class="product-action-btn ripple" onclick="editProduct(${product.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        <i data-lucide="edit"></i>
                                    </button>
                                    <button class="product-action-btn ripple" onclick="toggleProductAvailability(${product.id})" title="${product.is_available ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å'}">
                                        <i data-lucide="${product.is_available ? 'eye-off' : 'eye'}"></i>
                                    </button>
                                    <button class="product-action-btn ripple" onclick="deleteProduct(${product.id})" title="–£–¥–∞–ª–∏—Ç—å">
                                        <i data-lucide="trash-2"></i>
                                    </button>
                                </div>
                                <div class="product-info">
                                    <div class="product-header">
                                        <h3 class="product-title">${product.name}</h3>
                                        ${product.discount > 0 ? `<div class="badge-discount">-${product.discount}%</div>` : ''}
                                    </div>
                                    <p class="product-description">${product.description || ''}</p>
                                    <div class="product-meta">
                                        <div class="meta-item">
                                            <i data-lucide="package"></i>
                                            <span class="meta-value">${product.stock || 0} ${product.unit || '—à—Ç'}</span>
                                        </div>
                                        <div class="meta-item">
                                            <i data-lucide="eye"></i>
                                            <span class="meta-value">${product.views || 0}</span>
                                        </div>
                                    </div>
                                    <div class="product-footer">
                                        <div class="product-price">
                                            ${product.discount > 0 ? `<div class="price-old">${formatPrice(product.original_price)}</div>` : ''}
                                            <div class="price-current">${formatPrice(product.price)}</div>
                                        </div>
                                        <button class="product-cta" onclick="editProduct(${product.id})">
                                            <i data-lucide="edit"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('') || '<div class="empty-state"><div class="empty-icon">üì¶</div><p class="empty-title">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</p><button class="btn btn-primary" onclick="openProductModal()">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä</button></div>'}
                    </div>
                </div>
            `;

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function searchProducts(query) {
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                const title = card.querySelector('.product-title').textContent.toLowerCase();
                const match = title.includes(query.toLowerCase());
                card.style.display = match ? '' : 'none';
            });
        }

        function openProductModal(productId = null) {
            haptic('light');
            const product = productId ? state.products.find(p => p.id === productId) : null;
            const isEdit = !!product;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay scale-in';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä' : '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä'}</h3>
                        <button class="btn-icon ripple" onclick="this.closest('.modal-overlay').remove()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <form id="productForm" onsubmit="saveProduct(event, ${productId})">
                        <div class="modal-body">
                            <div class="form-group">
                                <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                                <input type="text" name="name" value="${product?.name || ''}" required class="search-input" 
                                       oninput="validateField(this)" minlength="3" maxlength="100">
                                <div class="form-error" style="display: none;">–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞</div>
                            </div>

                            <div class="form-group">
                                <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                <textarea name="description" rows="3" class="search-input" 
                                          oninput="validateField(this)" maxlength="500">${product?.description || ''}</textarea>
                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">0/500</div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="form-group">
                                    <label>–¶–µ–Ω–∞ *</label>
                                    <input type="number" name="price" value="${product?.price || ''}" required min="1" step="0.01" class="search-input"
                                           oninput="validateField(this)">
                                    <div class="form-error" style="display: none;">–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å > 0</div>
                                </div>

                                <div class="form-group">
                                    <label>–°–∫–∏–¥–∫–∞ (%)</label>
                                    <input type="number" name="discount" value="${product?.discount || 0}" min="0" max="99" class="search-input"
                                           oninput="validateField(this)">
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="form-group">
                                    <label>–û—Å—Ç–∞—Ç–æ–∫</label>
                                    <input type="number" name="stock" value="${product?.stock || 0}" min="0" class="search-input">
                                </div>

                                <div class="form-group">
                                    <label>–ï–¥–∏–Ω–∏—Ü–∞</label>
                                    <select name="unit" class="search-input">
                                        <option value="—à—Ç" ${product?.unit === '—à—Ç' ? 'selected' : ''}>—à—Ç</option>
                                        <option value="–∫–≥" ${product?.unit === '–∫–≥' ? 'selected' : ''}>–∫–≥</option>
                                        <option value="–ª" ${product?.unit === '–ª' ? 'selected' : ''}>–ª</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>URL —Ñ–æ—Ç–æ</label>
                                <input type="url" name="photo_url" value="${product?.photo_url || ''}" placeholder="https://..." class="search-input"
                                       oninput="validateField(this)">
                                <div class="form-error" style="display: none;">–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL</div>
                            </div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" name="is_available" ${product?.is_available !== false ? 'checked' : ''}>
                                    <span>–î–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–∫–∞–∑–∞</span>
                                </label>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; padding: 16px; border-top: 1px solid var(--border);">
                            <button type="submit" class="btn btn-primary ripple" style="flex: 1;">
                                ${isEdit ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'}
                            </button>
                            <button type="button" class="btn btn-secondary ripple" onclick="this.closest('.modal-overlay').remove()">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // Setup character counter for description
            const textarea = modal.querySelector('textarea[name="description"]');
            const counter = textarea.nextElementSibling;
            textarea.addEventListener('input', () => {
                counter.textContent = `${textarea.value.length}/500`;
            });
            counter.textContent = `${textarea.value.length}/500`;

            // Auto-focus first input
            setTimeout(() => modal.querySelector('input[name="name"]').focus(), 100);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    haptic('light');
                    modal.remove();
                }
            });
        }

        async function saveProduct(event, productId) {
            event.preventDefault();
            haptic('medium');

            const formData = new FormData(event.target);
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                price: parseFloat(formData.get('price')),
                discount: parseInt(formData.get('discount')) || 0,
                stock: parseInt(formData.get('stock')) || 0,
                unit: formData.get('unit'),
                photo_url: formData.get('photo_url'),
                is_available: formData.get('is_available') === 'on'
            };

            // Show loading state on submit button
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner spinner-small" style="margin: 0 auto;"></div>';

            try {
                if (productId) {
                    await apiFetch(`/api/partner/products/${productId}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    haptic('success');
                    toast('–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                } else {
                    await apiFetch('/api/partner/products', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    haptic('success');
                    toast('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                }

                document.querySelector('.modal-overlay').remove();
                loadProducts();
            } catch (error) {
                console.error('Save product error:', error);
                haptic('error');
                toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞', 'error');
                
                // Restore button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // Inline validation helper
        function validateField(input) {
            const errorDiv = input.parentElement.querySelector('.form-error');
            if (!errorDiv) return;

            let isValid = true;
            let errorMsg = '';

            // Required field
            if (input.required && !input.value) {
                isValid = false;
                errorMsg = '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ';
            }
            // Min length
            else if (input.minLength && input.value.length > 0 && input.value.length < input.minLength) {
                isValid = false;
                errorMsg = `–ú–∏–Ω–∏–º—É–º ${input.minLength} —Å–∏–º–≤–æ–ª–∞`;
            }
            // URL validation
            else if (input.type === 'url' && input.value && !input.value.match(/^https?:\/\/.+/)) {
                isValid = false;
                errorMsg = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL';
            }
            // Number validation
            else if (input.type === 'number' && input.value) {
                const num = parseFloat(input.value);
                if (input.min && num < parseFloat(input.min)) {
                    isValid = false;
                    errorMsg = `–ú–∏–Ω–∏–º—É–º ${input.min}`;
                }
                if (input.max && num > parseFloat(input.max)) {
                    isValid = false;
                    errorMsg = `–ú–∞–∫—Å–∏–º—É–º ${input.max}`;
                }
            }

            if (isValid) {
                input.classList.remove('error');
                input.classList.add('success');
                errorDiv.style.display = 'none';
            } else {
                input.classList.add('error');
                input.classList.remove('success');
                errorDiv.textContent = errorMsg;
                errorDiv.style.display = 'flex';
            }
        }

        function editProduct(id) {
            haptic('light');
            openProductModal(id);
        }

        async function toggleProductAvailability(id) {
            try {
                haptic('light');
                
                const product = state.products.find(p => p.id === id);
                if (!product) return;

                // Optimistic UI update
                product.is_available = !product.is_available;
                const card = document.querySelector(`[data-product-id="${id}"]`);
                if (card) card.classList.add('optimistic-update');

                await apiFetch(`/api/partner/products/${id}/availability`, {
                    method: 'POST',
                    body: JSON.stringify({ is_available: product.is_available })
                });

                haptic('success');
                toast(
                    product.is_available ? '–¢–æ–≤–∞—Ä –¥–æ—Å—Ç—É–ø–µ–Ω' : '–¢–æ–≤–∞—Ä —Å–∫—Ä—ã—Ç', 
                    'success'
                );
                
                if (state.currentView === 'products') {
                    loadProducts();
                }
            } catch (error) {
                haptic('error');
                toast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
                loadProducts(); // Revert on error
            }
        }

        async function deleteProduct(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;
            
            haptic('heavy');

            try {
                // Optimistic UI - fade out card
                const card = document.querySelector(`[data-product-id="${id}"]`);
                if (card) {
                    card.style.opacity = '0.5';
                    card.style.pointerEvents = 'none';
                }

                await apiFetch(`/api/partner/products/${id}`, { method: 'DELETE' });
                
                state.products = state.products.filter(p => p.id !== id);
                haptic('success');
                toast('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω', 'success');
                loadProducts();
            } catch (error) {
                haptic('error');
                toast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞', 'error');
                loadProducts(); // Restore on error
            }
        }

        // ============================================
        // STATS
        // ============================================
        async function loadStats() {
            showLoading('stats');
            
            try {
                // Simulate loading (replace with actual API call)
                await new Promise(resolve => setTimeout(resolve, 500));
                
                document.querySelector('.content').innerHTML = `
                    <div class="container fade-in">
                        <h2 class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                        
                        <div class="empty-state">
                            <div class="empty-icon">üìä</div>
                            <p class="empty-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
                            <p class="empty-subtitle">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</p>
                            <p class="empty-text">–ì—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–æ–¥–∞–∂, –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã, –≤—ã—Ä—É—á–∫–∞ –ø–æ –¥–Ω—è–º</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.querySelector('.content').innerHTML = `
                    <div class="container">
                        <div class="error-state">
                            <div class="error-icon">üö®</div>
                            <p class="error-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>
                            <p class="error-text">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</p>
                            <button class="btn btn-primary error-action ripple" onclick="loadStats()">
                                –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // ============================================
        // SETTINGS
        // ============================================
        async function loadSettings() {
            showLoading('settings');
            
            try {
                // Load fresh store data if needed
                if (!state.store) {
                    state.store = await apiFetch('/api/partner/store');
                }
                
                document.querySelector('.content').innerHTML = `
                    <div class="container fade-in">
                        <h2 class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

                        <div class="dashboard-card" style="margin-bottom: 24px;">
                            <h3 class="card-title">
                                <i data-lucide="store" class="card-icon"></i>
                                –ü—Ä–æ—Ñ–∏–ª—å –º–∞–≥–∞–∑–∏–Ω–∞
                            </h3>
                            <div class="list-item">
                                <div class="list-content">
                                    <div class="list-info">
                                        <div class="list-title">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                                        <div class="list-subtitle" id="settingsStoreName">${state.store?.name || '–ó–∞–≥—Ä—É–∑–∫–∞...'}</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-ghost ripple" onclick="editStoreProfile()">
                                    <i data-lucide="edit"></i>
                                </button>
                            </div>

                            <div class="list-item">
                                <div class="list-content">
                                    <div class="list-info">
                                        <div class="list-title">–ê–¥—Ä–µ—Å</div>
                                        <div class="list-subtitle">${state.store?.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="list-item">
                                <div class="list-content">
                                    <div class="list-info">
                                        <div class="list-title">–¢–µ–ª–µ—Ñ–æ–Ω</div>
                                        <div class="list-subtitle">${state.store?.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="list-item">
                                <div class="list-content">
                                    <div class="list-info">
                                        <div class="list-title">–°—Ç–∞—Ç—É—Å</div>
                                        <div class="list-subtitle">${state.store?.is_open ? 'üü¢ –û—Ç–∫—Ä—ã—Ç–æ' : 'üî¥ –ó–∞–∫—Ä—ã—Ç–æ'}</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm ${state.store?.is_open ? 'btn-danger' : 'btn-success'} ripple" onclick="toggleStoreStatus()">
                                    ${state.store?.is_open ? '–ó–∞–∫—Ä—ã—Ç—å' : '–û—Ç–∫—Ä—ã—Ç—å'}
                                </button>
                            </div>
                        </div>

                        <div class="dashboard-card" style="margin-bottom: 24px;">
                            <h3 class="card-title">
                                <i data-lucide="clock" class="card-icon"></i>
                                –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
                            </h3>
                            <div class="list-item">
                                <div class="list-content">
                                    <div class="list-info">
                                        <div class="list-title">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - –ü—è—Ç–Ω–∏—Ü–∞</div>
                                        <div class="list-subtitle">09:00 - 21:00</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-ghost ripple" onclick="haptic('light'); toast('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info')">
                                    <i data-lucide="edit"></i>
                                </button>
                            </div>
                            <div class="list-item">
                                <div class="list-content">
                                    <div class="list-info">
                                        <div class="list-title">–°—É–±–±–æ—Ç–∞ - –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</div>
                                        <div class="list-subtitle">10:00 - 20:00</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-card" style="margin-bottom: 24px;">
                            <h3 class="card-title">
                                <i data-lucide="truck" class="card-icon"></i>
                                –î–æ—Å—Ç–∞–≤–∫–∞
                            </h3>
                            <div class="list-item">
                                <span class="list-title">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑</span>
                                <span class="list-value">${formatPrice(state.store?.min_order || 0)}</span>
                        </div>
                        <div class="list-item">
                            <span class="list-title">–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏</span>
                            <span class="list-value">${formatPrice(state.store?.delivery_cost || 0)}</span>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="toast('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info')" style="margin-top: 12px;">
                            –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                        </button>
                    </div>

                    <div class="dashboard-card">
                        <h3 class="card-title">
                            <i data-lucide="bell" class="card-icon"></i>
                            –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                        </h3>
                        <div class="list-item">
                            <span class="list-title">–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã</span>
                            <button class="btn btn-sm btn-success ripple" onclick="haptic('light'); toast('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã', 'success')">
                                –í–∫–ª—é—á–µ–Ω–æ
                            </button>
                        </div>
                        <div class="list-item">
                            <span class="list-title">–û—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–æ–≤</span>
                            <button class="btn btn-sm btn-success ripple" onclick="haptic('light'); toast('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã', 'success')">
                                –í–∫–ª—é—á–µ–Ω–æ
                            </button>
                        </div>
                    </div>
                </div>
            `;

            if (typeof lucide !== 'undefined') lucide.createIcons();
            } catch (error) {
                document.querySelector('.content').innerHTML = `
                    <div class="container">
                        <div class="error-state">
                            <div class="error-icon">üö®</div>
                            <p class="error-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>
                            <p class="error-text">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</p>
                            <button class="btn btn-primary error-action ripple" onclick="loadSettings()">
                                –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function editStoreProfile() {
            haptic('light');
            const modal = document.createElement('div');
            modal.className = 'modal-overlay scale-in';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
                        <button class="btn-icon ripple" onclick="this.closest('.modal-overlay').remove()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <form onsubmit="saveStoreProfile(event)">
                        <div class="modal-body">
                            <div class="form-group">
                                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ *</label>
                                <input type="text" name="name" value="${state.store?.name || ''}" required class="search-input" 
                                       minlength="3" maxlength="50" oninput="validateField(this)">
                                <div class="form-error" style="display: none;">–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞</div>
                            </div>

                            <div class="form-group">
                                <label>–ê–¥—Ä–µ—Å</label>
                                <input type="text" name="address" value="${state.store?.address || ''}" class="search-input" 
                                       maxlength="200" oninput="validateField(this)">
                            </div>

                            <div class="form-group">
                                <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <input type="tel" name="phone" value="${state.store?.phone || ''}" placeholder="+998 XX XXX XX XX" 
                                       class="search-input" pattern="\+998\s?\d{2}\s?\d{3}\s?\d{2}\s?\d{2}" oninput="validateField(this)">
                                <div class="form-error" style="display: none;">–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç</div>
                            </div>

                            <div class="form-group">
                                <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                <textarea name="description" rows="3" class="search-input" maxlength="300" 
                                          oninput="validateField(this)">${state.store?.description || ''}</textarea>
                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">0/300</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; padding: 16px; border-top: 1px solid var(--border);">
                            <button type="submit" class="btn btn-primary ripple" style="flex: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // Setup character counter for description
            const textarea = modal.querySelector('textarea[name="description"]');
            const counter = textarea.nextElementSibling;
            textarea.addEventListener('input', () => {
                counter.textContent = `${textarea.value.length}/300`;
            });
            counter.textContent = `${textarea.value.length}/300`;

            // Auto-focus first input
            setTimeout(() => modal.querySelector('input[name="name"]').focus(), 100);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    haptic('light');
                    modal.remove();
                }
            });
        }

        async function saveStoreProfile(event) {
            event.preventDefault();
            haptic('medium');

            const formData = new FormData(event.target);
            const data = {
                name: formData.get('name'),
                address: formData.get('address'),
                phone: formData.get('phone'),
                description: formData.get('description')
            };

            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner spinner-small" style="margin: 0 auto;"></div>';

            try {
                await apiFetch('/api/partner/store', {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });

                // Update local state
                state.store = { ...state.store, ...data };
                document.getElementById('storeName').textContent = data.name;

                haptic('success');
                toast('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                document.querySelector('.modal-overlay').remove();
                loadSettings();
            } catch (error) {
                haptic('error');
                toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                
                // Restore button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        async function toggleStoreStatus() {
            try {
                haptic('medium');
                
                const newStatus = !state.store?.is_open;
                
                // Optimistic UI update
                const oldStatus = state.store.is_open;
                state.store.is_open = newStatus;
                
                await apiFetch('/api/partner/store', {
                    method: 'PUT',
                    body: JSON.stringify({ is_open: newStatus })
                });

                haptic('success');
                toast(newStatus ? '–ú–∞–≥–∞–∑–∏–Ω –æ—Ç–∫—Ä—ã—Ç' : '–ú–∞–≥–∞–∑–∏–Ω –∑–∞–∫—Ä—ã—Ç', 'success');
                loadSettings();
            } catch (error) {
                haptic('error');
                toast('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞', 'error');
                loadSettings(); // Revert on error
            }
        }

        // ============================================
        // HELPERS
        // ============================================
        function formatPrice(price) {
            if (price == null || price === '' || isNaN(price)) return '0 —Å—É–º';
            const num = Number(price);
            return num.toLocaleString('ru-RU') + ' —Å—É–º';
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }

        function isToday(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function isYesterday(dateString) {
            const date = new Date(dateString);
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return date.toDateString() === yesterday.toDateString();
        }

        function getStatusText(status) {
            const statusMap = {
                'new': '–ù–æ–≤—ã–π',
                'preparing': '–ì–æ—Ç–æ–≤–∏—Ç—Å—è',
                'ready': '–ì–æ—Ç–æ–≤',
                'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω',
                'cancelled': '–û—Ç–º–µ–Ω–µ–Ω'
            };
            return statusMap[status] || status;
        }

        function refreshAll() {
            const view = state.currentView;
            switch(view) {
                case 'dashboard': loadDashboard(); break;
                case 'orders': loadOrders(); break;
                case 'products': loadProducts(); break;
                case 'stats': loadStats(); break;
                case 'settings': loadSettings(); break;
            }
            toast('–û–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        }

        // Pull-to-Refresh
        let touchStartY = 0;
        let pullDistance = 0;
        let isPulling = false;

        document.addEventListener('touchstart', (e) => {
            if (window.scrollY === 0) {
                touchStartY = e.touches[0].clientY;
                isPulling = true;
            }
        });

        document.addEventListener('touchmove', (e) => {
            if (!isPulling) return;
            pullDistance = e.touches[0].clientY - touchStartY;
            if (pullDistance > 0 && pullDistance < 120) {
                e.preventDefault();
                document.body.style.transform = `translateY(${pullDistance * 0.5}px)`;
            }
        });

        document.addEventListener('touchend', () => {
            if (pullDistance > 80) {
                refreshAll();
                if (typeof tg?.HapticFeedback !== 'undefined') {
                    tg.HapticFeedback.impactOccurred('medium');
                }
            }
            document.body.style.transform = '';
            isPulling = false;
            pullDistance = 0;
        });

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            console.log('üöÄ Initializing Fudly Partner Panel...');

            // Initialize Telegram WebApp
            if (tg) {
                tg.ready();
                tg.expand();
                console.log('‚úÖ Telegram WebApp initialized');
            }

            // Update store info
            const { userId } = getAuth();
            document.getElementById('storeName').textContent = state.store?.name || '–ó–∞–≥—Ä—É–∑–∫–∞...';

            // Initialize icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Add haptic feedback to buttons
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.btn, .nav-item, .icon-btn, .action-btn, .product-card, .order-card');
                if (btn && typeof tg?.HapticFeedback !== 'undefined') {
                    tg.HapticFeedback.impactOccurred('light');
                }
            });

            // Smooth scroll for iOS
            if ('scrollBehavior' in document.documentElement.style) {
                document.documentElement.style.scrollBehavior = 'smooth';
            }

            // Load dashboard
            loadDashboard();

            console.log('‚úÖ App initialized successfully');
        }

        // Start app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>

    <!-- UX Improvements Phase 1 -->
    <script src="improvements.js"></script>
</body>
</html>
