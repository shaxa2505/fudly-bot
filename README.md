# рџЌЅпёЏ Fudly Bot - РЎРїР°СЃР°Р№С‚Рµ РµРґСѓ, СЌРєРѕРЅРѕРјСЊС‚Рµ РґРµРЅСЊРіРё

[![Railway](https://railway.app/button.svg)](https://railway.app/template/fudly-bot)

**Fudly** - СЌС‚Рѕ Telegram Р±РѕС‚-Р°РЅР°Р»РѕРі Too Good To Go РґР»СЏ РЈР·Р±РµРєРёСЃС‚Р°РЅР°. РџРѕРјРѕРіР°РµС‚ Р±РёР·РЅРµСЃСѓ РїСЂРѕРґР°РІР°С‚СЊ РµРґСѓ СЃРѕ СЃРєРёРґРєРѕР№ РґРѕ 70% РІРјРµСЃС‚Рѕ РІС‹Р±СЂР°СЃС‹РІР°РЅРёСЏ, Р° РїРѕРєСѓРїР°С‚РµР»СЏРј - СЌРєРѕРЅРѕРјРёС‚СЊ РґРµРЅСЊРіРё Рё Р·Р°Р±РѕС‚РёС‚СЊСЃСЏ РѕР± СЌРєРѕР»РѕРіРёРё.

## вљЎ Р‘С‹СЃС‚СЂС‹Р№ СЃС‚Р°СЂС‚ - 5 РјРёРЅСѓС‚

### Р’Р°СЂРёР°РЅС‚ 1: Deploy to Railway (1 РєР»РёРє)

1. РќР°Р¶РјРёС‚Рµ РєРЅРѕРїРєСѓ [![Deploy on Railway](https://railway.app/button.svg)](https://railway.app/new/template?template=https://github.com/shaxa2505/fudly-bot)

2. РџРѕР»СѓС‡РёС‚Рµ С‚РѕРєРµРЅ Р±РѕС‚Р° Сѓ [@BotFather](https://t.me/BotFather):
   ```
   /newbot в†’ РЎР»РµРґСѓР№С‚Рµ РёРЅСЃС‚СЂСѓРєС†РёСЏРј в†’ РЎРєРѕРїРёСЂСѓР№С‚Рµ С‚РѕРєРµРЅ
   ```

3. РџРѕР»СѓС‡РёС‚Рµ СЃРІРѕР№ Telegram ID Сѓ [@userinfobot](https://t.me/userinfobot):
   ```
   /start в†’ РЎРєРѕРїРёСЂСѓР№С‚Рµ ID
   ```

4. Р’СЃС‚Р°РІСЊС‚Рµ РІ Railway РїРµСЂРµРјРµРЅРЅС‹Рµ:
   - `TELEGRAM_BOT_TOKEN` - РІР°С€ С‚РѕРєРµРЅ
   - `ADMIN_ID` - РІР°С€ ID
   - `USE_WEBHOOK` - true
   - `WEBHOOK_URL` - https://your-app.railway.app

5. РЎРѕР·РґР°Р№С‚Рµ Volume РґР»СЏ Р‘Р”:
   - Storage в†’ New Volume
   - Mount Path: `/data`
   - Р”РѕР±Р°РІСЊС‚Рµ РїРµСЂРµРјРµРЅРЅСѓСЋ: `DATABASE_PATH=/data/fudly.db`

6. РќР°РїРёС€РёС‚Рµ Р±РѕС‚Сѓ `/start` РІ Telegram!

**пїЅ РџРѕРґСЂРѕР±РЅРµРµ:** [QUICK_START.md](QUICK_START.md)

### Р’Р°СЂРёР°РЅС‚ 2: Р›РѕРєР°Р»СЊРЅС‹Р№ Р·Р°РїСѓСЃРє

```bash
# РљР»РѕРЅРёСЂСѓР№С‚Рµ СЂРµРїРѕР·РёС‚РѕСЂРёР№
git clone https://github.com/shaxa2505/fudly-bot.git
cd fudly-bot

# РЈСЃС‚Р°РЅРѕРІРёС‚Рµ Р·Р°РІРёСЃРёРјРѕСЃС‚Рё
pip install -r requirements.txt

# РќР°СЃС‚СЂРѕР№С‚Рµ .env
cp .env.example .env
# РћС‚СЂРµРґР°РєС‚РёСЂСѓР№С‚Рµ .env (РґРѕР±Р°РІСЊС‚Рµ TELEGRAM_BOT_TOKEN Рё ADMIN_ID)

# Р—Р°РїСѓСЃС‚РёС‚Рµ
python bot.py
```

---

## рџЋЇ Р’РѕР·РјРѕР¶РЅРѕСЃС‚Рё

### Р”Р»СЏ РїРѕРєСѓРїР°С‚РµР»РµР№ рџ›ЌпёЏ
- вњ… РџСЂРѕСЃРјРѕС‚СЂ РґРѕСЃС‚СѓРїРЅС‹С… РїСЂРµРґР»РѕР¶РµРЅРёР№ СЃРѕ СЃРєРёРґРєРѕР№ РґРѕ 70%
- вњ… Р¤РёР»СЊС‚СЂР°С†РёСЏ РїРѕ РєР°С‚РµРіРѕСЂРёСЏРј (С…Р»РµР±, РјРѕР»РѕС‡РЅРѕРµ, РјСЏСЃРѕ Рё С‚.Рґ.)
- вњ… Р‘СЂРѕРЅРёСЂРѕРІР°РЅРёРµ С‚РѕРІР°СЂРѕРІ СЃ РєРѕРґРѕРј РїРѕР»СѓС‡РµРЅРёСЏ
- вњ… Р РµР№С‚РёРЅРіРё Рё РѕС‚Р·С‹РІС‹ РјР°РіР°Р·РёРЅРѕРІ
- вњ… РР·Р±СЂР°РЅРЅС‹Рµ РјР°РіР°Р·РёРЅС‹
- вњ… РСЃС‚РѕСЂРёСЏ Р±СЂРѕРЅРёСЂРѕРІР°РЅРёР№
- вњ… Р”РІСѓСЏР·С‹С‡РЅС‹Р№ РёРЅС‚РµСЂС„РµР№СЃ (Р СѓСЃСЃРєРёР№/РЈР·Р±РµРєСЃРєРёР№)

### Р”Р»СЏ РїР°СЂС‚РЅС‘СЂРѕРІ рџЏЄ
- вњ… РЎРѕР·РґР°РЅРёРµ РїСЂРµРґР»РѕР¶РµРЅРёР№ Р·Р° 1 РјРёРЅСѓС‚Сѓ
- вњ… РњР°СЃСЃРѕРІРѕРµ СЃРѕР·РґР°РЅРёРµ С‚РѕРІР°СЂРѕРІ
- вњ… Р—Р°РіСЂСѓР·РєР° С„РѕС‚Рѕ
- вњ… РЈРїСЂР°РІР»РµРЅРёРµ Р±СЂРѕРЅРёСЂРѕРІР°РЅРёСЏРјРё
- вњ… РџРѕРґС‚РІРµСЂР¶РґРµРЅРёРµ РІС‹РґР°С‡Рё РїРѕ РєРѕРґСѓ
- вњ… Р”РµС‚Р°Р»СЊРЅР°СЏ Р°РЅР°Р»РёС‚РёРєР°:
  - РЎС‚Р°С‚РёСЃС‚РёРєР° Р±СЂРѕРЅРёСЂРѕРІР°РЅРёР№
  - РљРѕРЅРІРµСЂСЃРёСЏ
  - РџРѕРїСѓР»СЏСЂРЅС‹Рµ РєР°С‚РµРіРѕСЂРёРё
  - РђРЅР°Р»РёР· РїРѕ РґРЅСЏРј РЅРµРґРµР»Рё
  - РЎСЂРµРґРЅРёР№ СЂРµР№С‚РёРЅРі

#### рџ–ҐпёЏ Partner Panel (Р’РµР±-РїР°РЅРµР»СЊ)

**вљ пёЏ Р’РђР–РќРћ:** РџР°РЅРµР»СЊ СЂР°Р±РѕС‚Р°РµС‚ РўРћР›Р¬РљРћ РїСЂРё РѕС‚РєСЂС‹С‚РёРё С‡РµСЂРµР· Telegram Р±РѕС‚!

**РљР°Рє РѕС‚РєСЂС‹С‚СЊ РїСЂР°РІРёР»СЊРЅРѕ:**
1. РћС‚РєСЂРѕР№С‚Рµ @fudly_bot РІ Telegram
2. Р—Р°СЂРµРіРёСЃС‚СЂРёСЂСѓР№С‚РµСЃСЊ РєР°Рє РїСЂРѕРґР°РІРµС†
3. РќР°Р¶РјРёС‚Рµ РєРЅРѕРїРєСѓ "рџ–Ґ Р’РµР±-РїР°РЅРµР»СЊ" РІ РјРµРЅСЋ
4. РџР°РЅРµР»СЊ РѕС‚РєСЂРѕРµС‚СЃСЏ СЃ РєРѕСЂСЂРµРєС‚РЅРѕР№ Р°РІС‚РѕСЂРёР·Р°С†РёРµР№

**вќЊ РќР• Р РђР‘РћРўРђР•Рў:** РџСЂСЏРјРѕРµ РѕС‚РєСЂС‹С‚РёРµ РІ Р±СЂР°СѓР·РµСЂРµ (РѕС‚СЃСѓС‚СЃС‚РІСѓРµС‚ С‚РѕРєРµРЅ Telegram WebApp)

### Р”Р»СЏ Р°РґРјРёРЅРёСЃС‚СЂР°С‚РѕСЂР° рџ‘‘
- вњ… РњРѕРґРµСЂР°С†РёСЏ РЅРѕРІС‹С… РјР°РіР°Р·РёРЅРѕРІ
- вњ… РћРґРѕР±СЂРµРЅРёРµ/РѕС‚РєР»РѕРЅРµРЅРёРµ Р·Р°СЏРІРѕРє
- вњ… РЎС‚Р°С‚РёСЃС‚РёРєР° РїРѕ РІСЃРµР№ РїР»Р°С‚С„РѕСЂРјРµ
- вњ… Р­РєСЃРїРѕСЂС‚ РґР°РЅРЅС‹С… РІ CSV
- вњ… РЈРїСЂР°РІР»РµРЅРёРµ РїРѕР»СЊР·РѕРІР°С‚РµР»СЏРјРё

---

## рџ“Љ РўРµС…РЅРѕР»РѕРіРёРё

- **Python 3.11** - СЃРѕРІСЂРµРјРµРЅРЅС‹Р№, Р±С‹СЃС‚СЂС‹Р№
- **aiogram 3.x** - Р°СЃРёРЅС…СЂРѕРЅРЅС‹Р№ Telegram Bot framework
- **PostgreSQL** - РЅР°РґС‘Р¶РЅР°СЏ РЎРЈР‘Р” СЃ Full-Text Search
- **Redis** - РєСЌС€РёСЂРѕРІР°РЅРёРµ Рё real-time СѓРІРµРґРѕРјР»РµРЅРёСЏ
- **Docker** - РєРѕРЅС‚РµР№РЅРµСЂРёР·Р°С†РёСЏ РґР»СЏ РґРµРїР»РѕСЏ
- **Railway** - РїСЂРѕСЃС‚РѕР№ РґРµРїР»РѕР№ Рё С…РѕСЃС‚РёРЅРі
- **Webhook** - РјРіРЅРѕРІРµРЅРЅР°СЏ РґРѕСЃС‚Р°РІРєР° СЃРѕРѕР±С‰РµРЅРёР№

### РћРїС‚РёРјРёР·Р°С†РёСЏ:
- рџљЂ **13 РёРЅРґРµРєСЃРѕРІ Р‘Р”** РґР»СЏ Р±С‹СЃС‚СЂС‹С… Р·Р°РїСЂРѕСЃРѕРІ
- вљЎ **Connection pooling** РґР»СЏ СЌС„С„РµРєС‚РёРІРЅРѕР№ СЂР°Р±РѕС‚С‹ СЃ Р‘Р”
- рџ”„ **Webhook РІРјРµСЃС‚Рѕ polling** РІ production
- рџ›ЎпёЏ **Р’Р°Р»РёРґР°С†РёСЏ РґР°РЅРЅС‹С…** Рё Р·Р°С‰РёС‚Р° РѕС‚ SQL injection
- рџ“Љ **Health check endpoints** РґР»СЏ РјРѕРЅРёС‚РѕСЂРёРЅРіР°
- рџ”„ **Alembic РјРёРіСЂР°С†РёРё** РґР»СЏ РІРµСЂСЃРёРѕРЅРёСЂРѕРІР°РЅРёСЏ Р‘Р”
- рџ“€ **Prometheus-style РјРµС‚СЂРёРєРё** РґР»СЏ РјРѕРЅРёС‚РѕСЂРёРЅРіР°
- рџ”Ќ **Full-Text Search** РґР»СЏ РїРѕРёСЃРєР° РЅР° СЂСѓСЃСЃРєРѕРј Рё СѓР·Р±РµРєСЃРєРѕРј
- рџ’ѕ **Redis РєСЌС€РёСЂРѕРІР°РЅРёРµ** РґР»СЏ СѓСЃРєРѕСЂРµРЅРёСЏ Р·Р°РїСЂРѕСЃРѕРІ

---

## рџђі Docker

### Р‘С‹СЃС‚СЂС‹Р№ Р·Р°РїСѓСЃРє (production):

```bash
# РЎРєРѕРїРёСЂСѓР№С‚Рµ .env.example РІ .env Рё Р·Р°РїРѕР»РЅРёС‚Рµ РїРµСЂРµРјРµРЅРЅС‹Рµ
cp .env.example .env

# Р—Р°РїСѓСЃС‚РёС‚Рµ РІСЃРµ СЃРµСЂРІРёСЃС‹
docker-compose up -d

# РџРѕСЃРјРѕС‚СЂРµС‚СЊ Р»РѕРіРё
docker-compose logs -f bot

# РћСЃС‚Р°РЅРѕРІРёС‚СЊ
docker-compose down
```

### Р Р°Р·СЂР°Р±РѕС‚РєР° (С‚РѕР»СЊРєРѕ Р‘Р” Рё Redis):

```bash
# Р—Р°РїСѓСЃС‚РёС‚Рµ С‚РѕР»СЊРєРѕ Р±Р°Р·С‹ РґР°РЅРЅС‹С…
docker-compose -f docker-compose.dev.yml up -d

# Р—Р°РїСѓСЃС‚РёС‚Рµ Р±РѕС‚ Р»РѕРєР°Р»СЊРЅРѕ
python bot.py

# Р”РѕСЃС‚СѓРї Рє РёРЅСЃС‚СЂСѓРјРµРЅС‚Р°Рј:
# - Adminer (DB): http://localhost:8081
# - Redis Commander: http://localhost:8082
```

### РџРѕР»РµР·РЅС‹Рµ РєРѕРјР°РЅРґС‹:

```bash
# РџРµСЂРµСЃР±РѕСЂРєР° РѕР±СЂР°Р·Р°
docker-compose build --no-cache

# РџРѕСЃРјРѕС‚СЂРµС‚СЊ СЃС‚Р°С‚СѓСЃ
docker-compose ps

# РџСЂРѕРІРµСЂРёС‚СЊ health
curl http://localhost:8080/health

# Р’РѕР№С‚Рё РІ РєРѕРЅС‚РµР№РЅРµСЂ
docker-compose exec bot bash

# РћС‡РёСЃС‚РёС‚СЊ РІСЃС‘
docker-compose down -v --rmi all
```

### РџРµСЂРµРјРµРЅРЅС‹Рµ РѕРєСЂСѓР¶РµРЅРёСЏ:

| РџРµСЂРµРјРµРЅРЅР°СЏ | РћРїРёСЃР°РЅРёРµ | РћР±СЏР·Р°С‚РµР»СЊРЅРѕ |
|------------|----------|-------------|
| `TELEGRAM_BOT_TOKEN` | РўРѕРєРµРЅ РѕС‚ @BotFather | вњ… |
| `ADMIN_ID` | Telegram ID Р°РґРјРёРЅРёСЃС‚СЂР°С‚РѕСЂР° | вњ… |
| `POSTGRES_PASSWORD` | РџР°СЂРѕР»СЊ PostgreSQL | вњ… |
| `USE_WEBHOOK` | Р РµР¶РёРј webhook (true/false) | вќЊ |
| `WEBHOOK_URL` | URL РґР»СЏ webhook | вќЊ |
| `LOG_LEVEL` | РЈСЂРѕРІРµРЅСЊ Р»РѕРіРѕРІ (DEBUG/INFO/WARNING) | вќЊ |
| `SENTRY_DSN` | DSN РґР»СЏ Sentry РјРѕРЅРёС‚РѕСЂРёРЅРіР° | вќЊ |

---

## рџ—„пёЏ РњРёРіСЂР°С†РёРё Р±Р°Р·С‹ РґР°РЅРЅС‹С… (Alembic)

РџСЂРѕРµРєС‚ РёСЃРїРѕР»СЊР·СѓРµС‚ Alembic РґР»СЏ РІРµСЂСЃРёРѕРЅРёСЂРѕРІР°РЅРёСЏ СЃС…РµРјС‹ Р‘Р”.

### Р‘С‹СЃС‚СЂС‹Рµ РєРѕРјР°РЅРґС‹:

```bash
# РџСЂРёРјРµРЅРёС‚СЊ РІСЃРµ РјРёРіСЂР°С†РёРё
python scripts/migrate.py upgrade

# РћС‚РєР°С‚РёС‚СЊ РїРѕСЃР»РµРґРЅСЋСЋ РјРёРіСЂР°С†РёСЋ
python scripts/migrate.py downgrade

# РџРѕРєР°Р·Р°С‚СЊ С‚РµРєСѓС‰СѓСЋ РІРµСЂСЃРёСЋ
python scripts/migrate.py current

# РџРѕРєР°Р·Р°С‚СЊ РёСЃС‚РѕСЂРёСЋ РјРёРіСЂР°С†РёР№
python scripts/migrate.py history

# РЎРѕР·РґР°С‚СЊ РЅРѕРІСѓСЋ РјРёРіСЂР°С†РёСЋ
python scripts/migrate.py new "Add new_column to users"

# РџРѕРјРµС‚РёС‚СЊ Р‘Р” РєР°Рє Р°РєС‚СѓР°Р»СЊРЅСѓСЋ (РґР»СЏ СЃСѓС‰РµСЃС‚РІСѓСЋС‰РёС… Р‘Р”)
python scripts/migrate.py stamp head
```

### Р”Р»СЏ СЃСѓС‰РµСЃС‚РІСѓСЋС‰РёС… Р±Р°Р· РґР°РЅРЅС‹С…:

Р•СЃР»Рё Сѓ РІР°СЃ СѓР¶Рµ РµСЃС‚СЊ Р±Р°Р·Р° РґР°РЅРЅС‹С…, РїСЂРѕСЃС‚Рѕ РІС‹РїРѕР»РЅРёС‚Рµ:
```bash
python scripts/migrate.py stamp head
```

Р­С‚Рѕ РїРѕРјРµС‚РёС‚ Р‘Р” РєР°Рє Р°РєС‚СѓР°Р»СЊРЅСѓСЋ Р±РµР· РІС‹РїРѕР»РЅРµРЅРёСЏ РјРёРіСЂР°С†РёР№.

### РЎРѕР·РґР°РЅРёРµ РЅРѕРІРѕР№ РјРёРіСЂР°С†РёРё:

```bash
# Р’СЂСѓС‡РЅСѓСЋ
python scripts/migrate.py new "Add delivery_address to orders"

# РЎ Р°РІС‚РѕРіРµРЅРµСЂР°С†РёРµР№ РёР· РјРѕРґРµР»РµР№ (РµСЃР»Рё РјРѕРґРµР»Рё РёР·РјРµРЅРёР»РёСЃСЊ)
python scripts/migrate.py new "Auto migration" --autogenerate
```

### РЎС‚СЂСѓРєС‚СѓСЂР° РјРёРіСЂР°С†РёР№:

```
alembic/
в”њв”Ђв”Ђ versions/           # Р¤Р°Р№Р»С‹ РјРёРіСЂР°С†РёР№
в”‚   в””в”Ђв”Ђ 001_initial_schema.py
в”њв”Ђв”Ђ models.py           # SQLAlchemy РјРѕРґРµР»Рё
в”њв”Ђв”Ђ env.py              # РљРѕРЅС„РёРіСѓСЂР°С†РёСЏ Alembic
в””в”Ђв”Ђ script.py.mako      # РЁР°Р±Р»РѕРЅ РјРёРіСЂР°С†РёР№
```

---

## рџ“Ѓ РЎС‚СЂСѓРєС‚СѓСЂР° РїСЂРѕРµРєС‚Р°

```
fudly-bot/
в”њв”Ђв”Ђ bot.py                 # Р“Р»Р°РІРЅС‹Р№ С„Р°Р№Р» Р±РѕС‚Р° (3000+ СЃС‚СЂРѕРє)
в”њв”Ђв”Ђ database.py            # Р‘Р°Р·Р° РґР°РЅРЅС‹С… СЃ РѕРїС‚РёРјРёР·Р°С†РёРµР№
в”њв”Ђв”Ђ keyboards.py           # UI РєР»Р°РІРёР°С‚СѓСЂС‹
в”њв”Ђв”Ђ localization.py        # РўРµРєСЃС‚С‹ RU/UZ
в”њв”Ђв”Ђ requirements.txt       # Р—Р°РІРёСЃРёРјРѕСЃС‚Рё
в”њв”Ђв”Ђ Procfile              # Railway deployment
в”њв”Ђв”Ђ runtime.txt           # Python РІРµСЂСЃРёСЏ
в”њв”Ђв”Ђ .env.example          # РЁР°Р±Р»РѕРЅ РЅР°СЃС‚СЂРѕРµРє
в”‚
в”њв”Ђв”Ђ QUICK_START.md        # вљЎ Р‘С‹СЃС‚СЂС‹Р№ СЃС‚Р°СЂС‚
в”њв”Ђв”Ђ RAILWAY_DEPLOY.md     # рџ“ Р”РµРїР»РѕР№ РЅР° Railway
в”њв”Ђв”Ђ CHECKLIST.md          # вњ… РўРµСЃС‚РёСЂРѕРІР°РЅРёРµ
в”њв”Ђв”Ђ SUMMARY.md            # рџ“– РџРѕР»РЅРѕРµ РѕРїРёСЃР°РЅРёРµ
в”‚
в”њв”Ђв”Ђ deploy.ps1            # рџЄџ РђРІС‚Рѕ-РґРµРїР»РѕР№ (Windows)
в””в”Ђв”Ђ deploy.sh             # рџђ§ РђРІС‚Рѕ-РґРµРїР»РѕР№ (Linux/Mac)
```

---

## вњ… РСЃРїСЂР°РІР»РµРЅРЅС‹Рµ РїСЂРѕР±Р»РµРјС‹

### 1. **РўРѕРІР°СЂ РЅРµ РёСЃС‡РµР·Р°РµС‚ РїРѕСЃР»Рµ Р±СЂРѕРЅРёСЂРѕРІР°РЅРёСЏ**
- вњ… **РСЃРїСЂР°РІР»РµРЅРѕ**: `update_offer_quantity()` С‚РµРїРµСЂСЊ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё РґРµР°РєС‚РёРІРёСЂСѓРµС‚ С‚РѕРІР°СЂ РєРѕРіРґР° `quantity = 0`
- вњ… **Р”РѕР±Р°РІР»РµРЅРѕ**: РђРІС‚РѕРјР°С‚РёС‡РµСЃРєР°СЏ СЂРµР°РєС‚РёРІР°С†РёСЏ С‚РѕРІР°СЂР° РїСЂРё РѕС‚РјРµРЅРµ Р±СЂРѕРЅРёСЂРѕРІР°РЅРёСЏ
- вњ… **Р›РѕРіРёРєР°**: РџСЂРё Р±СЂРѕРЅРёСЂРѕРІР°РЅРёРё quantity СѓРјРµРЅСЊС€Р°РµС‚СЃСЏ, РїСЂРё РѕС‚РјРµРЅРµ - СѓРІРµР»РёС‡РёРІР°РµС‚СЃСЏ

### 2. **РћС‚РєР»СЋС‡РµРЅРёРµ СѓРІРµРґРѕРјР»РµРЅРёР№ РЅРµ СЂР°Р±РѕС‚Р°Р»Рѕ**
- вњ… **РСЃРїСЂР°РІР»РµРЅРѕ**: Р”РѕР±Р°РІР»РµРЅ РѕР±СЂР°Р±РѕС‚С‡РёРє `toggle_notifications`
- вњ… **Р¤СѓРЅРєС†РёРѕРЅР°Р»**: РџРµСЂРµРєР»СЋС‡РµРЅРёРµ СѓРІРµРґРѕРјР»РµРЅРёР№ СЃ РѕР±РЅРѕРІР»РµРЅРёРµРј РєР»Р°РІРёР°С‚СѓСЂС‹ РЅР°СЃС‚СЂРѕРµРє
- вњ… **Р‘Р°Р·Р° РґР°РЅРЅС‹С…**: РњРµС‚РѕРґ `db.toggle_notifications()` СЂР°Р±РѕС‚Р°РµС‚ РєРѕСЂСЂРµРєС‚РЅРѕ

### 3. **РЈРґР°Р»РµРЅРёРµ Р°РєРєР°СѓРЅС‚Р° РЅРµ СЂР°Р±РѕС‚Р°Р»Рѕ**
- вњ… **РСЃРїСЂР°РІР»РµРЅРѕ**: Р”РѕР±Р°РІР»РµРЅС‹ 3 РѕР±СЂР°Р±РѕС‚С‡РёРєР°:
  - `delete_account` - РїРѕРєР°Р· РїСЂРµРґСѓРїСЂРµР¶РґРµРЅРёСЏ
  - `confirm_delete_yes` - РїРѕРґС‚РІРµСЂР¶РґРµРЅРёРµ СѓРґР°Р»РµРЅРёСЏ
  - `confirm_delete_no` - РѕС‚РјРµРЅР° СѓРґР°Р»РµРЅРёСЏ
- вњ… **Р‘РµР·РѕРїР°СЃРЅРѕСЃС‚СЊ**: Р”РІРѕР№РЅРѕРµ РїРѕРґС‚РІРµСЂР¶РґРµРЅРёРµ РїРµСЂРµРґ СѓРґР°Р»РµРЅРёРµРј
- вњ… **РџРѕР»РЅР°СЏ РѕС‡РёСЃС‚РєР°**: РЈРґР°Р»СЏСЋС‚СЃСЏ РІСЃРµ РґР°РЅРЅС‹Рµ РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ (РјР°РіР°Р·РёРЅС‹, С‚РѕРІР°СЂС‹, Р±СЂРѕРЅРёСЂРѕРІР°РЅРёСЏ, СЂРµР№С‚РёРЅРіРё)

### 4. **РћС€РёР±РєР° IndexError РІ "РњРѕРё Р±СЂРѕРЅРёСЂРѕРІР°РЅРёСЏ"**
- вњ… **РСЃРїСЂР°РІР»РµРЅРѕ**: РћР±РЅРѕРІР»РµРЅ SQL Р·Р°РїСЂРѕСЃ `get_user_bookings()` РґР»СЏ РІРєР»СЋС‡РµРЅРёСЏ РІСЃРµС… РЅРµРѕР±С…РѕРґРёРјС‹С… РїРѕР»РµР№
- вњ… **Р”РѕР±Р°РІР»РµРЅРѕ**: `available_until`, `city` РІ СЂРµР·СѓР»СЊС‚Р°С‚ Р·Р°РїСЂРѕСЃР°
- вњ… **РРЅРґРµРєСЃС‹**: РћР±РЅРѕРІР»РµРЅС‹ РІСЃРµ РёРЅРґРµРєСЃС‹ РІ РєРѕРґРµ РґР»СЏ СЃРѕРѕС‚РІРµС‚СЃС‚РІРёСЏ СЃС‚СЂСѓРєС‚СѓСЂРµ РґР°РЅРЅС‹С…

### 5. **РЎС‚Р°СЂС‹Р№ СЃРёРЅС‚Р°РєСЃРёСЃ aiogram 2.x**
- вњ… **РСЃРїСЂР°РІР»РµРЅРѕ**: Р—Р°РјРµРЅРµРЅ `InlineKeyboardMarkup` РЅР° `InlineKeyboardBuilder` (aiogram 3.x)
- вњ… **РЎРѕРІРјРµСЃС‚РёРјРѕСЃС‚СЊ**: Р’СЃРµ РєР»Р°РІРёР°С‚СѓСЂС‹ С‚РµРїРµСЂСЊ РёСЃРїРѕР»СЊР·СѓСЋС‚ РїСЂР°РІРёР»СЊРЅС‹Р№ СЃРёРЅС‚Р°РєСЃРёСЃ

### 6. **РћРїС‚РёРјРёР·Р°С†РёСЏ РїСЂРѕРµРєС‚Р°**
- вњ… **РЈРґР°Р»РµРЅРѕ**: 22 СЃС‚Р°СЂС‹С… С„Р°Р№Р»Р° РґРѕРєСѓРјРµРЅС‚Р°С†РёРё (~200 РљР‘)
- вњ… **РћС‡РёС‰РµРЅРѕ**: Backup С„Р°Р№Р»С‹ Рё РІСЂРµРјРµРЅРЅС‹Рµ СЃРєСЂРёРїС‚С‹
- вњ… **Р РµР·СѓР»СЊС‚Р°С‚**: РџСЂРѕРµРєС‚ СѓСЃРєРѕСЂРµРЅ Рё СѓРїСЂРѕС‰РµРЅ

## рџ“Љ РўРµРєСѓС‰РµРµ СЃРѕСЃС‚РѕСЏРЅРёРµ

### Р¤Р°Р№Р»С‹ РїСЂРѕРµРєС‚Р° (РѕСЃРЅРѕРІРЅС‹Рµ):
- `bot.py` (54 KB) - Р“Р»Р°РІРЅС‹Р№ С„Р°Р№Р» Р±РѕС‚Р°
- `database.py` (27 KB) - Р‘Р°Р·Р° РґР°РЅРЅС‹С…
- `keyboards.py` (8 KB) - РљР»Р°РІРёР°С‚СѓСЂС‹
- `localization.py` (23 KB) - РџРµСЂРµРІРѕРґС‹
- `fudly.db` (32 KB) - SQLite Р±Р°Р·Р°
- `.env` - РќР°СЃС‚СЂРѕР№РєРё (TOKEN, ADMIN_ID)

### РЎС‚Р°С‚РёСЃС‚РёРєР° Р±Р°Р·С‹:
- РџРѕР»СЊР·РѕРІР°С‚РµР»РµР№: 3
- РђРєС‚РёРІРЅС‹С… РїСЂРµРґР»РѕР¶РµРЅРёР№: 1
- Р’СЃРµРіРѕ Р±СЂРѕРЅРёСЂРѕРІР°РЅРёР№: 4

## рџЋЇ РџРѕР»РЅР°СЏ С„СѓРЅРєС†РёРѕРЅР°Р»СЊРЅРѕСЃС‚СЊ

### Р”Р»СЏ РїРѕРєСѓРїР°С‚РµР»РµР№:
- вњ… РџСЂРѕСЃРјРѕС‚СЂ РґРѕСЃС‚СѓРїРЅС‹С… РїСЂРµРґР»РѕР¶РµРЅРёР№
- вњ… Р‘СЂРѕРЅРёСЂРѕРІР°РЅРёРµ С‚РѕРІР°СЂРѕРІ
- вњ… РџСЂРѕСЃРјРѕС‚СЂ СЃРІРѕРёС… Р±СЂРѕРЅРёСЂРѕРІР°РЅРёР№
- вњ… РћС‚РјРµРЅР° Р±СЂРѕРЅРёСЂРѕРІР°РЅРёСЏ (С‚РѕРІР°СЂ РІРѕР·РІСЂР°С‰Р°РµС‚СЃСЏ)
- вњ… РЎРјРµРЅР° РіРѕСЂРѕРґР°
- вњ… РџСЂРѕС„РёР»СЊ СЃ РЅР°СЃС‚СЂРѕР№РєР°РјРё
- вњ… РћС‚РєР»СЋС‡РµРЅРёРµ СѓРІРµРґРѕРјР»РµРЅРёР№
- вњ… РЈРґР°Р»РµРЅРёРµ Р°РєРєР°СѓРЅС‚Р°

### Р”Р»СЏ РїР°СЂС‚РЅРµСЂРѕРІ:
- вњ… Р РµРіРёСЃС‚СЂР°С†РёСЏ РјР°РіР°Р·РёРЅР°
- вњ… РЎРѕР·РґР°РЅРёРµ РїСЂРµРґР»РѕР¶РµРЅРёР№
- вњ… РњР°СЃСЃРѕРІРѕРµ СЃРѕР·РґР°РЅРёРµ РїСЂРµРґР»РѕР¶РµРЅРёР№
- вњ… РџСЂРѕСЃРјРѕС‚СЂ СЃРІРѕРёС… С‚РѕРІР°СЂРѕРІ
- вњ… Р”СѓР±Р»РёСЂРѕРІР°РЅРёРµ/СѓРґР°Р»РµРЅРёРµ С‚РѕРІР°СЂРѕРІ
- вњ… РџРѕРґС‚РІРµСЂР¶РґРµРЅРёРµ РІС‹РґР°С‡Рё РїРѕ РєРѕРґСѓ
- вњ… РџСЂРѕСЃРјРѕС‚СЂ СЃС‚Р°С‚РёСЃС‚РёРєРё РјР°РіР°Р·РёРЅР°
- вњ… РџРµСЂРµРєР»СЋС‡РµРЅРёРµ РјРµР¶РґСѓ СЂРµР¶РёРјР°РјРё

### Р”Р»СЏ Р°РґРјРёРЅРѕРІ:
- вњ… РњРѕРґРµСЂР°С†РёСЏ Р·Р°СЏРІРѕРє РЅР° РїР°СЂС‚РЅРµСЂСЃС‚РІРѕ
- вњ… РЎС‚Р°С‚РёСЃС‚РёРєР° СЃРёСЃС‚РµРјС‹
- вњ… РЈРїСЂР°РІР»РµРЅРёРµ РїРѕР»СЊР·РѕРІР°С‚РµР»СЏРјРё
- вњ… Р Р°СЃСЃС‹Р»РєР° СѓРІРµРґРѕРјР»РµРЅРёР№

## рџ”§ РўРµС…РЅРёС‡РµСЃРєРёРµ СѓР»СѓС‡С€РµРЅРёСЏ

### Database.py
```python
# РђРІС‚РѕРјР°С‚РёС‡РµСЃРєРѕРµ СѓРїСЂР°РІР»РµРЅРёРµ СЃС‚Р°С‚СѓСЃРѕРј С‚РѕРІР°СЂР°
def update_offer_quantity(self, offer_id: int, new_quantity: int):
    if new_quantity <= 0:
        # Р”РµР°РєС‚РёРІР°С†РёСЏ РїСЂРё РѕРєРѕРЅС‡Р°РЅРёРё
        cursor.execute('UPDATE offers SET quantity = 0, status = ? WHERE offer_id = ?',
                      ('inactive', offer_id))
    else:
        # Р РµР°РєС‚РёРІР°С†РёСЏ РїСЂРё РІРѕР·РІСЂР°С‚Рµ
        cursor.execute('UPDATE offers SET quantity = ?, status = ? WHERE offer_id = ?',
                      (new_quantity, 'active', offer_id))
## рџ› пёЏ Standalone booking expiry worker

Р”Р»СЏ РЅР°РґС‘Р¶РЅРѕР№ СЂР°Р±РѕС‚С‹ РЅР°РїРѕРјРёРЅР°РЅРёР№ Рё Р°РІС‚Рѕ-РѕС‚РјРµРЅ (РІРЅРµ РїСЂРѕС†РµСЃСЃР° Р±РѕС‚Р°) РјРѕР¶РЅРѕ Р·Р°РїСѓСЃРєР°С‚СЊ РѕС‚РґРµР»СЊРЅС‹Р№ worker process.

1) Р—Р°РїСѓСЃРє (Р»РѕРєР°Р»СЊРЅРѕ РёР»Рё РІ РєРѕРЅС‚РµР№РЅРµСЂРµ):

```powershell
$env:TELEGRAM_BOT_TOKEN = '<your_token>'
# Р”Р»СЏ Postgres РІ staging/production
$env:DATABASE_URL = 'postgresql://user:<REDACTED>@host:port/dbname'
python scripts/run_booking_worker.py
```

2) systemd unit (РїСЂРёРјРµСЂ):

```ini
[Unit]
Description=Fudly Booking Expiry Worker
After=network.target

[Service]
User=www-data
WorkingDirectory=/opt/fudly-bot
Environment=TELEGRAM_BOT_TOKEN=your_token
Environment=DATABASE_URL=postgresql://...
ExecStart=/opt/fudly-bot/.venv/bin/python /opt/fudly-bot/scripts/run_booking_worker.py
Restart=always

[Install]
WantedBy=multi-user.target
```

3) Heroku / Procfile example:

```
worker: .venv/bin/python scripts/run_booking_worker.py
```

4) Notes:
- РЎРєСЂРёРїС‚ РёСЃРїРѕР»СЊР·СѓРµС‚ `TELEGRAM_BOT_TOKEN` РґР»СЏ РѕС‚РїСЂР°РІРєРё РЅР°РїРѕРјРёРЅР°РЅРёР№; Р±РµР· С‚РѕРєРµРЅР° worker РЅРµ СЃС‚Р°СЂС‚СѓРµС‚.
- Р”Р»СЏ Postgres СѓРєР°Р¶РёС‚Рµ `DATABASE_URL`; РёРЅР°С‡Рµ РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ Р»РѕРєР°Р»СЊРЅР°СЏ SQLite (РєР°Рє fallback).
- РЎРєСЂРёРїС‚ РєРѕСЂСЂРµРєС‚РЅРѕ Р·Р°РєСЂС‹РІР°РµС‚ DB-РїСѓР» Рё СЃРµСЃСЃРёСЋ Р±РѕС‚Р° РїСЂРё РѕСЃС‚Р°РЅРѕРІРєРµ.

```

### Bot.py
```python
# РџСЂРѕРІРµСЂРєР° СЃС‚Р°С‚СѓСЃР° РїРµСЂРµРґ РѕС‚РјРµРЅРѕР№
@dp.callback_query(F.data.startswith("cancel_booking_"))
async def cancel_booking(callback: types.CallbackQuery):
    if booking and booking[3] == 'pending':  # РўРѕР»СЊРєРѕ Р°РєС‚РёРІРЅС‹Рµ
        db.cancel_booking(booking_id)
        db.update_offer_quantity(booking[1], offer[6] + 1)  # Р’РѕР·РІСЂР°С‚ С‚РѕРІР°СЂР°
```

## рџљЂ Р—Р°РїСѓСЃРє Р±РѕС‚Р°

```powershell
# РћСЃС‚Р°РЅРѕРІРёС‚СЊ РІСЃРµ РїСЂРѕС†РµСЃСЃС‹ Python
taskkill /F /IM python.exe /T 2>$null

# Р—Р°РїСѓСЃС‚РёС‚СЊ Р±РѕС‚Р°
python bot.py
```

## рџ“ќ Р—Р°РјРµС‚РєРё

1. **Р‘СЂРѕРЅРёСЂРѕРІР°РЅРёРµ**: РўРѕРІР°СЂ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё РёСЃС‡РµР·Р°РµС‚ РєРѕРіРґР° Р·Р°РєР°РЅС‡РёРІР°РµС‚СЃСЏ Рё РїРѕСЏРІР»СЏРµС‚СЃСЏ РїСЂРё РѕС‚РјРµРЅРµ
2. **РЈРІРµРґРѕРјР»РµРЅРёСЏ**: РњРѕР¶РЅРѕ РѕС‚РєР»СЋС‡РёС‚СЊ РІ РЅР°СЃС‚СЂРѕР№РєР°С… РїСЂРѕС„РёР»СЏ
3. **РЈРґР°Р»РµРЅРёРµ**: РўСЂРµР±СѓРµС‚ РґРІРѕР№РЅРѕРіРѕ РїРѕРґС‚РІРµСЂР¶РґРµРЅРёСЏ, СѓРґР°Р»СЏРµС‚ РІСЃРµ РґР°РЅРЅС‹Рµ Р±РµР·РІРѕР·РІСЂР°С‚РЅРѕ
4. **РџСЂРѕРёР·РІРѕРґРёС‚РµР»СЊРЅРѕСЃС‚СЊ**: РџСЂРѕРµРєС‚ РѕС‡РёС‰РµРЅ РѕС‚ РјСѓСЃРѕСЂР°, СЂР°Р±РѕС‚Р°РµС‚ Р±С‹СЃС‚СЂРѕ
5. **РЎС‚Р°Р±РёР»СЊРЅРѕСЃС‚СЊ**: Р’СЃРµ РѕС€РёР±РєРё РёСЃРїСЂР°РІР»РµРЅС‹, Р±РѕС‚ СЂР°Р±РѕС‚Р°РµС‚ Р±РµР· СЃР±РѕРµРІ

---

**РџРѕСЃР»РµРґРЅРµРµ РѕР±РЅРѕРІР»РµРЅРёРµ**: 31 РѕРєС‚СЏР±СЂСЏ 2025
**Р’РµСЂСЃРёСЏ**: 3.0 (Р¤РёРЅР°Р»СЊРЅР°СЏ)
**РЎС‚Р°С‚СѓСЃ**: вњ… РџРѕР»РЅРѕСЃС‚СЊСЋ СЂР°Р±РѕС‡РёР№

---

## рџ“Ј Booking expiry worker (standalone)

We provide a standalone worker to run reminders and auto-cancel expired bookings outside the bot process. This is recommended for production to isolate background work.

Usage (Windows PowerShell):

```powershell
$env:TELEGRAM_BOT_TOKEN = '<your_token>'
$env:DATABASE_URL = '<your_database_url>'
python .\scripts\booking_expiry_worker.py
```

Behavior:
- Sends a localized reminder (RU/UZ) 1 hour before booking expiry, marks `reminder_sent` to avoid duplicates.
- Cancels bookings past `expiry_time` and returns reserved quantity to the offer atomically.

Notes:
- The bot still starts an internal worker by default, but running the standalone script is safer and recommended on production hosts.

