# üîç –ê–Ω–∞–ª–∏–∑ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL - –ü—Ä–æ–µ–∫—Ç Fudly

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 18 –¥–µ–∫–∞–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è —Å—Ö–µ–º—ã:** v22.0

---

## üìä –û–±–∑–æ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
–ü—Ä–æ–µ–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç **18 –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü**, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã—Ö –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ –≥—Ä—É–ø–ø—ã:

#### 1Ô∏è‚É£ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –º–∞–≥–∞–∑–∏–Ω—ã (Core)
- `users` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã
- `stores` - –º–∞–≥–∞–∑–∏–Ω—ã/–ø–∞—Ä—Ç–Ω—ë—Ä—ã
- `store_admins` - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–∞–≥–∞–∑–∏–Ω–æ–≤

#### 2Ô∏è‚É£ –¢–æ–≤–∞—Ä—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- `offers` - —Ç–æ–≤–∞—Ä–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- `recently_viewed` - –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤

#### 3Ô∏è‚É£ –ó–∞–∫–∞–∑—ã –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- `bookings` - –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ (—Å–∞–º–æ–≤—ã–≤–æ–∑)
- `orders` - –∑–∞–∫–∞–∑—ã —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π
- `pickup_slots` - —Å–ª–æ—Ç—ã –¥–ª—è —Å–∞–º–æ–≤—ã–≤–æ–∑–∞

#### 4Ô∏è‚É£ –ü–ª–∞—Ç–µ–∂–∏
- `payment_settings` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø–ª–∞—Ç—ã –º–∞–≥–∞–∑–∏–Ω–∞
- `store_payment_integrations` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Click/Payme

#### 5Ô∏è‚É£ –í–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å
- `ratings` - –æ—Ç–∑—ã–≤—ã –∏ –æ—Ü–µ–Ω–∫–∏
- `favorites` - –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω—ã
- `notifications` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

#### 6Ô∏è‚É£ –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥
- `promocodes` - –ø—Ä–æ–º–æ–∫–æ–¥—ã
- `promo_usage` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
- `referrals` - —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

#### 7Ô∏è‚É£ –°–∏—Å—Ç–µ–º–∞
- `fsm_states` - —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM –¥–ª—è –±–æ—Ç–∞
- `platform_settings` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- `search_history` - –∏—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞

---

## üóÇÔ∏è –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü

### üìå USERS
```sql
CREATE TABLE users (
    user_id BIGINT PRIMARY KEY,
    username TEXT,
    first_name TEXT,
    phone TEXT,
    city TEXT DEFAULT '–¢–∞—à–∫–µ–Ω—Ç',
    language TEXT DEFAULT 'ru',
    role TEXT DEFAULT 'customer',
    is_admin INTEGER DEFAULT 0,
    notifications_enabled INTEGER DEFAULT 1,
    view_mode TEXT DEFAULT 'customer',
    last_delivery_address TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ `ix_users_city` ON (city)
- ‚úÖ `ix_users_role` ON (role)
- ‚úÖ `ix_users_phone` ON (phone)

**–í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏:** –ù–µ—Ç (–∫–æ—Ä–Ω–µ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞)

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è `user_id` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç BIGINT (–¥–ª—è Telegram ID) - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚ö†Ô∏è –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –ø–æ `(role, city)` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚ùå –ü–æ–ª–µ `phone` –Ω–µ –∏–º–µ–µ—Ç UNIQUE constraint (–≤–æ–∑–º–æ–∂–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã)

---

### üìå STORES
```sql
CREATE TABLE stores (
    store_id SERIAL PRIMARY KEY,
    owner_id BIGINT REFERENCES users(user_id),
    name TEXT NOT NULL,
    city TEXT NOT NULL,
    address TEXT,
    description TEXT,
    category TEXT DEFAULT '–†–µ—Å—Ç–æ—Ä–∞–Ω',
    phone TEXT,
    photo TEXT,
    status TEXT DEFAULT 'pending',
    rejection_reason TEXT,
    business_type TEXT DEFAULT 'supermarket',
    delivery_enabled INTEGER DEFAULT 1,
    delivery_price INTEGER DEFAULT 15000,
    min_order_amount INTEGER DEFAULT 30000,
    latitude REAL,
    longitude REAL,
    rating REAL DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ `idx_stores_owner` ON (owner_id)
- ‚úÖ `idx_stores_status` ON (status)
- ‚úÖ `idx_stores_city` ON (city)
- ‚úÖ `idx_stores_city_status` ON (city, status) -- **–°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å**

**–í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏:**
- ‚úÖ `owner_id ‚Üí users(user_id)` (–±–µ–∑ CASCADE - –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–æ–π)

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –ø–æ `(city, business_type, status)` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- ‚ö†Ô∏è `rating` - –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è (–¥–æ–ª–∂–Ω–æ –≤—ã—á–∏—Å–ª—è—Ç—å—Å—è –∏–∑ ratings)
- ‚ùå `latitude/longitude` –±–µ–∑ –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è –≥–µ–æ–ø–æ–∏—Å–∫–∞ (–Ω—É–∂–µ–Ω GiST –∏–Ω–¥–µ–∫—Å)

---

### üìå OFFERS (CRITICAL)
```sql
CREATE TABLE offers (
    offer_id SERIAL PRIMARY KEY,
    store_id INTEGER REFERENCES stores(store_id),
    title TEXT NOT NULL,
    description TEXT,
    original_price INTEGER,        -- ‚úÖ v22: INTEGER (–≤ –∫–æ–ø–µ–π–∫–∞—Ö)
    discount_price INTEGER,        -- ‚úÖ v22: INTEGER (–≤ –∫–æ–ø–µ–π–∫–∞—Ö)
    quantity INTEGER DEFAULT 1,
    stock_quantity INTEGER DEFAULT 0,  -- ‚úÖ v22: –ù–æ–≤–æ–µ –ø–æ–ª–µ
    available_from TIME,           -- ‚úÖ v22: TIME –≤–º–µ—Å—Ç–æ VARCHAR
    available_until TIME,          -- ‚úÖ v22: TIME –≤–º–µ—Å—Ç–æ VARCHAR
    expiry_date DATE,              -- ‚úÖ v22: DATE –≤–º–µ—Å—Ç–æ VARCHAR
    photo_id TEXT,
    status TEXT DEFAULT 'active',
    unit TEXT DEFAULT '—à—Ç',        -- ‚úÖ v22: –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è
    category TEXT DEFAULT 'other', -- ‚úÖ v22: –ö–∞—Ç–µ–≥–æ—Ä–∏—è
    search_vector TSVECTOR,        -- ‚úÖ Full-text search
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ `idx_offers_store` ON (store_id)
- ‚úÖ `idx_offers_status` ON (status)
- ‚úÖ `idx_offers_category` ON (category) -- ‚úÖ v22
- ‚úÖ `idx_offers_unit` ON (unit) -- ‚úÖ v22
- ‚úÖ `idx_offers_stock` ON (stock_quantity) -- ‚úÖ v22
- ‚úÖ `idx_offers_status_store` ON (status, store_id)
- ‚úÖ `idx_offers_category_status` ON (category, status) -- ‚úÖ v22
- ‚úÖ `idx_offers_expiry` ON (expiry_date)
- ‚úÖ `idx_offers_search` ON USING GIN(search_vector) -- FTS –∏–Ω–¥–µ–∫—Å

**–í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏:**
- ‚úÖ `store_id ‚Üí stores(store_id) ON DELETE CASCADE` (–º–∏–≥—Ä–∞—Ü–∏—è 009)

**Constraints:**
- ‚úÖ `check_valid_category` - –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: bakery, dairy, meat, fruits, vegetables, drinks, snacks, frozen, other
- ‚úÖ `check_valid_unit` - –µ–¥–∏–Ω–∏—Ü—ã: —à—Ç, –∫–≥, –ª, –≥, –º–ª, —É–ø–∞–∫
- ‚úÖ `check_stock_non_negative` - stock_quantity >= 0
- ‚úÖ `check_prices_positive` - —Ü–µ–Ω—ã >= 0

**Full-Text Search:**
```sql
-- –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è search_vector
CREATE TRIGGER offers_search_vector_trigger
BEFORE INSERT OR UPDATE OF title, description, category
ON offers
FOR EACH ROW
EXECUTE FUNCTION offers_search_vector_update();
```

**–ú–∏–≥—Ä–∞—Ü–∏–∏ v22:**
- ‚úÖ –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö (TIME, DATE, INTEGER)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `stock_quantity`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –∏ –µ–¥–∏–Ω–∏—Ü–∞–º
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã CHECK constraints

---

### üìå BOOKINGS
```sql
CREATE TABLE bookings (
    booking_id SERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(user_id),
    offer_id INTEGER REFERENCES offers(offer_id) ON DELETE SET NULL,
    store_id INTEGER REFERENCES stores(store_id) ON DELETE CASCADE,
    quantity INTEGER DEFAULT 1,
    booking_code TEXT,
    pickup_time TEXT,
    pickup_address TEXT,
    status TEXT DEFAULT 'active',
    delivery_option INTEGER DEFAULT 0,
    delivery_address TEXT,
    delivery_cost INTEGER DEFAULT 0,
    expiry_time TIMESTAMP,
    reminder_sent INTEGER DEFAULT 0,
    payment_proof_photo_id TEXT,
    cart_items JSONB,
    is_cart_booking INTEGER DEFAULT 0,
    customer_message_id BIGINT,
    seller_message_id BIGINT,
    rating_reminder_sent BOOLEAN DEFAULT false,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ `idx_bookings_user` ON (user_id)
- ‚úÖ `idx_bookings_store` ON (store_id)
- ‚úÖ `idx_bookings_offer` ON (offer_id)
- ‚úÖ `idx_bookings_status` ON (status)
- ‚úÖ `idx_bookings_code` ON (booking_code)
- ‚úÖ `idx_bookings_created` ON (created_at DESC)
- ‚úÖ `idx_bookings_partner_reminder` ON (status, partner_reminder_sent, created_at) WHERE status='pending'

**–í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏:**
- ‚úÖ `user_id ‚Üí users(user_id)`
- ‚úÖ `offer_id ‚Üí offers(offer_id) ON DELETE SET NULL` (–º–∏–≥—Ä–∞—Ü–∏—è 009)
- ‚úÖ `store_id ‚Üí stores(store_id) ON DELETE CASCADE` (–º–∏–≥—Ä–∞—Ü–∏—è 009)

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –ø–æ `(user_id, status)` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
- ‚ö†Ô∏è `expiry_time` - –Ω—É–∂–µ–Ω –∏–Ω–¥–µ–∫—Å –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- ‚ö†Ô∏è `cart_items` JSONB - –Ω–µ—Ç GIN –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É

---

### üìå ORDERS
```sql
CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(user_id),
    offer_id INTEGER REFERENCES offers(offer_id) ON DELETE SET NULL,
    store_id INTEGER REFERENCES stores(store_id) ON DELETE CASCADE,
    delivery_address TEXT,
    payment_method TEXT DEFAULT 'card',
    payment_status TEXT DEFAULT 'pending',
    payment_proof_photo_id TEXT,
    order_status TEXT DEFAULT 'pending',
    order_type TEXT DEFAULT 'delivery',
    quantity INTEGER DEFAULT 1,
    total_price REAL,
    pickup_code TEXT,
    cart_items JSONB,
    is_cart_order INTEGER DEFAULT 0,
    customer_message_id BIGINT,
    seller_message_id BIGINT,
    rating_reminder_sent BOOLEAN DEFAULT false,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    cancel_reason VARCHAR(50),      -- ‚úÖ v22: –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã
    cancel_comment TEXT,             -- ‚úÖ v22: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ—Ç–º–µ–Ω–µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ `idx_orders_user` ON (user_id)
- ‚úÖ `idx_orders_store` ON (store_id)
- ‚úÖ `idx_orders_status` ON (order_status)
- ‚úÖ `idx_orders_created` ON (created_at DESC)
- ‚úÖ `idx_orders_cancel_reason` ON (cancel_reason) -- ‚úÖ v22

**–í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏:**
- ‚úÖ `user_id ‚Üí users(user_id)`
- ‚úÖ `offer_id ‚Üí offers(offer_id) ON DELETE SET NULL` (–º–∏–≥—Ä–∞—Ü–∏—è 009)
- ‚úÖ `store_id ‚Üí stores(store_id) ON DELETE CASCADE` (–º–∏–≥—Ä–∞—Ü–∏—è 009)

**Constraints:**
- ‚úÖ `check_valid_cancel_reason` - –ø—Ä–∏—á–∏–Ω—ã: out_of_stock, cant_fulfill, customer_request, technical_issue, other

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è `total_price` - —Ç–∏–ø REAL –≤–º–µ—Å—Ç–æ INTEGER (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –∫–æ–ø–µ–π–∫–∞—Ö)
- ‚ö†Ô∏è –ù–µ—Ç —Å–æ—Å—Ç–∞–≤–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ `(store_id, order_status, created_at)` –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø–∞–Ω–µ–ª–∏
- ‚ö†Ô∏è –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –ø–æ `(user_id, order_status)` –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤

---

### üìå RATINGS
```sql
CREATE TABLE ratings (
    rating_id SERIAL PRIMARY KEY,
    booking_id INTEGER REFERENCES bookings(booking_id),
    user_id BIGINT REFERENCES users(user_id),
    store_id INTEGER REFERENCES stores(store_id),
    order_id INTEGER REFERENCES orders(order_id),
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ `idx_ratings_store` ON (store_id)
- ‚úÖ `idx_ratings_user` ON (user_id)

**–í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏:**
- ‚úÖ `booking_id ‚Üí bookings(booking_id)`
- ‚úÖ `user_id ‚Üí users(user_id)`
- ‚úÖ `store_id ‚Üí stores(store_id)`
- ‚úÖ `order_id ‚Üí orders(order_id)`

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç UNIQUE constraint `(user_id, booking_id)` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–∑—ã–≤–æ–≤ –Ω–∞ –æ–¥–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚ö†Ô∏è –ù–µ—Ç UNIQUE constraint `(user_id, order_id)` - –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –∑–∞–∫–∞–∑–æ–≤
- ‚ö†Ô∏è –ù–µ—Ç —Å–æ—Å—Ç–∞–≤–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ `(store_id, created_at)` –¥–ª—è –ª–µ–Ω—Ç—ã –æ—Ç–∑—ã–≤–æ–≤

---

### üìå FAVORITES
```sql
CREATE TABLE favorites (
    favorite_id SERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(user_id),
    store_id INTEGER REFERENCES stores(store_id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, store_id)
)
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ `idx_favorites_user` ON (user_id)
- ‚úÖ `idx_favorites_store` ON (store_id)
- ‚úÖ UNIQUE constraint –Ω–∞ `(user_id, store_id)`

**–í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏:**
- ‚úÖ `user_id ‚Üí users(user_id)`
- ‚úÖ `store_id ‚Üí stores(store_id) ON DELETE CASCADE` (–º–∏–≥—Ä–∞—Ü–∏—è 009)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –°—Ö–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è

---

### üìå PICKUP_SLOTS
```sql
CREATE TABLE pickup_slots (
    store_id INTEGER REFERENCES stores(store_id),
    slot_ts TEXT,  -- ‚ö†Ô∏è –î–æ–ª–∂–Ω–æ –±—ã—Ç—å TIMESTAMP!
    capacity INTEGER DEFAULT 5,
    reserved INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (store_id, slot_ts)
)
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ –°–æ—Å—Ç–∞–≤–Ω–æ–π PRIMARY KEY –Ω–∞ `(store_id, slot_ts)`
- ‚ö†Ô∏è –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –ø–æ `slot_ts` –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤

**–í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏:**
- ‚úÖ `store_id ‚Üí stores(store_id)` (–Ω–æ –±–µ–∑ CASCADE!)

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå `slot_ts` –∏–º–µ–µ—Ç —Ç–∏–ø TEXT –≤–º–µ—Å—Ç–æ TIMESTAMP - **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞**
- ‚ö†Ô∏è –ù–µ—Ç CHECK constraint `reserved <= capacity`
- ‚ö†Ô∏è –ù–µ—Ç CHECK constraint `reserved >= 0`

---

### üìå FSM_STATES
```sql
CREATE TABLE fsm_states (
    user_id BIGINT PRIMARY KEY,
    state TEXT,
    data JSONB,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**–ò–Ω–¥–µ–∫—Å—ã:** PRIMARY KEY (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –ø–æ `updated_at` –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
- ‚ö†Ô∏è `data` JSONB - –Ω–µ—Ç GIN –∏–Ω–¥–µ–∫—Å–∞ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–∏—Å–∫ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É)

---

### üìå NOTIFICATIONS
```sql
CREATE TABLE notifications (
    notification_id SERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(user_id),
    type TEXT,
    title TEXT,
    message TEXT,
    is_read INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ `idx_notifications_user` ON (user_id)
- ‚úÖ `idx_notifications_unread` ON (user_id, is_read)

**–í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏:**
- ‚úÖ `user_id ‚Üí users(user_id)`

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç —Å–æ—Å—Ç–∞–≤–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ `(user_id, created_at DESC)` –¥–ª—è –ª–µ–Ω—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- ‚ö†Ô∏è –ù–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –¥–∞—Ç–µ (–º–æ–∂–µ—Ç –≤—ã—Ä–∞—Å—Ç–∏ –¥–æ –º–∏–ª–ª–∏–æ–Ω–æ–≤ –∑–∞–ø–∏—Å–µ–π)

---

### üìå PROMOCODES & PROMO_USAGE
```sql
CREATE TABLE promocodes (
    promo_id SERIAL PRIMARY KEY,
    code TEXT UNIQUE NOT NULL,
    discount_percent INTEGER,
    discount_amount REAL,
    max_uses INTEGER DEFAULT 0,
    current_uses INTEGER DEFAULT 0,
    valid_from TIMESTAMP,
    valid_until TIMESTAMP,
    is_active INTEGER DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)

CREATE TABLE promo_usage (
    usage_id SERIAL PRIMARY KEY,
    promo_id INTEGER REFERENCES promocodes(promo_id),
    user_id BIGINT REFERENCES users(user_id),
    order_id INTEGER REFERENCES orders(order_id),
    used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ `ix_promocodes_code` ON (code)
- ‚úÖ `ix_promocodes_active` ON (is_active)
- ‚ö†Ô∏è –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –ø–æ `valid_until` –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç—ë–∫—à–∏—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è `promo_usage` –Ω–µ –∏–º–µ–µ—Ç UNIQUE constraint `(user_id, promo_id)` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
- ‚ö†Ô∏è `discount_amount` - —Ç–∏–ø REAL –≤–º–µ—Å—Ç–æ INTEGER

---

### üìå PAYMENT_SETTINGS & STORE_PAYMENT_INTEGRATIONS
```sql
CREATE TABLE payment_settings (
    store_id INTEGER PRIMARY KEY REFERENCES stores(store_id),
    card_number TEXT,
    card_holder TEXT,
    card_expiry TEXT,
    payment_instructions TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)

CREATE TABLE store_payment_integrations (
    id SERIAL PRIMARY KEY,
    store_id INTEGER NOT NULL REFERENCES stores(store_id),
    provider TEXT NOT NULL,
    merchant_id TEXT,
    service_id TEXT,
    secret_key TEXT,
    is_active INTEGER DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(store_id, provider)
)
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ PRIMARY KEY –Ω–∞ `store_id` (payment_settings)
- ‚úÖ UNIQUE –Ω–∞ `(store_id, provider)` (store_payment_integrations)

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è `secret_key` —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ - **–ø—Ä–æ–±–ª–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏** (–Ω—É–∂–Ω–æ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ)
- ‚ö†Ô∏è –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –ø–æ `(provider, is_active)` –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

---

### üìå STORE_ADMINS
```sql
CREATE TABLE store_admins (
    id SERIAL PRIMARY KEY,
    store_id INTEGER NOT NULL REFERENCES stores(store_id),
    user_id BIGINT NOT NULL REFERENCES users(user_id),
    role TEXT DEFAULT 'admin',
    added_by BIGINT REFERENCES users(user_id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(store_id, user_id)
)
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ UNIQUE –Ω–∞ `(store_id, user_id)`

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –ø–æ `user_id` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚ö†Ô∏è –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –ø–æ `store_id` –¥–ª—è —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –º–∞–≥–∞–∑–∏–Ω–∞

---

### üìå RECENTLY_VIEWED & SEARCH_HISTORY
```sql
CREATE TABLE recently_viewed (
    id SERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(user_id),
    offer_id INTEGER NOT NULL REFERENCES offers(offer_id),
    viewed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)

CREATE TABLE search_history (
    id SERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(user_id),
    query TEXT NOT NULL,
    searched_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- ‚úÖ `idx_recently_viewed_user` ON (user_id)
- ‚úÖ `idx_search_history_user` ON (user_id)

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç UNIQUE constraint `(user_id, offer_id)` –≤ `recently_viewed` - –º–æ–≥—É—Ç –±—ã—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
- ‚ö†Ô∏è –ù–µ—Ç —Å–æ—Å—Ç–∞–≤–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ `(user_id, viewed_at DESC)` –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
- ‚ö†Ô∏è –¢–∞–±–ª–∏—Ü—ã –º–æ–≥—É—Ç —Ä–∞—Å—Ç–∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ - –Ω—É–∂–Ω–∞ TTL –∏–ª–∏ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üîó –ì—Ä–∞—Ñ —Å–≤—è–∑–µ–π —Ç–∞–±–ª–∏—Ü

```
users (user_id)
  ‚îú‚îÄ‚îÄ stores.owner_id
  ‚îú‚îÄ‚îÄ bookings.user_id
  ‚îú‚îÄ‚îÄ orders.user_id
  ‚îú‚îÄ‚îÄ ratings.user_id
  ‚îú‚îÄ‚îÄ favorites.user_id
  ‚îú‚îÄ‚îÄ notifications.user_id
  ‚îú‚îÄ‚îÄ promo_usage.user_id
  ‚îú‚îÄ‚îÄ referrals.referrer_user_id
  ‚îú‚îÄ‚îÄ referrals.referred_user_id
  ‚îú‚îÄ‚îÄ recently_viewed.user_id
  ‚îú‚îÄ‚îÄ search_history.user_id
  ‚îî‚îÄ‚îÄ store_admins.user_id

stores (store_id)
  ‚îú‚îÄ‚îÄ offers.store_id ‚Üí CASCADE DELETE
  ‚îú‚îÄ‚îÄ bookings.store_id ‚Üí CASCADE DELETE
  ‚îú‚îÄ‚îÄ orders.store_id ‚Üí CASCADE DELETE
  ‚îú‚îÄ‚îÄ ratings.store_id
  ‚îú‚îÄ‚îÄ favorites.store_id ‚Üí CASCADE DELETE
  ‚îú‚îÄ‚îÄ payment_settings.store_id
  ‚îú‚îÄ‚îÄ store_payment_integrations.store_id
  ‚îú‚îÄ‚îÄ store_admins.store_id
  ‚îî‚îÄ‚îÄ pickup_slots.store_id

offers (offer_id)
  ‚îú‚îÄ‚îÄ bookings.offer_id ‚Üí SET NULL
  ‚îú‚îÄ‚îÄ orders.offer_id ‚Üí SET NULL
  ‚îî‚îÄ‚îÄ recently_viewed.offer_id

bookings (booking_id)
  ‚îî‚îÄ‚îÄ ratings.booking_id

orders (order_id)
  ‚îú‚îÄ‚îÄ ratings.order_id
  ‚îî‚îÄ‚îÄ promo_usage.order_id

promocodes (promo_id)
  ‚îî‚îÄ‚îÄ promo_usage.promo_id
```

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. N+1 Query Problems

#### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ #1: –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –≤ —Ü–∏–∫–ª–µ
**–§–∞–π–ª:** [handlers/customer/offers/browse_stores.py](handlers/customer/offers/browse_stores.py#L844)
```python
for sid in store_ids:
    store = offer_service.get_store(sid)  # ‚ùå N+1!
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –í–º–µ—Å—Ç–æ —Ü–∏–∫–ª–∞ - –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
stores = db.get_stores_by_ids(store_ids)
store_map = {s['store_id']: s for s in stores}
```

#### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ #2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
**–§–∞–π–ª:** [scripts/check_bookings.py](scripts/check_bookings.py#L79)
```python
for booking in bookings:
    user = cursor.execute("SELECT ... WHERE user_id = %s", (booking['user_id'],))  # ‚ùå N+1!
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –°–æ–±—Ä–∞—Ç—å –≤—Å–µ user_id –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞ —Ä–∞–∑
user_ids = [b['user_id'] for b in bookings]
users = cursor.execute("SELECT ... WHERE user_id IN %s", (tuple(user_ids),))
```

#### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ #3: –¶–∏–∫–ª–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
**–§–∞–π–ª:** [handlers/seller/management/offers.py](handlers/seller/management/offers.py#L282)
```python
for store in stores:
    offers = db.get_store_offers(store_id)  # ‚ùå N+1!
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
# JOIN –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
SELECT o.*, s.name as store_name 
FROM offers o 
JOIN stores s ON o.store_id = s.store_id 
WHERE s.owner_id = %s
```

---

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã

#### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã

```sql
-- 1. –î–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø–∞–Ω–µ–ª–∏ - —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
CREATE INDEX idx_orders_store_status_created 
ON orders(store_id, order_status, created_at DESC);

-- 2. –î–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CREATE INDEX idx_orders_user_status_created 
ON orders(user_id, order_status, created_at DESC);

-- 3. –î–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CREATE INDEX idx_bookings_user_status_created 
ON bookings(user_id, status, created_at DESC);

-- 4. –î–ª—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π (—Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞)
CREATE INDEX idx_bookings_expiry 
ON bookings(expiry_time) 
WHERE status IN ('active', 'pending');

-- 5. –î–ª—è –ø–æ–∏—Å–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –ø–æ —Ç–∏–ø—É –∏ –≥–æ—Ä–æ–¥—É
CREATE INDEX idx_stores_city_business_status 
ON stores(city, business_type, status);

-- 6. –î–ª—è –≥–µ–æ–ø–æ–∏—Å–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤
CREATE INDEX idx_stores_location 
ON stores USING GIST(ST_MakePoint(longitude, latitude)) 
WHERE latitude IS NOT NULL AND longitude IS NOT NULL;

-- 7. –î–ª—è –ª–µ–Ω—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
CREATE INDEX idx_notifications_user_created 
ON notifications(user_id, created_at DESC);

-- 8. –î–ª—è –ª–µ–Ω—Ç—ã –æ—Ç–∑—ã–≤–æ–≤ –º–∞–≥–∞–∑–∏–Ω–∞
CREATE INDEX idx_ratings_store_created 
ON ratings(store_id, created_at DESC);

-- 9. –î–ª—è JSONB cart_items –≤ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö –∏ –∑–∞–∫–∞–∑–∞—Ö
CREATE INDEX idx_bookings_cart_items 
ON bookings USING GIN(cart_items);

CREATE INDEX idx_orders_cart_items 
ON orders USING GIN(cart_items);

-- 10. –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –º–∞–≥–∞–∑–∏–Ω–æ–≤
CREATE INDEX idx_store_admins_user 
ON store_admins(user_id);

CREATE INDEX idx_store_admins_store 
ON store_admins(store_id);

-- 11. –î–ª—è –Ω–µ–¥–∞–≤–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
CREATE INDEX idx_recently_viewed_user_viewed 
ON recently_viewed(user_id, viewed_at DESC);

-- 12. –î–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö FSM —Å–æ—Å—Ç–æ—è–Ω–∏–π
CREATE INDEX idx_fsm_states_updated 
ON fsm_states(updated_at);

-- 13. –î–ª—è –ø–æ–∏—Å–∫–∞ –∏—Å—Ç—ë–∫—à–∏—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
CREATE INDEX idx_promocodes_valid_until 
ON promocodes(valid_until) 
WHERE is_active = 1;
```

---

### 3. –ü—Ä–æ–±–ª–µ–º—ã —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö

#### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Ç–∏–ø–æ–≤

| –¢–∞–±–ª–∏—Ü–∞ | –ü–æ–ª–µ | –¢–µ–∫—É—â–∏–π —Ç–∏–ø | –î–æ–ª–∂–µ–Ω –±—ã—Ç—å | –ü—Ä–∏—á–∏–Ω–∞ |
|---------|------|-------------|-------------|---------|
| `pickup_slots` | `slot_ts` | TEXT | TIMESTAMP | ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è |
| `orders` | `total_price` | REAL | INTEGER | ‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º, –ª—É—á—à–µ —Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–æ–ø–µ–π–∫–∞—Ö |
| `promocodes` | `discount_amount` | REAL | INTEGER | ‚ùå –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ |
| `payment_settings` | `card_number` | TEXT | ENCRYPTED | ‚ö†Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å - –Ω—É–∂–Ω–æ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ |
| `store_payment_integrations` | `secret_key` | TEXT | ENCRYPTED | ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ |

---

### 4. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (Constraints)

#### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ constraints

```sql
-- 1. –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
ALTER TABLE users 
ADD CONSTRAINT users_phone_unique 
UNIQUE (phone) 
WHERE phone IS NOT NULL;

-- 2. –û–¥–∏–Ω –æ—Ç–∑—ã–≤ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
ALTER TABLE ratings 
ADD CONSTRAINT ratings_booking_unique 
UNIQUE (user_id, booking_id) 
WHERE booking_id IS NOT NULL;

-- 3. –û–¥–∏–Ω –æ—Ç–∑—ã–≤ –Ω–∞ –∑–∞–∫–∞–∑
ALTER TABLE ratings 
ADD CONSTRAINT ratings_order_unique 
UNIQUE (user_id, order_id) 
WHERE order_id IS NOT NULL;

-- 4. –ü—Ä–æ–º–æ–∫–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
ALTER TABLE promo_usage 
ADD CONSTRAINT promo_usage_unique 
UNIQUE (user_id, promo_id);

-- 5. –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–ª–æ—Ç–æ–≤ —Å–∞–º–æ–≤—ã–≤–æ–∑–∞
ALTER TABLE pickup_slots 
ADD CONSTRAINT check_slot_capacity 
CHECK (reserved <= capacity AND reserved >= 0);

-- 6. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞
ALTER TABLE offers 
ADD CONSTRAINT check_time_order 
CHECK (available_until IS NULL OR available_from IS NULL OR available_until > available_from);

-- 7. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–Ω —Ç–æ–≤–∞—Ä–∞
ALTER TABLE offers 
ADD CONSTRAINT check_discount_valid 
CHECK (discount_price IS NULL OR original_price IS NULL OR discount_price <= original_price);

-- 8. –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥–∞
ALTER TABLE promocodes 
ADD CONSTRAINT check_promo_dates 
CHECK (valid_until IS NULL OR valid_from IS NULL OR valid_until > valid_from);

-- 9. –õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
ALTER TABLE promocodes 
ADD CONSTRAINT check_promo_usage 
CHECK (current_uses <= max_uses OR max_uses = 0);

-- 10. –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤
ALTER TABLE recently_viewed 
DROP CONSTRAINT IF EXISTS recently_viewed_unique;

ALTER TABLE recently_viewed 
ADD CONSTRAINT recently_viewed_unique 
UNIQUE (user_id, offer_id);
```

---

### 5. –ü—Ä–æ–±–ª–µ–º—ã CASCADE DELETE

#### ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ CASCADE –Ω–∞—Å—Ç—Ä–æ–µ–∫

**–ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ CASCADE:**
- ‚úÖ `offers.store_id ‚Üí stores.store_id ON DELETE CASCADE` (–º–∏–≥—Ä–∞—Ü–∏—è 009)
- ‚úÖ `orders.store_id ‚Üí stores.store_id ON DELETE CASCADE` (–º–∏–≥—Ä–∞—Ü–∏—è 009)
- ‚úÖ `bookings.store_id ‚Üí stores.store_id ON DELETE CASCADE` (–º–∏–≥—Ä–∞—Ü–∏—è 009)
- ‚úÖ `favorites.store_id ‚Üí stores.store_id ON DELETE CASCADE` (–º–∏–≥—Ä–∞—Ü–∏—è 009)

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è:**
- ‚ö†Ô∏è `stores.owner_id ‚Üí users(user_id)` - –Ω–µ—Ç CASCADE (—á—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?)
- ‚ö†Ô∏è `pickup_slots.store_id ‚Üí stores(store_id)` - –Ω–µ—Ç CASCADE
- ‚ö†Ô∏è `payment_settings.store_id ‚Üí stores(store_id)` - –Ω–µ—Ç CASCADE
- ‚ö†Ô∏è `store_payment_integrations.store_id ‚Üí stores(store_id)` - –Ω–µ—Ç CASCADE
- ‚ö†Ô∏è `store_admins.store_id ‚Üí stores(store_id)` - –Ω–µ—Ç CASCADE

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```sql
-- –î–æ–±–∞–≤–∏—Ç—å CASCADE –¥–ª—è –∑–∞–≤–∏—Å–∏–º—ã—Ö —Ç–∞–±–ª–∏—Ü
ALTER TABLE pickup_slots 
DROP CONSTRAINT IF EXISTS pickup_slots_store_id_fkey;

ALTER TABLE pickup_slots 
ADD CONSTRAINT pickup_slots_store_id_fkey 
FOREIGN KEY (store_id) REFERENCES stores(store_id) ON DELETE CASCADE;

-- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
```

---

### 6. –¢–∞–±–ª–∏—Ü—ã –±–µ–∑ PRIMARY KEY

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏–º–µ—é—Ç PRIMARY KEY

---

## üìà –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### üöÄ –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–∏–ø `pickup_slots.slot_ts`**
```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞
ALTER TABLE pickup_slots 
ALTER COLUMN slot_ts TYPE TIMESTAMP USING slot_ts::TIMESTAMP;
```

2. **–î–æ–±–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–µ–∫—Å—ã**
```sql
-- –°–º. —Å–µ–∫—Ü–∏—é "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã" –≤—ã—à–µ
```

3. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 –ø—Ä–æ–±–ª–µ–º—ã –≤ –∫–æ–¥–µ**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JOIN –≤–º–µ—Å—Ç–æ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ó–∞–≥—Ä—É–∂–∞—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–∞—Ç—á–∞–º–∏

4. **–ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**
```sql
-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pgcrypto –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
CREATE EXTENSION IF NOT EXISTS pgcrypto;

ALTER TABLE payment_settings 
ALTER COLUMN card_number TYPE BYTEA 
USING pgp_sym_encrypt(card_number, 'encryption_key');
```

---

### üîß –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏)

1. **–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü**
```sql
-- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ notifications –ø–æ –º–µ—Å—è—Ü–∞–º
CREATE TABLE notifications_partitioned (
    LIKE notifications INCLUDING ALL
) PARTITION BY RANGE (created_at);

CREATE TABLE notifications_2024_12 
PARTITION OF notifications_partitioned 
FOR VALUES FROM ('2024-12-01') TO ('2025-01-01');
```

2. **–î–æ–±–∞–≤–∏—Ç—å TTL –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü**
```sql
-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö FSM —Å–æ—Å—Ç–æ—è–Ω–∏–π (7 –¥–Ω–µ–π)
DELETE FROM fsm_states 
WHERE updated_at < NOW() - INTERVAL '7 days';

-- –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ pg_cron
```

3. **–î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ constraints**
```sql
-- –°–º. —Å–µ–∫—Ü–∏—é "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è"
```

---

### üìä –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–≤ —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞)

1. **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö**
- `orders.total_price` ‚Üí INTEGER
- `promocodes.discount_amount` ‚Üí INTEGER

2. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
```sql
-- –í–∫–ª—é—á–∏—Ç—å pg_stat_statements
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- –ê–Ω–∞–ª–∏–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
SELECT query, mean_exec_time, calls 
FROM pg_stat_statements 
ORDER BY mean_exec_time DESC 
LIMIT 20;
```

3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫**
- –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∏–≥–≥—Ä–∞–º–º–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –Ω–µ—á—ë—Ç–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
```sql
CREATE EXTENSION IF NOT EXISTS pg_trgm;

CREATE INDEX idx_stores_name_trgm 
ON stores USING GIN (name gin_trgm_ops);

CREATE INDEX idx_offers_title_trgm 
ON offers USING GIN (title gin_trgm_ops);
```

---

## üìã –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| **–í—Å–µ–≥–æ —Ç–∞–±–ª–∏—Ü** | 18 |
| **–¢–∞–±–ª–∏—Ü —Å PRIMARY KEY** | 18 (100%) ‚úÖ |
| **–¢–∞–±–ª–∏—Ü —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏** | 18 (100%) ‚úÖ |
| **–ò–Ω–¥–µ–∫—Å–æ–≤ –≤—Å–µ–≥–æ** | ~45 |
| **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤** | ~13 ‚ö†Ô∏è |
| **Foreign keys —Å CASCADE** | 6 ‚úÖ |
| **Foreign keys –±–µ–∑ CASCADE** | 8 ‚ö†Ô∏è |
| **N+1 –ø—Ä–æ–±–ª–µ–º –Ω–∞–π–¥–µ–Ω–æ** | 5+ ‚ùå |
| **–ü—Ä–æ–±–ª–µ–º —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö** | 5 ‚ùå |
| **–ü—Ä–æ–±–ª–µ–º constraints** | 10 ‚ö†Ô∏è |

---

## ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º—ã

1. ‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è v22** - –æ—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø–æ —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ (TIME, DATE, INTEGER)
2. ‚úÖ **Full-Text Search** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏
3. ‚úÖ **CASCADE DELETE** - –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–≤—è–∑–µ–π (–º–∏–≥—Ä–∞—Ü–∏—è 009)
4. ‚úÖ **–ò–Ω–¥–µ–∫—Å—ã –Ω–∞ —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª—è—Ö** - –±–∞–∑–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
5. ‚úÖ **CHECK constraints** - –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ v22 –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
6. ‚úÖ **JSONB –¥–ª—è –≥–∏–±–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö** - cart_items, fsm_states
7. ‚úÖ **–ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞** - database_pg_module —Å –º–∏–∫—Å–∏–Ω–∞–º–∏

---

## üéØ –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ –±–ª–∏–∂–∞–π—à—É—é –Ω–µ–¥–µ–ª—é

### –î–µ–Ω—å 1-2: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–∏–ø `pickup_slots.slot_ts` ‚Üí TIMESTAMP
- [ ] –î–æ–±–∞–≤–∏—Ç—å 5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ (orders, bookings, notifications)
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å 3 –æ—Å–Ω–æ–≤–Ω—ã–µ N+1 –ø—Ä–æ–±–ª–µ–º—ã

### –î–µ–Ω—å 3-4: –ò–Ω–¥–µ–∫—Å—ã –∏ constraints
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã
- [ ] –î–æ–±–∞–≤–∏—Ç—å UNIQUE constraints (ratings, promo_usage, recently_viewed)
- [ ] –î–æ–±–∞–≤–∏—Ç—å CHECK constraints (pickup_slots, offers, promocodes)

### –î–µ–Ω—å 5: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- [ ] –ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (card_number, secret_key)
- [ ] –î–æ–±–∞–≤–∏—Ç—å CASCADE –¥–ª—è pickup_slots, payment_settings

### –î–µ–Ω—å 6-7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ staging
- [ ] –í–∫–ª—é—á–∏—Ç—å pg_stat_statements
- [ ] –ò–∑–º–µ—Ä–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Fudly –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ **—Ö–æ—Ä–æ—à–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏** –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ v22, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç **–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏** –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:

- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º:** 10 (—Ç—Ä–µ–±—É—é—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
- **–°—Ä–µ–¥–Ω–∏—Ö –ø—Ä–æ–±–ª–µ–º:** 15 (–º–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏)
- **–ú–µ–ª–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º:** 20+ (–∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø—Ä–∞–≤–∏—Ç—å N+1 –ø—Ä–æ–±–ª–µ–º—ã –∏ –¥–æ–±–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–µ–∫—Å—ã, –∑–∞—Ç–µ–º –∑–∞–Ω—è—Ç—å—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ constraints.

---

**–ê–≤—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∞:** GitHub Copilot  
**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:** PostgreSQL 14+, pg_stat_statements, explain analyze
