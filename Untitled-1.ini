Findings (P0/P1)

P0 Дублирующиеся админ‑хендлеры подтверждения/отклонения оплаты: admin_confirm_payment_* и admin_reject_payment_* определены одновременно в delivery_orders.py (line 47)/delivery_orders.py (line 134) и delivery_admin.py (line 46)/delivery_admin.py (line 277), при этом оба роутера активны (router.py, bot.py (line 556), bot.py (line 561)). Риск: двойная смена статуса/двойные уведомления/несогласованные ветки. Фикс: оставить один модуль (лучше админский), второй удалить или поменять callback_data, плюс единая проверка admin‑прав.
P1 Дубли toggle_notifications: features.py (line 210) и profile.py (line 513) одновременно активны (bot.py (line 518), bot.py (line 553)). Риск: двойной toggle ⇒ состояние “вернулось обратно” + сообщение не совпадает. Фикс: оставить один хендлер, второй заменить на вызов общего сервиса.
P1 Дубли избранного (и показ, и add/remove): features.py (line 112)/features.py (line 173)/features.py (line 193) и favorites.py (line 111)/favorites.py (line 177)/favorites.py (line 201). Из‑за фильтров F.text.in_ + F.text.contains обе ветки ловят один и тот же текст. Риск: двойные ответы, удаление сообщения дважды, дубль операций в БД. Фикс: оставить один модуль, второй убрать из регистрации.
P1 Дубли order_cancel_seller_: orders.py (line 589) и seller.py (line 996), при этом оба роутера подключены (bot.py (line 538), bot.py (line 545)). Риск: двойная отмена, двойные уведомления. Фикс: оставить один обработчик (предпочтительно unified).
P1 Разрозненная смена города и несогласованные обновления: commands.py (change_city/select_city), profile.py (line 258) (profile_change_city + reg_city_), favorites.py (line 42) (ChangeCity через текст). В одном месте обновляется только city без очистки region/district, в другом — update_user_location. Риск: “битые” районы/город, разные клавиатуры и тексты. Фикс: единый помощник обновления location + единый entrypoint.
P1 Отмена (cancel) фрагментирована: локальные отмены в нескольких модулях (commands.py (line 930), search.py, customer.py, registration.py), при этом cancel.py не подключён вообще. Риск: часть “Отмена” не срабатывает. Фикс: подключить cancel.py и убрать локальные дубли.
Findings (P2 / Cleanup)

P2 Легаси/мёртвые модули создают шум: order_management.py (не подключён), cart_checkout.py (заглушка), legacy.py (подключён как отдельный админ‑флоу в bot.py (line 562)). Фикс: вынести в handlers/legacy/ или убрать из регистрации.
P2 Дубли переключения режима продавец/покупатель: menu.py (line 49)/menu.py (line 76) и profile.py (line 343)/profile.py (line 399)/profile.py (line 678). Фикс: один источник + общий helper.
P2 Много локальных маппингов статусов/текста (пример: features.py, utils.py, notification_builder.py). Риск: несовпадение статусов/текстов. Фикс: один модуль форматирования статусов + единый enum.
P2 Поломанная кодировка строк (видно “Р…”/“вќЊ”) в ряде файлов: cancel.py, features.py, favorites.py, legacy.py. Риск: битые сообщения пользователю. Фикс: перевести строки в localization.py и сохранить файлы в UTF‑8.
Clean Flow (целевой аккуратный флоу)

CUSTOMER
/start -> выбор языка -> телефон -> город/район -> MAIN MENU
MAIN MENU -> browse/search -> offer -> add_to_cart или booking
CART -> checkout -> способ оплаты -> payment_status -> order_status -> завершение
MY ORDERS -> детали -> отмена (если pending) / upload_proof -> admin review -> статус
PROFILE -> настройки -> язык/уведомления -> смена города
FAVORITES -> список -> добавить/удалить

SELLER
/start -> (нет магазина) регистрация -> seller_menu
seller_menu -> offers (create/edit) -> orders -> confirm/reject -> preparing -> ready/delivering -> completed
seller_menu -> store_settings / analytics / bulk_import

ADMIN
dashboard -> moderation -> payment_review -> confirm/reject -> stats
Clean Logic (единая логика и источники истины)

Статусы только через unified_order_service.py (OrderStatus, PaymentStatus), запрет прямых db.update_* из хендлеров.
Единый обработчик для каждого callback_data namespace (один toggle_notifications, один favorite_, один admin_confirm_payment_*).
Единая смена города: helper обновляет city + region + district, один UI (inline).
Единый cancel: подключить cancel.py, стандартизировать *_cancel.
Все строки UI через localization.py, убрать битую кодировку из хендлеров.