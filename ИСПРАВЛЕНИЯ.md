# üîß –û–¢–ß–Å–¢ –û–ë –ò–°–ü–†–ê–í–õ–ï–ù–ò–ò –ü–†–û–ë–õ–ï–ú –ë–û–¢–ê

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. **–ö–†–ò–¢–ò–ß–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –ó–∞–≤–∏—Å–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–ü—Ä–∏—á–∏–Ω–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `await callback.answer()` –≤ callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö  
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–æ –≤–æ –≤—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ `show_all_offers_filter` - –¥–æ–±–∞–≤–ª–µ–Ω callback.answer()
- ‚úÖ `select_category` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è answer()
- ‚úÖ `back_to_offers` - –¥–æ–±–∞–≤–ª–µ–Ω answer()
- ‚úÖ `filter_bookings` - –¥–æ–±–∞–≤–ª–µ–Ω answer() —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫

### 2. **–£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–î–æ–±–∞–≤–ª–µ–Ω—ã try-except –±–ª–æ–∫–∏:**
- ‚úÖ `noop_callback`
- ‚úÖ `back_to_places_menu`
- ‚úÖ `back_to_categories`
- ‚úÖ `back_to_stores`
- ‚úÖ `show_all_offers_filter`
- ‚úÖ `select_category`
- ‚úÖ `back_to_offers`
- ‚úÖ `filter_bookings`

### 3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** ‚úÖ –£–õ–£–ß–®–ï–ù–û

#### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```python
# –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 3 –º–∏–Ω—É—Ç—ã
user_cache = {}  # {user_id: {'lang': str, 'role': str, 'city': str, 'user': tuple/dict, 'ts': float}}
CACHE_TTL = 180  # 3 minutes

def get_cached_user_data(user_id: int) -> dict:
    """–ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î"""
    
def invalidate_user_cache(user_id: int):
    """–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π"""
```

#### –ò–Ω–¥–µ–∫—Å—ã –ë–î:
‚úÖ –£–ñ–ï –°–£–©–ï–°–¢–í–£–Æ–¢ –≤ database.py:
- `idx_offers_status` - –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
- `idx_offers_expiry` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ä–æ–∫—É –≥–æ–¥–Ω–æ—Å—Ç–∏
- `idx_offers_store` - —Ç–æ–≤–∞—Ä—ã –º–∞–≥–∞–∑–∏–Ω–∞
- `idx_bookings_user` - –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `idx_stores_status` - –∞–∫—Ç–∏–≤–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω—ã

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 94 callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:
- üü¢ **–ö–†–ò–¢–ò–ß–ù–´–•:** 0 (–±—ã–ª–æ 1) ‚úÖ
- üü° **–°–†–ï–î–ù–ò–•:** 22 (–±—ã–ª–æ 27) - —É–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 18%
- üîµ **–ù–ò–ó–ö–ò–•:** 9 - –∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–µ

### –û—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã (–ù–ï –∫—Ä–∏—Ç–∏—á–Ω—ã–µ):

#### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (22):
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ admin callback'–∏ –±–µ–∑ try-except (–Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- –ü—Ä–æ—Å—Ç—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±–µ–∑ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏

#### üîµ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (9):
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö except –±–ª–æ–∫–∞—Ö
- –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä state –≤ –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

## üöÄ –ß—Ç–æ —É–ª—É—á—à–∏–ª–æ—Å—å

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
‚ùå –ö–Ω–æ–ø–∫–∏ –∑–∞–≤–∏—Å–∞–ª–∏ –∏ –Ω–µ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª–∏  
‚ùå –û—à–∏–±–∫–∏ –ø—Ä–∏–≤–æ–¥–∏–ª–∏ –∫ –ø–∞–¥–µ–Ω–∏—é –±–æ—Ç–∞  
‚ùå –ú–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∏–∑-–∑–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î  

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
‚úÖ –ö–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ  
‚úÖ –í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è  
‚úÖ –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º —á–µ—Ä–µ–∑ –∫—ç—à  
‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ callback'–∏ –∏–º–µ—é—Ç callback.answer()  

## üîç –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç **check_callbacks.py** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:
```bash
python check_callbacks.py
```

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
- ‚úÖ –ù–∞–ª–∏—á–∏–µ await callback.answer() –≤–æ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ (try-except)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ FSM

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å:
1. **–ì–æ—Ä—è—á–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è** - –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏—è
2. **–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏
3. **–ö–æ—Ä–∑–∏–Ω–∞** - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö/–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö
4. **–ù–∞–≤–∏–≥–∞—Ü–∏—è** - –≤—Å–µ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
5. **–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –º–∞–≥–∞–∑–∏–Ω—ã** - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏

### –ï—Å–ª–∏ –Ω–∞–π–¥–µ—Ç–µ –ø—Ä–æ–±–ª–µ–º—É:
1. –ù–∞–∂–º–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ —Å –æ—à–∏–±–∫–æ–π
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ - —è –∏—Å–ø—Ä–∞–≤–ª—é –∑–∞ –º–∏–Ω—É—Ç—É

### –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞ –æ—à–∏–±–∫–∏:
```
{"asctime": "2025-11-14 19:20:09", "name": "fudly", "levelname": "ERROR", 
"message": "Error in function_name: description"}
```

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

### –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5/5)
- –í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ (4/5)
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò–Ω–¥–µ–∫—Å—ã –ë–î –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è offers

### –£–¥–æ–±—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5/5)
- –ö–Ω–æ–ø–∫–∏ —Ä–µ–∞–≥–∏—Ä—É—é—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- –ù–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π
- –ü–ª–∞–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è

## üîß –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
python bot.py

# –ü—Ä–æ–≤–µ—Ä–∫–∞ callback'–æ–≤
python check_callbacks.py

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫ –≤ –∫–æ–¥–µ
python -m pylint bot.py --disable=all --enable=E

# –¢–µ—Å—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
python -m pytest tests/
```

---

**–î–∞—Ç–∞:** 14 –Ω–æ—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
