# –ü–û–õ–ù–´–ô –ê–£–î–ò–¢ –°–ò–°–¢–ï–ú–´ –ó–ê–ö–ê–ó–û–í

## –î–∞—Ç–∞: 10 –¥–µ–∫–∞–±—Ä—è 2025

---

## üìä –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï –°–ò–°–¢–ï–ú–´

### 1. ENTRY POINTS (–¢–æ—á–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤)

#### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û –†–ê–ë–û–¢–ê–ï–¢:

**A. –°–∞–º–æ–≤—ã–≤–æ–∑ (Pickup/Booking)**
1. **handlers/bookings/customer.py** ‚Üí `create_booking()`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: `db.create_booking_atomic()` 
   - ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (FOR UPDATE)
   - ‚úÖ –õ–∏–º–∏—Ç 20 –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ (6 —Å–∏–º–≤–æ–ª–æ–≤)
   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å—Ç–µ—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞
   - –°—Ç–∞—Ç—É—Å: `pending` ‚Üí `confirmed` ‚Üí `completed`

2. **handlers/customer/cart/checkout.py** ‚Üí `cart_checkout`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: `unified_order_service.create_order()`
   - –¢–∏–ø: `order_type="pickup"`
   - –ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã: `payment_method="cash"`
   - ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É, –±–µ–∑ —Å–∫—Ä–∏–Ω–∞ —á–µ–∫–∞
   - ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É –∏ –ø—Ä–æ–¥–∞–≤—Ü—É

#### ‚ùå –ò–°–ü–†–ê–í–õ–ï–ù–û (–±—ã–ª–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):

**B. –î–æ—Å—Ç–∞–≤–∫–∞ (Delivery)**

**–ë–´–õ–û:**
1. **handlers/customer/orders/delivery.py** 
   - ‚ùå –°–æ–∑–¥–∞–≤–∞–ª –∑–∞–∫–∞–∑ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–∞ (–î–û —Å–∫—Ä–∏–Ω–∞ —á–µ–∫–∞)
   
2. **handlers/customer/cart/payment.py**
   - ‚ùå `cart_pay_card()` - —Å–æ–∑–¥–∞–≤–∞–ª delivery –∑–∞–∫–∞–∑ —Å—Ä–∞–∑—É –ø—Ä–∏ –≤—ã–±–æ—Ä–µ Card
   - ‚ùå `cart_pay_click()` - —Å–æ–∑–¥–∞–≤–∞–ª delivery –∑–∞–∫–∞–∑ —Å—Ä–∞–∑—É –ø—Ä–∏ –≤—ã–±–æ—Ä–µ Click

**–°–¢–ê–õ–û:**
1. **handlers/customer/orders/delivery.py** ‚Üí `dlv_payment_proof()`
   - ‚úÖ –°–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ –ü–û–°–õ–ï –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∫—Ä–∏–Ω–∞ —á–µ–∫–∞
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: `unified_order_service.create_order()` –∏–ª–∏ `db.create_order()`
   
2. **handlers/customer/cart/payment.py** ‚Üí `cart_payment_proof()`
   - ‚úÖ –°–æ–∑–¥–∞–µ—Ç delivery –∑–∞–∫–∞–∑ –ü–û–°–õ–ï –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∫—Ä–∏–Ω–∞ —á–µ–∫–∞
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: `unified_order_service.create_order()`

**C. WebApp (Mini App)**
- **app/core/webhook_server.py** ‚Üí `api_create_order`
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: `unified_order_service.create_order()`
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ —Ç–∏–ø–∞: `pickup` –∏ `delivery`
  - ‚ö†Ô∏è –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ payment screenshot –¥–ª—è delivery!

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–û–ó–î–ê–ù–ò–Ø –ó–ê–ö–ê–ó–û–í

### –°–ª–æ–∏ —Å–∏—Å—Ç–µ–º—ã:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   HANDLERS (Entry Points)           ‚îÇ
‚îÇ   - bookings/customer.py            ‚îÇ
‚îÇ   - cart/checkout.py                ‚îÇ
‚îÇ   - cart/payment.py                 ‚îÇ
‚îÇ   - orders/delivery.py              ‚îÇ
‚îÇ   - webapp API                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   SERVICES (Business Logic)         ‚îÇ
‚îÇ   - unified_order_service.py ‚úÖ     ‚îÇ
‚îÇ   - order_service.py (legacy) ‚ö†Ô∏è    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   DATABASE LAYER                     ‚îÇ
‚îÇ   - create_booking_atomic() ‚úÖ       ‚îÇ
‚îÇ   - create_cart_order() ‚úÖ           ‚îÇ
‚îÇ   - create_order() ‚ö†Ô∏è NO TRANS!     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. **WebApp –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç payment screenshot –¥–ª—è delivery**

**–§–∞–π–ª:** `app/core/webhook_server.py` ‚Üí `api_create_order()`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
result: OrderResult = await order_service.create_order(
    user_id=int(user_id),
    items=order_items,
    order_type="delivery" if is_delivery else "pickup",  # ‚ùå 
    delivery_address=address if is_delivery else None,
    payment_method="card",  # ‚ùå –í—Å–µ–≥–¥–∞ "card", –Ω–æ –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∫—Ä–∏–Ω–∞!
    notify_customer=False,
    notify_sellers=False,
)
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- WebApp –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å delivery –∑–∞–∫–∞–∑ –ë–ï–ó –æ–ø–ª–∞—Ç—ã
- –ù–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ payment screenshot –≤ WebApp flow
- –ù–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è admin

**–†–µ—à–µ–Ω–∏–µ:**
- WebApp –¥–æ–ª–∂–µ–Ω —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å payment screenshot
- –ü–æ—Ç–æ–º —Å–æ–∑–¥–∞—Ç—å delivery –∑–∞–∫–∞–∑
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–≤—É—Ö—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å (–∫–∞–∫ –≤ –±–æ—Ç–µ)

---

### 2. **db.create_order() –ë–ï–ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**

**–§–∞–π–ª:** `database_pg_module/mixins/orders.py` ‚Üí `create_order()`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
def create_order(...) -> int | None:
    """Create new order.
    
    TODO: This method has no transaction protection and no stock checking!
    Should use create_cart_order() instead which has atomic stock reservation.
    """
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤
- –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç race conditions
- –ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–≤–∞—Ä
- –ú–æ–∂–µ—Ç —Å–ø–∏—Å–∞—Ç—å –±–æ–ª—å—à–µ —Ç–æ–≤–∞—Ä–æ–≤, —á–µ–º –µ—Å—Ç—å

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤:**
- `handlers/customer/orders/delivery.py` (fallback, –µ—Å–ª–∏ unified_order_service –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

**–†–µ—à–µ–Ω–∏–µ:**
- –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ `unified_order_service` –≤–µ–∑–¥–µ
- –£–¥–∞–ª–∏—Ç—å `create_order()` –∏–ª–∏ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏

---

### 3. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ logic: unified_order_service vs order_service**

**–§–∞–π–ª—ã:**
- `app/services/unified_order_service.py` - –Ω–æ–≤—ã–π ‚úÖ
- `app/services/order_service.py` - —Å—Ç–∞—Ä—ã–π ‚ö†Ô∏è

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –î–≤–∞ —Å–µ—Ä–≤–∏—Å–∞ –¥–µ–ª–∞—é—Ç –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ
- `order_service.py` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- –ü—É—Ç–∞–Ω–∏—Ü–∞ –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

**–†–µ—à–µ–Ω–∏–µ:**
- –£–¥–∞–ª–∏—Ç—å `app/services/order_service.py`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ `unified_order_service`

---

### 4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ payment_method –¥–ª—è delivery**

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –í unified_order_service.create_order()
# –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏: –µ—Å–ª–∏ order_type="delivery" ‚Üí –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å payment screenshot!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å delivery –∑–∞–∫–∞–∑ —Å `payment_method="cash"` (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)
- –ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ –Ω–∞–ª–∏—á–∏—è payment proof

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é:
```python
if order_type == "delivery" and payment_method != "cash":
    # Must have payment screenshot attached!
    # Or pass photo_id as parameter
    pass
```

---

### 5. **Mixed store orders –≤ cart**

**–§–∞–π–ª:** `unified_order_service.py` ‚Üí `create_order()`

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
```python
# Enforce business invariant: one order must belong to ONE store
store_ids = {item.store_id for item in items}
if len(store_ids) > 1:
    return OrderResult(success=False, error_message="...")
```

‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ! –ù–æ —ç—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–∏—Å–∞.

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö–æ—Ä–∑–∏–Ω–∞ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –∫–æ—Ä–∑–∏–Ω—É, –ø–æ—Ç–æ–º –ø—Ä–∏ checkout - –æ—à–∏–±–∫–∞
- –ü–ª–æ—Ö–æ–π UX

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É
- –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: "–ö–æ—Ä–∑–∏–Ω–∞ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–≤–∞—Ä—ã —Ç–æ–ª—å–∫–æ –∏–∑ –æ–¥–Ω–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞"
- –ò–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏–∑ –¥—Ä—É–≥–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞

---

### 6. **Inconsistent notifications**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –†–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
- `unified_order_service` –∏–º–µ–µ—Ç —Å–≤–æ–∏ —à–∞–±–ª–æ–Ω—ã
- `delivery_admin.py` –∏–º–µ–µ—Ç —Å–≤–æ–∏ —à–∞–±–ª–æ–Ω—ã
- `bookings/customer.py` –∏–º–µ–µ—Ç —Å–≤–æ–∏ —à–∞–±–ª–æ–Ω—ã

**–†–µ—à–µ–Ω–∏–µ:**
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—Å–µ —à–∞–±–ª–æ–Ω—ã –≤ `unified_order_service`
- –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

---

### 7. **FSM Data Loss Risk**

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –í delivery.py —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è —Ö—Ä–∞–Ω–∏–ª–∞ order_id –≤ FSM
# –ï—Å–ª–∏ FSM —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è - order_id —Ç–µ—Ä—è–µ—Ç—Å—è
# –°–æ–∑–¥–∞–≤–∞–ª–∏—Å—å fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ order
```

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ! –¢–µ–ø–µ—Ä—å –∑–∞–∫–∞–∑ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ `dlv_payment_proof` –∏ `cart_payment_proof` –ø–æ—Å–ª–µ —Å–∫—Ä–∏–Ω–∞.
–ù–µ—Ç —Ä–∏—Å–∫–∞ –ø–æ—Ç–µ—Ä–∏ order_id, —Ç–∞–∫ –∫–∞–∫ –∑–∞–∫–∞–∑–∞ –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.

---

## üìà –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ö–û–î–ê

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–∫–∞–∑–æ–≤:
- Handlers: 4 —Ñ–∞–π–ª–∞
- Services: 2 —Ñ–∞–π–ª–∞ (1 –∞–∫—Ç–∏–≤–Ω—ã–π, 1 legacy)
- Database: 3 –º–µ—Ç–æ–¥–∞
- WebApp API: 1 endpoint

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–µ—Ç–æ–¥—ã:
1. `db.create_booking_atomic()` - ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω—ã–π, —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
2. `db.create_cart_order()` - ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω—ã–π, —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
3. `db.create_order()` - ‚ö†Ô∏è –ë–ï–ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, fallback only
4. `unified_order_service.create_order()` - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç 1 –∏–ª–∏ 2

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ):

1. **–î–æ–±–∞–≤–∏—Ç—å payment screenshot –≤ WebApp flow**
   - –§–∞–π–ª: `app/core/webhook_server.py`
   - –î–µ–π—Å—Ç–≤–∏–µ: –ü—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞–ª–∏—á–∏–µ payment_proof –¥–ª—è delivery –∑–∞–∫–∞–∑–æ–≤
   - –í—Ä–µ–º—è: 2-4 —á–∞—Å–∞

2. **–£–¥–∞–ª–∏—Ç—å –∏–ª–∏ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å db.create_order() —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏**
   - –§–∞–π–ª: `database_pg_module/mixins/orders.py`
   - –î–µ–π—Å—Ç–≤–∏–µ: –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –º–µ—Ç–æ–¥
   - –í—Ä–µ–º—è: 2-3 —á–∞—Å–∞

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è payment_method –¥–ª—è delivery**
   - –§–∞–π–ª: `app/services/unified_order_service.py`
   - –î–µ–π—Å—Ç–≤–∏–µ: –¢—Ä–µ–±–æ–≤–∞—Ç—å payment screenshot –¥–ª—è delivery
   - –í—Ä–µ–º—è: 1 —á–∞—Å

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ):

4. **–£–¥–∞–ª–∏—Ç—å legacy order_service.py**
   - –§–∞–π–ª: `app/services/order_service.py`
   - –î–µ–π—Å—Ç–≤–∏–µ: –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
   - –í—Ä–µ–º—è: 30 –º–∏–Ω—É—Ç

5. **–í–∞–ª–∏–¥–∞—Ü–∏—è mixed store –≤ –∫–æ—Ä–∑–∏–Ω–µ**
   - –§–∞–π–ª: `webapp/src/stores/cartStore.js` –∏–ª–∏ backend
   - –î–µ–π—Å—Ç–≤–∏–µ: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É
   - –í—Ä–µ–º—è: 2 —á–∞—Å–∞

6. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å notification templates**
   - –§–∞–π–ª—ã: –≤—Å–µ handlers
   - –î–µ–π—Å—Ç–≤–∏–µ: –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —à–∞–±–ª–æ–Ω—ã –≤ unified_order_service
   - –í—Ä–µ–º—è: 4-6 —á–∞—Å–æ–≤

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–£–ª—É—á—à–µ–Ω–∏–µ):

7. **–î–æ–±–∞–≤–∏—Ç—å unit tests –¥–ª—è WebApp API**
   - –§–∞–π–ª: `tests/test_webapp_orders.py` (—Å–æ–∑–¥–∞—Ç—å)
   - –î–µ–π—Å—Ç–≤–∏–µ: –¢–µ—Å—Ç—ã –¥–ª—è api_create_order
   - –í—Ä–µ–º—è: 3-4 —á–∞—Å–∞

8. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API**
   - –§–∞–π–ª: `docs/API_ORDER_CREATION.md` (—Å–æ–∑–¥–∞—Ç—å)
   - –î–µ–π—Å—Ç–≤–∏–µ: –û–ø–∏—Å–∞—Ç—å –≤—Å–µ entry points
   - –í—Ä–µ–º—è: 2 —á–∞—Å–∞

9. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –î–µ–π—Å—Ç–≤–∏–µ: –î–æ–±–∞–≤–∏—Ç—å structured logging –¥–ª—è –∑–∞–∫–∞–∑–æ–≤
   - –í—Ä–µ–º—è: 2-3 —á–∞—Å–∞

---

## üí° –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

### –ò–¥–µ–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:

```python
# –ï–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∑–∞–∫–∞–∑–æ–≤
class UnifiedOrderService:
    async def create_order(
        user_id: int,
        items: list[OrderItem],
        order_type: Literal["pickup", "delivery"],
        delivery_address: str | None = None,
        payment_proof: str | None = None,  # ‚úÖ –î–æ–±–∞–≤–∏—Ç—å!
        payment_method: str = "cash",
    ) -> OrderResult:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        if order_type == "delivery":
            if not delivery_address:
                raise ValueError("Delivery address required")
            if payment_method != "cash" and not payment_proof:
                raise ValueError("Payment proof required for card payment")
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
        # ... atomic operations ...
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚úÖ –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
- ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–∫–∞–∑
- ‚úÖ –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã

---

## üìù –í–´–í–û–î–´

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ:
1. ‚úÖ `create_booking_atomic()` - –æ—Ç–ª–∏—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
2. ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ pickup –∏ delivery –ª–æ–≥–∏–∫–∏
3. ‚úÖ Unified order service –∫–∞–∫ –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
4. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ä–∞–Ω–Ω–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ–º delivery –∑–∞–∫–∞–∑–æ–≤

### –ß—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Å—Ä–æ—á–Ω–æ:
1. ‚ùå WebApp —Å–æ–∑–¥–∞–µ—Ç delivery –±–µ–∑ payment screenshot
2. ‚ùå `db.create_order()` –±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (fallback)
3. ‚ùå –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ payment –¥–ª—è delivery

### –ß—Ç–æ —É–ª—É—á—à–∏—Ç—å —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º:
1. ‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å legacy order_service.py
2. ‚ö†Ô∏è –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å notifications
3. ‚ö†Ô∏è –í–∞–ª–∏–¥–∞—Ü–∏—è mixed store –≤ –∫–æ—Ä–∑–∏–Ω–µ
4. ‚ö†Ô∏è –ë–æ–ª—å—à–µ —Ç–µ—Å—Ç–æ–≤ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

---

## üîß –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### –ù–µ–¥–µ–ª—è 1:
- [ ] Fix WebApp payment screenshot requirement
- [ ] Add payment validation in unified_order_service
- [ ] Add transactions to db.create_order() or remove it

### –ù–µ–¥–µ–ª—è 2:
- [ ] Remove legacy order_service.py
- [ ] Add mixed store validation in cart
- [ ] Centralize notification templates

### –ù–µ–¥–µ–ª—è 3:
- [ ] Add tests for WebApp orders
- [ ] Write API documentation
- [ ] Add monitoring and structured logging

---

## üìä –ú–ï–¢–†–ò–ö–ò –£–°–ü–ï–•–ê

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —É–ª—É—á—à–µ–Ω–∏–π:
- ‚úÖ 0 –∑–∞–∫–∞–∑–æ–≤ —Å–æ–∑–¥–∞–Ω–æ –±–µ–∑ payment proof
- ‚úÖ 0 race conditions –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–æ–≤
- ‚úÖ 100% –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ unified_order_service
- ‚úÖ 1 –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –∑–∞–∫–∞–∑–æ–≤
- ‚úÖ < 1% –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–æ–≤

---

**–ö–æ–Ω–µ—Ü –∞—É–¥–∏—Ç–∞**
