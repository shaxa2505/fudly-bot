"""
Fudly Telegram Bot - Main Module

This file is being refactored to use modular handlers from the handlers/ package.
See handlers/README.md for details on the refactoring structure.

Current status: Foundation laid with handlers/common.py, handlers/registration.py,
handlers/user_commands.py, and handlers/admin.py created. Full integration pending.
"""
from __future__ import annotations

import asyncio
import os
import random
import signal
import socket
import sqlite3
import string
import sys
from datetime import datetime, timedelta, timezone
from typing import Any, Dict, Optional

from aiogram import F, types
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.types import FSInputFile
from aiogram.utils.keyboard import InlineKeyboardBuilder

from app.core.bootstrap import build_application
from app.core.config import load_settings
from app.core.security import (
    PRODUCTION_FEATURES,
    logger,
    rate_limiter,
    secure_user_input,
    start_background_tasks,
    validate_admin_action,
    validator,
)
from app.core.utils import get_store_field, get_user_field
from app.services.admin_service import AdminService
from app.services.offer_service import OfferService

# Import states from handlers.common_states package
from handlers.common_states import (
    BookOffer,
    BrowseOffers,
    BulkCreate,
    ChangeCity,
    ConfirmOrder,
    CreateOffer,
    EditOffer,
    OrderDelivery,
    Registration,
    RegisterStore,
)
# Import utilities from handlers/common.py module
from handlers import common as handlers_common_module
RegistrationCheckMiddleware = handlers_common_module.RegistrationCheckMiddleware
common_get_appropriate_menu = handlers_common_module.get_appropriate_menu
common_has_approved_store = handlers_common_module.has_approved_store
handler_user_view_mode = handlers_common_module.user_view_mode

from keyboards import (
    admin_menu,
    booking_filters_keyboard,
    cancel_keyboard,
    city_keyboard,
    language_keyboard,
    main_menu_customer,
    main_menu_seller,
    moderation_keyboard,
    offers_category_filter,
    phone_request_keyboard,
    product_categories_keyboard,
    units_keyboard,
)
from localization import get_categories, get_cities, get_text, normalize_category

# Load typed settings and bootstrap application components
settings = load_settings()

ADMIN_ID = settings.admin_id
DATABASE_URL = settings.database_url
USE_WEBHOOK = settings.webhook.enabled
WEBHOOK_URL = settings.webhook.url
WEBHOOK_PATH = settings.webhook.path
PORT = settings.webhook.port
SECRET_TOKEN = settings.webhook.secret_token

bot, dp, db, cache = build_application(settings)
offer_service = OfferService(db, cache)
admin_service = AdminService(db, bool(DATABASE_URL))

# Initialize metrics dictionary
METRICS: Dict[str, int] = {
    "updates_received": 0,
    "updates_errors": 0,
    "webhook_json_errors": 0,
    "webhook_validation_errors": 0,
    "webhook_unexpected_errors": 0,
    "bookings_created": 0,
    "bookings_cancelled": 0
}

# Use imported utilities (override local definitions)
user_view_mode = handler_user_view_mode


def has_approved_store(user_id: int) -> bool:
    """Check if user has approved store."""
    return common_has_approved_store(user_id, db)


def get_appropriate_menu(user_id: int, lang: str) -> Any:
    """Get appropriate menu for user."""
    return common_get_appropriate_menu(user_id, lang, db, main_menu_seller, main_menu_customer)


def get_cached_user_data(user_id: int) -> Dict[str, Any]:
    """Get cached user data or fetch from DB."""
    return cache.get_user_data(user_id)


def invalidate_user_cache(user_id: int) -> None:
    """Invalidate user cache after updates."""
    cache.invalidate_user(user_id)


def get_user_language_cached(user_id: int) -> str:
    """Cached version of get_user_language."""
    return cache.get_user_data(user_id)['lang']

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
if ADMIN_ID > 0:
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        user = db.get_user(ADMIN_ID)
        if not user:
            # –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è-–∞–¥–º–∏–Ω–∞
            db.add_user(ADMIN_ID, "admin", "Admin")
        # –î–µ–ª–∞–µ–º –∞–¥–º–∏–Ω–æ–º
        db.set_admin(ADMIN_ID)
        print(f"‚úÖ –ê–¥–º–∏–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {ADMIN_ID}")
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∞–¥–º–∏–Ω–∞: {e}")

# Register modular handlers from handlers package
from handlers import registration, user_commands, admin, admin_stats, offers

# Setup registration handlers
registration.setup(dp, db, get_text, get_cities, city_keyboard, phone_request_keyboard, main_menu_customer,
                  validator, rate_limiter, logger, secure_user_input)

# Setup user command handlers
user_commands.setup(dp, db, get_text, get_cities, city_keyboard, language_keyboard,
                   phone_request_keyboard, main_menu_seller, main_menu_customer)

# Setup admin handlers
admin.setup(dp, db, get_text, admin_menu)

# Setup offer browsing handlers
offers.setup(dp, db, offer_service, logger)

# Setup admin statistics handlers
admin_stats.setup(dp, admin_service, logger)

# Register middleware for registration check
dp.update.middleware(RegistrationCheckMiddleware(db, get_text, phone_request_keyboard))

# ============== PHASE 3: EXTRACTED HANDLERS INTEGRATION ==============
# Import extracted handler modules
from handlers import bookings, orders, partner, booking_rating, common_user
from handlers.seller import create_offer, management, analytics, order_management
from handlers.user import profile, favorites
from handlers.admin import dashboard as admin_dashboard

# Setup dependencies for extracted handlers
bookings.setup_dependencies(db, cache, bot, METRICS)  # bookings needs cache and METRICS
orders.setup_dependencies(db, bot, user_view_mode)
partner.setup_dependencies(db, bot, user_view_mode)
create_offer.setup_dependencies(db, bot)  # seller modules need only db and bot
management.setup_dependencies(db, bot)
analytics.setup_dependencies(db, bot)
profile.setup_dependencies(db, bot, user_view_mode)
favorites.setup_dependencies(db, bot, user_view_mode)
order_management.setup(bot, db)  # New: seller order management
booking_rating.setup(bot, db)  # New: booking ratings
common_user.setup(bot, db, user_view_mode, get_text, main_menu_customer)  # New: common user functionality
admin_dashboard.setup(bot, db, get_text, moderation_keyboard, get_uzb_time)  # New: admin dashboard

# Include extracted routers in dispatcher
dp.include_router(bookings.router)
dp.include_router(orders.router)
dp.include_router(partner.router)
dp.include_router(create_offer.router)
dp.include_router(management.router)
dp.include_router(analytics.router)
dp.include_router(profile.router)
dp.include_router(favorites.router)
dp.include_router(order_management.router)  # New
dp.include_router(booking_rating.router)  # New
dp.include_router(common_user.router)  # New
dp.include_router(admin_dashboard.router)  # New

# ============== REMAINING HANDLERS (TO BE MIGRATED) ==============
# Note: The handlers below will be gradually moved to the handlers/ package
# Handlers already migrated: registration, user_commands (start, language, cancel), admin (main panel)

# Skip duplicate handlers that are now in handler modules
# - Removed: Registration handlers (process_phone, process_city) - now in handlers/registration.py
# - Removed: User commands (cmd_start, choose_language, cancel_action, etc.) - now in handlers/user_commands.py
# - Removed: Admin commands (cmd_admin, admin_dashboard, admin_exit) - now in handlers/admin.py



# Old middleware registration removed - now registered above with imported class

# ============== HANDLERS BELOW WILL BE GRADUALLY MIGRATED ==============
# The following handlers remain in bot.py and can be moved to handler modules incrementally:
# - Store registration and management
# - Offer creation and management
# - Booking operations
# - Callback handlers (pagination, filters, etc.)
# - Additional admin handlers (moderation, detailed stats, etc.)

# ============== –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ - –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==============
# Admin statistics handlers moved to handlers/admin_stats.py

# @dp.message(F.text == "üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏")
# async def admin_users(message: types.Message):
#     """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å inline-–º–µ–Ω—é (SQLite/PostgreSQL —Å–æ–≤–º–µ—Å—Ç–∏–º–æ)"""
#     if not db.is_admin(message.from_user.id):
#         return

    # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
#     try:
#         from datetime import datetime
#         today = datetime.now().strftime('%Y-%m-%d')
#         with db.get_connection() as conn:
#             cursor = conn.cursor()

#             cursor.execute('SELECT COUNT(*) FROM users')
#             total = cursor.fetchone()[0]

#             cursor.execute("SELECT COUNT(*) FROM users WHERE role = 'seller'")
#             sellers = cursor.fetchone()[0]

#             cursor.execute("SELECT COUNT(*) FROM users WHERE role = 'customer'")
#             customers = cursor.fetchone()[0]

#             if DATABASE_URL:
                # PostgreSQL syntax
#                 cursor.execute("SELECT COUNT(*) FROM users WHERE created_at >= CURRENT_DATE - INTERVAL '7 days'")
#                 week_users = cursor.fetchone()[0]
#                 cursor.execute('SELECT COUNT(*) FROM users WHERE DATE(created_at) = %s', (today,))
#                 today_users = cursor.fetchone()[0]
#             else:
                # SQLite syntax
#                 cursor.execute("""
#                     SELECT COUNT(*) FROM users 
#                     WHERE DATE(created_at) >= DATE('now', '-7 days')
#                 """)
#                 week_users = cursor.fetchone()[0]
#                 cursor.execute('SELECT COUNT(*) FROM users WHERE DATE(created_at) = ?', (today,))
#                 today_users = cursor.fetchone()[0]
#     except Exception as e:
#         logger.error(f"Admin users stats error: {e}")
#         return

#     text = "üë• <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</b>\n\n"
#     text += f"üìä –í—Å–µ–≥–æ: {total}\n"
#     text += f"‚îú üè™ –ü–∞—Ä—Ç–Ω—ë—Ä—ã: {sellers}\n"
#     text += f"‚îî üõç –ü–æ–∫—É–ø–∞—Ç–µ–ª–∏: {customers}\n\n"
#     text += f"üìÖ –ó–∞ –Ω–µ–¥–µ–ª—é: +{week_users}\n"
#     text += f"üìÖ –°–µ–≥–æ–¥–Ω—è: +{today_users}"

#     from aiogram.utils.keyboard import InlineKeyboardBuilder
#     kb = InlineKeyboardBuilder()
#     kb.button(text="üìã –°–ø–∏—Å–æ–∫ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤", callback_data="admin_list_sellers")
#     kb.button(text="üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", callback_data="admin_search_user")
#     kb.adjust(1)

#     await message.answer(text, parse_mode="HTML", reply_markup=kb.as_markup())

# @dp.message(F.text == "üè™ –ú–∞–≥–∞–∑–∏–Ω—ã")
# async def admin_stores(message: types.Message):
#     """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞–º–∏ —Å inline-–º–µ–Ω—é"""
#     if not db.is_admin(message.from_user.id):
#         return
    
#     with db.get_connection() as conn:
#         cursor = conn.cursor()
        
#         cursor.execute("SELECT COUNT(*) FROM stores WHERE status = 'active'")
#         active = cursor.fetchone()[0]
        
#         cursor.execute("SELECT COUNT(*) FROM stores WHERE status = 'pending'")
#         pending = cursor.fetchone()[0]
        
#         cursor.execute("SELECT COUNT(*) FROM stores WHERE status = 'rejected'")
#         rejected = cursor.fetchone()[0]
    
#     text = "üè™ <b>–ú–∞–≥–∞–∑–∏–Ω—ã</b>\n\n"
#     text += f"‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ: {active}\n"
#     text += f"‚è≥ –ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏: {pending}\n"
#     text += f"‚ùå –û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ: {rejected}"
    
#     from aiogram.utils.keyboard import InlineKeyboardBuilder
#     kb = InlineKeyboardBuilder()
    
#     if pending > 0:
#         kb.button(text=f"‚è≥ –ú–æ–¥–µ—Ä–∞—Ü–∏—è ({pending})", callback_data="admin_moderation")
    
#     kb.button(text="‚úÖ –û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ", callback_data="admin_approved_stores")
#     kb.button(text="‚ùå –û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ", callback_data="admin_rejected_stores")
#     kb.button(text="üîç –ü–æ–∏—Å–∫ –º–∞–≥–∞–∑–∏–Ω–∞", callback_data="admin_search_store")
#     kb.adjust(1)
    
#     await message.answer(text, parse_mode="HTML", reply_markup=kb.as_markup())

# @dp.message(F.text == "üì¶ –¢–æ–≤–∞—Ä—ã")
# async def admin_offers(message: types.Message):
#     """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤"""
#     if not db.is_admin(message.from_user.id):
#         return
    
#     with db.get_connection() as conn:
#         cursor = conn.cursor()
        
#         cursor.execute('SELECT COUNT(*) FROM offers WHERE status = "active"')
#         active = cursor.fetchone()[0]
        
#         cursor.execute('SELECT COUNT(*) FROM offers WHERE status = "inactive"')
#         inactive = cursor.fetchone()[0]
    
#     cursor.execute('SELECT COUNT(*) FROM offers WHERE status = "deleted"')
#     deleted = cursor.fetchone()[0]
    
    # –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π
#     cursor.execute('''
#         SELECT category, COUNT(*) as cnt 
#         FROM offers 
#         WHERE status = 'active' AND category IS NOT NULL
#         GROUP BY category 
#         ORDER BY cnt DESC 
#         LIMIT 5
#     ''')
#     top_categories = cursor.fetchall()
    
#     conn.close()
    
#     text = "üì¶ <b>–¢–æ–≤–∞—Ä—ã</b>\n\n"
#     text += f"‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ: {active}\n"
#     text += f"‚ùå –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ: {inactive}\n"
#     text += f"üóë –£–¥–∞–ª—ë–Ω–Ω—ã–µ: {deleted}\n\n"
    
#     if top_categories:
#         text += "<b>–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π:</b>\n"
#         for cat, cnt in top_categories:
#             text += f"‚îú {cat}: {cnt}\n"
    
#     from aiogram.utils.keyboard import InlineKeyboardBuilder
#     kb = InlineKeyboardBuilder()
#     kb.button(text="üìã –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ", callback_data="admin_all_offers")
#     kb.button(text="üóë –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ", callback_data="admin_cleanup_offers")
#     kb.adjust(1)
    
#     await message.answer(text, parse_mode="HTML", reply_markup=kb.as_markup())

# @dp.message(F.text == "üìã –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è")
# async def admin_bookings(message: types.Message):
#     """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π"""
#     if not db.is_admin(message.from_user.id):
#         return
    
#     with db.get_connection() as conn:
#         cursor = conn.cursor()
        
#         cursor.execute('SELECT COUNT(*) FROM bookings')
#         total = cursor.fetchone()[0]
        
#         cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "pending"')
#         pending = cursor.fetchone()[0]
        
#         cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "completed"')
#     completed = cursor.fetchone()[0]
    
#     cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "cancelled"')
#     cancelled = cursor.fetchone()[0]
    
    # –ó–∞ —Å–µ–≥–æ–¥–Ω—è
#     from datetime import datetime
#     today = datetime.now().strftime('%Y-%m-%d')
    
#     cursor.execute('SELECT COUNT(*) FROM bookings WHERE DATE(created_at) = ?', (today,))
#     today_bookings = cursor.fetchone()[0]
    
#     cursor.execute('''
#         SELECT SUM(o.discount_price * b.quantity)
#         FROM bookings b
#         JOIN offers o ON b.offer_id = o.offer_id
#         WHERE DATE(b.created_at) = ? AND b.status != 'cancelled'
#     ''', (today,))
#     today_revenue = cursor.fetchone()[0] or 0
    
#     conn.close()
    
#     text = "üé´ <b>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</b>\n\n"
#     text += f"üìä –í—Å–µ–≥–æ: {total}\n"
#     text += f"‚îú ‚è≥ –ê–∫—Ç–∏–≤–Ω—ã–µ: {pending}\n"
#     text += f"‚îú ‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ: {completed}\n"
#     text += f"‚îî ‚ùå –û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ: {cancelled}\n\n"
#     text += f"üìÖ –°–µ–≥–æ–¥–Ω—è: {today_bookings}\n"
#     text += f"ÔøΩ –í—ã—Ä—É—á–∫–∞: {int(today_revenue):,} —Å—É–º"
    
#     from aiogram.utils.keyboard import InlineKeyboardBuilder
#     kb = InlineKeyboardBuilder()
#     kb.button(text="‚è≥ –ê–∫—Ç–∏–≤–Ω—ã–µ", callback_data="admin_pending_bookings")
#     kb.button(text="‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ", callback_data="admin_completed_bookings")
#     kb.button(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_bookings_stats")
#     kb.adjust(1)
    
#     await message.answer(text, parse_mode="HTML", reply_markup=kb.as_markup())

# ============== EXTRACTED HANDLERS ==============
# The following handlers have been extracted to modular files:
# - handlers/bookings.py: Booking operations (8 handlers)
# - handlers/orders.py: Delivery orders (10 handlers)
# - handlers/partner.py: Partner registration (7 handlers)
# - handlers/seller/create_offer.py: Offer creation (12 handlers)
# - handlers/seller/management.py: Offer management (15 handlers)
# - handlers/seller/analytics.py: Analytics (2 handlers)
# - handlers/user/profile.py: User profile (9 handlers)
# - handlers/user/favorites.py: Favorites and city (5 handlers)
# - handlers/seller/order_management.py: Order operations (4 handlers)
# - handlers/booking_rating.py: Booking ratings (1 handler)
# - handlers/common_user.py: Common user features (1 handler)
# Total: 75 handlers extracted, integrated via routers in lines 171-203

# ============== –û–°–¢–ê–õ–¨–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==============
# Handlers below will be extracted in next phases

# Lines 433-457: Handlers extracted to booking_rating module
# Lines 459-632: Handlers extracted to seller/order_management module
# Lines 634-642: Handlers extracted to common_user module
# Lines 646-726: Handlers extracted to seller/analytics module

# ============== –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ - INLINE CALLBACKS ==============

@dp.callback_query(F.data == "admin_refresh_dashboard")
async def refresh_dashboard(callback: types.CallbackQuery):
    """–û–±–Ω–æ–≤–∏—Ç—å dashboard"""
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω", show_alert=True)
        return
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –∫–æ–¥ —á—Ç–æ –∏ –≤ admin_dashboard
    with db.get_connection() as conn:
        cursor = conn.cursor()
        
        # [–ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å –∫–æ–¥ –∏–∑ admin_dashboard –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏]
        cursor.execute('SELECT COUNT(*) FROM users')
        total_users = cursor.fetchone()[0]
        
        cursor.execute('SELECT COUNT(*) FROM users WHERE role = "seller"')
        sellers = cursor.fetchone()[0]
        
        cursor.execute('SELECT COUNT(*) FROM users WHERE role = "customer"')
        customers = cursor.fetchone()[0]
        
        cursor.execute('SELECT COUNT(*) FROM stores WHERE status = "active"')
        active_stores = cursor.fetchone()[0]
        
        cursor.execute('SELECT COUNT(*) FROM stores WHERE status = "pending"')
        pending_stores = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM offers WHERE status = "active"')
    active_offers = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM offers WHERE status = "inactive"')
    inactive_offers = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM bookings')
    total_bookings = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "pending"')
    pending_bookings = cursor.fetchone()[0]
    
    from datetime import datetime
    today = datetime.now().strftime('%Y-%m-%d')
    
    cursor.execute('SELECT COUNT(*) FROM bookings WHERE DATE(created_at) = ?', (today,))
    today_bookings = cursor.fetchone()[0]
    
    cursor.execute('''
        SELECT SUM(o.discount_price * b.quantity)
        FROM bookings b
        JOIN offers o ON b.offer_id = o.offer_id
        WHERE DATE(b.created_at) = ? AND b.status != 'cancelled'
    ''', (today,))
    today_revenue = cursor.fetchone()[0] or 0
    
    cursor.execute('SELECT COUNT(*) FROM users WHERE DATE(created_at) = ?', (today,))
    today_users = cursor.fetchone()[0]
    
    text = "üìä <b>Dashboard - –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b>\n\n"
    text += "üë• <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</b>\n"
    text += f"‚îú –í—Å–µ–≥–æ: {total_users} (+{today_users} —Å–µ–≥–æ–¥–Ω—è)\n"
    text += f"‚îú üè™ –ü–∞—Ä—Ç–Ω—ë—Ä—ã: {sellers}\n"
    text += f"‚îî üõç –ü–æ–∫—É–ø–∞—Ç–µ–ª–∏: {customers}\n\n"
    text += "üè™ <b>–ú–∞–≥–∞–∑–∏–Ω—ã:</b>\n"
    text += f"‚îú ‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ: {active_stores}\n"
    text += f"‚îî ‚è≥ –ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏: {pending_stores}\n\n"
    text += "üì¶ <b>–¢–æ–≤–∞—Ä—ã:</b>\n"
    text += f"‚îú ‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ: {active_offers}\n"
    text += f"‚îî ‚ùå –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ: {inactive_offers}\n\n"
    text += "üé´ <b>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</b>\n"
    text += f"‚îú –í—Å–µ–≥–æ: {total_bookings}\n"
    text += f"‚îú ‚è≥ –ê–∫—Ç–∏–≤–Ω—ã–µ: {pending_bookings}\n"
    text += f"‚îî üìÖ –°–µ–≥–æ–¥–Ω—è: {today_bookings}\n\n"
    text += f"üí∞ <b>–í—ã—Ä—É—á–∫–∞ —Å–µ–≥–æ–¥–Ω—è:</b> {int(today_revenue):,} —Å—É–º"
    
    from aiogram.utils.keyboard import InlineKeyboardBuilder
    kb = InlineKeyboardBuilder()
    if pending_stores > 0:
        kb.button(text=f"‚è≥ –ú–æ–¥–µ—Ä–∞—Ü–∏—è ({pending_stores})", callback_data="admin_moderation")
    kb.button(text="üìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_detailed_stats")
    kb.button(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="admin_refresh_dashboard")
    kb.adjust(1)
    
    try:
        await callback.message.edit_text(text, parse_mode="HTML", reply_markup=kb.as_markup())
    except Exception:
        await callback.message.answer(text, parse_mode="HTML", reply_markup=kb.as_markup())
    
    await callback.answer("‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ")

@dp.callback_query(F.data == "admin_moderation")
async def admin_moderation_callback(callback: types.CallbackQuery):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞—è–≤–∫–∏ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é"""
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω", show_alert=True)
        return
    
    await callback.answer()
    
    lang = 'ru'
    pending = db.get_pending_stores()
    
    if not pending:
        await bot.send_message(callback.message.chat.id, get_text(lang, 'no_pending_stores'))
        return
    
    await bot.send_message(callback.message.chat.id, get_text(lang, 'pending_stores_count', count=len(pending)))
    
    for store in pending:
        text = f"üè™ <b>{store['name']}</b>\n\n"
        text += f"–û—Ç: {store['first_name']} (@{store.get('username') or '–Ω–µ—Ç'})\n"
        text += f"ID: <code>{store['store_id']}</code>\n\n"
        text += f"üìç {store['city']}, {store['address']}\n"
        text += f"üè∑ {store['category']}\n"
        text += f"üì± {store['phone']}\n"
        text += f"üìù {store['description']}\n"
        text += f"üìÖ {store['created_at']}"
        
        await bot.send_message(
            callback.message.chat.id,
            text,
            parse_mode="HTML",
            reply_markup=moderation_keyboard(store['store_id'])
        )
        await asyncio.sleep(0.3)

@dp.callback_query(F.data == "admin_detailed_stats")
async def admin_detailed_stats_callback(callback: types.CallbackQuery):
    """–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ Dashboard"""
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω", show_alert=True)
        return
    
    await callback.answer()
    
    lang = 'ru'
    await bot.send_message(callback.message.chat.id, "‚è≥ –°–æ–±–∏—Ä–∞—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...")
    
    with db.get_connection() as conn:
        cursor = conn.cursor()
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        cursor.execute('SELECT COUNT(*) FROM users')
        total_users = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM users WHERE role = "seller"')
        sellers = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM users WHERE role = "customer"')
        customers = cursor.fetchone()[0]
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º
        cursor.execute('SELECT COUNT(*) FROM stores')
        total_stores = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM stores WHERE status = "active"')
        approved_stores = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM stores WHERE status = "pending"')
        pending_stores = cursor.fetchone()[0]
    cursor.execute('SELECT COUNT(*) FROM stores WHERE status = "rejected"')
    rejected_stores = cursor.fetchone()[0]
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ—Ä–æ–¥–∞–º
    cursor.execute('SELECT city, COUNT(*) FROM stores GROUP BY city ORDER BY COUNT(*) DESC LIMIT 5')
    top_cities = cursor.fetchall()
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    cursor.execute('SELECT category, COUNT(*) FROM stores GROUP BY category ORDER BY COUNT(*) DESC LIMIT 5')
    top_categories = cursor.fetchall()
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º
    cursor.execute('SELECT COUNT(*) FROM offers')
    total_offers = cursor.fetchone()[0]
    cursor.execute('SELECT COUNT(*) FROM offers WHERE status = "active"')
    active_offers = cursor.fetchone()[0]
    cursor.execute('SELECT SUM(original_price) FROM offers WHERE status = "active"')
    total_original_price = cursor.fetchone()[0] or 0
    cursor.execute('SELECT SUM(discount_price) FROM offers WHERE status = "active"')
    total_discounted_price = cursor.fetchone()[0] or 0
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º
    cursor.execute('SELECT COUNT(*) FROM bookings')
    total_bookings = cursor.fetchone()[0]
    cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "active"')
    active_bookings = cursor.fetchone()[0]
    cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "completed"')
    completed_bookings = cursor.fetchone()[0]
    cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "cancelled"')
    cancelled_bookings = cursor.fetchone()[0]
    cursor.execute('SELECT SUM(quantity) FROM bookings WHERE status IN ("active", "completed")')
    total_quantity = cursor.fetchone()[0] or 0
    
    # –î–æ—Ö–æ–¥ (—ç–∫–æ–Ω–æ–º–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π)
    cursor.execute('''
        SELECT SUM((o.original_price - o.discount_price) * b.quantity)
        FROM bookings b
        JOIN offers o ON b.offer_id = o.offer_id
        WHERE b.status IN ("active", "completed")
    ''')
    total_savings = cursor.fetchone()[0] or 0
    
    # –°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω—ã
    cursor.execute('''
        SELECT s.name, COUNT(b.booking_id) as bookings_count
        FROM stores s
        LEFT JOIN offers o ON s.store_id = o.store_id
        LEFT JOIN bookings b ON o.offer_id = b.offer_id
        WHERE b.status IN ("active", "completed")
        GROUP BY s.store_id
        ORDER BY bookings_count DESC
        LIMIT 5
    ''')
    top_stores = cursor.fetchall()
    
    conn.close()
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
    text = "üìà <b>–î–ï–¢–ê–õ–¨–ù–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê</b>\n\n"
    
    text += "üë• <b>–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò:</b>\n"
    text += f"‚îú –í—Å–µ–≥–æ: {total_users}\n"
    text += f"‚îú –ü–∞—Ä—Ç–Ω—ë—Ä—ã: {sellers}\n"
    text += f"‚îî –ü–æ–∫—É–ø–∞—Ç–µ–ª–∏: {customers}\n\n"
    
    text += "üè™ <b>–ú–ê–ì–ê–ó–ò–ù–´:</b>\n"
    text += f"‚îú –í—Å–µ–≥–æ: {total_stores}\n"
    text += f"‚îú ‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ: {approved_stores}\n"
    text += f"‚îú ‚è≥ –ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏: {pending_stores}\n"
    text += f"‚îî ‚ùå –û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ: {rejected_stores}\n\n"
    
    if top_cities:
        text += "üìç <b>–¢–û–ü –ì–û–†–û–î–ê:</b>\n"
        for city, count in top_cities:
            text += f"‚îú {city}: {count}\n"
        text += "\n"
    
    if top_categories:
        text += "üè∑ <b>–¢–û–ü –ö–ê–¢–ï–ì–û–†–ò–ò:</b>\n"
        for cat, count in top_categories:
            text += f"‚îú {cat}: {count}\n"
        text += "\n"
    
    text += "üì¶ <b>–ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø:</b>\n"
    text += f"‚îú –í—Å–µ–≥–æ: {total_offers}\n"
    text += f"‚îú –ê–∫—Ç–∏–≤–Ω—ã–µ: {active_offers}\n"
    text += f"‚îú –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {int(total_original_price):,} —Å—É–º\n"
    text += f"‚îî –°–æ —Å–∫–∏–¥–∫–æ–π: {int(total_discounted_price):,} —Å—É–º\n\n"
    
    text += "üìã <b>–ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø:</b>\n"
    text += f"‚îú –í—Å–µ–≥–æ: {total_bookings}\n"
    text += f"‚îú ‚è≥ –ê–∫—Ç–∏–≤–Ω—ã–µ: {active_bookings}\n"
    text += f"‚îú ‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ: {completed_bookings}\n"
    text += f"‚îú ‚ùå –û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ: {cancelled_bookings}\n"
    text += f"‚îî –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: {total_quantity} —à—Ç\n\n"
    
    text += f"üí∞ <b>–≠–ö–û–ù–û–ú–ò–Ø –ü–û–ö–£–ü–ê–¢–ï–õ–ï–ô:</b> {int(total_savings):,} —Å—É–º\n\n"
    
    if top_stores:
        text += "üèÜ <b>–¢–û–ü –ú–ê–ì–ê–ó–ò–ù–´:</b>\n"
        for store_name, count in top_stores:
            text += f"‚îú {store_name}: {count} –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π\n"
    
    await bot.send_message(callback.message.chat.id, text, parse_mode="HTML")

@dp.callback_query(F.data == "admin_list_sellers")
async def admin_list_sellers_callback(callback: types.CallbackQuery):
    """–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π"""
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω", show_alert=True)
        return
    
    await callback.answer()
    with db.get_connection() as conn:
        cursor = conn.cursor()
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        cursor.execute('''
            SELECT u.user_id, u.username, u.first_name, u.city, u.created_at,
                   COUNT(DISTINCT s.store_id) as stores_count,
                   COUNT(DISTINCT CASE WHEN s.status = 'active' THEN s.store_id END) as active_stores,
                   COUNT(DISTINCT o.offer_id) as offers_count
            FROM users u
            LEFT JOIN stores s ON u.user_id = s.owner_id
            LEFT JOIN offers o ON s.store_id = o.store_id AND o.status = 'active'
            WHERE u.role = 'seller'
            GROUP BY u.user_id
            ORDER BY active_stores DESC, offers_count DESC
        ''')
        sellers = cursor.fetchall()
    
    if not sellers:
        await bot.send_message(callback.message.chat.id, "üë• –ü—Ä–æ–¥–∞–≤—Ü–æ–≤ –Ω–µ—Ç")
        return
    
    text = f"üë• <b>–°–ø–∏—Å–æ–∫ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ ({len(sellers)}):</b>\n\n"
    
    from aiogram.utils.keyboard import InlineKeyboardBuilder
    kb = InlineKeyboardBuilder()
    
    for user_id, username, first_name, city, created_at, stores_count, active_stores, offers_count in sellers[:20]:
        text += f"üë§ <b>{first_name or '–ë–µ–∑ –∏–º–µ–Ω–∏'}</b>"
        if username:
            text += f" (@{username})"
        text += f"\n"
        text += f"‚îú üìç {city or '–ù–µ —É–∫–∞–∑–∞–Ω'}\n"
        text += f"‚îú üè™ –ú–∞–≥–∞–∑–∏–Ω–æ–≤: {active_stores}/{stores_count}\n"
        text += f"‚îú üì¶ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤: {offers_count}\n"
        text += f"‚îî ID: <code>{user_id}</code>\n"
        
        # –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–æ–≤ –ø–∞—Ä—Ç–Ω—ë—Ä–∞
        if stores_count > 0:
            kb.button(text=f"üóë –£–¥–∞–ª–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω—ã {first_name or user_id}", callback_data=f"admin_delete_user_stores_{user_id}")
        text += "\n"
    
    kb.adjust(1)
    
    if len(sellers) > 20:
        text += f"\n<i>–ü–æ–∫–∞–∑–∞–Ω–æ 20 –∏–∑ {len(sellers)}. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.</i>"
    
    await bot.send_message(callback.message.chat.id, text, parse_mode="HTML", reply_markup=kb.as_markup() if kb.export() else None)

@dp.callback_query(F.data.startswith("admin_delete_user_stores_"))
async def admin_delete_user_stores_callback(callback: types.CallbackQuery):
    user_id = int(callback.data.split("_")[-1])
    
    with db.get_connection() as conn:
        cursor = conn.cursor()
        
        # –ü–æ–ª—É—á–∞–µ–º –º–∞–≥–∞–∑–∏–Ω—ã
        cursor.execute('SELECT store_id FROM stores WHERE owner_id = ?', (user_id,))
        stores = cursor.fetchall()
        
        if not stores:
            await callback.answer("‚ùå –ú–∞–≥–∞–∑–∏–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã", show_alert=True)
            return
        
        # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –º–∞–≥–∞–∑–∏–Ω–æ–≤
        for (store_id,) in stores:
            cursor.execute('DELETE FROM offers WHERE store_id = ?', (store_id,))
        
        # –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã
        cursor.execute('DELETE FROM stores WHERE user_id = ?', (user_id,))
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        cursor.execute('SELECT first_name, username FROM users WHERE user_id = ?', (user_id,))
        user_info = cursor.fetchone()
        
        if not user_info:
            await callback.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
            return
        
        first_name, username = user_info
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤
        cursor.execute('SELECT store_id, name, status FROM stores WHERE owner_id = ?', (user_id,))
        stores = cursor.fetchall()
    
    if not stores:
        await callback.answer("‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –º–∞–≥–∞–∑–∏–Ω–æ–≤", show_alert=True)
        conn.close()
        return
    
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
    from aiogram.utils.keyboard import InlineKeyboardBuilder
    kb = InlineKeyboardBuilder()
    kb.button(text="‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å –≤—Å–µ", callback_data=f"admin_confirm_delete_stores_{user_id}")
    kb.button(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="admin_cancel_action")
    kb.adjust(1)
    
    text = f"‚ö†Ô∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</b>\n\n"
    text += f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {first_name or '–ë–µ–∑ –∏–º–µ–Ω–∏'}"
    if username:
        text += f" (@{username})"
    text += f"\n\n–ú–∞–≥–∞–∑–∏–Ω—ã ({len(stores)}):\n"
    
    for store_id, name, status in stores:
        status_emoji = "‚úÖ" if status == "active" else "‚è≥" if status == "pending" else "‚ùå"
        text += f"{status_emoji} {name}\n"
    
    text += f"\n<b>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?</b>"
    
    conn.close()
    
    await callback.message.edit_text(text, parse_mode="HTML", reply_markup=kb.as_markup())
    await callback.answer()

@dp.callback_query(F.data.startswith("admin_confirm_delete_stores_"))
async def admin_confirm_delete_stores_callback(callback: types.CallbackQuery):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–æ–≤"""
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω", show_alert=True)
        return
    
    user_id = int(callback.data.split("_")[-1])
    
    conn = db.get_connection()
    cursor = conn.cursor()
    
    # –ü–æ–ª—É—á–∞–µ–º –º–∞–≥–∞–∑–∏–Ω—ã
    cursor.execute('SELECT store_id FROM stores WHERE owner_id = ?', (user_id,))
    stores = cursor.fetchall()
    
    if not stores:
        await callback.answer("‚ùå –ú–∞–≥–∞–∑–∏–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã", show_alert=True)
        conn.close()
        return
    
    # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –º–∞–≥–∞–∑–∏–Ω–æ–≤
    for (store_id,) in stores:
        cursor.execute('UPDATE offers SET status = "deleted" WHERE store_id = ?', (store_id,))
    
    # –£–¥–∞–ª—è–µ–º –º–∞–≥–∞–∑–∏–Ω—ã (–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ rejected)
    cursor.execute('UPDATE stores SET status = "rejected" WHERE owner_id = ?', (user_id,))
    
    # –ú–µ–Ω—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ customer
    cursor.execute('UPDATE users SET role = "customer" WHERE user_id = ?', (user_id,))
    
    conn.commit()
    conn.close()
    
    await callback.message.edit_text(
        f"‚úÖ <b>–£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ</b>\n\n"
        f"–£–¥–∞–ª–µ–Ω–æ –º–∞–≥–∞–∑–∏–Ω–æ–≤: {len(stores)}\n"
        f"–í—Å–µ —Ç–æ–≤–∞—Ä—ã —ç—Ç–∏—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã\n"
        f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–≤–µ–¥—ë–Ω –≤ —Ä–æ–ª—å –ø–æ–∫—É–ø–∞—Ç–µ–ª—è",
        parse_mode="HTML"
    )
    await callback.answer("‚úÖ –ú–∞–≥–∞–∑–∏–Ω—ã —É–¥–∞–ª–µ–Ω—ã")

@dp.callback_query(F.data == "admin_cancel_action")
async def admin_cancel_action_callback(callback: types.CallbackQuery):
    """–û—Ç–º–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è"""
    await callback.message.delete()
    await callback.answer("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ")

@dp.callback_query(F.data == "admin_search_user")
async def admin_search_user_callback(callback: types.CallbackQuery):
     """–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
     await callback.answer("üîç –û—Ç–ø—Ä–∞–≤—å—Ç–µ ID –∏–ª–∏ username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞", show_alert=True)

@dp.callback_query(F.data == "admin_approved_stores")
async def admin_approved_stores_callback(callback: types.CallbackQuery):
    """–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤"""
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω", show_alert=True)
        return
    
    await callback.answer()
    with db.get_connection() as conn:
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT s.store_id, s.name, s.city, s.category, u.first_name, u.username,
                   s.created_at, COUNT(o.offer_id) as offers_count
            FROM stores s
            JOIN users u ON s.owner_id = u.user_id
            LEFT JOIN offers o ON s.store_id = o.store_id AND o.status = 'active'
            WHERE s.status = 'active'
            GROUP BY s.store_id
            ORDER BY s.created_at DESC
        ''')
        stores = cursor.fetchall()
    
    if not stores:
        await bot.send_message(callback.message.chat.id, "üè™ –û–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤ –Ω–µ—Ç")
        return
    
    text = f"üè™ <b>–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω—ã ({len(stores)}):</b>\n\n"
    
    from aiogram.utils.keyboard import InlineKeyboardBuilder
    kb = InlineKeyboardBuilder()
    
    for store_id, name, city, category, owner_name, username, created_at, offers_count in stores[:15]:
        text += f"üè™ <b>{name}</b>\n"
        text += f"‚îú üìç {city} | üè∑ {category}\n"
        text += f"‚îú üë§ {owner_name}"
        if username:
            text += f" (@{username})"
        text += f"\n‚îú üì¶ –¢–æ–≤–∞—Ä–æ–≤: {offers_count}\n"
        text += f"‚îî ID: <code>{store_id}</code>\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞
        kb.button(text=f"üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å {name[:15]}", callback_data=f"admin_block_store_{store_id}")
        text += "\n"
    
    kb.adjust(1)
    
    if len(stores) > 15:
        text += f"\n<i>–ü–æ–∫–∞–∑–∞–Ω–æ 15 –∏–∑ {len(stores)}</i>"
    
    await bot.send_message(callback.message.chat.id, text, parse_mode="HTML", reply_markup=kb.as_markup() if kb.export() else None)

@dp.callback_query(F.data.startswith("admin_block_store_"))
async def admin_block_store_callback(callback: types.CallbackQuery):
    """–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞"""
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω", show_alert=True)
        return
    
    store_id = int(callback.data.split("_")[-1])
    
    with db.get_connection() as conn:
        cursor = conn.cursor()
        
        cursor.execute('SELECT name FROM stores WHERE store_id = ?', (store_id,))
        store = cursor.fetchone()
        
        if not store:
            await callback.answer("‚ùå –ú–∞–≥–∞–∑–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
            return
        
        # –ë–ª–æ–∫–∏—Ä—É–µ–º –º–∞–≥–∞–∑–∏–Ω
        cursor.execute('UPDATE stores SET status = "rejected" WHERE store_id = ?', (store_id,))
        
        # –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
        cursor.execute('UPDATE offers SET status = "inactive" WHERE store_id = ?', (store_id,))
    
    await callback.message.edit_text(
        f"üö´ <b>–ú–∞–≥–∞–∑–∏–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</b>\n\n"
        f"–ù–∞–∑–≤–∞–Ω–∏–µ: {store[0]}\n"
        f"ID: {store_id}\n\n"
        f"–í—Å–µ —Ç–æ–≤–∞—Ä—ã —ç—Ç–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã.",
        parse_mode="HTML"
    )
    await callback.answer("‚úÖ –ú–∞–≥–∞–∑–∏–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω")

@dp.callback_query(F.data == "admin_rejected_stores")
async def admin_rejected_stores_callback(callback: types.CallbackQuery):
    """–û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω—ã"""
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω", show_alert=True)
        return
    
    await callback.answer()
    with db.get_connection() as conn:
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT s.store_id, s.name, s.city, u.first_name, u.username, s.created_at
            FROM stores s
            JOIN users u ON s.owner_id = u.user_id
            WHERE s.status = 'rejected'
            ORDER BY s.created_at DESC
            LIMIT 10
        ''')
        stores = cursor.fetchall()
    
    if not stores:
        await bot.send_message(callback.message.chat.id, "üè™ –û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤ –Ω–µ—Ç")
        return
    
    text = f"‚ùå <b>–û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω—ã ({len(stores)}):</b>\n\n"
    
    for store_id, name, city, owner_name, username, created_at in stores:
        text += f"üè™ {name}\n"
        text += f"‚îú üìç {city}\n"
        text += f"‚îú üë§ {owner_name}"
        if username:
            text += f" (@{username})"
        text += f"\n‚îî ID: <code>{store_id}</code>\n\n"
    
    await bot.send_message(callback.message.chat.id, text, parse_mode="HTML")

@dp.callback_query(F.data == "admin_search_store")
async def admin_search_store_callback(callback: types.CallbackQuery):
    """–ü–æ–∏—Å–∫ –º–∞–≥–∞–∑–∏–Ω–∞"""
    await callback.answer("üîç –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ", show_alert=True)

@dp.callback_query(F.data == "admin_all_offers")
async def admin_all_offers_callback(callback: types.CallbackQuery):
    """–î–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤"""
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω", show_alert=True)
        return
    
    await callback.answer()
    with db.get_connection() as conn:
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT o.offer_id, o.title, o.original_price, o.discount_price, o.quantity,
                   s.name as store_name, o.status, o.created_at
            FROM offers o
            JOIN stores s ON o.store_id = s.store_id
            ORDER BY o.created_at DESC
            LIMIT 20
        ''')
        offers = cursor.fetchall()
        
        cursor.execute('SELECT COUNT(*) FROM offers')
        total = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM offers WHERE status = "active"')
        active = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM offers WHERE status = "deleted"')
        deleted = cursor.fetchone()[0]
    
    text = f"üì¶ <b>–í—Å–µ —Ç–æ–≤–∞—Ä—ã</b>\n\n"
    text += f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
    text += f"‚îú –í—Å–µ–≥–æ: {total}\n"
    text += f"‚îú ‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö: {active}\n"
    text += f"‚îî üóë –£–¥–∞–ª—ë–Ω–Ω—ã—Ö: {deleted}\n\n"
    
    if offers:
        text += "<b>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç–æ–≤–∞—Ä—ã:</b>\n\n"
        for offer_id, title, orig, disc, qty, store, status, created in offers[:10]:
            status_emoji = "‚úÖ" if status == "active" else "‚ùå"
            text += f"{status_emoji} <b>{title}</b>\n"
            text += f"‚îú üè™ {store}\n"
            text += f"‚îú üí∞ {int(orig):,} ‚Üí {int(disc):,} —Å—É–º\n"
            text += f"‚îú üì¶ –û—Å—Ç–∞—Ç–æ–∫: {qty}\n"
            text += f"‚îî ID: <code>{offer_id}</code>\n\n"
        
        if len(offers) > 10:
            text += f"<i>–ü–æ–∫–∞–∑–∞–Ω–æ 10 –∏–∑ {len(offers)}</i>"
    
    await bot.send_message(callback.message.chat.id, text, parse_mode="HTML")

@dp.callback_query(F.data == "admin_cleanup_offers")
async def admin_cleanup_offers_callback(callback: types.CallbackQuery):
    """–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö –∏ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤"""
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω", show_alert=True)
        return
    
    await callback.answer()
    with db.get_connection() as conn:
        cursor = conn.cursor()
        
        # –ü–æ–¥—Å—á—ë—Ç –∏—Å—Ç–µ–∫—à–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤
        today = get_uzb_time().strftime('%Y-%m-%d')
        cursor.execute('SELECT COUNT(*) FROM offers WHERE expiry_date < ? AND status = "active"', (today,))
        expired = cursor.fetchone()[0]
        
        cursor.execute('SELECT COUNT(*) FROM offers WHERE status = "deleted"')
        deleted = cursor.fetchone()[0]
    
    text = f"üóë <b>–û—á–∏—Å—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤</b>\n\n"
    text += f"üìä –ù–∞–π–¥–µ–Ω–æ:\n"
    text += f"‚îú ‚è∞ –ò—Å—Ç–µ–∫—à–∏—Ö: {expired}\n"
    text += f"‚îî üóë –£–¥–∞–ª—ë–Ω–Ω—ã—Ö: {deleted}\n\n"
    
    if expired + deleted > 0:
        text += "<i>–§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏</i>"
    else:
        text += "‚úÖ –í—Å–µ —Ç–æ–≤–∞—Ä—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã!"
    
    await bot.send_message(callback.message.chat.id, text, parse_mode="HTML")

@dp.callback_query(F.data == "admin_pending_bookings")
async def admin_pending_bookings_callback(callback: types.CallbackQuery):
    """–î–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π"""
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω", show_alert=True)
        return
    
    await callback.answer()
    with db.get_connection() as conn:
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT b.booking_id, o.title, b.quantity, u.first_name, s.name,
                   b.created_at, (o.original_price - o.discount_price) * b.quantity as savings
            FROM bookings b
            JOIN offers o ON b.offer_id = o.offer_id
            JOIN users u ON b.user_id = u.user_id
            JOIN stores s ON o.store_id = s.store_id
            WHERE b.status = 'active'
            ORDER BY b.created_at DESC
            LIMIT 15
        ''')
        bookings = cursor.fetchall()
        
        cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "active"')
        total = cursor.fetchone()[0]
        
        cursor.execute('SELECT SUM(quantity) FROM bookings WHERE status = "active"')
        total_qty = cursor.fetchone()[0] or 0
    
    text = f"üìã <b>–ê–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</b>\n\n"
    text += f"üìä –í—Å–µ–≥–æ: {total} ({total_qty} —à—Ç.)\n\n"
    
    if bookings:
        for booking_id, title, qty, customer, store, created, savings in bookings[:10]:
            text += f"üé´ <b>{title}</b> ({qty} —à—Ç.)\n"
            text += f"‚îú üë§ {customer}\n"
            text += f"‚îú üè™ {store}\n"
            text += f"‚îú üí∞ –≠–∫–æ–Ω–æ–º–∏—è: {int(savings):,} —Å—É–º\n"
            text += f"‚îî ID: <code>{booking_id}</code>\n\n"
        
        if len(bookings) > 10:
            text += f"<i>–ü–æ–∫–∞–∑–∞–Ω–æ 10 –∏–∑ {len(bookings)}</i>"
    else:
        text += "üì≠ –ê–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –Ω–µ—Ç"
    
    await bot.send_message(callback.message.chat.id, text, parse_mode="HTML")

@dp.callback_query(F.data == "admin_completed_bookings")
async def admin_completed_bookings_callback(callback: types.CallbackQuery):
    """–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω", show_alert=True)
        return
    
    await callback.answer()
    with db.get_connection() as conn:
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT b.booking_id, o.title, b.quantity, u.first_name, s.name,
                   b.created_at, (o.original_price - o.discount_price) * b.quantity as savings
            FROM bookings b
            JOIN offers o ON b.offer_id = o.offer_id
            JOIN users u ON b.user_id = u.user_id
            JOIN stores s ON o.store_id = s.store_id
            WHERE b.status = 'completed'
            ORDER BY b.created_at DESC
            LIMIT 10
        ''')
        bookings = cursor.fetchall()
        
        cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "completed"')
        total = cursor.fetchone()[0]
        
        cursor.execute('''
            SELECT SUM((o.original_price - o.discount_price) * b.quantity)
            FROM bookings b
            JOIN offers o ON b.offer_id = o.offer_id
            WHERE b.status = 'completed'
        ''')
        total_savings = cursor.fetchone()[0] or 0
    
    text = f"‚úÖ <b>–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</b>\n\n"
    text += f"üìä –í—Å–µ–≥–æ: {total}\n"
    text += f"üí∞ –û–±—â–∞—è —ç–∫–æ–Ω–æ–º–∏—è: {int(total_savings):,} —Å—É–º\n\n"
    
    if bookings:
        for booking_id, title, qty, customer, store, created, savings in bookings[:8]:
            text += f"‚úÖ {title} ({qty} —à—Ç.)\n"
            text += f"‚îú {customer} | {store}\n"
            text += f"‚îî üí∞ {int(savings):,} —Å—É–º\n\n"
        
        if len(bookings) > 8:
            text += f"<i>–ü–æ–∫–∞–∑–∞–Ω–æ 8 –∏–∑ {len(bookings)}</i>"
    else:
        text += "üì≠ –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –Ω–µ—Ç"
    
    await bot.send_message(callback.message.chat.id, text, parse_mode="HTML")

@dp.callback_query(F.data == "admin_bookings_stats")
async def admin_bookings_stats_callback(callback: types.CallbackQuery):
    """–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π"""
    if not db.is_admin(callback.from_user.id):
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω", show_alert=True)
        return
    
    await callback.answer()
    with db.get_connection() as conn:
        cursor = conn.cursor()
        
        # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        cursor.execute('SELECT COUNT(*) FROM bookings')
        total = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "active"')
        active = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "completed"')
        completed = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "cancelled"')
        cancelled = cursor.fetchone()[0]
        
        # –≠–∫–æ–Ω–æ–º–∏—è
        cursor.execute('''
            SELECT SUM((o.original_price - o.discount_price) * b.quantity)
            FROM bookings b
            JOIN offers o ON b.offer_id = o.offer_id
        ''')
        total_savings = cursor.fetchone()[0] or 0
    
    # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    cursor.execute('SELECT COUNT(*) FROM bookings')
    total = cursor.fetchone()[0]
    cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "active"')
    active = cursor.fetchone()[0]
    cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "completed"')
    completed = cursor.fetchone()[0]
    cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "cancelled"')
    cancelled = cursor.fetchone()[0]
    
    # –≠–∫–æ–Ω–æ–º–∏—è
    cursor.execute('''
        SELECT SUM((o.original_price - o.discount_price) * b.quantity)
        FROM bookings b
        JOIN offers o ON b.offer_id = o.offer_id
        WHERE b.status IN ('active', 'completed')
    ''')
    total_savings = cursor.fetchone()[0] or 0
    
    # –¢–æ–ø –º–∞–≥–∞–∑–∏–Ω–æ–≤ –ø–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º
    cursor.execute('''
        SELECT s.name, COUNT(b.booking_id) as cnt
        FROM bookings b
        JOIN offers o ON b.offer_id = o.offer_id
        JOIN stores s ON o.store_id = s.store_id
        WHERE b.status IN ('active', 'completed')
        GROUP BY s.store_id
        ORDER BY cnt DESC
        LIMIT 5
    ''')
    top_stores = cursor.fetchall()
    
    # –¢–æ–ø –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π
    cursor.execute('''
        SELECT u.first_name, COUNT(b.booking_id) as cnt
        FROM bookings b
        JOIN users u ON b.user_id = u.user_id
        GROUP BY u.user_id
        ORDER BY cnt DESC
        LIMIT 5
    ''')
    top_customers = cursor.fetchall()
    
    conn.close()
    
    text = f"üìã <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</b>\n\n"
    text += f"üìä <b>–û–±—â–µ–µ:</b>\n"
    text += f"‚îú –í—Å–µ–≥–æ: {total}\n"
    text += f"‚îú ‚è≥ –ê–∫—Ç–∏–≤–Ω—ã—Ö: {active}\n"
    text += f"‚îú ‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö: {completed}\n"
    text += f"‚îî ‚ùå –û—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö: {cancelled}\n\n"
    
    text += f"üí∞ <b>–≠–∫–æ–Ω–æ–º–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π:</b> {int(total_savings):,} —Å—É–º\n\n"
    
    if top_stores:
        text += "üèÜ <b>–¢–æ–ø –º–∞–≥–∞–∑–∏–Ω—ã:</b>\n"
        for name, cnt in top_stores:
            text += f"‚îú {name}: {cnt}\n"
        text += "\n"
    
    if top_customers:
        text += "üë• <b>–¢–æ–ø –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏:</b>\n"
        for name, cnt in top_customers:
            text += f"‚îú {name or '–ë–µ–∑ –∏–º–µ–Ω–∏'}: {cnt}\n"
    
    await bot.send_message(callback.message.chat.id, text, parse_mode="HTML")

# ============== –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ - –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ) ==============

@dp.message(F.text == "üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞")
async def admin_analytics(message: types.Message):
    await message.answer("‚è≥ –°–æ–±–∏—Ä–∞—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...")
    
    with db.get_connection() as conn:
        cursor = conn.cursor()
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        cursor.execute('SELECT COUNT(*) FROM users')
        total_users = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM users WHERE role = "seller"')
        sellers = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM users WHERE role = "customer"')
        customers = cursor.fetchone()[0]
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º
        cursor.execute('SELECT COUNT(*) FROM stores')
        total_stores = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM stores WHERE status = "active"')
        approved_stores = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM stores WHERE status = "pending"')
        pending_stores = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM stores WHERE status = "rejected"')
        rejected_stores = cursor.fetchone()[0]
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ—Ä–æ–¥–∞–º
        cursor.execute('SELECT city, COUNT(*) FROM stores GROUP BY city ORDER BY COUNT(*) DESC LIMIT 5')
        top_cities = cursor.fetchall()
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        cursor.execute('SELECT category, COUNT(*) FROM stores GROUP BY category ORDER BY COUNT(*) DESC LIMIT 5')
        top_categories = cursor.fetchall()
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º
        cursor.execute('SELECT COUNT(*) FROM offers')
        total_offers = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM offers WHERE status = "active"')
        active_offers = cursor.fetchone()[0]
        cursor.execute('SELECT SUM(original_price) FROM offers WHERE status = "active"')
        total_original_price = cursor.fetchone()[0] or 0
        cursor.execute('SELECT SUM(discount_price) FROM offers WHERE status = "active"')
        total_discounted_price = cursor.fetchone()[0] or 0
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º
        cursor.execute('SELECT COUNT(*) FROM bookings')
        total_bookings = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "active"')
        active_bookings = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "completed"')
        completed_bookings = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "cancelled"')
        cancelled_bookings = cursor.fetchone()[0]
        cursor.execute('SELECT SUM(quantity) FROM bookings WHERE status IN ("active", "completed")')
        total_quantity = cursor.fetchone()[0] or 0
        
        # –î–æ—Ö–æ–¥ (—ç–∫–æ–Ω–æ–º–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π)
        cursor.execute('''
            SELECT SUM((o.original_price - o.discount_price) * b.quantity)
            FROM bookings b
            JOIN offers o ON b.offer_id = o.offer_id
            WHERE b.status IN ("active", "completed")
        ''')
        total_savings = cursor.fetchone()[0] or 0
        
        # –°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω—ã
        cursor.execute('''
            SELECT s.name, COUNT(b.booking_id) as bookings_count
            FROM stores s
            LEFT JOIN offers o ON s.store_id = o.store_id
            LEFT JOIN bookings b ON o.offer_id = b.offer_id
            WHERE b.status IN ("active", "completed")
            GROUP BY s.store_id
            ORDER BY bookings_count DESC
            LIMIT 5
        ''')
        top_stores = cursor.fetchall()
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç
    """–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã"""
    lang = 'ru'
    if not db.is_admin(message.from_user.id):
        await message.answer(get_text(lang, 'access_denied'))
        return
    
    await message.answer("‚è≥ –°–æ–±–∏—Ä–∞—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...")
    
    with db.get_connection() as conn:
        cursor = conn.cursor()
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        cursor.execute('SELECT COUNT(*) FROM users')
        total_users = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM users WHERE role = "seller"')
        sellers = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM users WHERE role = "customer"')
        customers = cursor.fetchone()[0]
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º
        cursor.execute('SELECT COUNT(*) FROM stores')
        total_stores = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM stores WHERE status = "active"')
        approved_stores = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM stores WHERE status = "pending"')
        pending_stores = cursor.fetchone()[0]
        cursor.execute('SELECT COUNT(*) FROM stores WHERE status = "rejected"')
        rejected_stores = cursor.fetchone()[0]
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ—Ä–æ–¥–∞–º
    cursor.execute('SELECT city, COUNT(*) FROM stores GROUP BY city ORDER BY COUNT(*) DESC LIMIT 5')
    top_cities = cursor.fetchall()
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    cursor.execute('SELECT category, COUNT(*) FROM stores GROUP BY category ORDER BY COUNT(*) DESC LIMIT 5')
    top_categories = cursor.fetchall()
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º
    cursor.execute('SELECT COUNT(*) FROM offers')
    total_offers = cursor.fetchone()[0]
    cursor.execute('SELECT COUNT(*) FROM offers WHERE status = "active"')
    active_offers = cursor.fetchone()[0]
    cursor.execute('SELECT SUM(original_price) FROM offers WHERE status = "active"')
    total_original_price = cursor.fetchone()[0] or 0
    cursor.execute('SELECT SUM(discount_price) FROM offers WHERE status = "active"')
    total_discounted_price = cursor.fetchone()[0] or 0
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º
    cursor.execute('SELECT COUNT(*) FROM bookings')
    total_bookings = cursor.fetchone()[0]
    cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "active"')
    active_bookings = cursor.fetchone()[0]
    cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "completed"')
    completed_bookings = cursor.fetchone()[0]
    cursor.execute('SELECT COUNT(*) FROM bookings WHERE status = "cancelled"')
    cancelled_bookings = cursor.fetchone()[0]
    cursor.execute('SELECT SUM(quantity) FROM bookings WHERE status IN ("active", "completed")')
    total_quantity = cursor.fetchone()[0] or 0
    
    # –î–æ—Ö–æ–¥ (—ç–∫–æ–Ω–æ–º–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π)
    cursor.execute('''
        SELECT SUM((o.original_price - o.discount_price) * b.quantity)
        FROM bookings b
        JOIN offers o ON b.offer_id = o.offer_id
        WHERE b.status IN ("active", "completed")
    ''')
    total_savings = cursor.fetchone()[0] or 0
    
    # –°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω—ã
    cursor.execute('''
        SELECT s.name, COUNT(b.booking_id) as bookings_count
        FROM stores s
        LEFT JOIN offers o ON s.store_id = o.store_id
        LEFT JOIN bookings b ON o.offer_id = b.offer_id
        WHERE b.status IN ("active", "completed")
        GROUP BY s.store_id
        ORDER BY bookings_count DESC
        LIMIT 5
    ''')
    top_stores = cursor.fetchall()
    
    conn.close()
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç
    text = "üìà <b>–ü–û–õ–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´</b>\n\n"
    
    text += "üë• <b>–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò</b>\n"
    text += f"–í—Å–µ–≥–æ: {total_users}\n"
    text += f"üè™ –ü–∞—Ä—Ç–Ω–µ—Ä–æ–≤: {sellers}\n"
    text += f"üõç –ü–æ–∫—É–ø–∞—Ç–µ–ª–µ–π: {customers}\n\n"
    
    text += "üè™ <b>–ú–ê–ì–ê–ó–ò–ù–´</b>\n"
    text += f"–í—Å–µ–≥–æ: {total_stores}\n"
    text += f"‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ: {approved_stores}\n"
    text += f"‚è≥ –ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏: {pending_stores}\n"
    text += f"‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ: {rejected_stores}\n\n"
    
    if top_cities:
        text += "üìç <b>–¢–û–ü-5 –ì–û–†–û–î–û–í</b>\n"
        for city, count in top_cities:
            text += f"‚Ä¢ {city}: {count}\n"
        text += "\n"
    
    if top_categories:
        text += "üè∑ <b>–¢–û–ü-5 –ö–ê–¢–ï–ì–û–†–ò–ô</b>\n"
        for category, count in top_categories:
            text += f"‚Ä¢ {category}: {count}\n"
        text += "\n"
    
    text += "üçΩ <b>–ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø</b>\n"
    text += f"–í—Å–µ–≥–æ: {total_offers}\n"
    text += f"‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö: {active_offers}\n"
    text += f"üí∞ –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {int(total_original_price):,} —Å—É–º\n"
    text += f"üí∏ –°–æ —Å–∫–∏–¥–∫–æ–π: {int(total_discounted_price):,} —Å—É–º\n\n"
    
    text += "üìã <b>–ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø</b>\n"
    text += f"–í—Å–µ–≥–æ: {total_bookings}\n"
    text += f"‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö: {active_bookings}\n"
    text += f"‚úîÔ∏è –ó–∞–≤–µ—Ä—à–µ–Ω: {completed_bookings}\n"
    text += f"‚ùå –û—Ç–º–µ–Ω–µ–Ω: {cancelled_bookings}\n"
    text += f"üì¶ –¢–æ–≤–∞—Ä–æ–≤ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ: {total_quantity} —à—Ç\n"
    text += f"üí∞ –≠–∫–æ–Ω–æ–º–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π: {int(total_savings):,} —Å—É–º\n\n"
    
    if top_stores:
        text += "üèÜ <b>–¢–û–ü-5 –ú–ê–ì–ê–ó–ò–ù–û–í</b>\n"
        for store_name, bookings_count in top_stores:
            text += f"‚Ä¢ {store_name}: {bookings_count} –∑–∞–∫–∞–∑–æ–≤\n"
    
    await message.answer(text, parse_mode="HTML")
    
    # –°–æ–∑–¥–∞—ë–º CSV —Ñ–∞–π–ª
    import csv
    from datetime import datetime
    from aiogram.types import FSInputFile
    
    filename = f"statistics_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
    
    with open(filename, 'w', encoding='utf-8-sig', newline='') as f:
        writer = csv.writer(f)
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        writer.writerow(['–ü–û–õ–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê FUDLY'])
        writer.writerow(['–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è', datetime.now().strftime('%Y-%m-%d %H:%M:%S')])
        writer.writerow([])
        
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        writer.writerow(['–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò'])
        writer.writerow(['–í—Å–µ–≥–æ', total_users])
        writer.writerow(['–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤', sellers])
        writer.writerow(['–ü–æ–∫—É–ø–∞—Ç–µ–ª–µ–π', customers])
        writer.writerow([])
        
        # –ú–∞–≥–∞–∑–∏–Ω—ã
        writer.writerow(['–ú–ê–ì–ê–ó–ò–ù–´'])
        writer.writerow(['–í—Å–µ–≥–æ', total_stores])
        writer.writerow(['–û–¥–æ–±—Ä–µ–Ω–æ', approved_stores])
        writer.writerow(['–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏', pending_stores])
        writer.writerow(['–û—Ç–∫–ª–æ–Ω–µ–Ω–æ', rejected_stores])
        writer.writerow([])
        
        # –ì–æ—Ä–æ–¥–∞
        if top_cities:
            writer.writerow(['–¢–û–ü –ì–û–†–û–î–ê'])
            writer.writerow(['–ì–æ—Ä–æ–¥', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'])
            for city, count in top_cities:
                writer.writerow([city, count])
            writer.writerow([])
        
        # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
        if top_categories:
            writer.writerow(['–¢–û–ü –ö–ê–¢–ï–ì–û–†–ò–ò'])
            writer.writerow(['–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'])
            for category, count in top_categories:
                writer.writerow([category, count])
            writer.writerow([])
        
        # –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
        writer.writerow(['–ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø'])
        writer.writerow(['–í—Å–µ–≥–æ', total_offers])
        writer.writerow(['–ê–∫—Ç–∏–≤–Ω—ã—Ö', active_offers])
        writer.writerow(['–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (—Å—É–º)', int(total_original_price)])
        writer.writerow(['–°–æ —Å–∫–∏–¥–∫–æ–π (—Å—É–º)', int(total_discounted_price)])
        writer.writerow([])
        
        # –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        writer.writerow(['–ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø'])
        writer.writerow(['–í—Å–µ–≥–æ', total_bookings])
        writer.writerow(['–ê–∫—Ç–∏–≤–Ω—ã—Ö', active_bookings])
        writer.writerow(['–ó–∞–≤–µ—Ä—à–µ–Ω–æ', completed_bookings])
        writer.writerow(['–û—Ç–º–µ–Ω–µ–Ω–æ', cancelled_bookings])
        writer.writerow(['–¢–æ–≤–∞—Ä–æ–≤ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ', total_quantity])
        writer.writerow(['–≠–∫–æ–Ω–æ–º–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π (—Å—É–º)', int(total_savings)])
        writer.writerow([])
        
        # –¢–æ–ø –º–∞–≥–∞–∑–∏–Ω—ã
        if top_stores:
            writer.writerow(['–¢–û–ü –ú–ê–ì–ê–ó–ò–ù–´'])
            writer.writerow(['–ù–∞–∑–≤–∞–Ω–∏–µ', '–ó–∞–∫–∞–∑–æ–≤'])
            for store_name, bookings_count in top_stores:
                writer.writerow([store_name, bookings_count])
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
    document = FSInputFile(filename)
    await message.answer_document(
        document=document,
        caption="üìä –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV"
    )
    
    # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
    import os
    os.remove(filename)

@dp.message(F.text == "üè™ –ó–∞—è–≤–∫–∏ –Ω–∞ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ")
async def admin_pending_stores(message: types.Message):
    lang = 'ru'  # –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
    if not db.is_admin(message.from_user.id):
        await message.answer(get_text(lang, 'access_denied'))
        return
    
    pending = db.get_pending_stores()
    
    if not pending:
        await message.answer(get_text(lang, 'no_pending_stores'))
        return
    
    await message.answer(get_text(lang, 'pending_stores_count', count=len(pending)))
    
    for store in pending:
        text = f"üè™ <b>{store[2]}</b>\n\n"
        text += f"–û—Ç: {store[8]} (@{store[9] or '–Ω–µ—Ç'})\n"
        text += f"ID: <code>{store[1]}</code>\n\n"
        text += f"üìç {store[3]}, {store[4]}\n"
        text += f"üè∑ {store[6]}\n"
        text += f"üì± {store[7]}\n"
        text += f"üìù {store[5]}\n"
        text += f"üìÖ {store[10]}"
        
        await message.answer(
            text,
            parse_mode="HTML",
            reply_markup=moderation_keyboard(store[0])
        )
        await asyncio.sleep(0.3)

@dp.callback_query(F.data.startswith("approve_"))
async def approve_store(callback: types.CallbackQuery):
    lang = 'ru'  # –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º
    if not db.is_admin(callback.from_user.id):
        await callback.answer(get_text(lang, 'access_denied'), show_alert=True)
        return
    
    store_id = int(callback.data.split("_")[2])
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω–∞ –¥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è
    store = db.get_store(store_id)
    if not store:
        await callback.answer("‚ùå –ú–∞–≥–∞–∑–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return
    
    owner_id = get_store_field(store, 'owner_id')
    store_name = get_store_field(store, 'name')
    
    # –û–¥–æ–±—Ä—è–µ–º –º–∞–≥–∞–∑–∏–Ω (–≤–∫–ª—é—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞)
    success = db.approve_store(store_id)
    
    if success:
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞
        try:
            owner_lang = db.get_user_language(owner_id)
            await bot.send_message(
                owner_id,
                get_text(owner_lang, 'store_approved'),
                parse_mode="HTML",
                reply_markup=main_menu_seller(owner_lang)
            )
        except Exception as e:
            logger.error(f"Failed to notify store owner {owner_id}: {e}")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        await callback.message.edit_text(
            callback.message.text + "\n\n‚úÖ <b>–û–î–û–ë–†–ï–ù–û</b>",
            parse_mode="HTML"
        )
        await callback.answer(f"‚úÖ –ú–∞–≥–∞–∑–∏–Ω '{store_name}' –æ–¥–æ–±—Ä–µ–Ω!")
    else:
        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞", show_alert=True)

@dp.callback_query(F.data.startswith("reject_"))
async def reject_store(callback: types.CallbackQuery):
    lang = 'ru'  # –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º
    if not db.is_admin(callback.from_user.id):
        await callback.answer(get_text(lang, 'access_denied'), show_alert=True)
        return
    
    store_id = int(callback.data.split("_")[2])
    db.reject_store(store_id, "–ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º")
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞
    store = db.get_store(store_id)
    if store:
        owner_id = store[1]
        try:
            owner_lang = db.get_user_language(owner_id)
            await bot.send_message(
                owner_id,
                get_text(owner_lang, 'store_rejected'),
                parse_mode="HTML"
            )
        except Exception:
            pass
    
    await callback.message.edit_text(
        callback.message.text + "\n\n‚ùå <b>–û–¢–ö–õ–û–ù–ï–ù–û</b>",
        parse_mode="HTML"
    )
    await callback.answer(get_text(lang, 'store_rejected_admin'))

@dp.message(F.text == "üìã –í—Å–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è")
async def admin_all_offers(message: types.Message):
    lang = 'ru'
    if not db.is_admin(message.from_user.id):
        await message.answer(get_text(lang, 'access_denied'))
        return
    
    offers = db.get_active_offers()
    if not offers:
        await message.answer(f"üìã <b>{get_text(lang, 'all_offers')}</b>\n\n{get_text(lang, 'no_active_offers')}", parse_mode="HTML")
        return
    
    text = f"üìã <b>{get_text(lang, 'all_offers')} ({len(offers)})</b>\n\n"
    
    for i, offer in enumerate(offers[:10]):  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 10
        discount_percent = int((1 - offer[5] / offer[4]) * 100) if offer[4] > 0 else 0
        
        # –ü–æ–ª—É—á–∞–µ–º –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
        # unit –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ [13] –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        # –ü–æ—Å–ª–µ JOIN —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: [0-12] offers –±–∞–∑–æ–≤—ã–µ, [13]unit (–µ—Å–ª–∏ –µ—Å—Ç—å), [14]category (–µ—Å–ª–∏ –µ—Å—Ç—å)
        # [15] –∏–ª–∏ [13]store_name, [16] –∏–ª–∏ [14]address, [17] –∏–ª–∏ [15]city
        if len(offer) >= 19:
            # –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å unit/category
            unit = offer[13] if offer[13] else '—à—Ç'
        else:
            # –°—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–µ–∑ unit/category
            unit = '—à—Ç'
        
        text += f"{i+1}. <b>{offer[2]}</b>\n"
        text += f"   üí∞ {int(offer[4]):,} ‚ûú {int(offer[5]):,} —Å—É–º (-{discount_percent}%)\n"
        text += f"   üì¶ {offer[6]} {unit}\n"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏
        if len(offer) > 12 and offer[12]:
            text += f"   üìÖ –î–æ: {offer[12]}\n"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–≥–∞–∑–∏–Ω (–∏–Ω–¥–µ–∫—Å—ã –¥–ª—è JOIN: 15-store_name, 17-city)
        if len(offer) > 17:
            # –ò–Ω–¥–µ–∫—Å—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –Ω–∞–ª–∏—á–∏—è unit/category
            if len(offer) >= 19:
                # –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: [15]store_name, [17]city
                store_name = offer[15] if len(offer) > 15 else ""
                city = offer[17] if len(offer) > 17 else ""
            else:
                # –°—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: [13]store_name, [15]city
                store_name = offer[13] if len(offer) > 13 else ""
                city = offer[15] if len(offer) > 15 else ""
            if store_name or city:
                text += f"üè™ {store_name} ({city})\n"
        text += "\n"
    
    if len(offers) > 10:
        text += f"... –∏ –µ—â–µ {len(offers) - 10} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π"
    
    await message.answer(text, parse_mode="HTML")

@dp.message(F.text == "üè™ –í—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã")
async def admin_all_stores(message: types.Message):
    lang = 'ru'
    if not db.is_admin(message.from_user.id):
        await message.answer(get_text(lang, 'access_denied'))
        return
    
    with db.get_connection() as conn:
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM stores ORDER BY created_at DESC')
        stores = cursor.fetchall()
    
    if not stores:
        await message.answer("–ú–∞–≥–∞–∑–∏–Ω–æ–≤ –Ω–µ—Ç")
        return
    
    await message.answer(f"üè™ <b>–í—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã ({len(stores)})</b>", parse_mode="HTML")
    
    for store in stores[:20]:
        status_emoji = {
            'active': '‚úÖ',
            'approved': '‚úÖ',
            'pending': '‚è≥',
            'rejected': '‚ùå'
        }.get(store[8], '‚ùì')
        
        text = f"{status_emoji} <b>{store[2]}</b>\n"
        text += f"ID: {store[0]}\n"
        text += f"üìç {store[3]}, {store[4]}\n"
        text += f"üè∑ {store[6]}\n"
        text += f"–°—Ç–∞—Ç—É—Å: {store[8]}"
        
        # –°–æ–∑–¥–∞–µ–º inline –∫–Ω–æ–ø–∫—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        from aiogram.utils.keyboard import InlineKeyboardBuilder
        builder = InlineKeyboardBuilder()
        builder.button(text="üóë –£–¥–∞–ª–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω", callback_data=f"delete_store_{store[0]}")
        
        await message.answer(text, parse_mode="HTML", reply_markup=builder.as_markup())
        await asyncio.sleep(0.2)

@dp.callback_query(F.data.startswith("delete_store_"))
async def delete_store_callback(request: types.CallbackQuery):
    lang = 'ru'
    if not db.is_admin(request.from_user.id):
        await request.answer(get_text(lang, 'access_denied'), show_alert=True)
        return
    
    store_id = int(request.data.split("_")[2])
    
    try:
        db.delete_store(store_id)
        await request.message.edit_text(
            request.message.text + "\n\nüóë <b>–£–î–ê–õ–ï–ù–û</b>",
            parse_mode="HTML"
        )
        await request.answer("‚úÖ –ú–∞–≥–∞–∑–∏–Ω —É–¥–∞–ª—ë–Ω!")
    except Exception as e:
        await request.answer(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}", show_alert=True)

@dp.message(F.text == "üì¢ –†–∞—Å—Å—ã–ª–∫–∞")
async def admin_broadcast(message: types.Message):
    lang = 'ru'
    if not db.is_admin(message.from_user.id):
        await message.answer(get_text(lang, 'access_denied'))
        return
    
    await message.answer("üì¢ –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")

@dp.message(F.text == "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
async def admin_settings(message: types.Message):
    lang = 'ru'
    if not db.is_admin(message.from_user.id):
        await message.answer(get_text(lang, 'access_denied'))
        return
    
    await message.answer("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–¥–º–∏–Ω–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")

# ============== –ê–î–ú–ò–ù–°–ö–ò–ï –ö–û–ú–ê–ù–î–´ –î–õ–Ø –ú–ò–ì–†–ê–¶–ò–ò ==============

@dp.message(Command("migrate_db"))
async def cmd_migrate_db(message: types.Message):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)"""
    if message.from_user.id != ADMIN_ID:
        await message.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return
    
    try:
        if DATABASE_URL:
            await message.answer("‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è PostgreSQL.\n–ë–î –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ.")
            return
        
        await message.answer("üîÑ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
        
        # –ü–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–∑–æ–≤–∞ init_db
        temp_db = Database(db.db_name)
        
        await message.answer("‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü:")
        
        conn = sqlite3.connect(db.db_name)
        cursor = conn.cursor()
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
        tables = cursor.fetchall()
        conn.close()
        
        tables_text = "\n".join([f"‚úÖ {t[0]}" for t in tables])
        await message.answer(f"üìä –¢–∞–±–ª–∏—Ü—ã –≤ –ë–î:\n{tables_text}")
        
    except Exception as e:
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: {e}")

@dp.message(Command("enable_delivery"))
async def cmd_enable_delivery(message: types.Message):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –≤—Å–µ—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)"""
    if message.from_user.id != ADMIN_ID:
        await message.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return
    
    try:
        if DATABASE_URL:
            await message.answer("‚ö†Ô∏è –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å SQLite.\n–î–ª—è PostgreSQL –¥–æ—Å—Ç–∞–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.")
            return
        
        await message.answer("üîÑ –í–∫–ª—é—á–∞—é –¥–æ—Å—Ç–∞–≤–∫—É –¥–ª—è –≤—Å–µ—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤...")
        
        conn = sqlite3.connect(db.db_name)
        cursor = conn.cursor()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã stores –∏ –ø–æ–ª–µ–π –¥–æ—Å—Ç–∞–≤–∫–∏
        cursor.execute("PRAGMA table_info(stores)")
        columns = [col[1] for col in cursor.fetchall()]
        
        if 'delivery_enabled' not in columns:
            await message.answer("‚ùå –¢–∞–±–ª–∏—Ü–∞ stores –Ω–µ –∏–º–µ–µ—Ç –ø–æ–ª–µ–π –¥–æ—Å—Ç–∞–≤–∫–∏. –ó–∞–ø—É—Å—Ç–∏—Ç–µ /migrate_db")
            conn.close()
            return
        
        # –í–∫–ª—é—á–∞–µ–º –¥–æ—Å—Ç–∞–≤–∫—É
        cursor.execute('''
            UPDATE stores 
            SET delivery_enabled = 1,
                delivery_price = 15000,
                min_order_amount = 30000
            WHERE delivery_enabled = 0
        ''')
        updated = cursor.rowcount
        conn.commit()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        cursor.execute('SELECT store_id, name, delivery_enabled FROM stores')
        stores = cursor.fetchall()
        conn.close()
        
        result = f"‚úÖ –î–æ—Å—Ç–∞–≤–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞ –¥–ª—è {updated} –º–∞–≥–∞–∑–∏–Ω–∞(–æ–≤)\n\n"
        result += "üìä –°—Ç–∞—Ç—É—Å –º–∞–≥–∞–∑–∏–Ω–æ–≤:\n"
        for store in stores:
            status = "‚úÖ" if store[2] else "‚ùå"
            result += f"{status} {store[1]} (ID: {store[0]})\n"
        
        await message.answer(result)
        
    except Exception as e:
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞: {e}")

# ============== –û–¢–õ–ê–î–ö–ê - –ù–ï–ò–ó–í–ï–°–¢–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ==============

@dp.message(F.photo)
async def unexpected_photo_handler(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–æ—Ç–æ –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Railway)"""
    lang = db.get_user_language(message.from_user.id)
    current_state = await state.get_state()
    
    logger.warning(f"‚ö†Ô∏è User {message.from_user.id} sent photo without FSM state (current: {current_state})")
    print(f"[DEBUG] ‚ö†Ô∏è Unexpected photo from {message.from_user.id}, state: {current_state}")
    
    # –û–±—ä—è—Å–Ω—è–µ–º —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∏ –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å
    await message.answer(
        "‚ö†Ô∏è " + (
            "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –ø–æ—Ç–µ—Ä—è–Ω—ã.\n\n"
            "–≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –µ—Å–ª–∏:\n"
            "‚Ä¢ –ü—Ä–æ—à–ª–æ –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –º–µ–∂–¥—É —à–∞–≥–∞–º–∏\n"
            "‚Ä¢ –°–µ—Ä–≤–µ—Ä –±—ã–ª –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∑–∞–Ω–æ–≤–æ:\n"
            "1. –û—Ç–∫—Ä–æ–π—Ç–µ üî• –ì–æ—Ä—è—á–µ–µ –∏–ª–∏ üìç –ú–µ—Å—Ç–∞\n"
            "2. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä\n"
            "3. –ù–∞–∂–º–∏—Ç–µ üöö –ó–∞–∫–∞–∑–∞—Ç—å —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π"
            if lang == 'ru' else
            "‚ö†Ô∏è Xatolik: buyurtma ma'lumotlari yo'qoldi.\n\n"
            "Bu quyidagi hollarda sodir bo'lishi mumkin:\n"
            "‚Ä¢ Qadamlar orasida ko'p vaqt o'tdi\n"
            "‚Ä¢ Server qayta ishga tushirildi\n\n"
            "Iltimos, buyurtmani qaytadan boshlang:\n"
            "1. üî• Issiq yoki üìç Joylar ni oching\n"
            "2. Mahsulotni tanlang\n"
            "3. üöö Yetkazib berish bilan tugmasini bosing"
        ),
        reply_markup=get_appropriate_menu(message.from_user.id, lang)
    )

@dp.message(F.text)
async def unknown_message_debug(message: types.Message, state: FSMContext):
    """–û—Ç–ª–∞–¥–æ—á–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    lang = db.get_user_language(message.from_user.id)
    current_state = await state.get_state()
    
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —á–∏—Å–ª–æ, –Ω–æ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è - –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º
    if message.text.isdigit():
        hint_ru = "–ß—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä –ø–æ –Ω–æ–º–µ—Ä—É, —Å–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É üî• –ì–æ—Ä—è—á–µ–µ –∏–ª–∏ üìç –ú–µ—Å—Ç–∞"
        hint_uz = "Mahsulotni raqam bo'yicha tanlash uchun avval üî• Issiq yoki üìç Joylar tugmasidan mahsulotlar ro'yxatini oching"
        await message.answer(hint_ru if lang == 'ru' else hint_uz)
    else:
        # –ü—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –±–µ–∑ —Å–ø–∞–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        print(f"‚ö†Ô∏è –ù–ï–ò–ó–í–ï–°–¢–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï –æ—Ç {message.from_user.id}: '{message.text}' (—Å–æ—Å—Ç–æ—è–Ω–∏–µ: {current_state})")

# ============== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==============

# ============================================
# –§–û–ù–û–í–ê–Ø –ó–ê–î–ê–ß–ê - –£–î–ê–õ–ï–ù–ò–ï –ò–°–¢–ï–ö–®–ò–• –¢–û–í–ê–†–û–í
# ============================================

async def cleanup_expired_offers():
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç–µ–∫—à–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π"""
    while True:
        try:
            await asyncio.sleep(300)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (300 —Å–µ–∫—É–Ω–¥)
            deleted_count = db.delete_expired_offers()
            if deleted_count > 0:
                print(f"üóë –£–¥–∞–ª–µ–Ω–æ –∏—Å—Ç–µ–∫—à–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: {deleted_count}")
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏—Å—Ç–µ–∫—à–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤: {e}")

# ============================================
# –ó–ê–ü–£–°–ö –ë–û–¢–ê
# ============================================

async def on_startup():
    """–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞"""
    if USE_WEBHOOK:
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º webhook
        webhook_url = f"{WEBHOOK_URL}{WEBHOOK_PATH}"
        try:
            await bot.set_webhook(
                url=webhook_url,
                drop_pending_updates=True,
                # Don't restrict allowed_updates to avoid missing types in production
                secret_token=SECRET_TOKEN or None
            )
            print(f"‚úÖ Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {webhook_url}")
        except Exception as e:
            logger.error(f"Failed to set webhook: {e}")
            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–ø—É—Å–∫ HTTP —Å–µ—Ä–≤–µ—Ä–∞ –¥–∞–∂–µ –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook –Ω–µ —É–¥–∞–ª–æ—Å—å
    else:
        # –£–¥–∞–ª—è–µ–º webhook –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º polling
        await bot.delete_webhook(drop_pending_updates=True)
        print("‚úÖ Polling —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω")

async def on_shutdown():
    """–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞"""
    await bot.session.close()
    print("üëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

# ============== –û–¢–õ–ê–î–ö–ê –ù–ï–û–ë–†–ê–ë–û–¢–ê–ù–ù–´–• CALLBACKS ==============

@dp.callback_query()
async def catch_all_callbacks(callback: types.CallbackQuery):
    """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö callback_data –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –Ω–µ–ø–æ–π–º–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤"""
    data = callback.data or ""
    print(f"[CATCH_ALL] Received callback: {data} from user {callback.from_user.id}")
    try:
        logger.info(f"UNHANDLED callback: {data}")
        print(f"UNHANDLED callback: {data}")
    except Exception:
        pass
    # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –±–µ–∑ –∞–ª–µ—Ä—Ç–∞
    try:
        await callback.answer()
    except Exception:
        pass

# ============== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==============

async def main():
    print("‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!")
    print(f"üîÑ –†–µ–∂–∏–º: {'Webhook' if USE_WEBHOOK else 'Polling'}")
    print("‚ö†Ô∏è –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏")
    print("=" * 50)
    
    # –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –ú–ò–ì–†–ê–¶–ò–Ø –ë–î (—Ç–æ–ª—å–∫–æ –¥–ª—è SQLite)
    if not DATABASE_URL:
        try:
            print("üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
            conn = sqlite3.connect(db.db_name)
            cursor = conn.cursor()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª–µ–π –¥–æ—Å—Ç–∞–≤–∫–∏
            cursor.execute('PRAGMA table_info(stores)')
            columns = [col[1] for col in cursor.fetchall()]
            
            if 'delivery_enabled' not in columns:
                print("‚ö†Ô∏è –ü–æ–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç! –î–æ–±–∞–≤–ª—è–µ–º...")
                cursor.execute('ALTER TABLE stores ADD COLUMN delivery_enabled INTEGER DEFAULT 1')
                cursor.execute('ALTER TABLE stores ADD COLUMN delivery_price INTEGER DEFAULT 15000')
                cursor.execute('ALTER TABLE stores ADD COLUMN min_order_amount INTEGER DEFAULT 30000')
                conn.commit()
                print("‚úÖ –ü–æ–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã!")
            else:
                print("‚úÖ –ü–æ–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç")
                # –í–ö–õ–Æ–ß–ê–ï–ú –¥–æ—Å—Ç–∞–≤–∫—É –¥–ª—è –≤—Å–µ—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                cursor.execute('UPDATE stores SET delivery_enabled = 1 WHERE delivery_enabled = 0 OR delivery_enabled IS NULL')
                updated = cursor.rowcount
                conn.commit()
                if updated > 0:
                    print(f"‚úÖ –î–æ—Å—Ç–∞–≤–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞ –¥–ª—è {updated} –º–∞–≥–∞–∑–∏–Ω–∞(–æ–≤)")
            
            # –°–û–ó–î–ê–ï–ú –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï (–µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤)
            cursor.execute('SELECT COUNT(*) FROM offers WHERE status = "active"')
            offers_count = cursor.fetchone()[0]
            
            if offers_count == 0:
                print("‚ö†Ô∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤! –°–æ–∑–¥–∞—é —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...")
                
                # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–¥–º–∏–Ω)
                cursor.execute('SELECT COUNT(*) FROM users WHERE user_id = ?', (ADMIN_ID,))
                if cursor.fetchone()[0] == 0:
                    cursor.execute('''
                        INSERT INTO users (user_id, username, first_name, phone, city, language, role)
                        VALUES (?, ?, ?, ?, ?, ?, ?)
                    ''', (ADMIN_ID, 'admin', 'Admin', '+998901234567', '–¢–∞—à–∫–µ–Ω—Ç', 'ru', 'seller'))
                
                # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω
                cursor.execute('''
                    INSERT INTO stores (owner_id, name, city, address, description, category, phone, status, business_type, delivery_enabled, delivery_price, min_order_amount)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                ''', (ADMIN_ID, 'Demo Market', '–¢–∞—à–∫–µ–Ω—Ç', '–ø—Ä. –ê–º–∏—Ä–∞ –¢–µ–º—É—Ä–∞, 1', '–¢–µ—Å—Ç–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω —Å –≥–æ—Ä—è—á–∏–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏', '–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç', '+998901234567', 'active', 'supermarket', 1, 15000, 30000))
                store_id = cursor.lastrowid
                
                # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã —Å –±–æ–ª—å—à–∏–º–∏ —Å–∫–∏–¥–∫–∞–º–∏
                from datetime import datetime, timedelta
                now = datetime.now()
                tomorrow = now + timedelta(days=1)
                
                test_products = [
                    ('–•–ª–µ–± —Å–≤–µ–∂–∏–π', '–°–≤–µ–∂–µ–∏—Å–ø–µ—á–µ–Ω–Ω—ã–π —Ö–ª–µ–±', 8000, 3000, 50, tomorrow.strftime('%Y-%m-%d %H:%M:%S'), 'bakery', '—à—Ç'),
                    ('–ú–æ–ª–æ–∫–æ 1–ª', '–°–≤–µ–∂–µ–µ –º–æ–ª–æ–∫–æ', 12000, 5000, 30, tomorrow.strftime('%Y-%m-%d %H:%M:%S'), 'dairy', '–ª'),
                    ('–Ø–±–ª–æ–∫–∏ 1–∫–≥', '–°–≤–µ–∂–∏–µ —è–±–ª–æ–∫–∏', 20000, 8000, 100, tomorrow.strftime('%Y-%m-%d %H:%M:%S'), 'fruits', '–∫–≥'),
                    ('–ö—É—Ä–∏—Ü–∞ 1–∫–≥', '–û—Ö–ª–∞–∂–¥–µ–Ω–Ω–∞—è –∫—É—Ä–∏—Ü–∞', 35000, 18000, 25, tomorrow.strftime('%Y-%m-%d %H:%M:%S'), 'meat', '–∫–≥'),
                    ('–¢–æ—Ä—Ç –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π', '–í–∫—É—Å–Ω—ã–π —Ç–æ—Ä—Ç', 80000, 40000, 10, tomorrow.strftime('%Y-%m-%d %H:%M:%S'), 'ready_food', '—à—Ç'),
                ]
                
                for title, desc, orig_price, disc_price, qty, exp, cat, unit in test_products:
                    cursor.execute('''
                        INSERT INTO offers (store_id, title, description, original_price, discount_price, quantity, available_from, available_until, expiry_date, status, unit, category)
                        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'active', ?, ?)
                    ''', (store_id, title, desc, orig_price, disc_price, qty, now.strftime('%Y-%m-%d %H:%M:%S'), tomorrow.strftime('%Y-%m-%d %H:%M:%S'), exp, unit, cat))
                
                conn.commit()
                print(f"‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω —Å {len(test_products)} —Ç–æ–≤–∞—Ä–∞–º–∏!")
            else:
                cursor.execute('SELECT COUNT(*) FROM stores WHERE status = "active"')
                stores_count = cursor.fetchone()[0]
                print(f"‚úÖ –í –ë–î –µ—Å—Ç—å {stores_count} –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤ –∏ {offers_count} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤")
            
            conn.close()
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: {e}")
    else:
        print("‚úÖ PostgreSQL - –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –æ—á–∏—Å—Ç–∫–∏
    cleanup_task = asyncio.create_task(cleanup_expired_offers())
    
    if USE_WEBHOOK:
        # Webhook —Ä–µ–∂–∏–º (–¥–ª—è production –Ω–∞ Railway)
        from aiohttp import web
        
        await on_startup()
        
        app = web.Application()
        
        # Webhook endpoint
        async def webhook_handler(request):
            import time
            start_ts = time.time()
            # –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ POST –∑–∞–ø—Ä–æ—Å—ã Telegram
            if request.method != 'POST':
                return web.Response(status=405, text='Method Not Allowed')
            try:
                logger.info(f"Webhook request received from {request.remote}")

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
                if SECRET_TOKEN:
                    hdr = request.headers.get("X-Telegram-Bot-Api-Secret-Token")
                    if hdr != SECRET_TOKEN:
                        logger.warning("Invalid secret token")
                        METRICS["updates_errors"] += 1
                        return web.Response(status=403, text="Forbidden")

                # –ü–∞—Ä—Å–∏–Ω–≥ JSON
                try:
                    update_data = await request.json()
                except Exception as json_e:
                    logger.error(f"Webhook JSON parse error: {repr(json_e)}")
                    METRICS["webhook_json_errors"] += 1
                    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º 200 —á—Ç–æ–±—ã Telegram –Ω–µ —Ä–µ—Ç—Ä–∞–∏–ª –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
                    return web.Response(status=200, text="OK")

                logger.debug(f"Raw update: {update_data}")

                # –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Update
                try:
                    telegram_update = types.Update.model_validate(update_data)
                except Exception as validate_e:
                    logger.error(f"Webhook validation error: {repr(validate_e)}")
                    METRICS["webhook_validation_errors"] += 1
                    return web.Response(status=200, text="OK")

                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–ø–¥–µ–π—Ç–∞
                await dp.feed_update(bot, telegram_update)
                METRICS["updates_received"] += 1
                proc_ms = int((time.time() - start_ts) * 1000)
                logger.info(f"Update processed successfully ({proc_ms}ms)")
                return web.Response(status=200, text="OK")
            except Exception as e:
                logger.error(f"Webhook unexpected error: {repr(e)}", exc_info=True)
                METRICS["webhook_unexpected_errors"] += 1
                METRICS["updates_errors"] += 1
                return web.Response(status=200, text="OK")
        
        # Health check endpoint
        async def health_check(request):
            return web.json_response({"status": "ok", "bot": "Fudly"})
        async def version_info(request):
            return web.json_response({
                "app": "Fudly",
                "mode": "webhook",
                "port": PORT,
                "use_webhook": USE_WEBHOOK,
                "ts": datetime.now().isoformat(timespec='seconds')
            })
        # Prometheus-style metrics (text/plain) and JSON variant
        def _prometheus_metrics_text():
            help_map = {
                "updates_received": "Total updates received",
                "updates_errors": "Total webhook errors",
                "bookings_created": "Total bookings created",
                "bookings_cancelled": "Total bookings cancelled",
            }
            lines = []
            for key, val in METRICS.items():
                metric = f"fudly_{key}"
                lines.append(f"# HELP {metric} {help_map.get(key, key)}")
                lines.append(f"# TYPE {metric} counter")
                try:
                    v = int(val)
                except Exception:
                    v = 0
                lines.append(f"{metric} {v}")
            return "\n".join(lines) + "\n"

        async def metrics_prom(request):
            text = _prometheus_metrics_text()
            return web.Response(text=text, content_type='text/plain; version=0.0.4; charset=utf-8')

        async def metrics_json(request):
            return web.json_response(METRICS)
        
        # Webhook endpoints (POST + GET for sanity) ‚Äî register both with and without trailing slash
        path_main = WEBHOOK_PATH if WEBHOOK_PATH.startswith('/') else f'/{WEBHOOK_PATH}'
        path_alt = path_main.rstrip('/') + '/'
        app.router.add_post(path_main, webhook_handler)
        app.router.add_post(path_alt, webhook_handler)
        async def webhook_get(_request):
            return web.Response(text="OK", status=200)
        app.router.add_get(path_main, webhook_get)
        app.router.add_get(path_alt, webhook_get)
        app.router.add_get("/health", health_check)
        app.router.add_get("/version", version_info)
        app.router.add_get("/metrics", metrics_prom)
        app.router.add_get("/metrics.json", metrics_json)
        app.router.add_get("/", health_check)  # Railway health check
        
        runner = web.AppRunner(app)
        await runner.setup()
        site = web.TCPSite(runner, '0.0.0.0', PORT)
        await site.start()
        
        print(f"üåê Webhook —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É {PORT}")
        
        try:
            await shutdown_event.wait()
        finally:
            cleanup_task.cancel()
            await runner.cleanup()
            await on_shutdown()
    else:
        # Polling —Ä–µ–∂–∏–º (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
        await on_startup()
        
        # –°–æ–∑–¥–∞—ë–º –∑–∞–¥–∞—á—É –¥–ª—è polling
        polling_task = asyncio.create_task(dp.start_polling(
            bot,
            allowed_updates=dp.resolve_used_update_types(),
            drop_pending_updates=True
        ))
        
        try:
            await shutdown_event.wait()
            print("\nüõë –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ —Å–∏–≥–Ω–∞–ª—É...")
            polling_task.cancel()
            try:
                await polling_task
            except asyncio.CancelledError:
                pass
        except Exception as e:
            print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {type(e).__name__}: {e}")
        finally:
            cleanup_task.cancel()
            try:
                await cleanup_task
            except asyncio.CancelledError:
                pass
            await on_shutdown()

# ============================================
# –ó–ê–©–ò–¢–ê –û–¢ –ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–û–ì–û –ó–ê–ü–£–°–ö–ê
# ============================================

def is_bot_already_running(port=8444):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –∑–∞–ø—É—â–µ–Ω –ª–∏ —É–∂–µ –±–æ—Ç –Ω–∞ —ç—Ç–æ–º –ø–æ—Ä—Ç—É"""
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.bind(('127.0.0.1', port))
        sock.close()
        return False
    except OSError:
        print(f"üõë –û–®–ò–ë–ö–ê: –ë–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É {port}!")
        print("‚ö†Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥—Ä—É–≥–æ–π —ç–∫–∑–µ–º–ø–ª—è—Ä –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –Ω–æ–≤–æ–≥–æ.")
        return True

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è graceful shutdown
shutdown_event = asyncio.Event()

def signal_handler(sig, frame):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (Ctrl+C)"""
    print("\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...")
    shutdown_event.set()

if __name__ == "__main__":
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–ø—É—â–µ–Ω –ª–∏ –±–æ—Ç —É–∂–µ
    if is_bot_already_running():
        print("‚ùå –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –¥—É–±–ª–∏–∫–∞—Ç–∞...")
        sys.exit(1)
    
    # –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û —Å–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è SQLite)
    if not DATABASE_URL:
        try:
            conn = sqlite3.connect(db.db_name)
            cursor = conn.cursor()
            
            print("üîÑ –ü—Ä–æ–≤–µ—Ä—è—é –∏ —Å–æ–∑–¥–∞—é —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏...")
            
            # –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É orders
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS orders (
                        order_id INTEGER PRIMARY KEY AUTOINCREMENT,
                        user_id INTEGER NOT NULL,
                        store_id INTEGER NOT NULL,
                        offer_id INTEGER NOT NULL,
                        quantity INTEGER NOT NULL,
                        total_amount REAL NOT NULL,
                        delivery_price REAL NOT NULL,
                        delivery_address TEXT NOT NULL,
                        payment_method TEXT NOT NULL,
                        payment_proof TEXT,
                        status TEXT DEFAULT 'pending',
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        FOREIGN KEY (user_id) REFERENCES users(user_id),
                        FOREIGN KEY (store_id) REFERENCES stores(store_id),
                        FOREIGN KEY (offer_id) REFERENCES offers(offer_id)
                    )
            ''')
            
            # –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É payment_settings
            cursor.execute('''
                    CREATE TABLE IF NOT EXISTS payment_settings (
                        setting_id INTEGER PRIMARY KEY AUTOINCREMENT,
                        card_number TEXT NOT NULL,
                        card_holder TEXT NOT NULL,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            ''')
            
            # –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –∫–∞—Ä—Ç—É
            cursor.execute('SELECT COUNT(*) FROM payment_settings')
            if cursor.fetchone()[0] == 0:
                cursor.execute('''
                    INSERT INTO payment_settings (card_number, card_holder)
                    VALUES (?, ?)
                ''', ('8600 0000 0000 0000', 'FUDLY PLATFORM'))
            
            # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ stores
            try:
                cursor.execute('ALTER TABLE stores ADD COLUMN delivery_enabled INTEGER DEFAULT 0')
            except:
                pass
            try:
                cursor.execute('ALTER TABLE stores ADD COLUMN delivery_price INTEGER DEFAULT 10000')
            except:
                pass
            try:
                cursor.execute('ALTER TABLE stores ADD COLUMN min_order_amount INTEGER DEFAULT 20000')
            except:
                pass
            
            # –°–æ–∑–¥–∞—ë–º –∏–Ω–¥–µ–∫—Å—ã
            cursor.execute('CREATE INDEX IF NOT EXISTS idx_orders_user ON orders(user_id)')
            cursor.execute('CREATE INDEX IF NOT EXISTS idx_orders_store ON orders(store_id)')
            cursor.execute('CREATE INDEX IF NOT EXISTS idx_orders_status ON orders(status)')
            
            conn.commit()
            print("‚úÖ –¢–∞–±–ª–∏—Ü—ã –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–∑–¥–∞–Ω—ã")
            
            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ–º –¥–æ—Å—Ç–∞–≤–∫—É –¥–ª—è –≤—Å–µ—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤
            cursor.execute('SELECT COUNT(*) FROM stores WHERE delivery_enabled = 1')
            enabled_count = cursor.fetchone()[0]
            cursor.execute('SELECT COUNT(*) FROM stores')
            total_count = cursor.fetchone()[0]
            
            if total_count > 0 and enabled_count == 0:
                print("üöö –í–∫–ª—é—á–∞—é –¥–æ—Å—Ç–∞–≤–∫—É –¥–ª—è –≤—Å–µ—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤...")
                cursor.execute('''
                    UPDATE stores 
                    SET delivery_enabled = 1,
                        delivery_price = 15000,
                        min_order_amount = 30000
                    WHERE delivery_enabled = 0
                ''')
                conn.commit()
                print(f"‚úÖ –î–æ—Å—Ç–∞–≤–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞ –¥–ª—è {total_count} –º–∞–≥–∞–∑–∏–Ω–∞(–æ–≤)")
            
            conn.close()
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –¥–æ—Å—Ç–∞–≤–∫–∏: {e}")
    
    print("=" * 50)
    print("üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ Fudly (Production Optimized)...")
    print("=" * 50)
    print(f"üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {db.db_name}")
    if ADMIN_ID > 0:
        print(f"üëë –ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω: {ADMIN_ID}")
    print(f"üîí –ü–æ—Ä—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: 8444")
    print(f"üåç –Ø–∑—ã–∫–∏: –†—É—Å—Å–∫–∏–π, –£–∑–±–µ–∫—Å–∫–∏–π")
    print(f"üì∏ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ç–æ: –î–∞")
    print(f"‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –ü—É–ª–∏–Ω–≥ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å")
    print("=" * 50)
    
    # Start background tasks for cleanup and maintenance
    if PRODUCTION_FEATURES:
        logger.info("Starting background tasks...")
        start_background_tasks(db)
        print("‚úÖ Background tasks started")
    else:
        print("‚ö†Ô∏è Running in basic mode (production features disabled)")
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    
    try:
        logger.info("Bot starting...")
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("Bot stopped by user")
        print("\nüëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.error(f"Bot crashed: {str(e)}")
        print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")
    finally:
        logger.info("Bot shutdown complete")

