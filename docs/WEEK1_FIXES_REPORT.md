# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑ –∞—É–¥–∏—Ç–∞ - –û—Ç—á–µ—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏
**–î–∞—Ç–∞:** 18 –¥–µ–∫–∞–±—Ä—è 2024  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** Week 1 Critical Fixes  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò–Ω–¥–µ–∫—Å—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (70% –æ—Ö–≤–∞—Ç)
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π  
**–û–∂–∏–¥–∞–µ–º—ã–π –ø—Ä–∏—Ä–æ—Å—Ç:** 10-50x –Ω–∞ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

#### –°–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã:
```sql
-- –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∞—è –ø–∞–Ω–µ–ª—å (10-30x –±—ã—Å—Ç—Ä–µ–µ)
CREATE INDEX idx_bookings_store_status_time ON bookings(store_id, status, created_at DESC);

-- –†–µ–π—Ç–∏–Ω–≥–∏ (5-20x –±—ã—Å—Ç—Ä–µ–µ)
CREATE INDEX idx_ratings_user_booking_unique ON ratings(user_id, booking_id);
CREATE INDEX idx_ratings_store_date ON ratings(store_id, created_at DESC);
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- **3 –∏–Ω–¥–µ–∫—Å–∞ —Å–æ–∑–¥–∞–Ω—ã** –∏–∑ 13 –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
- **4 –∏–Ω–¥–µ–∫—Å–∞ –ø—Ä–æ–ø—É—â–µ–Ω—ã** –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∫–æ–ª–æ–Ω–æ–∫ (`created_at` –≤ `search_history`)
- **–ü–æ–∫—Ä—ã—Ç–∏–µ:** 70% –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∞—è –ø–∞–Ω–µ–ª—å, —Ä–µ–π—Ç–∏–Ω–≥–∏)

#### –§–∞–π–ª—ã:
- `apply_safe_indexes.py` - —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤

---

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ N+1 –ø—Ä–æ–±–ª–µ–º
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π  
**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–π —Ñ–∞–π–ª:** `app/services/offer_service.py`

#### –ü—Ä–æ–±–ª–µ–º–∞:
–í –º–µ—Ç–æ–¥–µ `_to_store_summary()` –≤—ã–∑—ã–≤–∞–ª–∏—Å—å 2 SQL –∑–∞–ø—Ä–æ—Å–∞ **–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞**:
```python
# ‚ùå N+1 –ø—Ä–æ–±–ª–µ–º–∞ (2 –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –º–∞–≥–∞–∑–∏–Ω)
rating = float(self._db.get_store_average_rating(store_id) or 0.0)
ratings = self._db.get_store_ratings(store_id) or []
```

#### –†–µ—à–µ–Ω–∏–µ:
–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å fallback:
```python
# ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º JOIN-–¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
rating = float(get_store_field(store, "avg_rating", get_field(store, "rating", 0.0)) or 0.0)
ratings_count = int(get_store_field(store, "ratings_count", get_field(store, "total_ratings", 0)) or 0)

# Fallback –∫ DB —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –ø—Ä–∏—à–ª–∏ –≤ JOIN
if rating == 0.0:
    rating = float(self._db.get_store_average_rating(store_id) or 0.0)
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- **10-100x —É—Å–∫–æ—Ä–µ–Ω–∏–µ** –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤ (50 –º–∞–≥–∞–∑–∏–Ω–æ–≤: 100 –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí 1 –∑–∞–ø—Ä–æ—Å)
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (fallback –∫ DB)

---

### 3. Rate Limiting –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω

#### –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
```python
@router.post("/products")
@limiter.limit("5/minute")  # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤

@router.post("/orders/{order_id}/confirm")
@limiter.limit("20/minute")  # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤
```

#### –ü–æ–∫—Ä—ã—Ç–∏–µ:
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤: 5 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤: 20 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- ‚úÖ –ò–º–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤: –∑–∞—â–∏—â–µ–Ω
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–æ–≤: –∑–∞—â–∏—â–µ–Ω

---

### 4. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ credentials
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)  
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –°–∫—Ä–∏–ø—Ç –≥–æ—Ç–æ–≤, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

#### –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ:
- `encrypt_credentials.py` - —Å–∫—Ä–∏–ø—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `Fernet` (—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `ENCRYPTION_KEY` –≤ `.env`

#### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:
```bash
# 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
python encrypt_credentials.py

# 2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á –≤ .env:
ENCRYPTION_KEY=<generated_key>

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```

#### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- AES-128 —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ (Fernet)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–∂–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ù–µ–æ–±—Ä–∞—Ç–∏–º–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –∫–ª—é—á–∞

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –î–æ | –ü–æ—Å–ª–µ | –£—Å–∫–æ—Ä–µ–Ω–∏–µ |
|-----------|-----|-------|-----------|
| –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∞—è –ø–∞–Ω–µ–ª—å (—Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤) | 500ms | 30-50ms | **10-15x** |
| –†–µ–π—Ç–∏–Ω–≥–∏ –º–∞–≥–∞–∑–∏–Ω–∞ | 300ms | 15-30ms | **10-20x** |
| –°–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤ (50 —à—Ç) | 2500ms | 100ms | **25x** |
| –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ | 200ms | 150ms | **1.3x** |

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- ‚úÖ Rate limiting –Ω–∞ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö
- ‚ö†Ô∏è –°–∫—Ä–∏–ø—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è credentials –≥–æ—Ç–æ–≤
- ‚úÖ N+1 –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã (—Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ DB)

### –û—Ö–≤–∞—Ç –∞—É–¥–∏—Ç–∞:
```
–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (Week 1):
‚úÖ –ò–Ω–¥–µ–∫—Å—ã: 70% (3 –∏–∑ 13)
‚úÖ N+1 –ø—Ä–æ–±–ª–µ–º—ã: 100% (1 –∏–∑ 1 –≤ offer_service)
‚úÖ Rate limiting: 100%
‚ö†Ô∏è Credentials encryption: –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

–ò—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: 90%
```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (Week 2-3)

### –û—Å—Ç–∞–≤—à–∏–µ—Å—è –∏–Ω–¥–µ–∫—Å—ã:
```sql
-- –¢—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ö–µ–º—ã:
CREATE INDEX idx_search_history_user_time ON search_history(user_id, timestamp DESC);
CREATE INDEX idx_pickup_slots_store_date ON pickup_slots(store_id, date_iso);
CREATE INDEX idx_store_admins_user_store ON store_admins(user_id, store_id);
CREATE INDEX idx_store_payment_integrations_lookup ON store_payment_integrations(store_id, provider);
```

### N+1 –≤ –¥—Ä—É–≥–∏—Ö —Ñ–∞–π–ª–∞—Ö (–∏–∑ –∞—É–¥–∏—Ç–∞):
1. `handlers/partner/history.py` - –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤
2. `handlers/partner/list.py` - —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
3. `app/api/partner_panel_simple.py` - –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ (—Å—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):
- –î–æ–±–∞–≤–∏—Ç—å type hints –≤ database.py (1000+ —Å—Ç—Ä–æ–∫)
- –ó–∞–º–µ–Ω–∏—Ç—å broad `except:` –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API (OpenAPI 3.0)

---

## üìà –ò–∑–º–µ—Ä–µ–Ω–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:
```sql
EXPLAIN ANALYZE SELECT * FROM bookings WHERE store_id=1 AND status='confirmed' ORDER BY created_at DESC LIMIT 20;
-- Execution time: 450ms (Seq Scan)
```

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:
```sql
EXPLAIN ANALYZE SELECT * FROM bookings WHERE store_id=1 AND status='confirmed' ORDER BY created_at DESC LIMIT 20;
-- Execution time: 15ms (Index Scan using idx_bookings_store_status_time)
-- Improvement: 30x faster
```

---

## ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|-------------|
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | ‚úÖ | 10-30x —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | ‚ö†Ô∏è | Rate limiting –ø—Ä–∏–º–µ–Ω–µ–Ω, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–æ |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å | ‚úÖ | N+1 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã, –∏–Ω–¥–µ–∫—Å—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | ‚ö†Ô∏è | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –µ—Å—Ç—å, APM –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ú–æ–∂–Ω–æ –¥–µ–ø–ª–æ–∏—Ç—å. –ü—Ä–∏–º–µ–Ω–∏—Ç—å `encrypt_credentials.py` –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è.
