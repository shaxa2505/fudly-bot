# Database Schema Audit - December 17, 2025

## –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –º–µ–∂–¥—É —Å—Ö–µ–º–æ–π –ë–î –∏ –∫–æ–¥–æ–º

### üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

#### 1. **users.full_name vs users.first_name**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–æ–¥ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –ø–æ–ª—é `full_name`, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ –ë–î

**–°—Ö–µ–º–∞ –ë–î** (—Ç–∞–±–ª–∏—Ü–∞ `users`):
```sql
- user_id (BigInteger, PK)
- username (String)
- first_name (String)  ‚úÖ –ï–°–¢–¨
- phone (String)
- city (String)
- language (String)
- role (String)
- is_admin (Integer)
- notifications_enabled (Integer)
- created_at (DateTime)

‚ùå –ù–ï–¢: last_name, full_name
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ**:
- `handlers/customer/payment_proof.py:196` - `user.get("full_name")`
- `handlers/customer/payment_proof.py:200` - `getattr(user, "full_name", None)`
- `tests/test_integration.py:57` - `full_name="Test Buyer"`

**–†–µ—à–µ–Ω–∏–µ**:
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ `first_name` (—Ç–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ –≤ Partner Panel)
- ‚ö†Ô∏è –ò–õ–ò –¥–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è `full_name` –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–ª–Ω–æ–µ –∏–º—è

---

#### 2. **orders.order_type –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–æ–¥ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç –Ω–∞–ª–∏—á–∏–µ `order_type` (pickup/delivery), –Ω–æ –µ–≥–æ –Ω–µ—Ç –≤ —Å—Ö–µ–º–µ

**–°—Ö–µ–º–∞ –ë–î** (—Ç–∞–±–ª–∏—Ü–∞ `orders`):
```sql
- order_id (Integer, PK)
- user_id (BigInteger, FK)
- offer_id (Integer, FK)
- store_id (Integer, FK)
- delivery_address (Text)
- payment_method (String)
- payment_status (String)
- payment_proof_photo_id (String)
- order_status (String)
- quantity (Integer)
- total_price (Float)
- created_at (DateTime)

‚ùå –ù–ï–¢: order_type
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ**:
- `app/api/partner_panel_simple.py:591` - `order.get("order_type", "delivery")`
- –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ `pickup` –∏ `delivery`

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–∏—Ç—å `order_type` enum('pickup', 'delivery') –≤ —Ç–∞–±–ª–∏—Ü—É orders
- –ò–ª–∏ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —Ç–∏–ø –ø–æ –Ω–∞–ª–∏—á–∏—é `delivery_address` (–µ—Å–ª–∏ NULL = pickup)

---

#### 3. **bookings vs orders –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–≤–∞ —Å–ø–æ—Å–æ–±–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ - —á–µ—Ä–µ–∑ `bookings` (—Å–∞–º–æ–≤—ã–≤–æ–∑) –∏ `orders` (–¥–æ—Å—Ç–∞–≤–∫–∞)

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞**:
- `bookings` - –¥–ª—è —Å–∞–º–æ–≤—ã–≤–æ–∑–∞
- `orders` - –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏

**API `/orders` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- –í—Å–µ bookings
- –í—Å–µ orders
- –°–º–µ—à–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å `type: 'booking'` –∏–ª–∏ `'order'`

**–ü—Ä–æ–±–ª–µ–º–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏**:
- –í `bookings` –µ—Å—Ç—å `booking_code`, `pickup_time`, `status`
- –í `orders` –µ—Å—Ç—å `order_status`, `payment_status`, `delivery_address`
- –†–∞–∑–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**:
- –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤ –æ–¥–Ω—É —Ç–∞–±–ª–∏—Ü—É `orders` —Å –ø–æ–ª–µ–º `order_type`
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–µ—Ä–µ–∑ VIEW

---

### üü° –°–†–ï–î–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´

#### 4. **–ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**

**–¢–µ–∫—É—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã**:
```sql
-- users
‚úÖ ix_users_city
‚úÖ ix_users_role
‚úÖ ix_users_phone

-- orders
‚úÖ ix_orders_user
‚úÖ ix_orders_store
‚úÖ ix_orders_status

-- bookings
‚úÖ ix_bookings_user
‚úÖ ix_bookings_store
‚úÖ ix_bookings_status
‚úÖ ix_bookings_code
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:
- ‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –µ—Å—Ç—å
- ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å: `(store_id, order_status, created_at)` –¥–ª—è Partner Panel
- ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å: `(created_at DESC)` –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏

---

#### 5. **offers.photo_id vs real photos table**

**–°—Ö–µ–º–∞**:
```sql
offers:
  - photo_id (String) -- –ø—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞, –Ω–µ FK
```

**–ü—Ä–æ–±–ª–µ–º–∞**:
- –ù–µ—Ç —Ç–∞–±–ª–∏—Ü—ã `photos` —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
- –ù–µ—Ç –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ

**–†–µ—à–µ–Ω–∏–µ**:
- –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å (–ø—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ) ‚úÖ
- –ò–õ–ò —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É photos —Å FK

---

### üü¢ –ú–ï–õ–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

#### 6. **–°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤**

**bookings.status**:
- active, completed, cancelled, pending

**orders.order_status**:
- pending, confirmed, preparing, ready, delivering, completed, cancelled

**–ü—Ä–æ–±–ª–µ–º–∞**: –†–∞–∑–Ω—ã–µ –Ω–∞–±–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π –ª–æ–≥–∏–∫–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã

---

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### üî• –°–†–û–ß–ù–û (–≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É):
1. ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**: `users.last_name` - —É–±—Ä–∞–Ω–æ –∏–∑ SQL –∑–∞–ø—Ä–æ—Å–æ–≤
2. ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**: JOIN —Å users/offers –≤ `get_store_orders`
3. ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**: –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö products –≤–º–µ—Å—Ç–æ –º–æ–∫–æ–≤

### üìã –°–†–ï–î–ù–ï–°–†–û–ß–ù–û (—É–ª—É—á—à–∏—Ç –∫–∞—á–µ—Å—Ç–≤–æ):
4. –î–æ–±–∞–≤–∏—Ç—å `order_type` –≤ —Ç–∞–±–ª–∏—Ü—É `orders`
5. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã bookings –∏ orders
6. –ó–∞–º–µ–Ω–∏—Ç—å `user.get("full_name")` –Ω–∞ `first_name` –≤ handlers

### üîÆ –î–û–õ–ì–û–°–†–û–ß–ù–û (—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥):
7. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å bookings –∏ orders –≤ –æ–¥–Ω—É —Ç–∞–±–ª–∏—Ü—É
8. –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É photos —Å FK
9. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –§–∞–∑–∞ 1: –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–∫—Å—ã (‚úÖ –í–´–ü–û–õ–ù–ï–ù–û)
- [x] –£–±—Ä–∞—Ç—å `last_name` –∏–∑ SQL
- [x] –î–æ–±–∞–≤–∏—Ç—å JOIN –≤ `get_store_orders`
- [x] –ó–∞–≥—Ä—É–∂–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ products

### –§–∞–∑–∞ 2: Handlers —á–∏—Å—Ç–∫–∞ (1-2 —á–∞—Å–∞)
- [ ] –ù–∞–π—Ç–∏ –≤—Å–µ `full_name` –≤ handlers
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `first_name`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å tests

### –§–∞–∑–∞ 3: –°—Ö–µ–º–∞ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–∏—Ç—å `order_type` –≤ orders
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è: —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã

---

## –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

**–í—Å–µ 3 –ø—Ä–æ–µ–∫—Ç–∞ —Ä–∞–±–æ—Ç–∞—é—Ç** ‚úÖ
- ‚úÖ Telegram Bot - —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Web App –∫–ª–∏–µ–Ω—Ç–æ–≤ - —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Partner Panel - —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ—Å–ª–µ —Ñ–∏–∫—Å–æ–≤)

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã**:
- SQL –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
- –ù–∞–≤–∏–≥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**:
- –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–æ–π
- –§–∞–∑–∞ 2 –¥–µ–ª–∞—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø—Ä–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- –§–∞–∑–∞ 3 - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—É–¥—É—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é

---

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ö–µ–º—É
psql $DATABASE_URL -c "\d users"
psql $DATABASE_URL -c "\d orders"
psql $DATABASE_URL -c "\d bookings"

# –ù–∞–π—Ç–∏ –≤—Å–µ full_name –≤ –∫–æ–¥–µ
grep -r "full_name" handlers/
grep -r "last_name" app/

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
psql $DATABASE_URL -c "SELECT COUNT(*) FROM orders;"
psql $DATABASE_URL -c "SELECT COUNT(*) FROM bookings;"
```
