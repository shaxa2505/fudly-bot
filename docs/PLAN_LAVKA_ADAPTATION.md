# План исправлений и адаптации (Lavka)

## Коротко
Этот документ фиксирует конкретные шаги исправления проблем из аудита и формирует план перехода к более чистой архитектуре без полного переписывания проекта.

## Цели
- Свести брони и заказы к одной модели и единой машине статусов.
- Убрать дублирующие обработчики и прямой доступ к БД из UI-слоя.
- Исправить кодировки/локализацию, чтобы тексты в боте читались корректно.
- Вынести миграции из рантайма бота.
- Свести `bot.py` к сборке приложения и wiring.

## Объем работ
**В рамках:**
- Унификация заказов/броней, статусы и платежные статусы.
- Рефакторинг обработчиков на вызовы сервисов.
- Нормализация доступа к данным (единая форма результата из БД).
- Исправление кодировок текста и локализаций.
- Разделение запуска: бот / API / фоновые задачи.

**Вне рамок (пока):**
- Полный редизайн UX-текстов.
- Глубокая переработка партнерского webapp.
- Расширенная аналитика и BI.

## Принципы
- UI слой = только ввод/вывод, без бизнес-логики.
- Сервисный слой = все правила и статусы.
- БД доступна только через репозитории/адаптеры.
- Никаких миграций схемы в рантайме бота.
- Одна модель заказа с четкими статусами и переходами.

---

## План работ по этапам

### Этап 0. Диагностика и фиксация текущего состояния
**Результат:** карта потоков и минимальный чек-лист регрессии.
- Зафиксировать текущие пользовательские сценарии (старт, поиск, бронь, доставка, оплата).
- Составить список задействованных обработчиков и сервисов по каждому сценарию.
- Определить «источник истины» для заказов (сейчас — `unified_order_service.py`).
- Подготовить короткий smoke-чеклист.

### Этап 1. Горячие правки инфраструктуры
**Результат:** читаемая локализация и безопасные миграции.
- Исправить битую кодировку текстов (README, `localization.py`, `locales/*`, ключевые handlers).
- Убрать/выключить миграции, выполняемые в рантайме бота (`schema.py`, `bot.py`).
- Вынести запуск миграций в отдельный скрипт/команду.
- Привести `bot.py` к формату “wiring only”: загрузка конфигов, DI, роутинг.

### Этап 2. Унификация заказов и платежей
**Результат:** единая сущность заказа и единый набор статусов.
- Зафиксировать модель заказа (order + payment) и матрицу переходов.
- Перенести старые брони в unified-модель через адаптер/обертку.
- Удалить/обездвижить дублирующие обработчики бронирования.
- Централизовать логику статусов в `unified_order_service.py`.

### Этап 3. Рефакторинг обработчиков
**Результат:** обработчики вызывают сервисы, не трогают БД напрямую.
- Вынести прямой SQL/DB доступ из `handlers/*` в сервисы/репозитории.
- Убрать дубли и разночтения статусов в `handlers/customer/*` и `handlers/bookings/*`.
- Обновить API-эндпоинты, чтобы они вызывали сервисы.

### Этап 4. Стабилизация доступа к данным
**Результат:** единая форма данных из БД и меньше ошибок.
- Ввести единый формат результата (dataclass/TypedDict/RowAdapter).
- Убрать ручные `get_field` и разнородность (`dict/tuple/HybridRow`).
- Добавить тонкий слой репозиториев для ключевых сущностей.

### Этап 5. Разделение процессов
**Результат:** бот, API и фоновые задачи запускаются отдельно.
- Разнести entrypoints: бот / API / webhook / tasks.
- Настроить конфиги запуска для каждого процесса.

---

## Область изменений по файлам (черновой список)
- `bot.py`, `bootstrap.py`, `config.py`
- `handlers/*` (customer, bookings, orders, admin)
- `app/services/unified_order_service.py`
- `app/services/offer_service.py`, `app/services/search_service.py`
- `database_pg_module/*`, `database_pg.py`, `database_protocol.py`
- `localization.py`, `locales/*`, `README.md`
- `tasks/*`, `webhook_server.py`, `api_server.py`

## Критерии готовности
- Любой заказ/бронь создается через unified-модель.
- Нет прямого доступа к БД в UI-обработчиках.
- Кодировки текста читаемы везде.
- Миграции не запускаются из `bot.py`.
- Статусы заказа и оплаты определены в одном месте и используются везде.

## Риски и допущения
- Возможны скрытые зависимости старых обработчиков бронирования.
- Потребуется краткая миграция данных/адаптер для совместимости.
- Временные флаги/переключатели для плавного перехода допустимы.

## Минимальный smoke-чеклист
- /start → язык → телефон → город → меню
- Поиск → карточка оффера → бронь/доставка
- Оплата: cash + click/payme + перевод
- Подтверждение продавцом → завершение
- Напоминание рейтинга
