# Описание основных потоков (flows) бота

Дата: 2025-12-13
Версия: 1.0

## Цели
- Сформировать единое, компактное представление о ключевых сценариях работы бота.
- Упростить навигацию по коду и документации, связав шаги с существующими модулями.

## Навигация по коду
- API/Handlers: `handlers/` (папки `admin/`, `customer/`, `seller/`, `common/`, `bookings/`).
- Сервисы: `app/services/` (логика домена и интеграции).
- Репозитории/БД: `app/repositories/`, `database_pg_module/`, файлы `database_pg.py`, `fsm_storage_pg.py`.
- Локализация: `localization.py`, `locales/`.
- Безопасность/валидация: `security.py`, middlewares в `app/middlewares/`.

---

## 1. Онбординг и старт
1. Пользователь открывает бота → команда/кнопка "Старт".
2. Проверка регистрации телефона/профиля.
3. Предложение выбрать роль: `Покупатель` / `Продавец` / `Администратор`.
4. Переход к соответствующему основному меню.

Связанные файлы:
- `handlers/common/` — общие стартовые хендлеры.
- `test_profile_switch.py`, `PROFILE_SWITCH_FIX.md` — логика переключения профиля.
- `security.py` — проверки и защита.

## 2. Переключение профиля
1. Команда/кнопка "Сменить профиль" из любого меню.
2. Отображение доступных ролей, подтверждение.
3. Обновление состояний FSM/сессии и прав доступа.

Связанные файлы:
- `handlers/common/`, `handlers/admin/`, `handlers/seller/`, `handlers/customer/` — маршрутизация по ролям.
- `fsm_storage_pg.py` — хранение состояний.
- `ORDER_SYSTEM_FULL_AUDIT.md`, `ORDER_SYSTEM_FIXES.md` — учёт последствий для заказов.

## 3. Каталог и выбор товара (для покупателя)
1. Открыть каталог: категории, список товаров, поиск.
2. Карточка товара: цена, варианты, наличие.
3. Добавить в корзину, изменить количество.
4. Перейти в корзину, проверить состав.

Связанные файлы:
- `app/services/` и `app/repositories/` — бизнес-логика и доступ к данным.
- `docs/UX_CART_FLOW_ANALYSIS.md`, `WEBAPP_COMPONENTS.md` — UX и компоненты.

## 4. Оформление заказа
1. Выбор способа получения: Доставка / Самовывоз.
2. Ввод адреса/выбор точки самовывоза.
3. Расчёт стоимости и сроков.
4. Подтверждение заказа.

Связанные файлы:
- `PICKUP_DELIVERY_FIX.md`, `DELIVERY_FLOW_FIX.md` — корректировка потоков.
- `UNIFIED_ORDER_SYSTEM.md`, `MINI_APP_ORDER_SYSTEM.md` — унификация.
- `app/services/` — расчёты и валидации.

## 5. Оплата
1. Выбор метода оплаты (интеграции/ссылки/инвойсы).
2. Проведение транзакции, обработка успешного/неуспешного статуса.
3. Обновление статуса заказа, уведомления.

Связанные файлы:
- `integrations/` — платёжные и внешние интеграции.
- `ORDER_SYSTEM_AUDIT.md`, `OPTIMIZATION_PLAN.md` — контроль статусов.

## 6. Доставка и самовывоз
1. Отслеживание статуса: принят → в работе → доставляется/готов к выдаче → завершён.
2. Уведомления о смене статуса, ожидание подтверждений.
3. Обработка исключений: перенос, отмена, возврат.

Связанные файлы:
- `DELIVERY_ORDER_CREATION_FIX.md`, `PICKUP_DELIVERY_FIX.md` — исправления.
- `app/services/` — обновление статусов и нотификации.

## 7. Управление продавца
1. Приём и обработка заказов: подтверждение/отмена, смена статусов.
2. Управление товарами: добавление, редактирование, скрытие.
3. Настройки магазина: график, зоны доставки, цены.

Связанные файлы:
- `handlers/seller/`, `handlers/admin/` — панели управления.
- `docs/PROJECT_MAP.md`, `RESTRUCTURE_PLAN.md` — архитектурные ориентиры.

## 8. Панель администратора
1. Управление пользователями и ролями.
2. Модерация контента, глобальные настройки.
3. Просмотр метрик и отчётов.

Связанные файлы:
- `handlers/admin/`, `docs/FINAL_REPORT.md`, `PROJECT_AUDIT.md`.

## 9. Локализация и контент
1. Определение языка по пользователю/настройке.
2. Загрузка текстов из `locales/`, выбор формулировок.
3. Контентные подсказки и ошибки.

Связанные файлы:
- `localization.py`, `locales/`, `docs/WEBAPP_IMPROVEMENTS.md`.

## 10. Ошибки, безопасность и логирование
1. Единая обработка ошибок и возврат понятных сообщений.
2. Лимиты/защита от злоупотреблений, проверка прав.
3. Логи, аудит, алерты.

Связанные файлы:


## 11. Статистика (Партнёр и Админ)
1. Партнёр: карточка «Статистика сегодня» с метриками — выручка, заказов, товаров продано, активных товаров, средний чек, возвраты (опц.). Переключатели периода: Сегодня/Вчера/Неделя/Месяц.
2. Админ: общая статистика по системе с фильтрами (магазин, город, категория, продавец), разрезы по каналам, топ-товары/продавцы.
3. Учёт таймзоны: период рассчитывается в TZ партнёра (для партнёра) и в системной TZ (для админа).
4. Кэширование: агрегации на 30–60 сек для снижения нагрузки; антифлуд на кнопке «Обновить».

Связанные файлы:
- `app/services/stats.py` — контракты `get_partner_stats`, `get_admin_stats`.
- `docs/STATS_SPEC.md` — полная спецификация метрик, фильтров и контрактов.
- `handlers/seller/`, `handlers/admin/` — подключение сервисов к кнопкам и меню.

## Диаграмма высокого уровня (текстовая)
```
[Старт] -> [Выбор роли]
  Покупатель -> Каталог -> Корзина -> Заказ -> Оплата -> Доставка/Самовывоз -> Завершение
  Продавец -> Заказы -> Управление товарами -> Настройки
  Администратор -> Пользователи/Роли -> Модерация -> Отчёты
```

## Примечания по интеграции
- Проверяйте актуальные фиксы: `ORDER_SYSTEM_FULL_AUDIT.md`, `DELIVERY_FLOW_FIX.md`, `PICKUP_DELIVERY_FIX.md`.
- Для FSM и БД используйте `fsm_storage_pg.py`, `database_pg_module/`.
- Старайтесь держать тексты в `locales/` и не хардкодить строки в хендлерах.

## TODO для дальнейшего уточнения
- Добавить ссылку на конкретные команды/эндпоинты в `handlers/*`.
- Вынести схемы в `docs/openapi.yaml` при обновлении API.
- Дополнить кейсы отмены/возвратов с привязкой к статусам.
