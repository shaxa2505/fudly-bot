# 🛒 Unified Order System

## Обзор

Унифицированная система заказов решает проблемы с:
- ❌ 5 разных точек входа для создания заказов
- ❌ 4 разных формата уведомлений
- ❌ Несогласованные callback-паттерны
- ❌ Непоследовательные уведомления клиентов
- ❌ Дублирование кода

## Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                    UnifiedOrderService                           │
│  (app/services/unified_order_service.py)                        │
├─────────────────────────────────────────────────────────────────┤
│  • create_order() - Единая точка создания                       │
│  • confirm_order() - Подтверждение продавцом                   │
│  • reject_order() - Отклонение с причиной                      │
│  • mark_ready() - Заказ готов                                   │
│  • start_delivery() - В доставке                               │
│  • complete_order() - Выполнен                                 │
│  • cancel_order() - Отменён                                    │
└────────────────────────────────────────┬────────────────────────┘
                                         │
                ┌────────────────────────┴────────────────────────┐
                │                                                 │
    ┌───────────▼───────────┐                     ┌───────────────▼────────────┐
    │   NotificationTemplates │                     │   unified_order_handlers    │
    │   (RU/UZ локализация)   │                     │   (handlers/common/)        │
    └─────────────────────────┘                     └──────────────────────────────┘
```

## Статусы заказов (OrderStatus)

| Статус | Описание | Для кого |
|--------|----------|----------|
| `pending` | Ожидает подтверждения | Pickup & Delivery |
| `preparing` | Готовится | Pickup & Delivery |
| `ready` | Готов к выдаче/доставке | Pickup & Delivery |
| `delivering` | В пути | Только Delivery |
| `completed` | Выполнен | Pickup & Delivery |
| `rejected` | Отклонён продавцом | Pickup & Delivery |
| `cancelled` | Отменён клиентом | Pickup & Delivery |

## Callback-паттерны

### Новые (унифицированные)
```
order_confirm_{id}      - Подтвердить заказ
order_reject_{id}       - Отклонить заказ
order_ready_{id}        - Заказ готов
order_delivering_{id}   - В доставке
order_complete_{id}     - Заказ выполнен
order_cancel_seller_{id} - Отмена продавцом
```

### Устаревшие (обратная совместимость)
```
partner_confirm_{id}        → order_confirm_{id}
partner_confirm_order_{id}  → order_confirm_{id}
partner_reject_{id}         → order_reject_{id}
partner_reject_order_{id}   → order_reject_{id}
confirm_order_{id}          → order_confirm_{id}
cancel_order_{id}           → order_reject_{id}
```

## Поток для самовывоза (Pickup)

```
📱 Клиент                 🏪 Продавец                📲 Уведомления
────────────────────────────────────────────────────────────────────
Оформляет заказ     →    Получает уведомление   →    🔔 НОВЫЙ ЗАКАЗ!
                         с кодом pickup             📦 #123, Код: AB12

                         ✅ Принять / ❌ Отклонить

                    →    Нажимает ✅ Принять    →    📱 Клиенту:
                                                     🎉 Заказ принят!
                                                     👨‍🍳 Готовится...

                         Появляется кнопка:
                         ✅ Выдано

                    →    Нажимает ✅ Выдано     →    📱 Клиенту:
                                                     🎊 Заказ выполнен!
                                                     ⭐ Оцените
```

## Поток для доставки (Delivery)

```
📱 Клиент                 🏪 Продавец                📲 Уведомления
────────────────────────────────────────────────────────────────────
Оформляет заказ     →    Получает уведомление   →    🔔 НОВЫЙ ЗАКАЗ!
с адресом                с адресом доставки          📦 #123
                                                     📍 Адрес: ...

                         ✅ Принять / ❌ Отклонить

                    →    Нажимает ✅ Принять    →    📱 Клиенту:
                                                     🎉 Заказ принят!
                                                     👨‍🍳 Готовится...

                         Появляется кнопка:
                         ✅ Готово

                    →    Нажимает ✅ Готово     →    📱 Клиенту:
                                                     ✅ Заказ готов!
                                                     🚚 Скоро доставим!

                         Появляется кнопка:
                         🚚 В доставке

                    →    Нажимает 🚚            →    📱 Клиенту:
                                                     🚚 Заказ в пути!
                                                     ⏱ 30-60 минут

                         Появляется кнопка:
                         ✅ Доставлено

                    →    Нажимает ✅            →    📱 Клиенту:
                                                     🎊 Заказ выполнен!
                                                     ⭐ Спасибо!
```

## Уведомления продавцу

### Формат уведомления
```
🔔 НОВЫЙ ЗАКАЗ!
━━━━━━━━━━━━━━━━━━

📦 #123
📋 🏪 Самовывоз / 🚚 Доставка
🎫 Код: AB12 (только для самовывоза)

👤 Имя клиента
📱 +998901234567
📍 Адрес (только для доставки)

Товары:
• Товар 1 × 2 = 50,000 сум
• Товар 2 × 1 = 25,000 сум

━━━━━━━━━━━━━━━━━━
💵 Товары: 75,000 сум
🚚 Доставка: 15,000 сум
💰 ИТОГО: 90,000 сум

💵 Наличные

⏳ Подтвердите заказ!

[✅ Принять] [❌ Отклонить]
```

## Уведомления клиенту

### При создании заказа
```
✅ ЗАКАЗ ОФОРМЛЕН!
━━━━━━━━━━━━━━━━━━━━

📦 #123
🏪 Название магазина
📋 🏪 Самовывоз
📍 Адрес магазина

🎫 Код: AB12

Товары:
• Товар 1 × 2 = 50,000 сум

━━━━━━━━━━━━━━━━━━━━
💰 ИТОГО: 50,000 сум

💵 Наличные

⏳ Ожидайте подтверждения продавца...
👆 Покажите код продавцу при получении
```

### При изменении статуса
| Статус | Уведомление |
|--------|-------------|
| `preparing` | 🎉 **Заказ принят!**<br>👨‍🍳 Ваш заказ готовится... |
| `ready` | ✅ **Заказ готов!**<br>🏪 Можете забирать! / 🚚 Скоро доставим! |
| `delivering` | 🚚 **Заказ в пути!**<br>⏱ Примерно 30-60 минут до доставки |
| `completed` | 🎊 **Заказ выполнен!**<br>Спасибо за покупку! ⭐ |
| `rejected` | 😔 **Заказ отклонён**<br>📝 Причина: ...<br>Попробуйте другой магазин! |
| `cancelled` | ❌ **Заказ отменён** |

## Использование в коде

### Создание заказа
```python
from app.services.unified_order_service import (
    get_unified_order_service,
    OrderItem,
)

order_service = get_unified_order_service()

items = [
    OrderItem(
        offer_id=123,
        store_id=1,
        title="Товар",
        price=50000,
        original_price=60000,
        quantity=2,
        store_name="Магазин",
        store_address="Адрес",
        delivery_price=15000,  # Для доставки
    )
]

result = await order_service.create_order(
    user_id=customer_id,
    items=items,
    order_type="pickup",  # или "delivery"
    delivery_address="Адрес" if order_type == "delivery" else None,
    payment_method="cash",
)

if result.success:
    print(f"Order IDs: {result.order_ids}")
    print(f"Pickup codes: {result.pickup_codes}")
```

### Изменение статуса
```python
# Подтвердить
await order_service.confirm_order(order_id, "order")

# Отклонить
await order_service.reject_order(order_id, "order", "Нет в наличии")

# Готов
await order_service.mark_ready(order_id, "order")

# В доставке
await order_service.start_delivery(order_id)

# Выполнен
await order_service.complete_order(order_id, "order")
```

## Файловая структура

```
app/services/
├── unified_order_service.py   # 🆕 Унифицированный сервис
│   ├── OrderStatus            # Статусы
│   ├── NotificationTemplates  # Шаблоны уведомлений
│   └── UnifiedOrderService    # Основной класс

handlers/common/
├── unified_order_handlers.py  # 🆕 Унифицированные обработчики
│   ├── unified_confirm_handler    # Подтверждение
│   ├── unified_reject_handler     # Отклонение
│   ├── order_ready_handler        # Готов
│   ├── order_delivering_handler   # В доставке
│   └── order_complete_handler     # Выполнен
```

## Миграция со старой системы

1. Все новые callback используют паттерн `order_confirm_{id}` / `order_reject_{id}`
2. Старые паттерны поддерживаются для обратной совместимости
3. `unified_order_handlers.router` регистрируется первым для приоритетной обработки
4. Автоматические уведомления клиентам при изменении статуса

## Тестирование

Для проверки системы:

1. **Самовывоз**: Создать заказ с `order_type="pickup"`, проверить код получения
2. **Доставка**: Создать заказ с `order_type="delivery"` и адресом
3. **Подтверждение**: Нажать кнопку продавцом, проверить уведомление клиенту
4. **Отклонение**: Нажать отклонить, проверить восстановление количества товара
5. **Полный цикл**: Пройти все статусы до `completed`
