# 📱 Fudly Bot - Полная карта функционала

## 1. 🚀 РЕГИСТРАЦИЯ (новый пользователь)

### Поток:
```
/start
  │
  ├─► Проверка: пользователь есть в БД?
  │   │
  │   ├─► НЕТ: Показать приветствие + выбор языка
  │   │       [🇷🇺 Русский] [🇺🇿 O'zbek]
  │   │
  │   └─► ДА: Проверить есть ли телефон
  │           │
  │           ├─► НЕТ телефона: Запросить телефон
  │           └─► ДА: Показать главное меню
  │
  └─► Выбор языка (lang_ru / lang_uz)
      │
      └─► Создать пользователя + Запросить телефон
          │
          └─► Получить контакт (Registration.phone)
              │
              └─► Сохранить телефон + Показать города
                  │
                  └─► Выбор города (reg_city_*)
                      │
                      └─► Сохранить город + Главное меню
```

### Файлы:
- `handlers/common/commands.py` - `/start`, `lang_*`
- `handlers/common/registration.py` - `Registration.phone`, `Registration.city`
- `app/keyboards/__init__.py` - `language_keyboard()`, `phone_request_keyboard()`, `city_inline_keyboard()`

### Состояния FSM:
- `Registration.phone` - ожидание номера телефона
- `Registration.city` - ожидание выбора города

---

## 2. 🏠 ГЛАВНОЕ МЕНЮ

### Покупатель:
```
[🔥 Горячее] [🏪 Заведения]
[🔍 Поиск]
[🛒 Корзина] [👤 Профиль]
```

### Продавец:
```
[📊 Статистика] [📦 Заказы]
[🍽 Меню] [⚙️ Настройки]
[👁 Режим покупателя]
```

### Файлы:
- `app/keyboards/__init__.py` - `main_menu_customer()`, `main_menu_seller()`

---

## 3. 🔥 ГОРЯЧИЕ ПРЕДЛОЖЕНИЯ

### Поток:
```
Нажал [🔥 Горячее]
  │
  └─► Получить офферы по городу пользователя
      │
      └─► Показать список с фото, названием, ценой
          │
          └─► Нажал на оффер (view_offer_*)
              │
              └─► Показать детали:
                  - Фото
                  - Название, описание
                  - Цена (старая/новая)
                  - Количество
                  - Магазин, адрес
                  │
                  └─► Кнопки: [Забронировать] [❤️ В избранное]
```

### Файлы:
- `handlers/customer/offers/browse.py` - просмотр офферов
- `handlers/customer/offers/search.py` - поиск

---

## 4. 📦 БРОНИРОВАНИЕ (Самовывоз)

### Поток:
```
Нажал [Забронировать] (book_offer_*)
  │
  └─► BookOffer.quantity: "Сколько хотите? (1-X)"
      │
      └─► Ввёл количество
          │
          ├─► Магазин БЕЗ доставки:
          │   └─► Сразу создать бронь
          │
          └─► Магазин С доставкой:
              └─► BookOffer.delivery_choice
                  │
                  ├─► [🏪 Самовывоз] (pickup_choice)
                  │   └─► Создать бронь
                  │
                  └─► [🚚 Доставка] (delivery_choice)
                      └─► Перейти к OrderDelivery
```

### После создания брони:
```
Клиент получает:
  "⏳ Бронь отправлена!
   📦 Булочки × 1
   💰 Итого: 6,000 сум
   🏪 Cosmos
   📍 Адрес
   ━━━━━━━━━━━━━━━━━━
   ⏳ Ожидаем подтверждения продавца...
   ━━━━━━━━━━━━━━━━━━
   💡 После подтверждения получите код и QR"

Продавец получает:
  "🛎 Новая бронь!
   📦 Булочки × 1
   💰 6,000 сум
   👤 Клиент: Имя
   📱 Телефон
   [✅ Подтвердить] [❌ Отклонить]"
```

### После подтверждения продавцом:
```
Клиент получает (с QR-кодом):
  "✅ Ваша бронь подтверждена!
   🏪 Cosmos
   📍 Адрес
   ━━━━━━━━━━━━━━━━━━
   🎫 Код бронирования:
   55
   ━━━━━━━━━━━━━━━━━━
   ⚠️ Покажите код или QR продавцу"

Продавец видит:
  "✅ Бронь #55 подтверждена.
   📋 Нажмите 'Выдано' когда клиент заберёт.
   [✅ Выдано] [❌ Отменить]"
```

### После выдачи:
```
Клиент: уведомление (если включены)
Бронь: статус = 'completed'
```

### Файлы:
- `handlers/bookings/customer.py` - бронирование клиента
- `handlers/bookings/partner.py` - подтверждение/отклонение
- `database_pg_module/mixins/bookings.py` - `create_booking_atomic()`

### Состояния FSM:
- `BookOffer.quantity` - ввод количества
- `BookOffer.delivery_choice` - выбор способа получения

---

## 5. 🚚 ДОСТАВКА (через такси)

### Поток создания заказа:
```
Нажал [🚚 Доставка] (delivery_choice)
  │
  └─► Проверка: сумма >= min_order_amount?
      │
      ├─► НЕТ: "❌ Минимальная сумма X сум"
      │
      └─► ДА: OrderDelivery.address
              "📍 Введите адрес доставки"
              │
              └─► Ввёл адрес
                  │
                  └─► OrderDelivery.payment_method
                      "Выберите способ оплаты"
                      [💳 Карта] [💵 Наличные]
                      │
                      └─► Карта:
                          └─► "Переведите X сум на карту Y"
                              "Отправьте скриншот чека"
                              │
                              └─► Отправил фото чека
                                  │
                                  └─► Создать заказ + отправить чек продавцу
```

### Поток обработки заказа (партнёр → курьер → клиент):
```
ЭТАП 1: ПОДТВЕРЖДЕНИЕ ОПЛАТЫ
──────────────────────────────
Продавец получает фото чека:
  "🛎 Новый заказ с доставкой!
   📦 Товар × кол-во
   💰 Сумма
   👤 Клиент: Имя
   📱 Телефон
   📍 Адрес доставки
   [✅ Подтвердить оплату] [❌ Отклонить]"

  └─► Нажал [✅ Подтвердить оплату]
      │
      └─► Статус: "preparing" (готовится)
          Клиент получает: "✅ Оплата подтверждена! 👨‍🍳 Заказ готовится..."
          Продавец видит: "✅ Оплата подтверждена!
                          📝 Когда заказ будет готов, передайте курьеру
                          [🚕 Передать курьеру]"

ЭТАП 2: ПЕРЕДАЧА КУРЬЕРУ
──────────────────────────────
Продавец нажимает [🚕 Передать курьеру]:
  └─► "📝 Введите имя курьера/таксиста:"
      │
      └─► Ввёл имя (например "Али")
          │
          └─► "📱 Введите телефон курьера:"
              │
              └─► Ввёл телефон
                  │
                  └─► Статус: "delivering" (в пути)

                      Продавец видит:
                        "✅ Заказ #123 передан курьеру!
                         🚕 Курьер: Али
                         📱 Телефон: +998..."

                      Клиент получает:
                        "🚕 Ваш заказ передан курьеру!
                         📦 Заказ #123
                         👤 Курьер: Али
                         📱 Телефон: +998...
                         📍 Адрес: ...
                         [✅ Получил заказ]"

ЭТАП 3: ПОЛУЧЕНИЕ ЗАКАЗА
──────────────────────────────
Клиент нажимает [✅ Получил заказ]:
  └─► Статус: "completed"

      Клиент видит:
        "✅ Заказ успешно доставлен!
         Спасибо за покупку! 🎉

         Как вам понравился заказ?
         [⭐][⭐⭐][⭐⭐⭐][⭐⭐⭐⭐][⭐⭐⭐⭐⭐]"

      Продавец получает:
        "✅ Заказ #123 доставлен!
         Клиент подтвердил получение."
```

### Статусы заказа доставки:
```
pending    → ⏳ Ожидает оплаты
confirmed  → ✅ Оплата подтверждена (deprecated, используется preparing)
preparing  → 👨‍🍳 Готовится
delivering → 🚗 В пути (передан курьеру)
completed  → ✅ Доставлен
cancelled  → ❌ Отменён
```

### Файлы:
- `handlers/customer/orders/delivery.py` - создание заказа с доставкой
- `handlers/seller/order_management.py` - подтверждение, передача курьеру
- `handlers/common/states.py` - `OrderDelivery`, `CourierHandover`

### Состояния FSM:
- `OrderDelivery.address` - ввод адреса
- `OrderDelivery.payment_method` - выбор оплаты
- `OrderDelivery.payment_proof` - ожидание скриншота чека
- `CourierHandover.courier_phone` - ввод телефона курьера

---

## 6. 🛒 КОРЗИНА

### Поток:
```
Нажал [🛒 Корзина]
  │
  └─► Получить брони + заказы пользователя
      │
      ├─► ВСЁ пусто:
      │   "🛒 Корзина пуста
      │    📜 Недавние заказы:
      │    ✔️ Булочки"
      │
      └─► Есть активные:
          "🛒 Моя корзина

           🏪 Самовывоз (1)
           ━━━━━━━━━━━━━━━━━━
           ⏳ Булочки
              📦 1 × 6,000 = 6,000 сум
              🏪 Cosmos
              📍 Каттакурган
              ⏳ Ожидает подтверждения

           Всего активных: 1
           [❌ Булочки] [🏪 Подробнее] [📜 История]"
```

### Статусы в корзине:
- `pending` → ⏳ "Ожидает подтверждения продавца" (без кода)
- `confirmed` → ✅ "Подтверждено" + Код + "Покажите продавцу"
- `active` → 🔵 "Активно"

### Файлы:
- `handlers/customer/features.py` - `my_cart()`

---

## 7. 👤 ПРОФИЛЬ

### Поток:
```
Нажал [👤 Профиль]
  │
  └─► Показать информацию:
      "👤 Ваш профиль
       📱 Телефон: +998...
       📍 Город: Ташкент
       📊 Заказов: 5"
      │
      └─► [⚙️ Настройки]
          │
          ├─► [🔔 Уведомления] - вкл/выкл
          ├─► [🌐 Язык] - выбор языка
          └─► [🗑 Удалить аккаунт]
              │
              └─► "Вы уверены?"
                  [Да, удалить] [Отмена]
                  │
                  └─► Удалить + Показать регистрацию
```

### Файлы:
- `handlers/customer/profile.py` - профиль
- `handlers/customer/features.py` - настройки, удаление

---

## 8. 🏪 ПРОДАВЕЦ (Партнёр)

### Главное меню:
```
[📊 Статистика] [📦 Заказы]
[🍽 Меню] [⚙️ Настройки]
[👁 Режим покупателя]
```

### Управление заказами:
```
Нажал [📦 Заказы]
  │
  └─► Список активных броней/заказов
      │
      └─► Для каждой брони:
          [✅ Подтвердить] [❌ Отклонить]
          │
          └─► После подтверждения:
              [✅ Выдано] [❌ Отменить]
```

### Файлы:
- `handlers/seller/` - все хендлеры продавца
- `handlers/bookings/partner.py` - работа с бронями

---

## 9. 📱 QR-КОД И РУЧНОЙ ВВОД КОДА

### Генерация QR (для самовывоза):
```
Продавец подтверждает бронь
  │
  └─► Генерация QR с deep link:
      t.me/FudlyBot?start=pickup_CODE
      │
      └─► Отправка клиенту: фото QR + код
```

### Сканирование QR:
```
Продавец сканирует QR с телефона клиента
  │
  └─► Открывается бот с /start pickup_CODE
      │
      └─► Проверка: это владелец магазина?
          │
          ├─► ДА: Показать бронь + [✅ Подтвердить выдачу]
          └─► НЕТ: "Вы не владелец"
```

### Ручной ввод кода (команда /code):
```
Продавец вводит /code
  │
  └─► "📝 Введите код бронирования клиента:"
      │
      └─► Ввёл код (например "55" или "FUDLY-55")
          │
          └─► Показать бронь + [✅ Подтвердить выдачу]

Или: /code 55 (сразу с кодом)
```

### Файлы:
- `app/core/qr_generator.py` - генерация QR
- `handlers/common/commands.py` - `handle_qr_pickup()`, `/code` команда
- `handlers/bookings/partner.py` - отправка QR клиенту

---

## 10. 🔧 УТИЛИТЫ

### Отмена действия:
```
Нажал [❌ Отмена] в любом месте
  │
  └─► Очистить FSM state
      │
      └─► Вернуть главное меню
```

### Команды:
- `/start` - начало/главное меню
- `/code` - ручной ввод кода бронирования (для партнёров)
- `/mybookings` - все мои брони (debug)
- `/cancelall` - отменить все активные (debug)
- `/checkdb` - проверка БД (debug)

---

## 📁 Структура файлов

```
handlers/
├── common/
│   ├── commands.py      # /start, /code, язык, город, QR
│   ├── registration.py  # телефон, город
│   ├── states.py        # FSM состояния (включая CourierHandover)
│   └── utils.py         # утилиты
│
├── customer/
│   ├── features.py      # корзина, настройки
│   ├── profile.py       # профиль
│   ├── favorites.py     # избранное
│   ├── menu.py          # меню
│   ├── offers/
│   │   ├── browse.py    # просмотр офферов
│   │   └── search.py    # поиск
│   └── orders/
│       └── delivery.py  # заказы с доставкой (создание)
│
├── bookings/
│   ├── customer.py      # бронирование клиента (самовывоз)
│   ├── partner.py       # подтверждение продавца
│   └── utils.py         # утилиты бронирования
│
├── seller/
│   ├── dashboard.py     # статистика
│   ├── order_management.py  # подтверждение оплаты, передача курьеру
│   └── management/
│       ├── offers.py    # управление офферами
│       └── orders.py    # управление заказами
│
└── admin/
    └── dashboard.py     # админ панель
```
