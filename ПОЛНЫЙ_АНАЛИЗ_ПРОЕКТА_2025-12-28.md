# üìö –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–û–ï–ö–¢–ê FUDLY BOT
## –î–µ—Ç–∞–ª—å–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

**–î–∞—Ç–∞:** 28 –¥–µ–∫–∞–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 2.0.0  
**–ê–≤—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∞:** AI Assistant  
**–Ø–∑—ã–∫:** –†—É—Å—Å–∫–∏–π  

> üí° **–¶–µ–ª—å –¥–æ–∫—É–º–µ–Ω—Ç–∞:** –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞, –ø–∞–ø–∫–∏ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞. –ü–æ—Å–ª–µ –ø—Ä–æ—á—Ç–µ–Ω–∏—è –≤—ã –±—É–¥–µ—Ç–µ –∑–Ω–∞—Ç—å –ì–î–ï –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç, –ß–¢–û –æ–Ω –¥–µ–ª–∞–µ—Ç, –∏ –ö–ê–ö —Å –Ω–∏–º —Ä–∞–±–æ—Ç–∞—Ç—å.

---

## üìñ –°–û–î–ï–†–ñ–ê–ù–ò–ï

1. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
2. [–ö–æ—Ä–Ω–µ–≤—ã–µ —Ñ–∞–π–ª—ã](#–∫–æ—Ä–Ω–µ–≤—ã–µ-—Ñ–∞–π–ª—ã)
3. [–ü–∞–ø–∫–∞ app/ - –Ø–¥—Ä–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è](#–ø–∞–ø–∫–∞-app)
4. [–ü–∞–ø–∫–∞ handlers/ - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Telegram](#–ø–∞–ø–∫–∞-handlers)
5. [–ü–∞–ø–∫–∞ database_pg_module/ - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–ø–∞–ø–∫–∞-database)
6. [–ü–∞–ø–∫–∞ webapp/ - –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ](#–ø–∞–ø–∫–∞-webapp)
7. [–ü–∞–ø–∫–∞ tests/ - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#–ø–∞–ø–∫–∞-tests)
8. [–ü–∞–ø–∫–∞ migrations/ - –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î](#–ø–∞–ø–∫–∞-migrations)
9. [–ü–∞–ø–∫–∞ tasks/ - Background workers](#–ø–∞–ø–∫–∞-tasks)
10. [–ü–∞–ø–∫–∞ scripts/ - –£—Ç–∏–ª–∏—Ç—ã](#–ø–∞–ø–∫–∞-scripts)
11. [–ü–∞–ø–∫–∞ docs/ - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](#–ø–∞–ø–∫–∞-docs)
12. [–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç](#–∫–∞–∫-—Ä–∞–±–æ—Ç–∞–µ—Ç-–ø—Ä–æ–µ–∫—Ç)

---

## üóÇÔ∏è –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê

```
fudly-bot-main/
‚îÇ
‚îú‚îÄ‚îÄ ü§ñ bot.py                          # –ì–õ–ê–í–ù–´–ô –§–ê–ô–õ - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –±–æ—Ç–∞
‚îú‚îÄ‚îÄ üìÑ requirements.txt                # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ üìù README.md                       # –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
‚îú‚îÄ‚îÄ ‚öôÔ∏è .env.example                    # –®–∞–±–ª–æ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ üê≥ Dockerfile                      # Docker –æ–±—Ä–∞–∑ –¥–ª—è production
‚îú‚îÄ‚îÄ üê≥ docker-compose.yml              # –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ (bot + PostgreSQL + Redis)
‚îú‚îÄ‚îÄ üß™ pytest.ini                      # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ pytest (–µ—Å–ª–∏ –µ—Å—Ç—å)
‚îú‚îÄ‚îÄ üì¶ pyproject.toml                  # Python project metadata + tools config
‚îú‚îÄ‚îÄ üîß railway.toml                    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Railway deployment
‚îÇ
‚îú‚îÄ‚îÄ üìÇ app/                            # –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py                    # –î–µ–ª–∞–µ—Ç app Python –ø–∞–∫–µ—Ç–æ–º
‚îÇ   ‚îú‚îÄ‚îÄ api/                           # REST API –¥–ª—è Mini App (FastAPI)
‚îÇ   ‚îú‚îÄ‚îÄ core/                          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, security, utilities
‚îÇ   ‚îú‚îÄ‚îÄ domain/                        # –ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª–∏ (Pydantic schemas)
‚îÇ   ‚îú‚îÄ‚îÄ integrations/                  # –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã (–ø–ª–∞—Ç–µ–∂–∏, AI)
‚îÇ   ‚îú‚îÄ‚îÄ keyboards/                     # Telegram –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ middlewares/                   # aiogram middlewares
‚îÇ   ‚îú‚îÄ‚îÄ repositories/                  # Data Access Layer (—Å –∫–µ—à–µ–º)
‚îÇ   ‚îú‚îÄ‚îÄ services/                      # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ templates/                     # –®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ
‚îú‚îÄ‚îÄ üìÇ handlers/                       # TELEGRAM BOT HANDLERS
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py                    # Router aggregation
‚îÇ   ‚îú‚îÄ‚îÄ README.md                      # –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã handlers
‚îÇ   ‚îú‚îÄ‚îÄ common/                        # –û–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã (/start, /help)
‚îÇ   ‚îú‚îÄ‚îÄ customer/                      # –ü–æ–∫—É–ø–∞—Ç–µ–ª–∏ (–∑–∞–∫–∞–∑—ã, –ø–æ–∏—Å–∫)
‚îÇ   ‚îú‚îÄ‚îÄ seller/                        # –ü—Ä–æ–¥–∞–≤—Ü—ã (—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤)
‚îÇ   ‚îú‚îÄ‚îÄ bookings/                      # –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ admin/                         # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (–º–æ–¥–µ—Ä–∞—Ü–∏—è)
‚îÇ
‚îú‚îÄ‚îÄ üìÇ database_pg_module/             # –ë–ê–ó–ê –î–ê–ù–ù–´–• PostgreSQL
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py                    # Exports –¥–ª—è backwards compatibility
‚îÇ   ‚îú‚îÄ‚îÄ core.py                        # Connection pool, HybridRow
‚îÇ   ‚îú‚îÄ‚îÄ schema.py                      # CREATE TABLE statements
‚îÇ   ‚îú‚îÄ‚îÄ database.py                    # –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å Database
‚îÇ   ‚îú‚îÄ‚îÄ crypto.py                      # Encryption helpers
‚îÇ   ‚îî‚îÄ‚îÄ mixins/                        # SQL –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ —Å—É—â–Ω–æ—Å—Ç—è–º
‚îÇ       ‚îú‚îÄ‚îÄ users.py                   # –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îÇ       ‚îú‚îÄ‚îÄ stores.py                  # –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –º–∞–≥–∞–∑–∏–Ω–∞–º–∏
‚îÇ       ‚îú‚îÄ‚îÄ offers.py                  # –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏
‚îÇ       ‚îú‚îÄ‚îÄ bookings.py                # –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (atomic)
‚îÇ       ‚îú‚îÄ‚îÄ orders.py                  # –ó–∞–∫–∞–∑—ã (unified pickup + delivery)
‚îÇ       ‚îú‚îÄ‚îÄ ratings.py                 # –†–µ–π—Ç–∏–Ω–≥–∏
‚îÇ       ‚îú‚îÄ‚îÄ favorites.py               # –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
‚îÇ       ‚îú‚îÄ‚îÄ search.py                  # –ü–æ–∏—Å–∫
‚îÇ       ‚îú‚îÄ‚îÄ stats.py                   # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚îÇ       ‚îú‚îÄ‚îÄ payments.py                # –ü–ª–∞—Ç—ë–∂–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
‚îÇ       ‚îî‚îÄ‚îÄ notifications.py           # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îÇ
‚îú‚îÄ‚îÄ üìÇ webapp/                         # –í–ï–ë-–ü–†–ò–õ–û–ñ–ï–ù–ò–ï (React + Vite)
‚îÇ   ‚îú‚îÄ‚îÄ src/                           # –ò—Å—Ö–æ–¥–Ω–∏–∫–∏ React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.jsx                   # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ React
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ App.jsx                    # –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/                     # –°—Ç—Ä–∞–Ω–∏—Ü—ã (React Router)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/                # React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ context/                   # Context API (Cart, Location)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/                       # API client (axios)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/                     # Custom React hooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/                     # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ styles/                    # CSS —Å—Ç–∏–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ public/                        # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
‚îÇ   ‚îú‚îÄ‚îÄ tests/                         # Frontend —Ç–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ package.json                   # npm dependencies
‚îÇ   ‚îú‚îÄ‚îÄ vite.config.js                 # Vite –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ vitest.config.js               # Vitest —Ç–µ—Å—Ç—ã
‚îÇ
‚îú‚îÄ‚îÄ üìÇ tests/                          # –¢–ï–°–¢–´ (pytest)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ test_database.py               # –¢–µ—Å—Ç—ã –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ test_services.py               # –¢–µ—Å—Ç—ã –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ test_e2e_*.py                  # E2E —Ç–µ—Å—Ç—ã user flows
‚îÇ   ‚îú‚îÄ‚îÄ test_security.py               # Security —Ç–µ—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ ... (30+ test files)
‚îÇ
‚îú‚îÄ‚îÄ üìÇ migrations/                     # DATABASE MIGRATIONS
‚îÇ   ‚îú‚îÄ‚îÄ v22_unified_orders.sql         # –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ unified orders
‚îÇ   ‚îú‚îÄ‚îÄ v23_add_performance_indexes.sql
‚îÇ   ‚îú‚îÄ‚îÄ v24_migrate_bookings.sql
‚îÇ   ‚îî‚îÄ‚îÄ ... (SQL –º–∏–≥—Ä–∞—Ü–∏–∏)
‚îÇ
‚îú‚îÄ‚îÄ üìÇ tasks/                          # BACKGROUND WORKERS
‚îÇ   ‚îú‚îÄ‚îÄ booking_expiry_worker.py       # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å—Ç–µ—á–µ–Ω–∏–µ –±—Ä–æ–Ω–µ–π
‚îÇ   ‚îî‚îÄ‚îÄ rating_reminder_worker.py      # –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
‚îÇ
‚îú‚îÄ‚îÄ üìÇ scripts/                        # UTILITY SCRIPTS
‚îÇ   ‚îú‚îÄ‚îÄ migrate.py                     # –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ check_db_structure.py          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ smoke_test_pickup.py           # Smoke test –¥–ª—è pickup
‚îÇ   ‚îî‚îÄ‚îÄ ... (—Ä–∞–∑–ª–∏—á–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã)
‚îÇ
‚îú‚îÄ‚îÄ üìÇ docs/                           # –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø
‚îÇ   ‚îú‚îÄ‚îÄ architecture/                  # –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ api/                           # API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ guides/                        # –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞
‚îÇ   ‚îî‚îÄ‚îÄ audits/                        # –ê—É–¥–∏—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞
‚îÇ
‚îú‚îÄ‚îÄ üìÇ locales/                        # –ü–ï–†–ï–í–û–î–´ (i18n)
‚îÇ   ‚îú‚îÄ‚îÄ ru/                            # –†—É—Å—Å–∫–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ uz/                            # –£–∑–±–µ–∫—Å–∫–∏–π
‚îÇ
‚îú‚îÄ‚îÄ üìÑ localization.py                 # –§—É–Ω–∫—Ü–∏–∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ (legacy)
‚îú‚îÄ‚îÄ üìÑ database_protocol.py            # Protocol –¥–ª—è type safety
‚îú‚îÄ‚îÄ üìÑ database.py                     # Backwards compatibility wrapper
‚îú‚îÄ‚îÄ üìÑ database_pg.py                  # Backwards compatibility wrapper
‚îú‚îÄ‚îÄ üìÑ fsm_storage_pg.py               # PostgreSQL FSM storage
‚îú‚îÄ‚îÄ üìÑ logging_config.py               # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ üìÑ security.py                     # Security helpers (re-export)
‚îÇ
‚îî‚îÄ‚îÄ üìÇ load_tests/                     # LOAD TESTING
    ‚îú‚îÄ‚îÄ load_test_pg.py                # –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã PostgreSQL
    ‚îî‚îÄ‚îÄ test_concurrent_bookings.py    # –¢–µ—Å—Ç—ã race conditions
```

---

## üìÅ –ö–û–†–ù–ï–í–´–ï –§–ê–ô–õ–´

### ü§ñ `bot.py` (887 —Å—Ç—Ä–æ–∫) - –ì–õ–ê–í–ù–´–ô –§–ê–ô–õ

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤—Å–µ–≥–æ Telegram –±–æ—Ç–∞. –ó–¥–µ—Å—å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**

```python
# 1. –ò–º–ø–æ—Ä—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
from app.core.bootstrap import build_application
from app.core.config import load_settings

# 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ .env
settings = load_settings()
ADMIN_ID = settings.admin_id
DATABASE_URL = settings.database_url
USE_WEBHOOK = settings.webhook.enabled

# 3. –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–∞–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
bot, dp, db, cache = build_application(settings)
# bot = aiogram Bot (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π)
# dp = Dispatcher (—Ä–æ—É—Ç–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π)
# db = Database (PostgreSQL)
# cache = CacheManager (Redis –∏–ª–∏ in-memory)

# 4. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
offer_service = OfferService(db, cache)
admin_service = AdminService(db)
unified_order_service = UnifiedOrderService(db, bot)

# 5. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è handlers
from handlers import common, customer, seller, bookings, admin
dp.include_router(common.router)
dp.include_router(customer.router)
# ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ

# 6. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == "__main__":
    if USE_WEBHOOK:
        # Production: Railway
        run_webhook_mode()
    else:
        # Development: –ª–æ–∫–∞–ª—å–Ω–æ
        asyncio.run(dp.start_polling(bot))
```

**–ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:**
- `python bot.py` - –ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
- `railway up` - production deployment
- `docker-compose up` - Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

**–í–∞–∂–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:**
- `ADMIN_ID` - Telegram ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- `DATABASE_URL` - —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
- `USE_WEBHOOK` - —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã (webhook –¥–ª—è production, polling –¥–ª—è dev)

---

### üìÑ `requirements.txt` - Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö Python –±–∏–±–ª–∏–æ—Ç–µ–∫, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω—ã –ø—Ä–æ–µ–∫—Ç—É.

**–û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**

```python
# Telegram Bot Framework
aiogram>=3.0.0                    # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è Telegram –±–æ—Ç–æ–≤

# Environment variables
python-dotenv>=0.19.0             # –ß—Ç–µ–Ω–∏–µ .env —Ñ–∞–π–ª–æ–≤

# Web frameworks
aiohttp>=3.9.0                    # Async HTTP server –¥–ª—è webhook
fastapi>=0.109.0                  # REST API –¥–ª—è Mini App
uvicorn>=0.27.0                   # ASGI server –¥–ª—è FastAPI

# Database
psycopg[binary]>=3.2              # PostgreSQL –¥—Ä–∞–π–≤–µ—Ä
psycopg-pool>=3.2                 # Connection pooling

# Caching
redis>=5.0.0                      # Redis client
cachetools>=5.3.0                 # In-memory cache

# Security
cryptography>=42.0.0              # Encryption (Fernet)
python-multipart>=0.0.6           # File uploads

# Production features
sentry-sdk>=1.40.0                # Error tracking
python-json-logger>=2.0.0         # Structured logging

# Image processing
Pillow>=10.0.0                    # Image manipulation
qrcode>=7.4.0                     # QR code generation

# AI Integration
google-generativeai>=0.3.0        # Google Gemini API

# Testing
pytest>=7.4.0                     # Unit testing
pytest-cov>=4.1.0                 # Coverage reporting
pytest-asyncio>=0.21.0            # Async tests

# Development tools
ruff>=0.1.7                       # Fast linter
black>=23.12.0                    # Code formatter
pre-commit>=3.6.0                 # Git hooks
```

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
pip install -r requirements.txt
```

---

### ‚öôÔ∏è `.env.example` - –®–∞–±–ª–æ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –®–∞–±–ª–æ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è `.env` —Ñ–∞–π–ª–∞ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```bash
# ============================================
# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò
# ============================================

# –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –æ—Ç @BotFather
TELEGRAM_BOT_TOKEN=your_bot_token_here

# Telegram ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–ø–æ–ª—É—á–∏—Ç—å —É @userinfobot)
ADMIN_ID=your_telegram_id

# URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Mini App)
WEBAPP_URL=https://fudly-webapp.vercel.app

# ============================================
# –ë–ê–ó–ê –î–ê–ù–ù–´–•
# ============================================

# PostgreSQL (Railway –∏–ª–∏ Docker)
DATABASE_URL=postgresql://user:password@host:5432/dbname

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ connection pool
DB_MIN_CONN=5          # –ú–∏–Ω–∏–º—É–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
DB_MAX_CONN=20         # –ú–∞–∫—Å–∏–º—É–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
DB_TIMEOUT=30          # –¢–∞–π–º–∞—É—Ç (—Å–µ–∫—É–Ω–¥—ã)

# ============================================
# –†–ï–ñ–ò–ú –†–ê–ë–û–¢–´
# ============================================

# Webhook –¥–ª—è production (Railway)
USE_WEBHOOK=true
WEBHOOK_URL=https://your-app.railway.app
WEBHOOK_PATH=/webhook
PORT=8080
SECRET_TOKEN=your_random_secret_token_here

# Polling –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–ª–æ–∫–∞–ª—å–Ω–æ)
# USE_WEBHOOK=false

# ============================================
# –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)
# ============================================

# Redis –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
REDIS_URL=redis://localhost:6379/0

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
LOG_LEVEL=INFO

# Sentry –¥–ª—è error tracking
SENTRY_DSN=your_sentry_dsn

# Encryption –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
ENCRYPTION_KEY=your_fernet_key_here

# –ü–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ Telegram
TELEGRAM_PAYMENT_PROVIDER_TOKEN=your_provider_token
```

**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: `cp .env.example .env`
2. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–≤–æ–∏ –∑–Ω–∞—á–µ–Ω–∏—è
3. `.env` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

**–í–ê–ñ–ù–û:** `.env` —Ñ–∞–π–ª –ù–ï –∫–æ–º–º–∏—Ç–∏—Ç—Å—è –≤ git (–Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `.gitignore`)!

---

### üê≥ `Dockerfile` - Docker –æ–±—Ä–∞–∑

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Å–±–æ—Ä–∫–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```dockerfile
# ============================================
# Stage 1: Builder - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
# ============================================
FROM python:3.11-slim AS builder

WORKDIR /build

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º build tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# –°–æ–∑–¥–∞—ë–º virtual environment
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –ø–∞–∫–µ—Ç—ã
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# ============================================
# Stage 2: Runtime - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑
# ============================================
FROM python:3.11-slim AS runtime

LABEL maintainer="Fudly Team <support@fudly.uz>"
LABEL version="2.0.0"

WORKDIR /app

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    libpq5 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# –ö–æ–ø–∏—Ä—É–µ–º virtual environment –∏–∑ builder
COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Environment –¥–ª—è Python
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONFAULTHANDLER=1

# –°–æ–∑–¥–∞—ë–º non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å!)
RUN groupadd -r botuser && useradd -r -g botuser -u 1000 botuser

# –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
COPY --chown=botuser:botuser . .

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ non-root
USER botuser

# –ü–æ—Ä—Ç –¥–ª—è health checks
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:${PORT:-8080}/health || exit 1

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
CMD ["python", "bot.py"]
```

**–ü–æ—á–µ–º—É multi-stage build?**
- **Stage 1 (builder):** –ë–æ–ª—å—à–æ–π –æ–±—Ä–∞–∑ —Å gcc –∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞–º–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
- **Stage 2 (runtime):** –ú–∞–ª–µ–Ω—å–∫–∏–π –æ–±—Ä–∞–∑ —Ç–æ–ª—å–∫–æ —Å —Ç–µ–º —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –†–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–∞ –º–µ–Ω—å—à–µ –Ω–∞ ~500MB

**–°–±–æ—Ä–∫–∞:**
```bash
docker build -t fudly-bot .
```

**–ó–∞–ø—É—Å–∫:**
```bash
docker run -d --env-file .env fudly-bot
```

---

### üê≥ `docker-compose.yml` - –õ–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–∫

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ó–∞–ø—É—Å–∫ –≤—Å–µ–≥–æ —Å—Ç–µ–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ (bot + PostgreSQL + Redis).

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```yaml
services:
  # ============================================
  # Telegram Bot
  # ============================================
  bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fudly-bot
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - ADMIN_ID=${ADMIN_ID}
      # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL –≤–Ω—É—Ç—Ä–∏ Docker network
      - DATABASE_URL=postgresql://fudly:password@postgres:5432/fudly
      - USE_WEBHOOK=false          # –õ–æ–∫–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º polling
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      postgres:
        condition: service_healthy  # –ñ–¥—ë–º –ø–æ–∫–∞ PostgreSQL –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
      redis:
        condition: service_healthy
    networks:
      - fudly-network
    
  # ============================================
  # PostgreSQL Database
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: fudly-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=fudly
      - POSTGRES_USER=fudly
      - POSTGRES_PASSWORD=password
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    # –ü–æ—Ä—Ç –ù–ï –æ—Ç–∫—Ä—ã—Ç –Ω–∞—Ä—É–∂—É (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å!)
    # –¢–æ–ª—å–∫–æ bot –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –≤–Ω—É—Ç—Ä–∏ Docker network
    networks:
      - fudly-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fudly -d fudly"]
      interval: 10s
      timeout: 5s
      retries: 5
    
  # ============================================
  # Redis Cache
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: fudly-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 100mb
    volumes:
      - redis-data:/data
    networks:
      - fudly-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

networks:
  fudly-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
```

**–ó–∞–ø—É—Å–∫:**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë
docker-compose up -d

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
docker-compose logs -f bot

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë
docker-compose down

# –£–¥–∞–ª–∏—Ç—å volumes (–ë–î –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω–∞!)
docker-compose down -v
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –í—Å—ë –≤ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ
- –ù–µ –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å PostgreSQL –∏ Redis –ª–æ–∫–∞–ª—å–Ω–æ
- –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

---

### üì¶ `pyproject.toml` - Python metadata

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```toml
[tool.poetry]
name = "fudly-bot"
version = "2.0.0"
description = "Telegram bot –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –µ–¥—ã —Å–æ —Å–∫–∏–¥–∫–æ–π"
authors = ["shaxa2505"]
license = "MIT"

[tool.poetry.dependencies]
python = "^3.11"
aiogram = ">=3.0.0"
# ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

# ============================================
# Black - code formatter
# ============================================
[tool.black]
line-length = 100
target-version = ['py311']
include = '\.pyi?$'

# ============================================
# Ruff - linter (–∑–∞–º–µ–Ω–∞ Flake8, isort, etc)
# ============================================
[tool.ruff]
line-length = 100
target-version = "py311"
select = [
    "E",   # pycodestyle errors
    "W",   # pycodestyle warnings
    "F",   # pyflakes
    "I",   # isort (import sorting)
    "C",   # flake8-comprehensions
    "B",   # flake8-bugbear
    "UP",  # pyupgrade
]
ignore = [
    "E501",  # line too long (handled by black)
    "E402",  # module level import not at top
]

# ============================================
# MyPy - type checking
# ============================================
[tool.mypy]
python_version = "3.11"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = false
ignore_missing_imports = false
strict_optional = true

# ============================================
# Pytest - testing
# ============================================
[tool.pytest.ini_options]
minversion = "7.0"
addopts = "-ra -q --strict-markers"
testpaths = ["tests"]
pythonpath = ["."]
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```bash
# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
black .

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
ruff check .

# –ê–≤—Ç–æ—Ñ–∏–∫—Å
ruff check --fix .

# Type checking
mypy app/ handlers/

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
pytest
```

---

### üîß `railway.toml` - Railway deployment

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ Railway.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```toml
[build]
builder = "NIXPACKS"

[deploy]
startCommand = "python bot.py"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

[env]
# Health check endpoint
HEALTH_CHECK_PATH = "/health"
PORT = "8080"
```

**Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**
1. –ß–∏—Ç–∞–µ—Ç `requirements.txt`
2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Python 3.11
3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
4. –ó–∞–ø—É—Å–∫–∞–µ—Ç `python bot.py`

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ Railway Dashboard:**
- `TELEGRAM_BOT_TOKEN`
- `ADMIN_ID`
- `DATABASE_URL` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ Railway PostgreSQL)
- `USE_WEBHOOK=true`
- `WEBHOOK_URL=https://your-app.railway.app`

---

## üìÇ –ü–ê–ü–ö–ê `app/` - –Ø–î–†–û –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø

–≠—Ç–æ —Å–∞–º–∞—è –≤–∞–∂–Ω–∞—è –ø–∞–ø–∫–∞! –ó–¥–µ—Å—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞.

### üìÅ `app/__init__.py`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –î–µ–ª–∞–µ—Ç `app/` Python –ø–∞–∫–µ—Ç–æ–º.

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:** –û–±—ã—á–Ω–æ –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ imports:

```python
"""Fudly Bot Application Package"""
__version__ = "2.0.0"
```

---

### üìÇ `app/api/` - REST API –¥–ª—è Mini App

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** FastAPI endpoints –¥–ª—è React –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–§–∞–π–ª—ã:**

#### `api_server.py` - –ì–ª–∞–≤–Ω—ã–π API server

```python
"""FastAPI application for Mini App."""
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI(
    title="Fudly API",
    version="2.0.0",
    docs_url="/api/docs",      # Swagger UI
    redoc_url="/api/redoc"     # ReDoc
)

# CORS –¥–ª—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://fudly-webapp.vercel.app",
        "https://telegram.org",
    ],
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["*"],
)

# Health check
@app.get("/health")
async def health_check():
    return {"status": "ok", "timestamp": datetime.now()}

# –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã
from app.api import auth, orders, partner_panel_simple
app.include_router(auth.router, prefix="/api/v1")
app.include_router(orders.router, prefix="/api/v1")
app.include_router(partner_panel_simple.router, prefix="/api/partner")

def run_api_server(host="0.0.0.0", port=8000):
    """–ó–∞–ø—É—Å–∫ API server."""
    import uvicorn
    uvicorn.run(app, host=host, port=port)
```

**–ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:** –í –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ/–ø—Ä–æ—Ü–µ—Å—Å–µ –≤–º–µ—Å—Ç–µ —Å –±–æ—Ç–æ–º.

---

#### `auth.py` - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è Mini App

```python
"""
Telegram Mini App Authentication.

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –æ—Ç –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ Telegram,
–∞ –Ω–µ –æ—Ç –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞.
"""

from fastapi import APIRouter, Depends, HTTPException, Header
from pydantic import BaseModel

router = APIRouter(prefix="/api/v1", tags=["auth"])

class AuthRequest(BaseModel):
    """Request –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏."""
    init_data: str  # Telegram WebApp.initData

class UserProfile(BaseModel):
    """Response —Å –ø—Ä–æ—Ñ–∏–ª–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    user_id: int
    username: str | None
    first_name: str
    phone: str | None
    city: str
    language: str
    registered: bool

@router.post("/auth/validate", response_model=UserProfile)
async def validate_auth(request: AuthRequest, db=Depends(get_db)):
    """
    –í–∞–ª–∏–¥–∞—Ü–∏—è Telegram WebApp initData.
    
    –ê–ª–≥–æ—Ä–∏—Ç–º:
    1. –ü–∞—Ä—Å–∏–º initData (URL-encoded —Å—Ç—Ä–æ–∫–∞)
    2. –ü—Ä–æ–≤–µ—Ä—è–µ–º HMAC-SHA256 –ø–æ–¥–ø–∏—Å—å
    3. –ü—Ä–æ–≤–µ—Ä—è–µ–º auth_date (–Ω–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤)
    4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Security:
    - HMAC signature –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥–¥–µ–ª–∫—É
    - auth_date –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç replay attacks
    - –¢–æ–ª—å–∫–æ Telegram –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –≤–∞–ª–∏–¥–Ω—É—é –ø–æ–¥–ø–∏—Å—å
    """
    
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å
    validated_data = validate_telegram_webapp_data(
        request.init_data,
        settings.bot_token
    )
    
    if not validated_data:
        raise HTTPException(401, "Invalid signature")
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º auth_date
    auth_timestamp = int(validated_data.get("auth_date", 0))
    age = time.time() - auth_timestamp
    
    if age > 86400:  # 24 —á–∞—Å–∞
        raise HTTPException(401, "Auth data expired")
    
    # 3. –ü–æ–ª—É—á–∞–µ–º user_id
    telegram_user = validated_data["user"]
    user_id = telegram_user["id"]
    
    # 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –ë–î
    user = db.get_user_model(user_id)
    
    if not user:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
        return UserProfile(
            user_id=user_id,
            username=telegram_user.get("username"),
            first_name=telegram_user["first_name"],
            phone=None,
            city="–¢–∞—à–∫–µ–Ω—Ç",
            language="ru",
            registered=False
        )
    
    # 5. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
    return UserProfile(
        user_id=user_id,
        username=user.get("username"),
        first_name=user.get("first_name"),
        phone=user.get("phone"),
        city=user.get("city", "–¢–∞—à–∫–µ–Ω—Ç"),
        language=user.get("language", "ru"),
        registered=True
    )


def validate_telegram_webapp_data(init_data: str, bot_token: str) -> dict | None:
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ HMAC –ø–æ–¥–ø–∏—Å–∏ Telegram WebApp.
    
    –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
    https://core.telegram.org/bots/webapps#validating-data-received-via-the-mini-app
    
    Returns:
        dict —Å parsed –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ None –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å—å –Ω–µ–≤–∞–ª–∏–¥–Ω–∞
    """
    import hmac
    import hashlib
    from urllib.parse import parse_qsl
    
    # –ü–∞—Ä—Å–∏–º URL-encoded –¥–∞–Ω–Ω—ã–µ
    parsed = dict(parse_qsl(init_data))
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º hash
    received_hash = parsed.pop("hash", None)
    if not received_hash:
        return None
    
    # –°–æ–∑–¥–∞—ë–º data_check_string
    data_check_string = "\n".join(
        f"{k}={v}" for k, v in sorted(parsed.items())
    )
    
    # –í—ã—á–∏—Å–ª—è–µ–º secret_key
    secret_key = hmac.new(
        b"WebAppData",
        bot_token.encode(),
        hashlib.sha256
    ).digest()
    
    # –í—ã—á–∏—Å–ª—è–µ–º hash
    computed_hash = hmac.new(
        secret_key,
        data_check_string.encode(),
        hashlib.sha256
    ).hexdigest()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º
    if computed_hash != received_hash:
        return None
    
    # –ü–∞—Ä—Å–∏–º user JSON
    import json
    parsed["user"] = json.loads(parsed["user"])
    
    return parsed
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ React:**

```javascript
// webapp/src/utils/auth.js
const initData = window.Telegram.WebApp.initData

const response = await axios.post('/api/v1/auth/validate', {
  init_data: initData
})

const profile = response.data
if (!profile.registered) {
  // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
}
```

---

#### `partner_panel_simple.py` - API –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–æ–≤

```python
"""
API endpoints –¥–ª—è Partner Panel (–≤–µ–±-–ø–∞–Ω–µ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞).

Endpoints:
- GET  /api/partner/products       - –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –º–∞–≥–∞–∑–∏–Ω–∞
- POST /api/partner/products       - –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä
- PUT  /api/partner/products/:id   - –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
- DELETE /api/partner/products/:id - –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä
- GET  /api/partner/orders         - –ó–∞–∫–∞–∑—ã –º–∞–≥–∞–∑–∏–Ω–∞
- PUT  /api/partner/orders/:id     - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
- GET  /api/partner/stats          - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
"""

from fastapi import APIRouter, Depends, HTTPException, Header
from pydantic import BaseModel, Field

router = APIRouter(prefix="/api/partner", tags=["partner"])

# ============================================
# Request/Response Models
# ============================================

class CreateProductRequest(BaseModel):
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞."""
    title: str = Field(..., min_length=1, max_length=200)
    category: str = Field(..., pattern="^(bread|dairy|meat|...)$")
    original_price: int = Field(..., gt=0)
    discount_price: int = Field(..., gt=0)
    quantity: int = Field(..., ge=1)
    description: str | None = None
    available_from: str | None = None  # HH:MM
    available_until: str | None = None
    
    @field_validator('discount_price')
    def validate_discount(cls, v, info):
        if v >= info.data.get('original_price'):
            raise ValueError("Discount must be less than original")
        return v

class UpdateProductRequest(BaseModel):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞."""
    title: str | None = None
    quantity: int | None = Field(None, ge=0)
    discount_price: int | None = Field(None, gt=0)
    # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è

class ProductResponse(BaseModel):
    """–û—Ç–≤–µ—Ç —Å —Ç–æ–≤–∞—Ä–æ–º."""
    id: int
    title: str
    category: str
    original_price: int
    discount_price: int
    quantity: int
    created_at: str
    # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è

# ============================================
# Authentication Dependency
# ============================================

async def get_current_user_id(
    x_telegram_init_data: str = Header(...),
    db=Depends(get_db)
) -> int:
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç user_id –∏–∑ Telegram initData.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ dependency –¥–ª—è –≤—Å–µ—Ö endpoints.
    """
    validated = validate_telegram_webapp_data(
        x_telegram_init_data,
        settings.bot_token
    )
    
    if not validated:
        raise HTTPException(401, "Invalid auth")
    
    user_id = validated["user"]["id"]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –ø—Ä–æ–¥–∞–≤–µ—Ü
    stores = db.get_user_accessible_stores(user_id)
    if not stores:
        raise HTTPException(403, "No store access")
    
    return user_id

# ============================================
# Endpoints
# ============================================

@router.get("/products", response_model=list[ProductResponse])
async def get_products(
    user_id: int = Depends(get_current_user_id),
    db=Depends(get_db)
):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –º–∞–≥–∞–∑–∏–Ω–∞.
    
    Authorization: —Ç—Ä–µ–±—É–µ—Ç X-Telegram-Init-Data header.
    """
    stores = db.get_user_accessible_stores(user_id)
    store_id = stores[0]['store_id']
    
    offers = db.get_store_offers(store_id)
    return [ProductResponse(**offer) for offer in offers]


@router.post("/products", response_model=dict)
async def create_product(
    product: CreateProductRequest,
    user_id: int = Depends(get_current_user_id),
    db=Depends(get_db)
):
    """
    –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä.
    
    Validation:
    - discount_price < original_price
    - quantity >= 1
    - category –≤ —Å–ø–∏—Å–∫–µ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö
    """
    stores = db.get_user_accessible_stores(user_id)
    store_id = stores[0]['store_id']
    
    offer_id = db.create_offer(
        store_id=store_id,
        title=product.title,
        category=product.category,
        original_price=product.original_price,
        discount_price=product.discount_price,
        quantity=product.quantity,
        description=product.description,
        available_from=product.available_from,
        available_until=product.available_until
    )
    
    # –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à
    cache.delete(f"hot_offers:*")
    cache.delete(f"store:{store_id}:offers")
    
    return {"success": True, "offer_id": offer_id}


@router.put("/products/{offer_id}")
async def update_product(
    offer_id: int,
    product: UpdateProductRequest,
    user_id: int = Depends(get_current_user_id),
    db=Depends(get_db)
):
    """
    –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä.
    
    Checks:
    - –¢–æ–≤–∞—Ä –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –º–∞–≥–∞–∑–∏–Ω—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    - –¢–æ–ª—å–∫–æ –Ω–µ-null –ø–æ–ª—è –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
    offer = db.get_offer(offer_id)
    if not offer:
        raise HTTPException(404, "Offer not found")
    
    stores = db.get_user_accessible_stores(user_id)
    store_ids = [s['store_id'] for s in stores]
    
    if offer['store_id'] not in store_ids:
        raise HTTPException(403, "Access denied")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—è
    update_data = product.model_dump(exclude_none=True)
    
    if update_data:
        db.update_offer(offer_id, **update_data)
        cache.delete(f"offer:{offer_id}")
        cache.delete(f"store:{offer['store_id']}:offers")
    
    return {"success": True}


@router.delete("/products/{offer_id}")
async def delete_product(
    offer_id: int,
    user_id: int = Depends(get_current_user_id),
    db=Depends(get_db)
):
    """
    –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä (–º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ - quantity = 0).
    """
    offer = db.get_offer(offer_id)
    if not offer:
        raise HTTPException(404, "Offer not found")
    
    stores = db.get_user_accessible_stores(user_id)
    if offer['store_id'] not in [s['store_id'] for s in stores]:
        raise HTTPException(403, "Access denied")
    
    # –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
    db.update_offer(offer_id, quantity=0)
    cache.delete(f"offer:{offer_id}")
    
    return {"success": True}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ React (Partner Panel):**

```javascript
// webapp/partner-panel/src/api/products.js
import axios from 'axios'

const API = axios.create({
  baseURL: '/api/partner',
  headers: {
    'X-Telegram-Init-Data': window.Telegram.WebApp.initData
  }
})

export async function getProducts() {
  const { data } = await API.get('/products')
  return data
}

export async function createProduct(product) {
  const { data } = await API.post('/products', product)
  return data
}
```

---

#### `orders.py` - API –¥–ª—è –∑–∞–∫–∞–∑–æ–≤

```python
"""
API endpoints –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ (–¥–ª—è Mini App).

Endpoints:
- POST /api/v1/orders          - –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
- GET  /api/v1/orders/:id      - –ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑
- GET  /api/v1/user/orders     - –ú–æ–∏ –∑–∞–∫–∞–∑—ã
- PUT  /api/v1/orders/:id/cancel - –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
"""

from fastapi import APIRouter, Depends, HTTPException

router = APIRouter(prefix="/api/v1", tags=["orders"])

class CreateOrderRequest(BaseModel):
    """–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã."""
    items: list[dict]  # [{"offer_id": 1, "quantity": 2}, ...]
    order_type: str = Field(..., pattern="^(pickup|delivery)$")
    
    # –î–ª—è pickup
    pickup_time: str | None = None
    
    # –î–ª—è delivery
    delivery_address: str | None = None
    delivery_phone: str | None = None
    delivery_note: str | None = None
    
    # –û–ø–ª–∞—Ç–∞
    payment_method: str = Field(..., pattern="^(cash|card|click)$")
    
    @model_validator(mode='after')
    def validate_order_type(self):
        if self.order_type == 'pickup' and not self.pickup_time:
            raise ValueError("pickup_time required for pickup")
        if self.order_type == 'delivery' and not self.delivery_address:
            raise ValueError("delivery_address required for delivery")
        return self

@router.post("/orders")
async def create_order(
    request: CreateOrderRequest,
    x_telegram_init_data: str = Header(...),
    db=Depends(get_db),
    bot=Depends(get_bot)
):
    """
    –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã Mini App.
    
    –ü—Ä–æ—Ü–µ—Å—Å:
    1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ—Ä–∑–∏–Ω—ã (availability, quantity)
    2. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î
    3. –£–º–µ–Ω—å—à–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤
    4. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–ø–æ–∫—É–ø–∞—Ç–µ–ª—é –∏ –ø—Ä–æ–¥–∞–≤—Ü—É)
    """
    # Auth
    validated = validate_telegram_webapp_data(x_telegram_init_data, ...)
    user_id = validated["user"]["id"]
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è items
    for item in request.items:
        offer = db.get_offer(item["offer_id"])
        if not offer:
            raise HTTPException(400, f"Offer {item['offer_id']} not found")
        if offer['quantity'] < item['quantity']:
            raise HTTPException(400, f"Not enough {offer['title']}")
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ UnifiedOrderService
    from app.services.unified_order_service import UnifiedOrderService
    
    service = UnifiedOrderService(db, bot)
    
    result = await service.create_order(
        user_id=user_id,
        offers=request.items,
        order_type=request.order_type,
        pickup_time=request.pickup_time,
        delivery_address=request.delivery_address,
        payment_method=request.payment_method
    )
    
    return result


@router.get("/orders/{order_id}")
async def get_order(
    order_id: int,
    x_telegram_init_data: str = Header(...),
    db=Depends(get_db)
):
    """
    –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞.
    
    Authorization: —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∑–∞–∫–∞–∑–∞.
    """
    validated = validate_telegram_webapp_data(x_telegram_init_data, ...)
    user_id = validated["user"]["id"]
    
    order = db.get_order(order_id)
    if not order:
        raise HTTPException(404, "Order not found")
    
    if order['user_id'] != user_id:
        raise HTTPException(403, "Access denied")
    
    return order
```

---

### üìÇ `app/core/` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ utilities

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–µ–∑–¥–µ.

#### `config.py` - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```python
"""Environment configuration with typed dataclasses."""

from dataclasses import dataclass
from dotenv import load_dotenv
import os

@dataclass(slots=True)
class WebhookConfig:
    """Webhook settings."""
    enabled: bool
    url: str
    path: str
    port: int
    secret_token: str

@dataclass(slots=True)
class Settings:
    """Application settings."""
    bot_token: str
    admin_id: int
    database_url: str | None
    redis_url: str | None
    webhook: WebhookConfig
    
    @property
    def telegram_bot_token(self) -> str:
        """Alias –¥–ª—è backwards compatibility."""
        return self.bot_token

def load_settings() -> Settings:
    """
    Load configuration from environment variables.
    
    Reads .env file and validates required values.
    
    Raises:
        ValueError: if TELEGRAM_BOT_TOKEN is not set
    """
    load_dotenv()  # –ó–∞–≥—Ä—É–∂–∞–µ–º .env
    
    token = os.getenv("TELEGRAM_BOT_TOKEN")
    if not token:
        raise ValueError("TELEGRAM_BOT_TOKEN is required")
    
    admin_id = int(os.getenv("ADMIN_ID", "0"))
    database_url = os.getenv("DATABASE_URL")
    redis_url = os.getenv("REDIS_URL")
    
    # Webhook config
    use_webhook = os.getenv("USE_WEBHOOK", "false").lower() in {"true", "1", "yes"}
    webhook_url = os.getenv("WEBHOOK_URL", "")
    
    # Auto-detect webhook from URL
    if webhook_url and not os.getenv("USE_WEBHOOK"):
        use_webhook = True
    
    # Generate SECRET_TOKEN if not provided
    secret_token = os.getenv("SECRET_TOKEN", "")
    if use_webhook and not secret_token:
        import secrets
        secret_token = secrets.token_urlsafe(32)
        print("‚ö†Ô∏è AUTO-GENERATED SECRET_TOKEN")
    
    webhook = WebhookConfig(
        enabled=use_webhook,
        url=webhook_url,
        path=os.getenv("WEBHOOK_PATH", "/webhook"),
        port=int(os.getenv("PORT", "8080")),
        secret_token=secret_token
    )
    
    return Settings(
        bot_token=token,
        admin_id=admin_id,
        database_url=database_url,
        redis_url=redis_url,
        webhook=webhook
    )
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```python
from app.core.config import load_settings

settings = load_settings()

bot = Bot(token=settings.bot_token)
print(f"Admin: {settings.admin_id}")
print(f"Webhook: {settings.webhook.enabled}")
```

---

#### `security.py` - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

```python
"""Security utilities - input validation, rate limiting."""

import html
import re
import time
from collections import defaultdict

class InputValidator:
    """Input validation and sanitization."""
    
    # Regex patterns
    PHONE_PATTERN = re.compile(r"^\+?[1-9]\d{1,14}$")
    USERNAME_PATTERN = re.compile(r"^[a-zA-Z0-9_]{3,32}$")
    CITY_PATTERN = re.compile(r"^[a-zA-Z–∞-—è–ê-–Ø—û“ì“õ“≥\s\-\']{1,50}$", re.UNICODE)
    PRICE_PATTERN = re.compile(r"^\d+(\.\d{1,2})?$")
    
    @staticmethod
    def sanitize_text(text: str, max_length: int = 1000) -> str:
        """
        Sanitize user input.
        
        - Escapes HTML (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
        - –¢—Ä–∏–º whitespace
        - –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–ª–∏–Ω—É
        """
        if not text:
            return ""
        return html.escape(text.strip())[:max_length]
    
    @staticmethod
    def validate_phone(phone: str) -> bool:
        """Validate phone number (E.164 format)."""
        return bool(InputValidator.PHONE_PATTERN.match(phone))
    
    @staticmethod
    def validate_city(city: str) -> bool:
        """Validate city name."""
        return bool(InputValidator.CITY_PATTERN.match(city))


class RateLimiter:
    """
    Simple in-memory rate limiter.
    
    NOTE: –î–ª—è production –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis!
    """
    
    def __init__(self, max_requests: int = 30, window: int = 60):
        self.max_requests = max_requests  # –ú–∞–∫—Å –∑–∞–ø—Ä–æ—Å–æ–≤
        self.window = window              # –í —Å–µ–∫—É–Ω–¥–∞—Ö
        self.requests = defaultdict(list) # {user_id: [timestamps]}
    
    def check_rate_limit(self, user_id: int) -> bool:
        """
        Check if user exceeded rate limit.
        
        Returns:
            True if OK, False if exceeded
        """
        now = time.time()
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ timestamps
        self.requests[user_id] = [
            ts for ts in self.requests[user_id]
            if now - ts < self.window
        ]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
        if len(self.requests[user_id]) >= self.max_requests:
            return False
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π timestamp
        self.requests[user_id].append(now)
        return True


# Global instances
validator = InputValidator()
rate_limiter = RateLimiter()
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```python
from app.core.security import validator, rate_limiter

# –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞
phone = validator.sanitize_text(user_input)
if not validator.validate_phone(phone):
    await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞")

# Rate limiting
if not rate_limiter.check_rate_limit(user_id):
    await message.answer("‚è≥ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ.")
    return
```

---

#### `constants.py` - –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã

```python
"""Application-wide constants."""

# Telegram limits
TELEGRAM_MESSAGE_LIMIT = 4096
TELEGRAM_CAPTION_LIMIT = 1024
TELEGRAM_BUTTON_TEXT_LIMIT = 64

# Business logic
MAX_BOOKING_QUANTITY = 10
BOOKING_DURATION_HOURS = 2
MAX_ACTIVE_BOOKINGS_PER_USER = 20

# Cache TTL
CACHE_TTL_SECONDS = 300  # 5 –º–∏–Ω—É—Ç
CACHE_TTL_HOT_OFFERS = 300
CACHE_TTL_USER_PROFILE = 3600  # 1 —á–∞—Å

# Time
SECONDS_PER_HOUR = 3600
SECONDS_PER_DAY = 86400

# Pagination
DEFAULT_PAGE_SIZE = 20
MAX_PAGE_SIZE = 100

# Categories
CATEGORIES = [
    "bread",      # –•–ª–µ–±–æ–±—É–ª–æ—á–Ω—ã–µ
    "dairy",      # –ú–æ–ª–æ—á–Ω—ã–µ
    "meat",       # –ú—è—Å–Ω—ã–µ
    "fruits",     # –§—Ä—É–∫—Ç—ã
    "vegetables", # –û–≤–æ—â–∏
    "ready",      # –ì–æ—Ç–æ–≤–∞—è –µ–¥–∞
    "drinks",     # –ù–∞–ø–∏—Ç–∫–∏
    "other"       # –î—Ä—É–≥–æ–µ
]

# Cities (Uzbekistan)
CITIES = [
    "–¢–∞—à–∫–µ–Ω—Ç",
    "–°–∞–º–∞—Ä–∫–∞–Ω–¥",
    "–ë—É—Ö–∞—Ä–∞",
    "–ê–Ω–¥–∏–∂–∞–Ω",
    "–§–µ—Ä–≥–∞–Ω–∞",
    "–ù–∞–º–∞–Ω–≥–∞–Ω",
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ
]
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```python
from app.core.constants import TELEGRAM_MESSAGE_LIMIT, MAX_BOOKING_QUANTITY

if len(message_text) > TELEGRAM_MESSAGE_LIMIT:
    message_text = message_text[:TELEGRAM_MESSAGE_LIMIT - 6] + "..."

if quantity > MAX_BOOKING_QUANTITY:
    await message.answer(f"‚ùå –ú–∞–∫—Å–∏–º—É–º {MAX_BOOKING_QUANTITY} —à—Ç—É–∫")
```

---

#### `bootstrap.py` - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```python
"""Application bootstrap - —Å–æ–∑–¥–∞–Ω–∏–µ bot, dispatcher, db, cache."""

from aiogram import Bot, Dispatcher
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.fsm.storage.redis import RedisStorage

from .cache import CacheManager
from .config import Settings
from .database import create_database

def build_application(settings: Settings):
    """
    Create all application components.
    
    Returns:
        (bot, dispatcher, database, cache)
    """
    # 1. Bot
    bot = Bot(token=settings.bot_token)
    
    # 2. Database
    db = create_database(settings.database_url)
    
    # 3. FSM Storage (–¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞)
    if settings.redis_url:
        # Production: Redis
        storage = RedisStorage.from_url(settings.redis_url)
        print("üöÄ Using Redis for FSM storage")
    elif settings.database_url and "postgresql" in settings.database_url:
        # Fallback: PostgreSQL
        from app.core.fsm_storage import EnhancedPostgreSQLStorage
        storage = EnhancedPostgreSQLStorage(db, ttl_hours=24)
        print("üíæ Using PostgreSQL for FSM storage")
    else:
        # Development: Memory
        storage = MemoryStorage()
        print("‚ö†Ô∏è FSM states will be lost on restart")
    
    # 4. Dispatcher
    dp = Dispatcher(storage=storage)
    
    # 5. Cache
    cache = CacheManager(redis_url=settings.redis_url)
    
    return bot, dp, db, cache
```

**–ü–æ—á–µ–º—É –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è?**
- –£–ø—Ä–æ—â–∞–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å mock components)
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
- –õ–µ–≥–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

---

–Ø —Å–æ–∑–¥–∞–ª –Ω–∞—á–∞–ª–æ –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. –î–æ–∫—É–º–µ–Ω—Ç –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–π (–±—É–¥–µ—Ç 3000+ —Å—Ç—Ä–æ–∫), –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–¥–æ–ª–∂—É –µ–≥–æ —Å–æ–∑–¥–∞–Ω–∏–µ. –•–æ—Ç–∏—Ç–µ —á—Ç–æ–±—ã —è:

1. ‚úÖ **–ü—Ä–æ–¥–æ–ª–∂–∏–ª —Å —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–∞** - –¥–µ—Ç–∞–ª—å–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞–ø–∫–∏ (services, repositories, handlers, database, webapp, tests)?
2. **–°–æ–∑–¥–∞–ª –±–æ–ª–µ–µ –∫—Ä–∞—Ç–∫—É—é –≤–µ—Ä—Å–∏—é** - –æ—Å–Ω–æ–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –±–µ–∑ –≥–ª—É–±–æ–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π –∫–æ–¥–∞?
3. **–†–∞–∑–±–∏–ª –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** - –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –∫–∞–∂–¥–æ–π –±–æ–ª—å—à–æ–π –ø–∞–ø–∫–∏?

–ö–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ?