# üìö –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–û–ï–ö–¢–ê FUDLY BOT
## –î–µ—Ç–∞–ª—å–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

**–î–∞—Ç–∞:** 28 –¥–µ–∫–∞–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 2.0.0  
**–ê–≤—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∞:** AI Assistant  
**–Ø–∑—ã–∫:** –†—É—Å—Å–∫–∏–π  

> üí° **–¶–µ–ª—å –¥–æ–∫—É–º–µ–Ω—Ç–∞:** –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞, –ø–∞–ø–∫–∏ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞. –ü–æ—Å–ª–µ –ø—Ä–æ—á—Ç–µ–Ω–∏—è –≤—ã –±—É–¥–µ—Ç–µ –∑–Ω–∞—Ç—å –ì–î–ï –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç, –ß–¢–û –æ–Ω –¥–µ–ª–∞–µ—Ç, –∏ –ö–ê–ö —Å –Ω–∏–º —Ä–∞–±–æ—Ç–∞—Ç—å.

---

## üìñ –°–û–î–ï–†–ñ–ê–ù–ò–ï

1. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
2. [–ö–æ—Ä–Ω–µ–≤—ã–µ —Ñ–∞–π–ª—ã](#–∫–æ—Ä–Ω–µ–≤—ã–µ-—Ñ–∞–π–ª—ã)
3. [–ü–∞–ø–∫–∞ app/ - –Ø–¥—Ä–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è](#–ø–∞–ø–∫–∞-app)
4. [–ü–∞–ø–∫–∞ handlers/ - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Telegram](#–ø–∞–ø–∫–∞-handlers)
5. [–ü–∞–ø–∫–∞ database_pg_module/ - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–ø–∞–ø–∫–∞-database)
6. [–ü–∞–ø–∫–∞ webapp/ - –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ](#–ø–∞–ø–∫–∞-webapp)
7. [–ü–∞–ø–∫–∞ tests/ - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#–ø–∞–ø–∫–∞-tests)
8. [–ü–∞–ø–∫–∞ migrations/ - –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î](#–ø–∞–ø–∫–∞-migrations)
9. [–ü–∞–ø–∫–∞ tasks/ - Background workers](#–ø–∞–ø–∫–∞-tasks)
10. [–ü–∞–ø–∫–∞ scripts/ - –£—Ç–∏–ª–∏—Ç—ã](#–ø–∞–ø–∫–∞-scripts)
11. [–ü–∞–ø–∫–∞ docs/ - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](#–ø–∞–ø–∫–∞-docs)
12. [–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç](#–∫–∞–∫-—Ä–∞–±–æ—Ç–∞–µ—Ç-–ø—Ä–æ–µ–∫—Ç)

---

## üóÇÔ∏è –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê

```
fudly-bot-main/
‚îÇ
‚îú‚îÄ‚îÄ ü§ñ bot.py                          # –ì–õ–ê–í–ù–´–ô –§–ê–ô–õ - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –±–æ—Ç–∞
‚îú‚îÄ‚îÄ üìÑ requirements.txt                # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ üìù README.md                       # –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
‚îú‚îÄ‚îÄ ‚öôÔ∏è .env.example                    # –®–∞–±–ª–æ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ üê≥ Dockerfile                      # Docker –æ–±—Ä–∞–∑ –¥–ª—è production
‚îú‚îÄ‚îÄ üê≥ docker-compose.yml              # –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ (bot + PostgreSQL + Redis)
‚îú‚îÄ‚îÄ üß™ pytest.ini                      # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ pytest (–µ—Å–ª–∏ –µ—Å—Ç—å)
‚îú‚îÄ‚îÄ üì¶ pyproject.toml                  # Python project metadata + tools config
‚îú‚îÄ‚îÄ üîß railway.toml                    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Railway deployment
‚îÇ
‚îú‚îÄ‚îÄ üìÇ app/                            # –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py                    # –î–µ–ª–∞–µ—Ç app Python –ø–∞–∫–µ—Ç–æ–º
‚îÇ   ‚îú‚îÄ‚îÄ api/                           # REST API –¥–ª—è Mini App (FastAPI)
‚îÇ   ‚îú‚îÄ‚îÄ core/                          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, security, utilities
‚îÇ   ‚îú‚îÄ‚îÄ domain/                        # –ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª–∏ (Pydantic schemas)
‚îÇ   ‚îú‚îÄ‚îÄ integrations/                  # –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã (–ø–ª–∞—Ç–µ–∂–∏, AI)
‚îÇ   ‚îú‚îÄ‚îÄ keyboards/                     # Telegram –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ middlewares/                   # aiogram middlewares
‚îÇ   ‚îú‚îÄ‚îÄ repositories/                  # Data Access Layer (—Å –∫–µ—à–µ–º)
‚îÇ   ‚îú‚îÄ‚îÄ services/                      # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ templates/                     # –®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ
‚îú‚îÄ‚îÄ üìÇ handlers/                       # TELEGRAM BOT HANDLERS
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py                    # Router aggregation
‚îÇ   ‚îú‚îÄ‚îÄ README.md                      # –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã handlers
‚îÇ   ‚îú‚îÄ‚îÄ common/                        # –û–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã (/start, /help)
‚îÇ   ‚îú‚îÄ‚îÄ customer/                      # –ü–æ–∫—É–ø–∞—Ç–µ–ª–∏ (–∑–∞–∫–∞–∑—ã, –ø–æ–∏—Å–∫)
‚îÇ   ‚îú‚îÄ‚îÄ seller/                        # –ü—Ä–æ–¥–∞–≤—Ü—ã (—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤)
‚îÇ   ‚îú‚îÄ‚îÄ bookings/                      # –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ admin/                         # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (–º–æ–¥–µ—Ä–∞—Ü–∏—è)
‚îÇ
‚îú‚îÄ‚îÄ üìÇ database_pg_module/             # –ë–ê–ó–ê –î–ê–ù–ù–´–• PostgreSQL
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py                    # Exports –¥–ª—è backwards compatibility
‚îÇ   ‚îú‚îÄ‚îÄ core.py                        # Connection pool, HybridRow
‚îÇ   ‚îú‚îÄ‚îÄ schema.py                      # CREATE TABLE statements
‚îÇ   ‚îú‚îÄ‚îÄ database.py                    # –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å Database
‚îÇ   ‚îú‚îÄ‚îÄ crypto.py                      # Encryption helpers
‚îÇ   ‚îî‚îÄ‚îÄ mixins/                        # SQL –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ —Å—É—â–Ω–æ—Å—Ç—è–º
‚îÇ       ‚îú‚îÄ‚îÄ users.py                   # –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îÇ       ‚îú‚îÄ‚îÄ stores.py                  # –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –º–∞–≥–∞–∑–∏–Ω–∞–º–∏
‚îÇ       ‚îú‚îÄ‚îÄ offers.py                  # –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏
‚îÇ       ‚îú‚îÄ‚îÄ bookings.py                # –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (atomic)
‚îÇ       ‚îú‚îÄ‚îÄ orders.py                  # –ó–∞–∫–∞–∑—ã (unified pickup + delivery)
‚îÇ       ‚îú‚îÄ‚îÄ ratings.py                 # –†–µ–π—Ç–∏–Ω–≥–∏
‚îÇ       ‚îú‚îÄ‚îÄ favorites.py               # –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
‚îÇ       ‚îú‚îÄ‚îÄ search.py                  # –ü–æ–∏—Å–∫
‚îÇ       ‚îú‚îÄ‚îÄ stats.py                   # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚îÇ       ‚îú‚îÄ‚îÄ payments.py                # –ü–ª–∞—Ç—ë–∂–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
‚îÇ       ‚îî‚îÄ‚îÄ notifications.py           # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îÇ
‚îú‚îÄ‚îÄ üìÇ webapp/                         # –í–ï–ë-–ü–†–ò–õ–û–ñ–ï–ù–ò–ï (React + Vite)
‚îÇ   ‚îú‚îÄ‚îÄ src/                           # –ò—Å—Ö–æ–¥–Ω–∏–∫–∏ React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.jsx                   # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ React
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ App.jsx                    # –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/                     # –°—Ç—Ä–∞–Ω–∏—Ü—ã (React Router)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/                # React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ context/                   # Context API (Cart, Location)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/                       # API client (axios)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/                     # Custom React hooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/                     # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ styles/                    # CSS —Å—Ç–∏–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ public/                        # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
‚îÇ   ‚îú‚îÄ‚îÄ tests/                         # Frontend —Ç–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ package.json                   # npm dependencies
‚îÇ   ‚îú‚îÄ‚îÄ vite.config.js                 # Vite –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ vitest.config.js               # Vitest —Ç–µ—Å—Ç—ã
‚îÇ
‚îú‚îÄ‚îÄ üìÇ tests/                          # –¢–ï–°–¢–´ (pytest)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ test_database.py               # –¢–µ—Å—Ç—ã –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ test_services.py               # –¢–µ—Å—Ç—ã –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ test_e2e_*.py                  # E2E —Ç–µ—Å—Ç—ã user flows
‚îÇ   ‚îú‚îÄ‚îÄ test_security.py               # Security —Ç–µ—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ ... (30+ test files)
‚îÇ
‚îú‚îÄ‚îÄ üìÇ migrations/                     # DATABASE MIGRATIONS
‚îÇ   ‚îú‚îÄ‚îÄ v22_unified_orders.sql         # –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ unified orders
‚îÇ   ‚îú‚îÄ‚îÄ v23_add_performance_indexes.sql
‚îÇ   ‚îú‚îÄ‚îÄ v24_migrate_bookings.sql
‚îÇ   ‚îî‚îÄ‚îÄ ... (SQL –º–∏–≥—Ä–∞—Ü–∏–∏)
‚îÇ
‚îú‚îÄ‚îÄ üìÇ tasks/                          # BACKGROUND WORKERS
‚îÇ   ‚îú‚îÄ‚îÄ booking_expiry_worker.py       # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å—Ç–µ—á–µ–Ω–∏–µ –±—Ä–æ–Ω–µ–π
‚îÇ   ‚îî‚îÄ‚îÄ rating_reminder_worker.py      # –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
‚îÇ
‚îú‚îÄ‚îÄ üìÇ scripts/                        # UTILITY SCRIPTS
‚îÇ   ‚îú‚îÄ‚îÄ migrate.py                     # –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ check_db_structure.py          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ smoke_test_pickup.py           # Smoke test –¥–ª—è pickup
‚îÇ   ‚îî‚îÄ‚îÄ ... (—Ä–∞–∑–ª–∏—á–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã)
‚îÇ
‚îú‚îÄ‚îÄ üìÇ docs/                           # –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø
‚îÇ   ‚îú‚îÄ‚îÄ architecture/                  # –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ api/                           # API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ guides/                        # –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞
‚îÇ   ‚îî‚îÄ‚îÄ audits/                        # –ê—É–¥–∏—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞
‚îÇ
‚îú‚îÄ‚îÄ üìÇ locales/                        # –ü–ï–†–ï–í–û–î–´ (i18n)
‚îÇ   ‚îú‚îÄ‚îÄ ru/                            # –†—É—Å—Å–∫–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ uz/                            # –£–∑–±–µ–∫—Å–∫–∏–π
‚îÇ
‚îú‚îÄ‚îÄ üìÑ localization.py                 # –§—É–Ω–∫—Ü–∏–∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ (legacy)
‚îú‚îÄ‚îÄ üìÑ database_protocol.py            # Protocol –¥–ª—è type safety
‚îú‚îÄ‚îÄ üìÑ database.py                     # Backwards compatibility wrapper
‚îú‚îÄ‚îÄ üìÑ database_pg.py                  # Backwards compatibility wrapper
‚îú‚îÄ‚îÄ üìÑ fsm_storage_pg.py               # PostgreSQL FSM storage
‚îú‚îÄ‚îÄ üìÑ logging_config.py               # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ üìÑ security.py                     # Security helpers (re-export)
‚îÇ
‚îî‚îÄ‚îÄ üìÇ load_tests/                     # LOAD TESTING
    ‚îú‚îÄ‚îÄ load_test_pg.py                # –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã PostgreSQL
    ‚îî‚îÄ‚îÄ test_concurrent_bookings.py    # –¢–µ—Å—Ç—ã race conditions
```

---

## üìÅ –ö–û–†–ù–ï–í–´–ï –§–ê–ô–õ–´

### ü§ñ `bot.py` (887 —Å—Ç—Ä–æ–∫) - –ì–õ–ê–í–ù–´–ô –§–ê–ô–õ

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤—Å–µ–≥–æ Telegram –±–æ—Ç–∞. –ó–¥–µ—Å—å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**

```python
# 1. –ò–º–ø–æ—Ä—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
from app.core.bootstrap import build_application
from app.core.config import load_settings

# 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ .env
settings = load_settings()
ADMIN_ID = settings.admin_id
DATABASE_URL = settings.database_url
USE_WEBHOOK = settings.webhook.enabled

# 3. –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–∞–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
bot, dp, db, cache = build_application(settings)
# bot = aiogram Bot (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π)
# dp = Dispatcher (—Ä–æ—É—Ç–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π)
# db = Database (PostgreSQL)
# cache = CacheManager (Redis –∏–ª–∏ in-memory)

# 4. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
offer_service = OfferService(db, cache)
admin_service = AdminService(db)
unified_order_service = UnifiedOrderService(db, bot)

# 5. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è handlers
from handlers import common, customer, seller, bookings, admin
dp.include_router(common.router)
dp.include_router(customer.router)
# ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ

# 6. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == "__main__":
    if USE_WEBHOOK:
        # Production: Railway
        run_webhook_mode()
    else:
        # Development: –ª–æ–∫–∞–ª—å–Ω–æ
        asyncio.run(dp.start_polling(bot))
```

**–ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:**
- `python bot.py` - –ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
- `railway up` - production deployment
- `docker-compose up` - Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

**–í–∞–∂–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:**
- `ADMIN_ID` - Telegram ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- `DATABASE_URL` - —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
- `USE_WEBHOOK` - —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã (webhook –¥–ª—è production, polling –¥–ª—è dev)

---

### üìÑ `requirements.txt` - Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö Python –±–∏–±–ª–∏–æ—Ç–µ–∫, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω—ã –ø—Ä–æ–µ–∫—Ç—É.

**–û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**

```python
# Telegram Bot Framework
aiogram>=3.0.0                    # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è Telegram –±–æ—Ç–æ–≤

# Environment variables
python-dotenv>=0.19.0             # –ß—Ç–µ–Ω–∏–µ .env —Ñ–∞–π–ª–æ–≤

# Web frameworks
aiohttp>=3.9.0                    # Async HTTP server –¥–ª—è webhook
fastapi>=0.109.0                  # REST API –¥–ª—è Mini App
uvicorn>=0.27.0                   # ASGI server –¥–ª—è FastAPI

# Database
psycopg[binary]>=3.2              # PostgreSQL –¥—Ä–∞–π–≤–µ—Ä
psycopg-pool>=3.2                 # Connection pooling

# Caching
redis>=5.0.0                      # Redis client
cachetools>=5.3.0                 # In-memory cache

# Security
cryptography>=42.0.0              # Encryption (Fernet)
python-multipart>=0.0.6           # File uploads

# Production features
sentry-sdk>=1.40.0                # Error tracking
python-json-logger>=2.0.0         # Structured logging

# Image processing
Pillow>=10.0.0                    # Image manipulation
qrcode>=7.4.0                     # QR code generation

# AI Integration
google-generativeai>=0.3.0        # Google Gemini API

# Testing
pytest>=7.4.0                     # Unit testing
pytest-cov>=4.1.0                 # Coverage reporting
pytest-asyncio>=0.21.0            # Async tests

# Development tools
ruff>=0.1.7                       # Fast linter
black>=23.12.0                    # Code formatter
pre-commit>=3.6.0                 # Git hooks
```

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
pip install -r requirements.txt
```

---

### ‚öôÔ∏è `.env.example` - –®–∞–±–ª–æ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –®–∞–±–ª–æ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è `.env` —Ñ–∞–π–ª–∞ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```bash
# ============================================
# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò
# ============================================

# –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –æ—Ç @BotFather
TELEGRAM_BOT_TOKEN=your_bot_token_here

# Telegram ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–ø–æ–ª—É—á–∏—Ç—å —É @userinfobot)
ADMIN_ID=your_telegram_id

# URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Mini App)
WEBAPP_URL=https://fudly-webapp.vercel.app

# ============================================
# –ë–ê–ó–ê –î–ê–ù–ù–´–•
# ============================================

# PostgreSQL (Railway –∏–ª–∏ Docker)
DATABASE_URL=postgresql://user:password@host:5432/dbname

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ connection pool
DB_MIN_CONN=5          # –ú–∏–Ω–∏–º—É–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
DB_MAX_CONN=20         # –ú–∞–∫—Å–∏–º—É–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
DB_TIMEOUT=30          # –¢–∞–π–º–∞—É—Ç (—Å–µ–∫—É–Ω–¥—ã)

# ============================================
# –†–ï–ñ–ò–ú –†–ê–ë–û–¢–´
# ============================================

# Webhook –¥–ª—è production (Railway)
USE_WEBHOOK=true
WEBHOOK_URL=https://your-app.railway.app
WEBHOOK_PATH=/webhook
PORT=8080
SECRET_TOKEN=your_random_secret_token_here

# Polling –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–ª–æ–∫–∞–ª—å–Ω–æ)
# USE_WEBHOOK=false

# ============================================
# –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)
# ============================================

# Redis –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
REDIS_URL=redis://localhost:6379/0

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
LOG_LEVEL=INFO

# Sentry –¥–ª—è error tracking
SENTRY_DSN=your_sentry_dsn

# Encryption –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
ENCRYPTION_KEY=your_fernet_key_here

# –ü–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ Telegram
TELEGRAM_PAYMENT_PROVIDER_TOKEN=your_provider_token
```

**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: `cp .env.example .env`
2. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–≤–æ–∏ –∑–Ω–∞—á–µ–Ω–∏—è
3. `.env` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

**–í–ê–ñ–ù–û:** `.env` —Ñ–∞–π–ª –ù–ï –∫–æ–º–º–∏—Ç–∏—Ç—Å—è –≤ git (–Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `.gitignore`)!

---

### üê≥ `Dockerfile` - Docker –æ–±—Ä–∞–∑

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Å–±–æ—Ä–∫–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```dockerfile
# ============================================
# Stage 1: Builder - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
# ============================================
FROM python:3.11-slim AS builder

WORKDIR /build

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º build tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# –°–æ–∑–¥–∞—ë–º virtual environment
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –ø–∞–∫–µ—Ç—ã
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# ============================================
# Stage 2: Runtime - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑
# ============================================
FROM python:3.11-slim AS runtime

LABEL maintainer="Fudly Team <support@fudly.uz>"
LABEL version="2.0.0"

WORKDIR /app

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    libpq5 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# –ö–æ–ø–∏—Ä—É–µ–º virtual environment –∏–∑ builder
COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Environment –¥–ª—è Python
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONFAULTHANDLER=1

# –°–æ–∑–¥–∞—ë–º non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å!)
RUN groupadd -r botuser && useradd -r -g botuser -u 1000 botuser

# –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
COPY --chown=botuser:botuser . .

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ non-root
USER botuser

# –ü–æ—Ä—Ç –¥–ª—è health checks
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:${PORT:-8080}/health || exit 1

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
CMD ["python", "bot.py"]
```

**–ü–æ—á–µ–º—É multi-stage build?**
- **Stage 1 (builder):** –ë–æ–ª—å—à–æ–π –æ–±—Ä–∞–∑ —Å gcc –∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞–º–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
- **Stage 2 (runtime):** –ú–∞–ª–µ–Ω—å–∫–∏–π –æ–±—Ä–∞–∑ —Ç–æ–ª—å–∫–æ —Å —Ç–µ–º —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –†–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–∞ –º–µ–Ω—å—à–µ –Ω–∞ ~500MB

**–°–±–æ—Ä–∫–∞:**
```bash
docker build -t fudly-bot .
```

**–ó–∞–ø—É—Å–∫:**
```bash
docker run -d --env-file .env fudly-bot
```

---

### üê≥ `docker-compose.yml` - –õ–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–∫

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ó–∞–ø—É—Å–∫ –≤—Å–µ–≥–æ —Å—Ç–µ–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ (bot + PostgreSQL + Redis).

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```yaml
services:
  # ============================================
  # Telegram Bot
  # ============================================
  bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fudly-bot
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - ADMIN_ID=${ADMIN_ID}
      # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL –≤–Ω—É—Ç—Ä–∏ Docker network
      - DATABASE_URL=postgresql://fudly:password@postgres:5432/fudly
      - USE_WEBHOOK=false          # –õ–æ–∫–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º polling
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      postgres:
        condition: service_healthy  # –ñ–¥—ë–º –ø–æ–∫–∞ PostgreSQL –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
      redis:
        condition: service_healthy
    networks:
      - fudly-network
    
  # ============================================
  # PostgreSQL Database
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: fudly-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=fudly
      - POSTGRES_USER=fudly
      - POSTGRES_PASSWORD=password
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    # –ü–æ—Ä—Ç –ù–ï –æ—Ç–∫—Ä—ã—Ç –Ω–∞—Ä—É–∂—É (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å!)
    # –¢–æ–ª—å–∫–æ bot –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –≤–Ω—É—Ç—Ä–∏ Docker network
    networks:
      - fudly-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fudly -d fudly"]
      interval: 10s
      timeout: 5s
      retries: 5
    
  # ============================================
  # Redis Cache
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: fudly-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 100mb
    volumes:
      - redis-data:/data
    networks:
      - fudly-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

networks:
  fudly-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
```

**–ó–∞–ø—É—Å–∫:**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë
docker-compose up -d

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
docker-compose logs -f bot

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë
docker-compose down

# –£–¥–∞–ª–∏—Ç—å volumes (–ë–î –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω–∞!)
docker-compose down -v
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –í—Å—ë –≤ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ
- –ù–µ –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å PostgreSQL –∏ Redis –ª–æ–∫–∞–ª—å–Ω–æ
- –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

---

### üì¶ `pyproject.toml` - Python metadata

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```toml
[tool.poetry]
name = "fudly-bot"
version = "2.0.0"
description = "Telegram bot –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –µ–¥—ã —Å–æ —Å–∫–∏–¥–∫–æ–π"
authors = ["shaxa2505"]
license = "MIT"

[tool.poetry.dependencies]
python = "^3.11"
aiogram = ">=3.0.0"
# ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

# ============================================
# Black - code formatter
# ============================================
[tool.black]
line-length = 100
target-version = ['py311']
include = '\.pyi?$'

# ============================================
# Ruff - linter (–∑–∞–º–µ–Ω–∞ Flake8, isort, etc)
# ============================================
[tool.ruff]
line-length = 100
target-version = "py311"
select = [
    "E",   # pycodestyle errors
    "W",   # pycodestyle warnings
    "F",   # pyflakes
    "I",   # isort (import sorting)
    "C",   # flake8-comprehensions
    "B",   # flake8-bugbear
    "UP",  # pyupgrade
]
ignore = [
    "E501",  # line too long (handled by black)
    "E402",  # module level import not at top
]

# ============================================
# MyPy - type checking
# ============================================
[tool.mypy]
python_version = "3.11"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = false
ignore_missing_imports = false
strict_optional = true

# ============================================
# Pytest - testing
# ============================================
[tool.pytest.ini_options]
minversion = "7.0"
addopts = "-ra -q --strict-markers"
testpaths = ["tests"]
pythonpath = ["."]
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```bash
# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
black .

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
ruff check .

# –ê–≤—Ç–æ—Ñ–∏–∫—Å
ruff check --fix .

# Type checking
mypy app/ handlers/

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
pytest
```

---

### üîß `railway.toml` - Railway deployment

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ Railway.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```toml
[build]
builder = "NIXPACKS"

[deploy]
startCommand = "python bot.py"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

[env]
# Health check endpoint
HEALTH_CHECK_PATH = "/health"
PORT = "8080"
```

**Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**
1. –ß–∏—Ç–∞–µ—Ç `requirements.txt`
2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Python 3.11
3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
4. –ó–∞–ø—É—Å–∫–∞–µ—Ç `python bot.py`

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ Railway Dashboard:**
- `TELEGRAM_BOT_TOKEN`
- `ADMIN_ID`
- `DATABASE_URL` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ Railway PostgreSQL)
- `USE_WEBHOOK=true`
- `WEBHOOK_URL=https://your-app.railway.app`

---

## üìÇ –ü–ê–ü–ö–ê `app/` - –Ø–î–†–û –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø

–≠—Ç–æ —Å–∞–º–∞—è –≤–∞–∂–Ω–∞—è –ø–∞–ø–∫–∞! –ó–¥–µ—Å—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞.

### üìÅ `app/__init__.py`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –î–µ–ª–∞–µ—Ç `app/` Python –ø–∞–∫–µ—Ç–æ–º.

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:** –û–±—ã—á–Ω–æ –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ imports:

```python
"""Fudly Bot Application Package"""
__version__ = "2.0.0"
```

---

### üìÇ `app/api/` - REST API –¥–ª—è Mini App

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** FastAPI endpoints –¥–ª—è React –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–§–∞–π–ª—ã:**

#### `api_server.py` - –ì–ª–∞–≤–Ω—ã–π API server

```python
"""FastAPI application for Mini App."""
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI(
    title="Fudly API",
    version="2.0.0",
    docs_url="/api/docs",      # Swagger UI
    redoc_url="/api/redoc"     # ReDoc
)

# CORS –¥–ª—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://fudly-webapp.vercel.app",
        "https://telegram.org",
    ],
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["*"],
)

# Health check
@app.get("/health")
async def health_check():
    return {"status": "ok", "timestamp": datetime.now()}

# –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã
from app.api import auth, orders, partner_panel_simple
app.include_router(auth.router, prefix="/api/v1")
app.include_router(orders.router, prefix="/api/v1")
app.include_router(partner_panel_simple.router, prefix="/api/partner")

def run_api_server(host="0.0.0.0", port=8000):
    """–ó–∞–ø—É—Å–∫ API server."""
    import uvicorn
    uvicorn.run(app, host=host, port=port)
```

**–ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:** –í –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ/–ø—Ä–æ—Ü–µ—Å—Å–µ –≤–º–µ—Å—Ç–µ —Å –±–æ—Ç–æ–º.

---

#### `auth.py` - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è Mini App

```python
"""
Telegram Mini App Authentication.

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –æ—Ç –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ Telegram,
–∞ –Ω–µ –æ—Ç –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞.
"""

from fastapi import APIRouter, Depends, HTTPException, Header
from pydantic import BaseModel

router = APIRouter(prefix="/api/v1", tags=["auth"])

class AuthRequest(BaseModel):
    """Request –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏."""
    init_data: str  # Telegram WebApp.initData

class UserProfile(BaseModel):
    """Response —Å –ø—Ä–æ—Ñ–∏–ª–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    user_id: int
    username: str | None
    first_name: str
    phone: str | None
    city: str
    language: str
    registered: bool

@router.post("/auth/validate", response_model=UserProfile)
async def validate_auth(request: AuthRequest, db=Depends(get_db)):
    """
    –í–∞–ª–∏–¥–∞—Ü–∏—è Telegram WebApp initData.
    
    –ê–ª–≥–æ—Ä–∏—Ç–º:
    1. –ü–∞—Ä—Å–∏–º initData (URL-encoded —Å—Ç—Ä–æ–∫–∞)
    2. –ü—Ä–æ–≤–µ—Ä—è–µ–º HMAC-SHA256 –ø–æ–¥–ø–∏—Å—å
    3. –ü—Ä–æ–≤–µ—Ä—è–µ–º auth_date (–Ω–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤)
    4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Security:
    - HMAC signature –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥–¥–µ–ª–∫—É
    - auth_date –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç replay attacks
    - –¢–æ–ª—å–∫–æ Telegram –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –≤–∞–ª–∏–¥–Ω—É—é –ø–æ–¥–ø–∏—Å—å
    """
    
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å
    validated_data = validate_telegram_webapp_data(
        request.init_data,
        settings.bot_token
    )
    
    if not validated_data:
        raise HTTPException(401, "Invalid signature")
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º auth_date
    auth_timestamp = int(validated_data.get("auth_date", 0))
    age = time.time() - auth_timestamp
    
    if age > 86400:  # 24 —á–∞—Å–∞
        raise HTTPException(401, "Auth data expired")
    
    # 3. –ü–æ–ª—É—á–∞–µ–º user_id
    telegram_user = validated_data["user"]
    user_id = telegram_user["id"]
    
    # 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –ë–î
    user = db.get_user_model(user_id)
    
    if not user:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
        return UserProfile(
            user_id=user_id,
            username=telegram_user.get("username"),
            first_name=telegram_user["first_name"],
            phone=None,
            city="–¢–∞—à–∫–µ–Ω—Ç",
            language="ru",
            registered=False
        )
    
    # 5. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
    return UserProfile(
        user_id=user_id,
        username=user.get("username"),
        first_name=user.get("first_name"),
        phone=user.get("phone"),
        city=user.get("city", "–¢–∞—à–∫–µ–Ω—Ç"),
        language=user.get("language", "ru"),
        registered=True
    )


def validate_telegram_webapp_data(init_data: str, bot_token: str) -> dict | None:
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ HMAC –ø–æ–¥–ø–∏—Å–∏ Telegram WebApp.
    
    –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
    https://core.telegram.org/bots/webapps#validating-data-received-via-the-mini-app
    
    Returns:
        dict —Å parsed –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ None –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å—å –Ω–µ–≤–∞–ª–∏–¥–Ω–∞
    """
    import hmac
    import hashlib
    from urllib.parse import parse_qsl
    
    # –ü–∞—Ä—Å–∏–º URL-encoded –¥–∞–Ω–Ω—ã–µ
    parsed = dict(parse_qsl(init_data))
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º hash
    received_hash = parsed.pop("hash", None)
    if not received_hash:
        return None
    
    # –°–æ–∑–¥–∞—ë–º data_check_string
    data_check_string = "\n".join(
        f"{k}={v}" for k, v in sorted(parsed.items())
    )
    
    # –í—ã—á–∏—Å–ª—è–µ–º secret_key
    secret_key = hmac.new(
        b"WebAppData",
        bot_token.encode(),
        hashlib.sha256
    ).digest()
    
    # –í—ã—á–∏—Å–ª—è–µ–º hash
    computed_hash = hmac.new(
        secret_key,
        data_check_string.encode(),
        hashlib.sha256
    ).hexdigest()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º
    if computed_hash != received_hash:
        return None
    
    # –ü–∞—Ä—Å–∏–º user JSON
    import json
    parsed["user"] = json.loads(parsed["user"])
    
    return parsed
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ React:**

```javascript
// webapp/src/utils/auth.js
const initData = window.Telegram.WebApp.initData

const response = await axios.post('/api/v1/auth/validate', {
  init_data: initData
})

const profile = response.data
if (!profile.registered) {
  // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
}
```

---

#### `partner_panel_simple.py` - API –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–æ–≤

```python
"""
API endpoints –¥–ª—è Partner Panel (–≤–µ–±-–ø–∞–Ω–µ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞).

Endpoints:
- GET  /api/partner/products       - –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –º–∞–≥–∞–∑–∏–Ω–∞
- POST /api/partner/products       - –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä
- PUT  /api/partner/products/:id   - –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
- DELETE /api/partner/products/:id - –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä
- GET  /api/partner/orders         - –ó–∞–∫–∞–∑—ã –º–∞–≥–∞–∑–∏–Ω–∞
- PUT  /api/partner/orders/:id     - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
- GET  /api/partner/stats          - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
"""

from fastapi import APIRouter, Depends, HTTPException, Header
from pydantic import BaseModel, Field

router = APIRouter(prefix="/api/partner", tags=["partner"])

# ============================================
# Request/Response Models
# ============================================

class CreateProductRequest(BaseModel):
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞."""
    title: str = Field(..., min_length=1, max_length=200)
    category: str = Field(..., pattern="^(bread|dairy|meat|...)$")
    original_price: int = Field(..., gt=0)
    discount_price: int = Field(..., gt=0)
    quantity: int = Field(..., ge=1)
    description: str | None = None
    available_from: str | None = None  # HH:MM
    available_until: str | None = None
    
    @field_validator('discount_price')
    def validate_discount(cls, v, info):
        if v >= info.data.get('original_price'):
            raise ValueError("Discount must be less than original")
        return v

class UpdateProductRequest(BaseModel):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞."""
    title: str | None = None
    quantity: int | None = Field(None, ge=0)
    discount_price: int | None = Field(None, gt=0)
    # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è

class ProductResponse(BaseModel):
    """–û—Ç–≤–µ—Ç —Å —Ç–æ–≤–∞—Ä–æ–º."""
    id: int
    title: str
    category: str
    original_price: int
    discount_price: int
    quantity: int
    created_at: str
    # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è

# ============================================
# Authentication Dependency
# ============================================

async def get_current_user_id(
    x_telegram_init_data: str = Header(...),
    db=Depends(get_db)
) -> int:
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç user_id –∏–∑ Telegram initData.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ dependency –¥–ª—è –≤—Å–µ—Ö endpoints.
    """
    validated = validate_telegram_webapp_data(
        x_telegram_init_data,
        settings.bot_token
    )
    
    if not validated:
        raise HTTPException(401, "Invalid auth")
    
    user_id = validated["user"]["id"]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –ø—Ä–æ–¥–∞–≤–µ—Ü
    stores = db.get_user_accessible_stores(user_id)
    if not stores:
        raise HTTPException(403, "No store access")
    
    return user_id

# ============================================
# Endpoints
# ============================================

@router.get("/products", response_model=list[ProductResponse])
async def get_products(
    user_id: int = Depends(get_current_user_id),
    db=Depends(get_db)
):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –º–∞–≥–∞–∑–∏–Ω–∞.
    
    Authorization: —Ç—Ä–µ–±—É–µ—Ç X-Telegram-Init-Data header.
    """
    stores = db.get_user_accessible_stores(user_id)
    store_id = stores[0]['store_id']
    
    offers = db.get_store_offers(store_id)
    return [ProductResponse(**offer) for offer in offers]


@router.post("/products", response_model=dict)
async def create_product(
    product: CreateProductRequest,
    user_id: int = Depends(get_current_user_id),
    db=Depends(get_db)
):
    """
    –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä.
    
    Validation:
    - discount_price < original_price
    - quantity >= 1
    - category –≤ —Å–ø–∏—Å–∫–µ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö
    """
    stores = db.get_user_accessible_stores(user_id)
    store_id = stores[0]['store_id']
    
    offer_id = db.create_offer(
        store_id=store_id,
        title=product.title,
        category=product.category,
        original_price=product.original_price,
        discount_price=product.discount_price,
        quantity=product.quantity,
        description=product.description,
        available_from=product.available_from,
        available_until=product.available_until
    )
    
    # –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à
    cache.delete(f"hot_offers:*")
    cache.delete(f"store:{store_id}:offers")
    
    return {"success": True, "offer_id": offer_id}


@router.put("/products/{offer_id}")
async def update_product(
    offer_id: int,
    product: UpdateProductRequest,
    user_id: int = Depends(get_current_user_id),
    db=Depends(get_db)
):
    """
    –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä.
    
    Checks:
    - –¢–æ–≤–∞—Ä –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –º–∞–≥–∞–∑–∏–Ω—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    - –¢–æ–ª—å–∫–æ –Ω–µ-null –ø–æ–ª—è –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
    offer = db.get_offer(offer_id)
    if not offer:
        raise HTTPException(404, "Offer not found")
    
    stores = db.get_user_accessible_stores(user_id)
    store_ids = [s['store_id'] for s in stores]
    
    if offer['store_id'] not in store_ids:
        raise HTTPException(403, "Access denied")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—è
    update_data = product.model_dump(exclude_none=True)
    
    if update_data:
        db.update_offer(offer_id, **update_data)
        cache.delete(f"offer:{offer_id}")
        cache.delete(f"store:{offer['store_id']}:offers")
    
    return {"success": True}


@router.delete("/products/{offer_id}")
async def delete_product(
    offer_id: int,
    user_id: int = Depends(get_current_user_id),
    db=Depends(get_db)
):
    """
    –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä (–º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ - quantity = 0).
    """
    offer = db.get_offer(offer_id)
    if not offer:
        raise HTTPException(404, "Offer not found")
    
    stores = db.get_user_accessible_stores(user_id)
    if offer['store_id'] not in [s['store_id'] for s in stores]:
        raise HTTPException(403, "Access denied")
    
    # –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
    db.update_offer(offer_id, quantity=0)
    cache.delete(f"offer:{offer_id}")
    
    return {"success": True}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ React (Partner Panel):**

```javascript
// webapp/partner-panel/src/api/products.js
import axios from 'axios'

const API = axios.create({
  baseURL: '/api/partner',
  headers: {
    'X-Telegram-Init-Data': window.Telegram.WebApp.initData
  }
})

export async function getProducts() {
  const { data } = await API.get('/products')
  return data
}

export async function createProduct(product) {
  const { data } = await API.post('/products', product)
  return data
}
```

---

#### `orders.py` - API –¥–ª—è –∑–∞–∫–∞–∑–æ–≤

```python
"""
API endpoints –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ (–¥–ª—è Mini App).

Endpoints:
- POST /api/v1/orders          - –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
- GET  /api/v1/orders/:id      - –ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑
- GET  /api/v1/user/orders     - –ú–æ–∏ –∑–∞–∫–∞–∑—ã
- PUT  /api/v1/orders/:id/cancel - –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
"""

from fastapi import APIRouter, Depends, HTTPException

router = APIRouter(prefix="/api/v1", tags=["orders"])

class CreateOrderRequest(BaseModel):
    """–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã."""
    items: list[dict]  # [{"offer_id": 1, "quantity": 2}, ...]
    order_type: str = Field(..., pattern="^(pickup|delivery)$")
    
    # –î–ª—è pickup
    pickup_time: str | None = None
    
    # –î–ª—è delivery
    delivery_address: str | None = None
    delivery_phone: str | None = None
    delivery_note: str | None = None
    
    # –û–ø–ª–∞—Ç–∞
    payment_method: str = Field(..., pattern="^(cash|card|click)$")
    
    @model_validator(mode='after')
    def validate_order_type(self):
        if self.order_type == 'pickup' and not self.pickup_time:
            raise ValueError("pickup_time required for pickup")
        if self.order_type == 'delivery' and not self.delivery_address:
            raise ValueError("delivery_address required for delivery")
        return self

@router.post("/orders")
async def create_order(
    request: CreateOrderRequest,
    x_telegram_init_data: str = Header(...),
    db=Depends(get_db),
    bot=Depends(get_bot)
):
    """
    –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã Mini App.
    
    –ü—Ä–æ—Ü–µ—Å—Å:
    1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ—Ä–∑–∏–Ω—ã (availability, quantity)
    2. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î
    3. –£–º–µ–Ω—å—à–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤
    4. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–ø–æ–∫—É–ø–∞—Ç–µ–ª—é –∏ –ø—Ä–æ–¥–∞–≤—Ü—É)
    """
    # Auth
    validated = validate_telegram_webapp_data(x_telegram_init_data, ...)
    user_id = validated["user"]["id"]
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è items
    for item in request.items:
        offer = db.get_offer(item["offer_id"])
        if not offer:
            raise HTTPException(400, f"Offer {item['offer_id']} not found")
        if offer['quantity'] < item['quantity']:
            raise HTTPException(400, f"Not enough {offer['title']}")
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ UnifiedOrderService
    from app.services.unified_order_service import UnifiedOrderService
    
    service = UnifiedOrderService(db, bot)
    
    result = await service.create_order(
        user_id=user_id,
        offers=request.items,
        order_type=request.order_type,
        pickup_time=request.pickup_time,
        delivery_address=request.delivery_address,
        payment_method=request.payment_method
    )
    
    return result


@router.get("/orders/{order_id}")
async def get_order(
    order_id: int,
    x_telegram_init_data: str = Header(...),
    db=Depends(get_db)
):
    """
    –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞.
    
    Authorization: —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∑–∞–∫–∞–∑–∞.
    """
    validated = validate_telegram_webapp_data(x_telegram_init_data, ...)
    user_id = validated["user"]["id"]
    
    order = db.get_order(order_id)
    if not order:
        raise HTTPException(404, "Order not found")
    
    if order['user_id'] != user_id:
        raise HTTPException(403, "Access denied")
    
    return order
```

---

### üìÇ `app/core/` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ utilities

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–µ–∑–¥–µ.

#### `config.py` - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```python
"""Environment configuration with typed dataclasses."""

from dataclasses import dataclass
from dotenv import load_dotenv
import os

@dataclass(slots=True)
class WebhookConfig:
    """Webhook settings."""
    enabled: bool
    url: str
    path: str
    port: int
    secret_token: str

@dataclass(slots=True)
class Settings:
    """Application settings."""
    bot_token: str
    admin_id: int
    database_url: str | None
    redis_url: str | None
    webhook: WebhookConfig
    
    @property
    def telegram_bot_token(self) -> str:
        """Alias –¥–ª—è backwards compatibility."""
        return self.bot_token

def load_settings() -> Settings:
    """
    Load configuration from environment variables.
    
    Reads .env file and validates required values.
    
    Raises:
        ValueError: if TELEGRAM_BOT_TOKEN is not set
    """
    load_dotenv()  # –ó–∞–≥—Ä—É–∂–∞–µ–º .env
    
    token = os.getenv("TELEGRAM_BOT_TOKEN")
    if not token:
        raise ValueError("TELEGRAM_BOT_TOKEN is required")
    
    admin_id = int(os.getenv("ADMIN_ID", "0"))
    database_url = os.getenv("DATABASE_URL")
    redis_url = os.getenv("REDIS_URL")
    
    # Webhook config
    use_webhook = os.getenv("USE_WEBHOOK", "false").lower() in {"true", "1", "yes"}
    webhook_url = os.getenv("WEBHOOK_URL", "")
    
    # Auto-detect webhook from URL
    if webhook_url and not os.getenv("USE_WEBHOOK"):
        use_webhook = True
    
    # Generate SECRET_TOKEN if not provided
    secret_token = os.getenv("SECRET_TOKEN", "")
    if use_webhook and not secret_token:
        import secrets
        secret_token = secrets.token_urlsafe(32)
        print("‚ö†Ô∏è AUTO-GENERATED SECRET_TOKEN")
    
    webhook = WebhookConfig(
        enabled=use_webhook,
        url=webhook_url,
        path=os.getenv("WEBHOOK_PATH", "/webhook"),
        port=int(os.getenv("PORT", "8080")),
        secret_token=secret_token
    )
    
    return Settings(
        bot_token=token,
        admin_id=admin_id,
        database_url=database_url,
        redis_url=redis_url,
        webhook=webhook
    )
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```python
from app.core.config import load_settings

settings = load_settings()

bot = Bot(token=settings.bot_token)
print(f"Admin: {settings.admin_id}")
print(f"Webhook: {settings.webhook.enabled}")
```

---

#### `security.py` - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

```python
"""Security utilities - input validation, rate limiting."""

import html
import re
import time
from collections import defaultdict

class InputValidator:
    """Input validation and sanitization."""
    
    # Regex patterns
    PHONE_PATTERN = re.compile(r"^\+?[1-9]\d{1,14}$")
    USERNAME_PATTERN = re.compile(r"^[a-zA-Z0-9_]{3,32}$")
    CITY_PATTERN = re.compile(r"^[a-zA-Z–∞-—è–ê-–Ø—û“ì“õ“≥\s\-\']{1,50}$", re.UNICODE)
    PRICE_PATTERN = re.compile(r"^\d+(\.\d{1,2})?$")
    
    @staticmethod
    def sanitize_text(text: str, max_length: int = 1000) -> str:
        """
        Sanitize user input.
        
        - Escapes HTML (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
        - –¢—Ä–∏–º whitespace
        - –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–ª–∏–Ω—É
        """
        if not text:
            return ""
        return html.escape(text.strip())[:max_length]
    
    @staticmethod
    def validate_phone(phone: str) -> bool:
        """Validate phone number (E.164 format)."""
        return bool(InputValidator.PHONE_PATTERN.match(phone))
    
    @staticmethod
    def validate_city(city: str) -> bool:
        """Validate city name."""
        return bool(InputValidator.CITY_PATTERN.match(city))


class RateLimiter:
    """
    Simple in-memory rate limiter.
    
    NOTE: –î–ª—è production –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis!
    """
    
    def __init__(self, max_requests: int = 30, window: int = 60):
        self.max_requests = max_requests  # –ú–∞–∫—Å –∑–∞–ø—Ä–æ—Å–æ–≤
        self.window = window              # –í —Å–µ–∫—É–Ω–¥–∞—Ö
        self.requests = defaultdict(list) # {user_id: [timestamps]}
    
    def check_rate_limit(self, user_id: int) -> bool:
        """
        Check if user exceeded rate limit.
        
        Returns:
            True if OK, False if exceeded
        """
        now = time.time()
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ timestamps
        self.requests[user_id] = [
            ts for ts in self.requests[user_id]
            if now - ts < self.window
        ]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
        if len(self.requests[user_id]) >= self.max_requests:
            return False
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π timestamp
        self.requests[user_id].append(now)
        return True


# Global instances
validator = InputValidator()
rate_limiter = RateLimiter()
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```python
from app.core.security import validator, rate_limiter

# –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞
phone = validator.sanitize_text(user_input)
if not validator.validate_phone(phone):
    await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞")

# Rate limiting
if not rate_limiter.check_rate_limit(user_id):
    await message.answer("‚è≥ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ.")
    return
```

---

#### `constants.py` - –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã

```python
"""Application-wide constants."""

# Telegram limits
TELEGRAM_MESSAGE_LIMIT = 4096
TELEGRAM_CAPTION_LIMIT = 1024
TELEGRAM_BUTTON_TEXT_LIMIT = 64

# Business logic
MAX_BOOKING_QUANTITY = 10
BOOKING_DURATION_HOURS = 2
MAX_ACTIVE_BOOKINGS_PER_USER = 20

# Cache TTL
CACHE_TTL_SECONDS = 300  # 5 –º–∏–Ω—É—Ç
CACHE_TTL_HOT_OFFERS = 300
CACHE_TTL_USER_PROFILE = 3600  # 1 —á–∞—Å

# Time
SECONDS_PER_HOUR = 3600
SECONDS_PER_DAY = 86400

# Pagination
DEFAULT_PAGE_SIZE = 20
MAX_PAGE_SIZE = 100

# Categories
CATEGORIES = [
    "bread",      # –•–ª–µ–±–æ–±—É–ª–æ—á–Ω—ã–µ
    "dairy",      # –ú–æ–ª–æ—á–Ω—ã–µ
    "meat",       # –ú—è—Å–Ω—ã–µ
    "fruits",     # –§—Ä—É–∫—Ç—ã
    "vegetables", # –û–≤–æ—â–∏
    "ready",      # –ì–æ—Ç–æ–≤–∞—è –µ–¥–∞
    "drinks",     # –ù–∞–ø–∏—Ç–∫–∏
    "other"       # –î—Ä—É–≥–æ–µ
]

# Cities (Uzbekistan)
CITIES = [
    "–¢–∞—à–∫–µ–Ω—Ç",
    "–°–∞–º–∞—Ä–∫–∞–Ω–¥",
    "–ë—É—Ö–∞—Ä–∞",
    "–ê–Ω–¥–∏–∂–∞–Ω",
    "–§–µ—Ä–≥–∞–Ω–∞",
    "–ù–∞–º–∞–Ω–≥–∞–Ω",
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ
]
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```python
from app.core.constants import TELEGRAM_MESSAGE_LIMIT, MAX_BOOKING_QUANTITY

if len(message_text) > TELEGRAM_MESSAGE_LIMIT:
    message_text = message_text[:TELEGRAM_MESSAGE_LIMIT - 6] + "..."

if quantity > MAX_BOOKING_QUANTITY:
    await message.answer(f"‚ùå –ú–∞–∫—Å–∏–º—É–º {MAX_BOOKING_QUANTITY} —à—Ç—É–∫")
```

---

#### `bootstrap.py` - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```python
"""Application bootstrap - —Å–æ–∑–¥–∞–Ω–∏–µ bot, dispatcher, db, cache."""

from aiogram import Bot, Dispatcher
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.fsm.storage.redis import RedisStorage

from .cache import CacheManager
from .config import Settings
from .database import create_database

def build_application(settings: Settings):
    """
    Create all application components.
    
    Returns:
        (bot, dispatcher, database, cache)
    """
    # 1. Bot
    bot = Bot(token=settings.bot_token)
    
    # 2. Database
    db = create_database(settings.database_url)
    
    # 3. FSM Storage (–¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞)
    if settings.redis_url:
        # Production: Redis
        storage = RedisStorage.from_url(settings.redis_url)
        print("üöÄ Using Redis for FSM storage")
    elif settings.database_url and "postgresql" in settings.database_url:
        # Fallback: PostgreSQL
        from app.core.fsm_storage import EnhancedPostgreSQLStorage
        storage = EnhancedPostgreSQLStorage(db, ttl_hours=24)
        print("üíæ Using PostgreSQL for FSM storage")
    else:
        # Development: Memory
        storage = MemoryStorage()
        print("‚ö†Ô∏è FSM states will be lost on restart")
    
    # 4. Dispatcher
    dp = Dispatcher(storage=storage)
    
    # 5. Cache
    cache = CacheManager(redis_url=settings.redis_url)
    
    return bot, dp, db, cache
```

**–ü–æ—á–µ–º—É –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è?**
- –£–ø—Ä–æ—â–∞–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å mock components)
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
- –õ–µ–≥–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

---

### üìÇ `app/services/` - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–ª–æ–π —Å–µ—Ä–≤–∏—Å–æ–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –°–µ—Ä–≤–∏—Å—ã –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É—é—Ç —Ä–∞–±–æ—Ç—É –º–µ–∂–¥—É handlers –∏ repositories.

**–ü—Ä–∏–Ω—Ü–∏–ø:** Handler ‚Üí Service ‚Üí Repository ‚Üí Database

**–§–∞–π–ª—ã:**

#### `offer_service.py` (393 —Å—Ç—Ä–æ–∫–∏) - –†–∞–±–æ—Ç–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏

```python
"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ (offers).

–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ "–≥–æ—Ä—è—á–∏—Ö" –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å –∫–µ—à–µ–º
- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ
- –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
- –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞ + –º–∞–≥–∞–∑–∏–Ω–∞
"""

from dataclasses import dataclass
from app.core.cache import CacheManager

@dataclass(slots=True)
class OfferListItem:
    """DTO –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤."""
    id: int
    store_id: int
    title: str
    original_price: float
    discount_price: float
    discount_percent: float
    store_name: str
    store_address: str | None = None
    quantity: int | None = None
    photo: str | None = None
    category: str = "other"

@dataclass(slots=True)
class OfferDetails(OfferListItem):
    """DTO –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ."""
    description: str | None = None
    store_city: str | None = None
    store_description: str | None = None
    store_phone: str | None = None
    delivery_enabled: bool = False
    delivery_price: float = 0.0

class OfferService:
    """–ì–ª–∞–≤–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏."""
    
    def __init__(self, db, cache: CacheManager | None = None):
        self._db = db
        self._cache = cache
    
    def list_hot_offers(self, city: str, limit: int = 20) -> list[OfferListItem]:
        """
        –ü–æ–ª—É—á–∏—Ç—å "–≥–æ—Ä—è—á–∏–µ" –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞.
        
        –ê–ª–≥–æ—Ä–∏—Ç–º:
        1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à (5 –º–∏–Ω—É—Ç)
        2. –ï—Å–ª–∏ –Ω–µ—Ç - –∏–¥—ë–º –≤ –ë–î
        3. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ DTO
        4. –ö–µ—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        
        Args:
            city: –ì–æ—Ä–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            limit: –°–∫–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤–µ—Ä–Ω—É—Ç—å
        
        Returns:
            –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –º–∞–≥–∞–∑–∏–Ω–µ
        """
        # 1. –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –∏–∑ –∫–µ—à–∞
        if self._cache:
            cached = self._cache.get_hot_offers(city, limit)
            if cached:
                return [self._to_dto(row) for row in cached]
        
        # 2. –ò–¥—ë–º –≤ –ë–î
        raw_offers = self._db.get_hot_offers(city, limit=limit)
        
        # 3. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ DTO
        items = [self._to_dto(row) for row in raw_offers]
        
        # 4. –ö–µ—à–∏—Ä—É–µ–º
        if self._cache and items:
            self._cache.set_hot_offers(city, raw_offers)
        
        return items
    
    def get_offer_details(self, offer_id: int) -> OfferDetails | None:
        """
        –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ + –º–∞–≥–∞–∑–∏–Ω–µ.
        
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç JOIN –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –≤ 1 –∑–∞–ø—Ä–æ—Å–µ.
        """
        row = self._db.get_offer_with_store(offer_id)
        if not row:
            return None
        
        return OfferDetails(
            id=row['id'],
            store_id=row['store_id'],
            title=row['title'],
            description=row.get('description'),
            original_price=row['original_price'],
            discount_price=row['discount_price'],
            discount_percent=row['discount_percent'],
            quantity=row.get('quantity'),
            photo=row.get('photo'),
            category=row.get('category', 'other'),
            store_name=row['store_name'],
            store_city=row.get('store_city'),
            store_address=row.get('store_address'),
            store_phone=row.get('store_phone'),
            delivery_enabled=row.get('delivery_enabled', False),
            delivery_price=row.get('delivery_price', 0.0)
        )
    
    def search_offers(
        self,
        query: str,
        city: str,
        category: str | None = None
    ) -> list[OfferListItem]:
        """
        –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é.
        
        Features:
        - Full-text search –ø–æ title –∏ description
        - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≥–æ—Ä–æ–¥—É
        - –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        """
        results = self._db.search_offers(
            query=query,
            city=city,
            category=category
        )
        return [self._to_dto(row) for row in results]
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
```python
# –í handler
from app.services.offer_service import OfferService

offer_service = OfferService(db, cache)

# –ü–æ–∫–∞–∑–∞—Ç—å –≥–æ—Ä—è—á–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
offers = offer_service.list_hot_offers(user_city)
for offer in offers:
    await message.answer(
        f"{offer.title}\n"
        f"üí∞ {offer.discount_price} —Å—É–º (–±—ã–ª–æ {offer.original_price})\n"
        f"üìç {offer.store_name}"
    )
```

---

#### `unified_order_service.py` (2034 —Å—Ç—Ä–æ–∫–∏) - –ì–õ–ê–í–ù–´–ô –°–ï–†–í–ò–° –ó–ê–ö–ê–ó–û–í

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –í–°–ï–• –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∑–∞–∫–∞–∑–∞–º–∏ (pickup –∏ delivery).

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:** –≠—Ç–æ —Å–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π –∏ –≤–∞–∂–Ω—ã–π —Å–µ—Ä–≤–∏—Å –≤ –ø—Ä–æ–µ–∫—Ç–µ!

```python
"""
Unified Order Service - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏.

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:
- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ (pickup + delivery)
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º –∏ –ø—Ä–æ–¥–∞–≤—Ü–∞–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Å—Ç–∞—Ç—É—Å–æ–≤
- –í–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä

–°—Ç–∞—Ç—É—Å—ã:
    PENDING     ‚Üí –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–æ–¥–∞–≤—Ü–∞
    PREPARING   ‚Üí –ü—Ä–æ–¥–∞–≤–µ—Ü –ø—Ä–∏–Ω—è–ª, –≥–æ—Ç–æ–≤–∏—Ç –∑–∞–∫–∞–∑
    READY       ‚Üí –ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ/–¥–æ—Å—Ç–∞–≤–∫–µ
    DELIVERING  ‚Üí –í –ø—É—Ç–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è delivery)
    COMPLETED   ‚Üí –ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à—ë–Ω
    REJECTED    ‚Üí –û—Ç–∫–ª–æ–Ω—ë–Ω –ø—Ä–æ–¥–∞–≤—Ü–æ–º
    CANCELLED   ‚Üí –û—Ç–º–µ–Ω—ë–Ω –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–º

–°—Ç—Ä–∞—Ç–µ–≥–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è v2):
    - –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Å–ø–∞–º–∞: –ø—Ä–æ–ø—É—Å–∫–∞–µ–º READY —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    - –í–∏–∑—É–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã –¥–ª—è UX
    - Pickup: PREPARING ‚Üí COMPLETED (2 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
    - Delivery: PREPARING ‚Üí DELIVERING ‚Üí COMPLETED (3 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
"""

from dataclasses import dataclass
from aiogram import Bot

class OrderStatus:
    """–°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤."""
    PENDING = "pending"
    PREPARING = "preparing"
    READY = "ready"
    DELIVERING = "delivering"
    COMPLETED = "completed"
    REJECTED = "rejected"
    CANCELLED = "cancelled"

class PaymentStatus:
    """–°—Ç–∞—Ç—É—Å—ã –æ–ø–ª–∞—Ç—ã."""
    NOT_REQUIRED = "not_required"      # –ù–∞–ª–∏—á–Ω—ã–µ
    AWAITING_PAYMENT = "awaiting_payment"  # –ñ–¥—ë–º –æ–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç—É
    AWAITING_PROOF = "awaiting_proof"      # –ñ–¥—ë–º —Å–∫—Ä–∏–Ω—à–æ—Ç –ø–µ—Ä–µ–≤–æ–¥–∞
    CONFIRMED = "confirmed"                # –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞

@dataclass
class OrderCreationResult:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞."""
    success: bool
    order_id: int | None = None
    booking_id: int | None = None  # Legacy
    error: str | None = None
    total_amount: float = 0.0
    items_count: int = 0

class UnifiedOrderService:
    """–ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤."""
    
    def __init__(self, db, bot: Bot):
        self._db = db
        self._bot = bot
    
    async def create_order(
        self,
        user_id: int,
        offers: list[dict],  # [{"offer_id": 1, "quantity": 2}, ...]
        order_type: str,     # "pickup" –∏–ª–∏ "delivery"
        pickup_time: str | None = None,
        delivery_address: str | None = None,
        delivery_phone: str | None = None,
        payment_method: str = "cash"
    ) -> OrderCreationResult:
        """
        –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑.
        
        –ê–ª–≥–æ—Ä–∏—Ç–º:
        1. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ (availability, quantity)
        2. Atomic transaction:
           - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ orders
           - –£–º–µ–Ω—å—à–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤
           - –°–æ–∑–¥–∞–Ω–∏–µ order_items
        3. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
           - –ü–æ–∫—É–ø–∞—Ç–µ–ª—é: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
           - –ü—Ä–æ–¥–∞–≤—Ü—É: –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑
        
        Returns:
            OrderCreationResult —Å order_id –∏–ª–∏ error
        """
        try:
            # 1. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤
            validation = await self._validate_order_items(offers)
            if not validation["valid"]:
                return OrderCreationResult(
                    success=False,
                    error=validation["error"]
                )
            
            # 2. –í—ã—á–∏—Å–ª—è–µ–º —Å—É–º–º—É
            total_amount = sum(
                item["discount_price"] * item["quantity"]
                for item in validation["items"]
            )
            
            # 3. –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            order_id = self._db.create_order(
                user_id=user_id,
                order_type=order_type,
                status=OrderStatus.PENDING,
                payment_status=self._get_payment_status(payment_method),
                payment_method=payment_method,
                total_amount=total_amount,
                pickup_time=pickup_time,
                delivery_address=delivery_address,
                delivery_phone=delivery_phone
            )
            
            # 4. –î–æ–±–∞–≤–ª—è–µ–º items
            for item in validation["items"]:
                self._db.add_order_item(
                    order_id=order_id,
                    offer_id=item["offer_id"],
                    quantity=item["quantity"],
                    price=item["discount_price"]
                )
            
            # 5. –£–º–µ–Ω—å—à–∞–µ–º –æ—Å—Ç–∞—Ç–∫–∏
            for item in validation["items"]:
                self._db.decrease_offer_quantity(
                    item["offer_id"],
                    item["quantity"]
                )
            
            # 6. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            await self._notify_order_created(user_id, order_id, order_type)
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø—Ä–æ–¥–∞–≤—Ü–∞
            store_id = validation["items"][0]["store_id"]
            await self._notify_seller_new_order(store_id, order_id)
            
            return OrderCreationResult(
                success=True,
                order_id=order_id,
                total_amount=total_amount,
                items_count=len(offers)
            )
            
        except Exception as e:
            logger.error(f"Failed to create order: {e}")
            return OrderCreationResult(
                success=False,
                error=f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: {str(e)}"
            )
    
    async def update_order_status(
        self,
        order_id: int,
        new_status: str,
        updated_by: int | None = None
    ) -> bool:
        """
        –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏.
        
        CRITICAL: –í—ã–∑—ã–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è!
        
        –°—Ç—Ä–∞—Ç–µ–≥–∏—è:
        - PREPARING: "–í–∞—à –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤–∏—Ç—Å—è üë®‚Äçüç≥"
        - DELIVERING: "–ö—É—Ä—å–µ—Ä –≤ –ø—É—Ç–∏ üöó" + –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
        - COMPLETED: "–ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à—ë–Ω ‚úÖ" + –ø—Ä–æ—Å—å–±–∞ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
        - REJECTED: "–ó–∞–∫–∞–∑ –æ—Ç–∫–ª–æ–Ω—ë–Ω ‚ùå" + –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ (–µ—Å–ª–∏ –æ–ø–ª–∞—á–µ–Ω)
        """
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑
            order = self._db.get_order(order_id)
            if not order:
                return False
            
            old_status = order['status']
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ë–î
            self._db.update_order_status(order_id, new_status)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é
            await self._notify_status_change(
                user_id=order['user_id'],
                order_id=order_id,
                old_status=old_status,
                new_status=new_status,
                order_type=order['order_type']
            )
            
            # –õ–æ–≥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
            logger.info(
                f"Order {order_id} status changed: "
                f"{old_status} ‚Üí {new_status} by user {updated_by}"
            )
            
            return True
            
        except Exception as e:
            logger.error(f"Failed to update order status: {e}")
            return False
    
    async def _notify_status_change(
        self,
        user_id: int,
        order_id: int,
        old_status: str,
        new_status: str,
        order_type: str
    ):
        """
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞.
        
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç emoji –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã –¥–ª—è –ª—É—á—à–µ–≥–æ UX.
        """
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º READY (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å—Ç–∞—Ç—É—Å)
        if new_status == OrderStatus.READY:
            return
        
        # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user = self._db.get_user_model(user_id)
        lang = user.get('language', 'ru') if user else 'ru'
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if new_status == OrderStatus.PREPARING:
            text = (
                "üë®‚Äçüç≥ <b>–í–∞—à –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤–∏—Ç—Å—è!</b>\n\n"
                f"–ó–∞–∫–∞–∑ #{order_id}\n"
                f"{'üèÉ –ó–∞–±–µ—Ä–∏—Ç–µ –≤ –º–∞–≥–∞–∑–∏–Ω–µ' if order_type == 'pickup' else 'üöó –î–æ—Å—Ç–∞–≤–∏–º –∫ –≤–∞–º'}\n\n"
                f"{self._get_progress_bar('preparing', order_type)}"
            )
        
        elif new_status == OrderStatus.DELIVERING:
            text = (
                "üöó <b>–ö—É—Ä—å–µ—Ä –≤ –ø—É—Ç–∏!</b>\n\n"
                f"–ó–∞–∫–∞–∑ #{order_id}\n"
                "–û–∂–∏–¥–∞–π—Ç–µ –∑–≤–æ–Ω–∫–∞ –∫—É—Ä—å–µ—Ä–∞\n\n"
                f"{self._get_progress_bar('delivering', order_type)}"
            )
        
        elif new_status == OrderStatus.COMPLETED:
            text = (
                "‚úÖ <b>–ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à—ë–Ω!</b>\n\n"
                f"–ó–∞–∫–∞–∑ #{order_id}\n"
                "–°–ø–∞—Å–∏–±–æ —á—Ç–æ –≤—ã–±—Ä–∞–ª–∏ Fudly! üéâ\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ü–µ–Ω–∏—Ç–µ –∑–∞–∫–∞–∑:"
            )
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞
            from aiogram.utils.keyboard import InlineKeyboardBuilder
            builder = InlineKeyboardBuilder()
            for i in range(1, 6):
                builder.button(text=f"{'‚≠ê' * i}", callback_data=f"rate_{order_id}_{i}")
            builder.adjust(5)
            keyboard = builder.as_markup()
        
        elif new_status == OrderStatus.REJECTED:
            text = (
                "‚ùå <b>–ó–∞–∫–∞–∑ –æ—Ç–∫–ª–æ–Ω—ë–Ω</b>\n\n"
                f"–ó–∞–∫–∞–∑ #{order_id}\n"
                "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø—Ä–æ–¥–∞–≤–µ—Ü –Ω–µ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–∫–∞–∑.\n"
                "–°—Ä–µ–¥—Å—Ç–≤–∞ –≤–µ—Ä–Ω—É—Ç—Å—è –Ω–∞ –≤–∞—à —Å—á—ë—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤."
            )
            keyboard = None
        
        else:
            return  # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        try:
            if new_status == OrderStatus.COMPLETED:
                await self._bot.send_message(
                    user_id,
                    text,
                    reply_markup=keyboard,
                    parse_mode="HTML"
                )
            else:
                await self._bot.send_message(
                    user_id,
                    text,
                    parse_mode="HTML"
                )
        except Exception as e:
            logger.error(f"Failed to send notification to {user_id}: {e}")
    
    def _get_progress_bar(self, current_status: str, order_type: str) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä.
        
        Pickup:  ‚¨ú ‚Üí üü¶ ‚Üí ‚úÖ
        Delivery: ‚¨ú ‚Üí üü¶ ‚Üí üü© ‚Üí ‚úÖ
        """
        if order_type == "pickup":
            stages = {
                "pending": "‚¨ú ‚¨ú ‚¨ú",
                "preparing": "üü¶ ‚¨ú ‚¨ú",
                "ready": "üü¶ üü¶ ‚¨ú",
                "completed": "üü¶ üü¶ ‚úÖ"
            }
            labels = "–ù–æ–≤—ã–π ‚Üí –ì–æ—Ç–æ–≤–∏—Ç—Å—è ‚Üí –ì–æ—Ç–æ–≤"
        else:
            stages = {
                "pending": "‚¨ú ‚¨ú ‚¨ú ‚¨ú",
                "preparing": "üü¶ ‚¨ú ‚¨ú ‚¨ú",
                "delivering": "üü¶ üü¶ ‚¨ú ‚¨ú",
                "completed": "üü¶ üü¶ üü¶ ‚úÖ"
            }
            labels = "–ù–æ–≤—ã–π ‚Üí –ì–æ—Ç–æ–≤–∏—Ç—Å—è ‚Üí –í –ø—É—Ç–∏ ‚Üí –î–æ—Å—Ç–∞–≤–ª–µ–Ω"
        
        return f"{stages.get(current_status, stages['pending'])}\n{labels}"
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:**
1. **Single Source of Truth** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∑–∞–∫–∞–∑–∞–º–∏ –∏–¥—É—Ç —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å
2. **Consistency** - –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –ª–æ–≥–∏–∫—É –¥–ª—è pickup –∏ delivery
3. **Notifications** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
4. **Transactional** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞—Ç–æ–º–∞—Ä–Ω—ã–µ (rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# –í handler —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
from app.services.unified_order_service import UnifiedOrderService

service = UnifiedOrderService(db, bot)

result = await service.create_order(
    user_id=message.from_user.id,
    offers=[{"offer_id": 123, "quantity": 2}],
    order_type="pickup",
    pickup_time="18:00",
    payment_method="cash"
)

if result.success:
    await message.answer(f"‚úÖ –ó–∞–∫–∞–∑ #{result.order_id} —Å–æ–∑–¥–∞–Ω!")
else:
    await message.answer(f"‚ùå {result.error}")
```

---

#### `booking_service.py` - –°–µ—Ä–≤–∏—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π (Legacy)

**DEPRECATED:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `UnifiedOrderService`!

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω –¥–ª—è backwards compatibility, –Ω–æ –≤—Å–µ –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ `unified_order_service.py`.

---

#### `admin_service.py` - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

```python
"""–°–µ—Ä–≤–∏—Å –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π."""

class AdminService:
    """–û–ø–µ—Ä–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞."""
    
    def __init__(self, db):
        self._db = db
    
    def get_pending_stores(self) -> list[dict]:
        """–ü–æ–ª—É—á–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω—ã –æ–∂–∏–¥–∞—é—â–∏–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏."""
        return self._db.get_stores_by_status("pending")
    
    async def approve_store(self, store_id: int, admin_id: int) -> bool:
        """
        –û–¥–æ–±—Ä–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω.
        
        Actions:
        1. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å ‚Üí "approved"
        2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É
        3. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ
        """
        self._db.update_store_status(store_id, "approved")
        
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞
        store = self._db.get_store(store_id)
        owner_id = store['owner_id']
        
        await self._bot.send_message(
            owner_id,
            "‚úÖ –í–∞—à –º–∞–≥–∞–∑–∏–Ω –æ–¥–æ–±—Ä–µ–Ω! –ú–æ–∂–µ—Ç–µ –Ω–∞—á–∏–Ω–∞—Ç—å –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–æ–≤–∞—Ä—ã."
        )
        
        return True
```

---

#### `search_service.py` - –ü–æ–∏—Å–∫

```python
"""Full-text search service."""

class SearchService:
    """–ü–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä–∞–º."""
    
    def search(
        self,
        query: str,
        city: str,
        filters: dict | None = None
    ) -> list[dict]:
        """
        –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫.
        
        Features:
        - –ü–æ–∏—Å–∫ –ø–æ title –∏ description
        - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≥–æ—Ä–æ–¥—É
        - –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ relevance
        """
        return self._db.search_offers(
            query=query,
            city=city,
            category=filters.get("category") if filters else None
        )
```

---

#### `stats.py` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

```python
"""Statistics service for analytics."""

class StatsService:
    """–°–µ—Ä–≤–∏—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–æ–≤."""
    
    def get_store_stats(self, store_id: int, period: str = "week") -> dict:
        """
        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥.
        
        Returns:
            {
                "orders_count": 42,
                "revenue": 125000.0,
                "avg_order": 2976.2,
                "popular_items": [...],
                "peak_hours": [17, 18, 19]
            }
        """
        return self._db.get_store_statistics(store_id, period)
```

---

### üìÇ `app/repositories/` - Data Access Layer

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏–∑–æ–ª–∏—Ä—É—é—Ç —Ä–∞–±–æ—Ç—É —Å –ë–î. –≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ –≥–¥–µ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –º–µ—Ç–æ–¥—ã database.

**–ü–∞—Ç—Ç–µ—Ä–Ω Repository:**
- Handler ‚Üí Service ‚Üí **Repository** ‚Üí Database
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ repository
- Error handling –∏ mapping exceptions

**–§–∞–π–ª—ã:**

#### `base.py` - –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å

```python
"""Base repository with common functionality."""

class BaseRepository:
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤."""
    
    def __init__(self, db):
        self.db = db
    
    def _handle_db_error(self, operation: str, error: Exception):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ë–î."""
        logger.error(f"{operation} failed: {error}")
        raise DatabaseException(f"Database error in {operation}")
```

---

#### `offer_repository.py` (245 —Å—Ç—Ä–æ–∫) - –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Ç–æ–≤–∞—Ä–æ–≤

```python
"""Repository for offer operations."""

from app.core.exceptions import OfferNotFoundException

class OfferRepository(BaseRepository):
    """–†–∞–±–æ—Ç–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏."""
    
    def get_offer(self, offer_id: int) -> dict | None:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä –ø–æ ID.
        
        Returns:
            dict —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ None
        """
        try:
            return self.db.get_offer(offer_id)
        except Exception as e:
            self._handle_db_error("get_offer", e)
    
    def get_offer_or_raise(self, offer_id: int) -> dict:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–ª–∏ –≤—ã–±—Ä–æ—Å–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
        
        Raises:
            OfferNotFoundException: –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
        """
        offer = self.get_offer(offer_id)
        if not offer:
            raise OfferNotFoundException(offer_id)
        return offer
    
    def add_offer(
        self,
        store_id: int,
        title: str,
        original_price: float,
        discount_price: float,
        quantity: int = 1,
        **kwargs
    ) -> int:
        """
        –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä.
        
        Returns:
            ID –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
        """
        return self.db.add_offer(
            store_id,
            title,
            original_price=original_price,
            discount_price=discount_price,
            quantity=quantity,
            **kwargs
        )
    
    def update_quantity(self, offer_id: int, delta: int) -> bool:
        """
        –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞.
        
        Args:
            offer_id: ID —Ç–æ–≤–∞—Ä–∞
            delta: –ò–∑–º–µ–Ω–µ–Ω–∏–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º)
        """
        return self.db.update_offer_quantity(offer_id, delta)
```

---

#### `cached.py` - –ö–µ—à–∏—Ä—É—é—â–∏–π –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä

```python
"""Caching decorator for repositories."""

from functools import wraps
from app.core.cache import CacheManager

def cached(ttl: int = 300, key_prefix: str = ""):
    """
    –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –º–µ—Ç–æ–¥–∞.
    
    Usage:
        @cached(ttl=600, key_prefix="offer")
        def get_offer(self, offer_id: int):
            return self.db.get_offer(offer_id)
    """
    def decorator(func):
        @wraps(func)
        def wrapper(self, *args, **kwargs):
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á –∫–µ—à–∞
            cache_key = f"{key_prefix}:{func.__name__}:{args}:{kwargs}"
            
            # –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –∏–∑ –∫–µ—à–∞
            if hasattr(self, '_cache') and self._cache:
                cached_value = self._cache.get(cache_key)
                if cached_value is not None:
                    return cached_value
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é
            result = func(self, *args, **kwargs)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
            if hasattr(self, '_cache') and self._cache and result:
                self._cache.set(cache_key, result, ttl=ttl)
            
            return result
        return wrapper
    return decorator


# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
class OfferRepository(BaseRepository):
    def __init__(self, db, cache: CacheManager):
        super().__init__(db)
        self._cache = cache
    
    @cached(ttl=600, key_prefix="offer")
    def get_offer(self, offer_id: int):
        return self.db.get_offer(offer_id)
```

---

### üìÇ `app/domain/` - Domain Models

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ type safety.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- `entities/` - –°—É—â–Ω–æ—Å—Ç–∏ (User, Store, Offer, Order)
- `models/` - Request/Response –º–æ–¥–µ–ª–∏ –¥–ª—è API
- `value_objects/` - Value objects (Price, Location, etc.)

**–ü—Ä–∏–º–µ—Ä:**

```python
# app/domain/entities/offer.py
from pydantic import BaseModel, Field

class Offer(BaseModel):
    """–°—É—â–Ω–æ—Å—Ç—å Offer."""
    id: int
    store_id: int
    title: str = Field(..., min_length=1, max_length=200)
    original_price: float = Field(..., gt=0)
    discount_price: float = Field(..., gt=0)
    quantity: int = Field(..., ge=0)
    category: str
    
    @property
    def discount_percent(self) -> int:
        """–í—ã—á–∏—Å–ª–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏."""
        return int((1 - self.discount_price / self.original_price) * 100)
```

---

### üìÇ `app/middlewares/` - aiogram Middlewares

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Middleware –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–±—ã—Ç–∏—è –ü–ï–†–ï–î handler'–∞–º–∏.

**–§–∞–π–ª—ã:**

#### `db_middleware.py` - Database injection

```python
"""Inject database instance into handlers."""

from aiogram import BaseMiddleware

class DbSessionMiddleware(BaseMiddleware):
    """–î–æ–±–∞–≤–ª—è–µ—Ç db –≤ data –¥–ª—è –≤—Å–µ—Ö handlers."""
    
    def __init__(self, db):
        self.db = db
    
    async def __call__(self, handler, event, data):
        """
        –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –ö–ê–ñ–î–û–ì–û —Å–æ–æ–±—â–µ–Ω–∏—è/callback.
        
        –î–æ–±–∞–≤–ª—è–µ—Ç db –≤ data ‚Üí handler –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
            async def my_handler(message, db):
                user = db.get_user_model(message.from_user.id)
        """
        data["db"] = self.db
        return await handler(event, data)


# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ bot.py:
from app.middlewares.db_middleware import DbSessionMiddleware

dp.message.middleware(DbSessionMiddleware(db))
dp.callback_query.middleware(DbSessionMiddleware(db))
```

---

#### `rate_limit.py` - Rate limiting

```python
"""Rate limiting middleware to prevent spam."""

from app.core.security import RateLimiter

class RateLimitMiddleware(BaseMiddleware):
    """–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    
    def __init__(self, rate_limiter: RateLimiter):
        self.rate_limiter = rate_limiter
    
    async def __call__(self, handler, event, data):
        user_id = event.from_user.id
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º rate limit
        if not self.rate_limiter.check_rate_limit(user_id):
            # –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤
            if hasattr(event, 'answer'):
                await event.answer("‚è≥ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ.")
            return  # –ù–ï –≤—ã–∑—ã–≤–∞–µ–º handler
        
        # –û–ö, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
        return await handler(event, data)
```

---

#### `user_cache_middleware.py` - User caching

```python
"""Cache user data to reduce DB queries."""

class UserCacheMiddleware(BaseMiddleware):
    """
    –ö–µ—à–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    –í–º–µ—Å—Ç–æ db.get_user_model() –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å,
    –±–µ—Ä—ë–º –∏–∑ –∫–µ—à–∞ (TTL 1 —á–∞—Å).
    """
    
    def __init__(self, cache: CacheManager):
        self.cache = cache
    
    async def __call__(self, handler, event, data):
        user_id = event.from_user.id
        
        # –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –∏–∑ –∫–µ—à–∞
        user = self.cache.get(f"user:{user_id}")
        
        if not user:
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –ë–î
            db = data.get("db")
            if db:
                user = db.get_user_model(user_id)
                if user:
                    self.cache.set(f"user:{user_id}", user, ttl=3600)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ data
        data["user"] = user
        
        return await handler(event, data)
```

---

### üìÇ `app/keyboards/` - Telegram Keyboards

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä (ReplyKeyboard –∏ InlineKeyboard).

**–§–∞–π–ª—ã:**

#### `common.py` (244 —Å—Ç—Ä–æ–∫–∏) - –û–±—â–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã

```python
"""Common keyboards used across the bot."""

from aiogram.types import InlineKeyboardMarkup, ReplyKeyboardMarkup
from aiogram.utils.keyboard import InlineKeyboardBuilder, ReplyKeyboardBuilder
from localization import get_text

def language_keyboard() -> InlineKeyboardMarkup:
    """–í—ã–±–æ—Ä —è–∑—ã–∫–∞."""
    builder = InlineKeyboardBuilder()
    builder.button(text="üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data="lang_ru")
    builder.button(text="üá∫üáø O'zbekcha", callback_data="lang_uz")
    builder.adjust(2)  # 2 –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥
    return builder.as_markup()


def phone_request_keyboard(lang: str = "ru") -> ReplyKeyboardMarkup:
    """–ó–∞–ø—Ä–æ—Å –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞."""
    builder = ReplyKeyboardBuilder()
    builder.button(
        text=get_text(lang, "share_phone"),
        request_contact=True  # Telegram API feature
    )
    return builder.as_markup(
        resize_keyboard=True,
        one_time_keyboard=True  # –°–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    )


def city_keyboard(lang: str = "ru") -> ReplyKeyboardMarkup:
    """–í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞."""
    from localization import get_cities
    
    cities = get_cities(lang)
    builder = ReplyKeyboardBuilder()
    
    for city in cities:
        builder.button(text=f"üìç {city}")
    
    builder.adjust(2, 2, 2, 2)  # –ü–æ 2 –∫–Ω–æ–ø–∫–∏ –≤ 4 —Ä—è–¥–∞—Ö
    return builder.as_markup(resize_keyboard=True)


def main_menu_keyboard(lang: str = "ru", user_role: str = "customer") -> ReplyKeyboardMarkup:
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é."""
    builder = ReplyKeyboardBuilder()
    
    if user_role == "customer":
        builder.button(text=get_text(lang, "hot_offers"))
        builder.button(text=get_text(lang, "search"))
        builder.button(text=get_text(lang, "my_orders"))
        builder.button(text=get_text(lang, "favorites"))
        builder.button(text=get_text(lang, "profile"))
        builder.adjust(2, 2, 1)
    
    elif user_role == "seller":
        builder.button(text=get_text(lang, "my_products"))
        builder.button(text=get_text(lang, "add_product"))
        builder.button(text=get_text(lang, "orders"))
        builder.button(text=get_text(lang, "statistics"))
        builder.adjust(2, 2)
    
    return builder.as_markup(resize_keyboard=True)
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```python
from app.keyboards.common import phone_request_keyboard, main_menu_keyboard

# –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω
await message.answer(
    "–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞:",
    reply_markup=phone_request_keyboard(lang="ru")
)

# –ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
await message.answer(
    "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
    reply_markup=main_menu_keyboard(lang="ru", user_role="customer")
)
```

---

#### `inline.py` - Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã

```python
"""Inline keyboards for callbacks."""

def offer_actions_keyboard(offer_id: int, lang: str = "ru") -> InlineKeyboardMarkup:
    """–î–µ–π—Å—Ç–≤–∏—è —Å —Ç–æ–≤–∞—Ä–æ–º."""
    builder = InlineKeyboardBuilder()
    builder.button(
        text="üõí –í –∫–æ—Ä–∑–∏–Ω—É",
        callback_data=f"add_cart_{offer_id}"
    )
    builder.button(
        text="‚ù§Ô∏è –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ",
        callback_data=f"add_fav_{offer_id}"
    )
    builder.button(
        text="üìç –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ",
        callback_data=f"show_map_{offer_id}"
    )
    builder.adjust(2, 1)  # 2 –≤ –ø–µ—Ä–≤–æ–º —Ä—è–¥—É, 1 –≤–æ –≤—Ç–æ—Ä–æ–º
    return builder.as_markup()


def order_status_keyboard(order_id: int) -> InlineKeyboardMarkup:
    """–ö–Ω–æ–ø–∫–∏ –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–∞ (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–º)."""
    builder = InlineKeyboardBuilder()
    builder.button(text="‚úÖ –ü—Ä–∏–Ω—è—Ç—å", callback_data=f"order_accept_{order_id}")
    builder.button(text="‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"order_reject_{order_id}")
    builder.adjust(2)
    return builder.as_markup()
```

---

## üìÇ –ü–ê–ü–ö–ê `handlers/` - –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò TELEGRAM

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Handler'—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏ callback'–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
handlers/
‚îú‚îÄ‚îÄ common/        # –û–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã (/start, /help, /menu)
‚îú‚îÄ‚îÄ customer/      # –§—É–Ω–∫—Ü–∏–∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
‚îÇ   ‚îú‚îÄ‚îÄ cart/      # –ö–æ—Ä–∑–∏–Ω–∞
‚îÇ   ‚îú‚îÄ‚îÄ offers/    # –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ orders/    # –ú–æ–∏ –∑–∞–∫–∞–∑—ã
‚îÇ   ‚îú‚îÄ‚îÄ payments.py
‚îÇ   ‚îî‚îÄ‚îÄ profile.py
‚îú‚îÄ‚îÄ seller/        # –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–¥–∞–≤—Ü–∞
‚îÇ   ‚îú‚îÄ‚îÄ management/ # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ bookings/   # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ analytics.py
‚îÇ   ‚îî‚îÄ‚îÄ stats.py
‚îú‚îÄ‚îÄ bookings/      # –ü—Ä–æ—Ü–µ—Å—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
‚îî‚îÄ‚îÄ admin/         # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
```

### üìÅ `handlers/common/` - –û–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã

#### `/start` command

```python
"""Start command handler."""

from aiogram import Router, F
from aiogram.filters import Command
from aiogram.types import Message

router = Router()

@router.message(Command("start"))
async def cmd_start(message: Message, db, user: dict | None):
    """
    –ö–æ–º–∞–Ω–¥–∞ /start.
    
    –õ–æ–≥–∏–∫–∞:
    1. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω ‚Üí –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    2. –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –Ω–∞—á–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    """
    user_id = message.from_user.id
    
    if user and user.get('registered'):
        # –£–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
        from app.keyboards.common import main_menu_keyboard
        
        await message.answer(
            f"–ü—Ä–∏–≤–µ—Ç, {user['first_name']}! üëã\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=main_menu_keyboard(
                lang=user.get('language', 'ru'),
                user_role=user.get('role', 'customer')
            )
        )
    else:
        # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        from app.keyboards.common import language_keyboard
        
        await message.answer(
            "üá∑üá∫üá∫üáø –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Tilni tanlang:",
            reply_markup=language_keyboard()
        )
```

---

### üìÅ `handlers/customer/offers/` - –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤

#### `hot_offers.py` - –ì–æ—Ä—è—á–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

```python
"""Hot offers handler."""

from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from app.services.offer_service import OfferService
from app.keyboards.inline import offer_actions_keyboard

router = Router()

@router.message(F.text.in_(["üî• –ì–æ—Ä—è—á–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è", "üî• Issiq takliflar"]))
async def show_hot_offers(message: Message, db, user: dict, cache):
    """
    –ü–æ–∫–∞–∑–∞—Ç—å –≥–æ—Ä—è—á–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    Features:
    - –ë–µ—Ä—ë—Ç –≥–æ—Ä–æ–¥ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
    - –ö–µ—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (5 –º–∏–Ω—É—Ç)
    - –ü–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
    """
    user_city = user.get('city', '–¢–∞—à–∫–µ–Ω—Ç')
    lang = user.get('language', 'ru')
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å
    service = OfferService(db, cache)
    result = service.list_hot_offers(city=user_city, limit=10)
    
    if not result.items:
        await message.answer("–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–µ–π—á–∞—Å –Ω–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤ –≤–∞—à–µ–º –≥–æ—Ä–æ–¥–µ üòî")
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
    for offer in result.items:
        text = (
            f"üî• <b>{offer.title}</b>\n\n"
            f"üí∞ –¶–µ–Ω–∞: <b>{offer.discount_price} —Å—É–º</b>\n"
            f"<s>{offer.original_price} —Å—É–º</s> (-{offer.discount_percent}%)\n\n"
            f"üìç {offer.store_name}\n"
            f"üìÆ {offer.store_address}\n"
        )
        
        if offer.photo:
            await message.answer_photo(
                photo=offer.photo,
                caption=text,
                reply_markup=offer_actions_keyboard(offer.id, lang),
                parse_mode="HTML"
            )
        else:
            await message.answer(
                text,
                reply_markup=offer_actions_keyboard(offer.id, lang),
                parse_mode="HTML"
            )
```

---

### üìÅ `handlers/seller/` - –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–¥–∞–≤—Ü–∞

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Handler'—ã –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ –º–∞–≥–∞–∑–∏–Ω–æ–≤ (—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞).

#### `registration.py` (715 —Å—Ç—Ä–æ–∫) - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–∞

```python
"""
–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞ (–ø—Ä–æ–¥–∞–≤—Ü–∞).

FSM states:
- RegisterStore.name         ‚Üí –ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞
- RegisterStore.city         ‚Üí –ì–æ—Ä–æ–¥
- RegisterStore.address      ‚Üí –ê–¥—Ä–µ—Å
- RegisterStore.business_type ‚Üí –¢–∏–ø –±–∏–∑–Ω–µ—Å–∞
- RegisterStore.phone        ‚Üí –¢–µ–ª–µ—Ñ–æ–Ω
- RegisterStore.description  ‚Üí –û–ø–∏—Å–∞–Ω–∏–µ

–ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–∞–≥–∞–∑–∏–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é.
"""

from aiogram import Router, F
from aiogram.fsm.context import FSMContext
from handlers.common.states import RegisterStore

router = Router()

@router.message(F.text.contains("–°—Ç–∞—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º") | F.text.contains("Hamkor bolish"))
async def become_partner(message: Message, state: FSMContext, db):
    """
    –ù–∞—á–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –º–∞–≥–∞–∑–∏–Ω–∞.
    
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –º–∞–≥–∞–∑–∏–Ω ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤ seller mode
    - –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –Ω–∞—á–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    """
    user_id = message.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ –º–∞–≥–∞–∑–∏–Ω
    stores = db.get_user_accessible_stores(user_id)
    
    if stores:
        # –£–∂–µ –µ—Å—Ç—å –º–∞–≥–∞–∑–∏–Ω
        approved = [s for s in stores if s.get('status') == 'approved']
        if approved:
            # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤ seller mode
            set_user_view_mode(user_id, 'seller')
            await message.answer(
                "‚úÖ –†–µ–∂–∏–º –ø—Ä–æ–¥–∞–≤—Ü–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!",
                reply_markup=main_menu_seller(lang)
            )
            return
    
    # –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    await state.set_state(RegisterStore.name)
    await message.answer(
        "üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–∞\n\n"
        "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤–∞—à –º–∞–≥–∞–∑–∏–Ω?",
        reply_markup=cancel_keyboard(lang)
    )


@router.message(RegisterStore.name)
async def process_store_name(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞."""
    store_name = message.text.strip()
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è
    if len(store_name) < 3:
        await message.answer("‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ. –ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞.")
        return
    
    if len(store_name) > 100:
        await message.answer("‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ. –ú–∞–∫—Å–∏–º—É–º 100 —Å–∏–º–≤–æ–ª–æ–≤.")
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ FSM state
    await state.update_data(store_name=store_name)
    
    # –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –≥–æ—Ä–æ–¥
    await state.set_state(RegisterStore.city)
    await message.answer(
        "üìç –í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –º–∞–≥–∞–∑–∏–Ω?",
        reply_markup=city_keyboard(lang)
    )


@router.message(RegisterStore.city)
async def process_store_city(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏—Ç—å –≥–æ—Ä–æ–¥ –º–∞–≥–∞–∑–∏–Ω–∞."""
    city = message.text.replace("üìç ", "").strip()
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –≥–æ—Ä–æ–¥–∞
    valid_cities = get_cities(lang)
    if city not in valid_cities:
        await message.answer("‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞")
        return
    
    await state.update_data(city=city)
    
    # –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –∞–¥—Ä–µ—Å
    await state.set_state(RegisterStore.address)
    await message.answer(
        "üìÆ –£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –º–∞–≥–∞–∑–∏–Ω–∞:\n"
        "–ù–∞–ø—Ä–∏–º–µ—Ä: —É–ª. –ú–∏—Ä–∞–±–∞–¥—Å–∫–∞—è, 5",
        reply_markup=cancel_keyboard(lang)
    )


@router.message(RegisterStore.address)
async def process_store_address(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å –º–∞–≥–∞–∑–∏–Ω–∞."""
    address = message.text.strip()
    
    if len(address) < 5:
        await message.answer("‚ùå –ê–¥—Ä–µ—Å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π")
        return
    
    await state.update_data(address=address)
    
    # –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: —Ç–∏–ø –±–∏–∑–Ω–µ—Å–∞
    await state.set_state(RegisterStore.business_type)
    await message.answer(
        "üè™ –¢–∏–ø –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞:",
        reply_markup=category_keyboard(lang)
    )


@router.message(RegisterStore.business_type)
async def process_business_type(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–∏–ø –±–∏–∑–Ω–µ—Å–∞."""
    business_type = message.text.strip()
    await state.update_data(business_type=business_type)
    
    # –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: —Ç–µ–ª–µ—Ñ–æ–Ω
    await state.set_state(RegisterStore.phone)
    await message.answer(
        "üìû –£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω:\n"
        "–§–æ—Ä–º–∞—Ç: +998901234567",
        reply_markup=cancel_keyboard(lang)
    )


@router.message(RegisterStore.phone)
async def process_store_phone(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –º–∞–≥–∞–∑–∏–Ω–∞."""
    phone = message.text.strip()
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    from app.core.security import validator
    if not validator.validate_phone(phone):
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞")
        return
    
    await state.update_data(phone=phone)
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥: –æ–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    await state.set_state(RegisterStore.description)
    await message.answer(
        "üìù –ù–∞–ø–∏—à–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞:\n"
        "(–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å)",
        reply_markup=skip_keyboard(lang)
    )


@router.message(RegisterStore.description)
async def process_store_description(message: Message, state: FSMContext, db, bot):
    """
    –ü–æ–ª—É—á–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∏ —Å–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω.
    
    –§–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥:
    1. –°–æ–±—Ä–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ FSM state
    2. –°–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω –≤ –ë–î —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "pending"
    3. –£–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ –Ω–æ–≤–æ–º –º–∞–≥–∞–∑–∏–Ω–µ
    4. –°–æ–æ–±—â–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á—Ç–æ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞
    """
    description = message.text.strip() if message.text != "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å" else None
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    data = await state.get_data()
    user_id = message.from_user.id
    
    # –°–æ–∑–¥–∞—ë–º –º–∞–≥–∞–∑–∏–Ω
    store_id = db.create_store(
        owner_id=user_id,
        name=data['store_name'],
        city=data['city'],
        address=data['address'],
        business_type=data['business_type'],
        phone=data['phone'],
        description=description,
        status='pending'  # –¢—Ä–µ–±—É–µ—Ç –º–æ–¥–µ—Ä–∞—Ü–∏–∏!
    )
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    admin_id = settings.admin_id
    await bot.send_message(
        admin_id,
        f"üÜï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –º–∞–≥–∞–∑–∏–Ω!\n\n"
        f"ID: {store_id}\n"
        f"–ù–∞–∑–≤–∞–Ω–∏–µ: {data['store_name']}\n"
        f"–ì–æ—Ä–æ–¥: {data['city']}\n"
        f"–ê–¥—Ä–µ—Å: {data['address']}\n"
        f"–¢–∏–ø: {data['business_type']}\n"
        f"–¢–µ–ª–µ—Ñ–æ–Ω: {data['phone']}\n"
        f"–í–ª–∞–¥–µ–ª–µ—Ü: {user_id}",
        reply_markup=admin_store_approval_keyboard(store_id)
    )
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await message.answer(
        "‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!\n\n"
        "–í–∞—à –º–∞–≥–∞–∑–∏–Ω –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.\n"
        "–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –º–∞–≥–∞–∑–∏–Ω –±—É–¥–µ—Ç –æ–¥–æ–±—Ä–µ–Ω.",
        reply_markup=main_menu_customer(lang)
    )
    
    # –û—á–∏—â–∞–µ–º FSM state
    await state.clear()
```

**–í–∞–∂–Ω–æ:**
- –ú–∞–≥–∞–∑–∏–Ω —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`
- –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- –ê–¥–º–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –û–¥–æ–±—Ä–∏—Ç—å/–û—Ç–∫–ª–æ–Ω–∏—Ç—å

---

#### `create_offer.py` - –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞

```python
"""Handler –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –ø—Ä–æ–¥–∞–≤—Ü–æ–º."""

from aiogram import Router, F
from aiogram.fsm.context import FSMContext

router = Router()

@router.message(F.text.in_(["‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä", "‚ûï Mahsulot qo'shish"]))
async def start_create_offer(message: Message, state: FSMContext, db):
    """
    –ù–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞.
    
    –ü—Ä–æ–≤–µ—Ä–∫–∏:
    - –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω
    """
    user_id = message.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –º–∞–≥–∞–∑–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    stores = db.get_user_accessible_stores(user_id)
    approved = [s for s in stores if s.get('status') == 'approved']
    
    if not approved:
        await message.answer(
            "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–Ω–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞.\n"
            "–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –º–∞–≥–∞–∑–∏–Ω."
        )
        return
    
    # –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∞–≥–∞–∑–∏–Ω–æ–≤ - –≤—ã–±—Ä–∞—Ç—å
    if len(approved) > 1:
        # TODO: –ø–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞
        pass
    
    store_id = approved[0]['store_id']
    await state.update_data(store_id=store_id)
    
    # –ù–∞—á–∏–Ω–∞–µ–º FSM –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
    await state.set_state(CreateOffer.title)
    await message.answer(
        "üìù –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞\n\n"
        "–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:"
    )


# ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ FSM (category, price, quantity, photo, etc.)
```

---

#### `order_management.py` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏

```python
"""Handler –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏ –ø—Ä–æ–¥–∞–≤—Ü–æ–º."""

from aiogram import Router
from app.services.unified_order_service import UnifiedOrderService

router = Router()

@router.callback_query(F.data.startswith("order_accept_"))
async def accept_order(callback: CallbackQuery, db, bot):
    """
    –ü—Ä–æ–¥–∞–≤–µ—Ü –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–∫–∞–∑.
    
    Actions:
    1. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å ‚Üí PREPARING
    2. –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
    3. –û–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü–∞
    """
    order_id = int(callback.data.split("_")[2])
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è!)
    service = UnifiedOrderService(db, bot)
    success = await service.update_order_status(
        order_id,
        "preparing",
        updated_by=callback.from_user.id
    )
    
    if success:
        await callback.answer("‚úÖ –ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!")
        await callback.message.edit_text(
            f"{callback.message.text}\n\n"
            "‚úÖ <b>–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤–∏—Ç—Å—è</b>",
            parse_mode="HTML"
        )
    else:
        await callback.answer("‚ùå –û—à–∏–±–∫–∞", show_alert=True)


@router.callback_query(F.data.startswith("order_reject_"))
async def reject_order(callback: CallbackQuery, db, bot):
    """
    –ü—Ä–æ–¥–∞–≤–µ—Ü –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–∫–∞–∑.
    
    Actions:
    1. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å ‚Üí REJECTED
    2. –í–µ—Ä–Ω—É—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–∞
    3. –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
    4. –í–µ—Ä–Ω—É—Ç—å –¥–µ–Ω—å–≥–∏ (–µ—Å–ª–∏ –æ–ø–ª–∞—á–µ–Ω)
    """
    order_id = int(callback.data.split("_")[2])
    
    service = UnifiedOrderService(db, bot)
    success = await service.update_order_status(
        order_id,
        "rejected",
        updated_by=callback.from_user.id
    )
    
    if success:
        await callback.answer("‚ùå –ó–∞–∫–∞–∑ –æ—Ç–∫–ª–æ–Ω—ë–Ω")
        await callback.message.edit_text(
            f"{callback.message.text}\n\n"
            "‚ùå <b>–°—Ç–∞—Ç—É—Å: –û—Ç–∫–ª–æ–Ω—ë–Ω</b>",
            parse_mode="HTML"
        )
```

---

#### `stats.py` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞

```python
"""–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–æ–≤."""

from aiogram import Router, F
from app.services.stats import StatsService

router = Router()

@router.message(F.text.in_(["üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "üìä Statistika"]))
async def show_stats(message: Message, db):
    """
    –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–∞–≥–∞–∑–∏–Ω–∞.
    
    –í–∫–ª—é—á–∞–µ—Ç:
    - –ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥
    - –í—ã—Ä—É—á–∫–∞
    - –°—Ä–µ–¥–Ω–∏–π —á–µ–∫
    - –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
    - –ì—Ä–∞—Ñ–∏–∫ –∑–∞–∫–∞–∑–æ–≤ –ø–æ —á–∞—Å–∞–º
    """
    user_id = message.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –º–∞–≥–∞–∑–∏–Ω
    stores = db.get_user_accessible_stores(user_id)
    if not stores:
        await message.answer("‚ùå –ú–∞–≥–∞–∑–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return
    
    store_id = stores[0]['store_id']
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    service = StatsService(db)
    stats = service.get_store_stats(store_id, period="week")
    
    text = (
        f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é</b>\n\n"
        f"üì¶ –ó–∞–∫–∞–∑–æ–≤: {stats['orders_count']}\n"
        f"üí∞ –í—ã—Ä—É—á–∫–∞: {stats['revenue']:,.0f} —Å—É–º\n"
        f"üí≥ –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: {stats['avg_order']:,.0f} —Å—É–º\n\n"
        f"üî• <b>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã:</b>\n"
    )
    
    for item in stats['popular_items'][:5]:
        text += f"‚Ä¢ {item['title']} ({item['count']} —à—Ç)\n"
    
    text += f"\n‚è∞ <b>–ü–∏–∫–æ–≤—ã–µ —á–∞—Å—ã:</b> {', '.join(map(str, stats['peak_hours']))}"
    
    await message.answer(text, parse_mode="HTML")
```

---

## üìÇ –ü–ê–ü–ö–ê `database_pg_module/` - –ë–ê–ó–ê –î–ê–ù–ù–´–•

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –í—Å—è —Ä–∞–±–æ—Ç–∞ —Å PostgreSQL. –≠—Ç–æ —Å–∞–º–∞—è –≤–∞–∂–Ω–∞—è –ø–∞–ø–∫–∞ –ø–æ—Å–ª–µ `bot.py`!

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
database_pg_module/
‚îú‚îÄ‚îÄ core.py          # Connection pool, HybridRow
‚îú‚îÄ‚îÄ schema.py        # CREATE TABLE statements
‚îú‚îÄ‚îÄ database.py      # –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å Database (–æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ mixins)
‚îú‚îÄ‚îÄ crypto.py        # Encryption helpers
‚îî‚îÄ‚îÄ mixins/          # SQL –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –ø–æ —Å—É—â–Ω–æ—Å—Ç—è–º
    ‚îú‚îÄ‚îÄ users.py
    ‚îú‚îÄ‚îÄ stores.py
    ‚îú‚îÄ‚îÄ offers.py
    ‚îú‚îÄ‚îÄ bookings.py
    ‚îú‚îÄ‚îÄ orders.py
    ‚îî‚îÄ‚îÄ ... (11 —Ñ–∞–π–ª–æ–≤)
```

### `core.py` (235 —Å—Ç—Ä–æ–∫) - Connection Pool

```python
"""
Core database utilities.

–ì–ª–∞–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
1. ConnectionPool - –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å PostgreSQL
2. HybridRow - —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è –∏ dict –∏ tuple –¥–æ—Å—Ç—É–ø
3. Database configuration
"""

from psycopg_pool import ConnectionPool

# ============================================
# Configuration from environment
# ============================================

DATABASE_URL = os.environ.get("DATABASE_PRIVATE_URL") or os.environ.get("DATABASE_URL")
MIN_CONNECTIONS = int(os.environ.get("DB_MIN_CONN", "5"))  # –ú–∏–Ω–∏–º—É–º
MAX_CONNECTIONS = int(os.environ.get("DB_MAX_CONN", "20"))  # –ú–∞–∫—Å–∏–º—É–º
POOL_WAIT_TIMEOUT = int(os.environ.get("DB_POOL_WAIT_TIMEOUT", "60"))

# ============================================
# HybridRow - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø
# ============================================

class HybridRow:
    """
    –°—Ç—Ä–æ–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è –æ–±–∞ —Å–ø–æ—Å–æ–±–∞ –¥–æ—Å—Ç—É–ø–∞:
    - row[0], row[1] - –∫–∞–∫ tuple
    - row['id'], row['name'] - –∫–∞–∫ dict
    
    –ó–∞—á–µ–º?
    - Backwards compatibility —Å tuple-based –∫–æ–¥–æ–º
    - –£–¥–æ–±—Å—Ç–≤–æ —Ä–∞–±–æ—Ç—ã —Å –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
    """
    
    def __init__(self, cursor, values):
        # –°–æ–∑–¥–∞—ë–º dict –∏–∑ –∏–º—ë–Ω –∫–æ–ª–æ–Ω–æ–∫ –∏ –∑–Ω–∞—á–µ–Ω–∏–π
        self._data = dict(zip(
            [d.name for d in cursor.description],
            values
        ))
        self._values = values
    
    def __getitem__(self, key):
        """–ü–æ–¥–¥–µ—Ä–∂–∫–∞ row[0] –∏ row['name']."""
        if isinstance(key, int):
            return self._values[key]  # row[0]
        return self._data[key]  # row['name']
    
    def get(self, key, default=None):
        """Dict-style get —Å default."""
        return self._data.get(key, default)
    
    def keys(self):
        return self._data.keys()
    
    def values(self):
        return self._data.values()
    
    def items(self):
        return self._data.items()


def hybrid_row_factory(cursor):
    """Row factory –¥–ª—è psycopg."""
    def make_row(values):
        return HybridRow(cursor, values)
    return make_row


# ============================================
# Connection Pool
# ============================================

def create_connection_pool(database_url: str) -> ConnectionPool:
    """
    –°–æ–∑–¥–∞—Ç—å connection pool.
    
    Connection pooling –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è performance!
    –ë–µ–∑ pool'–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (–º–µ–¥–ª–µ–Ω–Ω–æ).
    
    Args:
        database_url: PostgreSQL URL
    
    Returns:
        ConnectionPool (5-20 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π)
    """
    # –§–∏–∫—Å –¥–ª—è Railway URLs
    database_url = fix_railway_database_url(database_url)
    
    pool = ConnectionPool(
        conninfo=database_url,
        min_size=MIN_CONNECTIONS,
        max_size=MAX_CONNECTIONS,
        timeout=POOL_WAIT_TIMEOUT,
        # –í–∞–∂–Ω–æ! –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º row_factory –¥–ª—è –≤—Å–µ—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
        configure=lambda conn: conn.row_factory = hybrid_row_factory
    )
    
    logger.info(
        f"‚úÖ Connection pool created: {MIN_CONNECTIONS}-{MAX_CONNECTIONS} connections"
    )
    
    return pool


def fix_railway_database_url(url: str) -> str:
    """
    –§–∏–∫—Å Railway database URL.
    
    Railway V2 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç .railway.internal –¥–ª—è internal network.
    –≠—Ç–æ –±—ã—Å—Ç—Ä–µ–µ —á–µ–º –ø—É–±–ª–∏—á–Ω—ã–π URL.
    """
    if not url or "railway" not in url:
        return url
    
    # –ó–∞–º–µ–Ω—è–µ–º –ø—É–±–ª–∏—á–Ω—ã–π —Ö–æ—Å—Ç –Ω–∞ internal
    url = url.replace(
        ".proxy.rlwy.net",
        ".railway.internal"
    )
    
    return url
```

**–ü–æ—á–µ–º—É connection pool –≤–∞–∂–µ–Ω:**
- ‚ùå **–ë–µ–∑ pool:** –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å = –Ω–æ–≤–æ–µ TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ + SSL handshake (~50-100ms)
- ‚úÖ **–° pool:** –±–µ—Ä—ë–º –≥–æ—Ç–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–∑ –ø—É–ª–∞ (~1ms)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í 50-100 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ!

---

### `database.py` - –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å

```python
"""Main Database class combining all mixins."""

from database_pg_module.core import create_connection_pool
from database_pg_module.mixins.users import UserMixin
from database_pg_module.mixins.stores import StoreMixin
from database_pg_module.mixins.offers import OfferMixin
from database_pg_module.mixins.bookings import BookingMixin
from database_pg_module.mixins.orders import OrderMixin
# ... –∏ –µ—â—ë 6 mixins

class Database(
    UserMixin,
    StoreMixin,
    OfferMixin,
    BookingMixin,
    OrderMixin,
    RatingMixin,
    FavoriteMixin,
    SearchMixin,
    StatsMixin,
    PaymentMixin,
    NotificationMixin
):
    """
    –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î.
    
    –ù–∞—Å–ª–µ–¥—É–µ—Ç 11 mixins, –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–≤–æ—é —Å—É—â–Ω–æ—Å—Ç—å.
    
    Usage:
        db = Database(database_url)
        user = db.get_user_model(123)
        offers = db.get_hot_offers("–¢–∞—à–∫–µ–Ω—Ç", limit=20)
        booking_id = db.create_booking_atomic(offer_id, user_id, quantity)
    """
    
    def __init__(self, database_url: str):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î.
        
        Args:
            database_url: PostgreSQL connection string
        """
        self.pool = create_connection_pool(database_url)
        logger.info("‚úÖ Database initialized")
    
    def close(self):
        """–ó–∞–∫—Ä—ã—Ç—å connection pool."""
        if self.pool:
            self.pool.close()
            logger.info("Connection pool closed")


# –£–¥–æ–±–Ω–∞—è —Ñ–∞–±—Ä–∏–∫–∞
def create_database(url: str) -> Database:
    """Create and initialize database."""
    return Database(url)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ mixin pattern:**
- **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏** - –∫–∞–∂–¥—ã–π mixin –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–≤–æ—é —Ç–∞–±–ª–∏—Ü—É
- **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å** - `offers.py` —Å–æ–¥–µ—Ä–∂–∏—Ç –¢–û–õ–¨–ö–û –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å offers
- **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å mixins –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π mixin

---

### `mixins/bookings.py` (726 —Å—Ç—Ä–æ–∫) - –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏

```python
"""
Booking operations.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ atomic (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ race conditions
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ (MAX_ACTIVE_BOOKINGS_PER_USER)
"""

class BookingMixin:
    """Mixin –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å bookings."""
    
    def create_booking_atomic(
        self,
        offer_id: int,
        user_id: int,
        quantity: int = 1,
        pickup_time: str | None = None
    ):
        """
        –ê—Ç–æ–º–∞—Ä–Ω–æ —Å–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ.
        
        –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:
        1. FOR UPDATE SKIP LOCKED –Ω–∞ offer (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è)
        2. –ü—Ä–æ–≤–µ—Ä–∫–∞ quantity >= requested
        3. –£–º–µ–Ω—å—à–µ–Ω–∏–µ quantity
        4. –°–æ–∑–¥–∞–Ω–∏–µ booking
        5. COMMIT
        
        Returns:
            (success, booking_id, booking_code, error_reason)
        """
        conn = None
        try:
            conn = self.pool.getconn()
            conn.autocommit = False  # –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            cursor = conn.cursor()
            
            # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–µ–π
            cursor.execute(
                "SELECT COUNT(*) FROM bookings "
                "WHERE user_id = %s AND status IN ('active','pending','confirmed')",
                (user_id,)
            )
            count = cursor.fetchone()[0]
            
            if count >= MAX_ACTIVE_BOOKINGS_PER_USER:
                conn.rollback()
                return (False, None, None, "TOO_MANY_BOOKINGS")
            
            # 2. –ë–ª–æ–∫–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä (SKIP LOCKED = –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è)
            cursor.execute(
                "SELECT offer_id, quantity FROM offers "
                "WHERE offer_id = %s "
                "FOR UPDATE SKIP LOCKED",
                (offer_id,)
            )
            
            offer_row = cursor.fetchone()
            if not offer_row:
                # –¢–æ–≤–∞—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥—Ä—É–≥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
                conn.rollback()
                return (False, None, None, "OFFER_LOCKED")
            
            available_qty = offer_row[1]
            
            # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —Ç–æ–≤–∞—Ä–∞
            if available_qty < quantity:
                conn.rollback()
                return (False, None, None, "INSUFFICIENT_QUANTITY")
            
            # 4. –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            cursor.execute(
                "UPDATE offers SET quantity = quantity - %s "
                "WHERE offer_id = %s",
                (quantity, offer_id)
            )
            
            # 5. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            booking_code = self._generate_booking_code()
            
            # 6. –°–æ–∑–¥–∞—ë–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            cursor.execute(
                "INSERT INTO bookings "
                "(user_id, offer_id, quantity, status, booking_code, pickup_time) "
                "VALUES (%s, %s, %s, 'active', %s, %s) "
                "RETURNING booking_id",
                (user_id, offer_id, quantity, booking_code, pickup_time)
            )
            
            booking_id = cursor.fetchone()[0]
            
            # 7. COMMIT - –≤—Å—ë –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ!
            conn.commit()
            
            logger.info(
                f"‚úÖ Booking created: id={booking_id}, "
                f"user={user_id}, offer={offer_id}, qty={quantity}"
            )
            
            return (True, booking_id, booking_code, None)
            
        except Exception as e:
            if conn:
                conn.rollback()
            logger.error(f"‚ùå Booking failed: {e}")
            return (False, None, None, str(e))
        
        finally:
            if conn:
                self.pool.putconn(conn)
    
    def _generate_booking_code(self) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
        
        –§–æ—Ä–º–∞—Ç: FDL-XXXXXX (6 —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤)
        """
        import random
        import string
        chars = string.ascii_uppercase + string.digits
        code = 'FDL-' + ''.join(random.choices(chars, k=6))
        return code
```

**–ü–æ—á–µ–º—É atomic –≤–∞–∂–Ω–æ:**
- **Race condition:** 2 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—Ä–æ–Ω–∏—Ä—É—é—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–æ–≤–∞—Ä –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **–ë–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:** –æ–±–∞ –ø–æ–ª—É—á–∞—Ç —É—Å–ø–µ—Ö ‚Üí overselling!
- **–° —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π + SKIP LOCKED:** —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä—É–µ—Ç

---

### `mixins/offers.py` - –û–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ç–æ–≤–∞—Ä–∞–º–∏

```python
"""Offer operations."""

class OfferMixin:
    """–†–∞–±–æ—Ç–∞ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏."""
    
    def get_hot_offers(
        self,
        city: str,
        limit: int = 20,
        offset: int = 0
    ) -> list[dict]:
        """
        –ü–æ–ª—É—á–∏—Ç—å "–≥–æ—Ä—è—á–∏–µ" –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
        
        –ö—Ä–∏—Ç–µ—Ä–∏–∏:
        - quantity > 0
        - discount_percent >= 30%
        - –ú–∞–≥–∞–∑–∏–Ω –æ–¥–æ–±—Ä–µ–Ω (approved)
        - –ì–æ—Ä–æ–¥ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
        
        –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:
        - –ü–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É —Å–∫–∏–¥–∫–∏ (–±–æ–ª—å—à–µ = –≤—ã—à–µ)
        - –ü–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –≤—ã—à–µ)
        """
        with self.pool.connection() as conn:
            cursor = conn.cursor()
            cursor.execute("""
                SELECT 
                    o.offer_id,
                    o.store_id,
                    o.title,
                    o.description,
                    o.original_price,
                    o.discount_price,
                    o.quantity,
                    o.photo,
                    o.category,
                    s.name as store_name,
                    s.address as store_address,
                    s.city as store_city,
                    -- –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏
                    CAST(
                        (1 - o.discount_price::float / o.original_price::float) * 100 
                        AS INTEGER
                    ) as discount_percent
                FROM offers o
                JOIN stores s ON o.store_id = s.store_id
                WHERE 
                    o.quantity > 0
                    AND s.status = 'approved'
                    AND s.city = %s
                    AND o.discount_price < o.original_price * 0.7  -- >= 30% —Å–∫–∏–¥–∫–∞
                ORDER BY 
                    discount_percent DESC,
                    o.created_at DESC
                LIMIT %s OFFSET %s
            """, (city, limit, offset))
            
            return cursor.fetchall()
    
    def search_offers(
        self,
        query: str,
        city: str,
        category: str | None = None
    ) -> list[dict]:
        """
        Full-text search –ø–æ —Ç–æ–≤–∞—Ä–∞–º.
        
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç:
        - ILIKE –¥–ª—è case-insensitive –ø–æ–∏—Å–∫–∞
        - –ü–æ–∏—Å–∫ –≤ title –∏ description
        - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≥–æ—Ä–æ–¥—É –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        """
        with self.pool.connection() as conn:
            cursor = conn.cursor()
            
            sql = """
                SELECT o.*, s.name as store_name, s.address as store_address
                FROM offers o
                JOIN stores s ON o.store_id = s.store_id
                WHERE 
                    o.quantity > 0
                    AND s.status = 'approved'
                    AND s.city = %s
                    AND (
                        o.title ILIKE %s 
                        OR o.description ILIKE %s
                    )
            """
            
            params = [city, f"%{query}%", f"%{query}%"]
            
            if category:
                sql += " AND o.category = %s"
                params.append(category)
            
            sql += " ORDER BY o.created_at DESC LIMIT 50"
            
            cursor.execute(sql, params)
            return cursor.fetchall()
```

---

## üìÇ –ü–ê–ü–ö–ê `webapp/` - –í–ï–ë-–ü–†–ò–õ–û–ñ–ï–ù–ò–ï (REACT)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Telegram Mini App - –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–Ω—É—Ç—Ä–∏ Telegram.

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
- React 18 + Vite
- React Router –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
- Axios –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
- Lucide React –¥–ª—è –∏–∫–æ–Ω–æ–∫
- Context API –¥–ª—è state management

### `package.json` - –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```json
{
  "name": "fudly-webapp",
  "version": "1.0.0",
  "scripts": {
    "dev": "vite",              // –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (port 5173)
    "build": "vite build",      // Production build
    "preview": "vite preview",  // Preview production build
    "test": "vitest",           // Unit —Ç–µ—Å—Ç—ã
    "test:e2e": "playwright test" // E2E —Ç–µ—Å—Ç—ã
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^7.9.6",  // –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
    "axios": "^1.6.2",             // HTTP –∫–ª–∏–µ–Ω—Ç
    "lucide-react": "^0.561.0",    // –ò–∫–æ–Ω–∫–∏
    "@sentry/react": "^10.27.0"    // Error tracking
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.2.1",
    "vite": "^5.0.8",
    "vitest": "^4.0.15",           // Unit testing
    "@playwright/test": "^1.52.0"  // E2E testing
  }
}
```

---

### `src/App.jsx` (212 —Å—Ç—Ä–æ–∫) - –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

```jsx
/**
 * –ì–ª–∞–≤–Ω–æ–µ React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
 * 
 * –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
 * - BrowserRouter –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
 * - Context providers (Favorites, Toast, Cart)
 * - Lazy loading —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
 * - Telegram WebApp integration
 */

import { BrowserRouter, Routes, Route } from 'react-router-dom'
import { FavoritesProvider } from './context/FavoritesContext'
import { ToastProvider } from './context/ToastContext'

// Lazy load pages (–∫–æ–¥ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω)
const CartPage = lazy(() => import('./pages/CartPage'))
const ProductDetailPage = lazy(() => import('./pages/ProductDetailPage'))
const OrderTrackingPage = lazy(() => import('./pages/OrderTrackingPage'))

function AppContent() {
  const [user, setUser] = useState(null)
  const [loading, setLoading] = useState(true)
  
  useEffect(() => {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram.WebApp
    tg.ready()
    tg.expand()  // –†–∞—Å–∫—Ä—ã—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const initData = tg.initDataUnsafe
    if (initData.user) {
      setUser(initData.user)
    }
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–µ–º—É –ø–æ–¥ Telegram
    document.documentElement.style.setProperty(
      '--tg-theme-bg-color', 
      tg.themeParams.bg_color || '#ffffff'
    )
    
    setLoading(false)
  }, [])
  
  if (loading) {
    return <LoadingScreen />
  }
  
  return (
    <Routes>
      <Route path="/" element={<HomePage />} />
      <Route path="/cart" element={<CartPage />} />
      <Route path="/product/:id" element={<ProductDetailPage />} />
      <Route path="/orders" element={<OrderTrackingPage />} />
      <Route path="/favorites" element={<FavoritesPage />} />
    </Routes>
  )
}

function App() {
  return (
    <BrowserRouter>
      <ToastProvider>
        <FavoritesProvider>
          <AppContent />
        </FavoritesProvider>
      </ToastProvider>
    </BrowserRouter>
  )
}

export default App
```

---

### `src/api/client.js` - API –∫–ª–∏–µ–Ω—Ç

```javascript
/**
 * Axios client –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤.
 * 
 * Features:
 * - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram
 * - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
 * - Retry logic
 */

import axios from 'axios'

const API_BASE_URL = import.meta.env.VITE_API_URL || 'https://fudly-bot.railway.app/api/v1'

const client = axios.create({
  baseURL: API_BASE_URL,
  timeout: 15000,
  headers: {
    'Content-Type': 'application/json'
  }
})

// Request interceptor: –¥–æ–±–∞–≤–ª—è–µ–º Telegram auth
client.interceptors.request.use((config) => {
  const tg = window.Telegram?.WebApp
  if (tg && tg.initData) {
    // –î–æ–±–∞–≤–ª—è–µ–º header –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    config.headers['X-Telegram-Init-Data'] = tg.initData
  }
  return config
})

// Response interceptor: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
client.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
      window.Telegram?.WebApp?.showAlert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.')
    } else if (error.response?.status >= 500) {
      // –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
      window.Telegram?.WebApp?.showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.')
    }
    return Promise.reject(error)
  }
)

export default client
```

---

### `src/pages/HomePage.jsx` - –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞

```jsx
/**
 * –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ Mini App.
 * 
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
 * - –ì–æ—Ä—è—á–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
 * - –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
 * - –ü–æ–∏—Å–∫
 */

import { useState, useEffect } from 'react'
import api from '../api/client'
import OfferCard from '../components/OfferCard'
import SearchBar from '../components/SearchBar'

function HomePage() {
  const [offers, setOffers] = useState([])
  const [loading, setLoading] = useState(true)
  
  useEffect(() => {
    loadOffers()
  }, [])
  
  async function loadOffers() {
    try {
      const response = await api.get('/offers/hot')
      setOffers(response.data.items)
    } catch (error) {
      console.error('Failed to load offers:', error)
    } finally {
      setLoading(false)
    }
  }
  
  if (loading) {
    return <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  }
  
  return (
    <div className="home-page">
      <SearchBar />
      
      <h2>üî• –ì–æ—Ä—è—á–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h2>
      
      <div className="offers-grid">
        {offers.map(offer => (
          <OfferCard 
            key={offer.id}
            offer={offer}
            onClick={() => navigate(`/product/${offer.id}`)}
          />
        ))}
      </div>
    </div>
  )
}

export default HomePage
```

---

### `src/components/OfferCard.jsx` - –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞

```jsx
/**
 * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞.
 */

import { Heart, ShoppingCart } from 'lucide-react'
import { useFavorites } from '../context/FavoritesContext'

function OfferCard({ offer, onClick }) {
  const { isFavorite, toggleFavorite } = useFavorites()
  const favorite = isFavorite(offer.id)
  
  const discountPercent = Math.round(
    (1 - offer.discount_price / offer.original_price) * 100
  )
  
  return (
    <div className="offer-card" onClick={onClick}>
      {/* –§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ */}
      <div className="offer-image">
        {offer.photo ? (
          <img src={offer.photo} alt={offer.title} />
        ) : (
          <div className="no-image">–ù–µ—Ç —Ñ–æ—Ç–æ</div>
        )}
        
        {/* –ë–µ–π–¥–∂ —Å–∫–∏–¥–∫–∏ */}
        <div className="discount-badge">-{discountPercent}%</div>
        
        {/* –ö–Ω–æ–ø–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ */}
        <button 
          className="favorite-btn"
          onClick={(e) => {
            e.stopPropagation()
            toggleFavorite(offer.id)
          }}
        >
          <Heart fill={favorite ? 'red' : 'none'} />
        </button>
      </div>
      
      {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
      <div className="offer-info">
        <h3>{offer.title}</h3>
        
        <div className="price">
          <span className="current">{offer.discount_price} —Å—É–º</span>
          <span className="original">{offer.original_price} —Å—É–º</span>
        </div>
        
        <div className="store">
          üìç {offer.store_name}
        </div>
        
        {/* –ö–Ω–æ–ø–∫–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É */}
        <button className="add-to-cart">
          <ShoppingCart size={18} />
          –í –∫–æ—Ä–∑–∏–Ω—É
        </button>
      </div>
    </div>
  )
}

export default OfferCard
```

---

### `src/context/CartContext.jsx` - –ö–æ—Ä–∑–∏–Ω–∞ (Context API)

```jsx
/**
 * Context –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω–æ–π.
 * 
 * State —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.
 */

import { createContext, useContext, useState, useEffect } from 'react'

const CartContext = createContext()

export function CartProvider({ children }) {
  const [items, setItems] = useState([])
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –∏–∑ localStorage
  useEffect(() => {
    const saved = localStorage.getItem('fudly_cart')
    if (saved) {
      setItems(JSON.parse(saved))
    }
  }, [])
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
  useEffect(() => {
    localStorage.setItem('fudly_cart', JSON.stringify(items))
  }, [items])
  
  const addItem = (offer, quantity = 1) => {
    setItems(prev => {
      const existing = prev.find(item => item.id === offer.id)
      
      if (existing) {
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        return prev.map(item =>
          item.id === offer.id
            ? { ...item, quantity: item.quantity + quantity }
            : item
        )
      } else {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä
        return [...prev, { ...offer, quantity }]
      }
    })
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º Telegram haptic feedback
    window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('success')
  }
  
  const removeItem = (offerId) => {
    setItems(prev => prev.filter(item => item.id !== offerId))
  }
  
  const updateQuantity = (offerId, quantity) => {
    if (quantity <= 0) {
      removeItem(offerId)
      return
    }
    
    setItems(prev =>
      prev.map(item =>
        item.id === offerId ? { ...item, quantity } : item
      )
    )
  }
  
  const clearCart = () => {
    setItems([])
  }
  
  const total = items.reduce(
    (sum, item) => sum + item.discount_price * item.quantity,
    0
  )
  
  const value = {
    items,
    addItem,
    removeItem,
    updateQuantity,
    clearCart,
    total,
    count: items.length
  }
  
  return (
    <CartContext.Provider value={value}>
      {children}
    </CartContext.Provider>
  )
}

// Hook –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã
export function useCart() {
  const context = useContext(CartContext)
  if (!context) {
    throw new Error('useCart must be used within CartProvider')
  }
  return context
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```jsx
function SomeComponent() {
  const { addItem, items, total } = useCart()
  
  return (
    <button onClick={() => addItem(offer, 1)}>
      –í –∫–æ—Ä–∑–∏–Ω—É ({items.length}) - {total} —Å—É–º
    </button>
  )
}
```

---

## üìÇ –ü–ê–ü–ö–ê `webapp/partner-panel/` - –í–ï–ë-–ü–ê–ù–ï–õ–¨ –ü–†–û–î–ê–í–¶–ê

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Ç–¥–µ–ª—å–Ω–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–æ–º –ø—Ä–æ–¥–∞–≤—Ü–∞–º–∏. –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ Telegram Mini App –∏ standalone webapp.

**URL Production:** 
- Telegram: –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ
- Standalone: https://partner-panel-fudly.vercel.app

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
- **Vanilla JavaScript** (–±–µ–∑ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
- **Modular CSS** - 11 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö CSS —Ñ–∞–π–ª–æ–≤
- **Chart.js** - –≥—Ä–∞—Ñ–∏–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- **Lucide Icons** - –∏–∫–æ–Ω–∫–∏
- **Telegram WebApp API** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Partner Panel

```
partner-panel/
‚îú‚îÄ‚îÄ index.html                  # –ì–ª–∞–≤–Ω—ã–π HTML —Ñ–∞–π–ª (3374 —Å—Ç—Ä–æ–∫–∏!)
‚îú‚îÄ‚îÄ config.js                   # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —Å–±–æ—Ä–∫–µ)
‚îú‚îÄ‚îÄ package.json                # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ vercel.json                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Vercel
‚îú‚îÄ‚îÄ railway.toml                # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Railway (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)
‚îÇ
‚îú‚îÄ‚îÄ js/                         # JavaScript –º–æ–¥—É–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ main.js                 # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ api.js                  # API –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ state.js                # State management
‚îÇ   ‚îú‚îÄ‚îÄ products.js             # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ orders.js               # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ stats.js                # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ settings.js             # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞
‚îÇ   ‚îî‚îÄ‚îÄ utils.js                # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ
‚îî‚îÄ‚îÄ styles/                     # Modular CSS
    ‚îú‚îÄ‚îÄ variables.css           # CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (—Ü–≤–µ—Ç–∞, –æ—Ç—Å—Ç—É–ø—ã)
    ‚îú‚îÄ‚îÄ base.css                # –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏
    ‚îú‚îÄ‚îÄ header.css              # –®–∞–ø–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    ‚îú‚îÄ‚îÄ navigation.css          # –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
    ‚îú‚îÄ‚îÄ buttons.css             # –ö–Ω–æ–ø–∫–∏
    ‚îú‚îÄ‚îÄ products.css            # –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
    ‚îú‚îÄ‚îÄ main.css                # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    ‚îú‚îÄ‚îÄ utilities.css           # Utility –∫–ª–∞—Å—Å—ã
    ‚îú‚îÄ‚îÄ states.css              # –°–æ—Å—Ç–æ—è–Ω–∏—è (loading, error)
    ‚îú‚îÄ‚îÄ design-fixes.css        # –§–∏–∫—Å—ã –¥–∏–∑–∞–π–Ω–∞
    ‚îî‚îÄ‚îÄ product-form-improvements.css  # –£–ª—É—á—à–µ–Ω–∏—è —Ñ–æ—Ä–º
```

---

### `index.html` (3374 —Å—Ç—Ä–æ–∫–∏!) - Single Page Application

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:** –í–°–Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –æ–¥–Ω–æ–º HTML —Ñ–∞–π–ª–µ!

```html
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="api-base" content="https://fudly-bot-production.up.railway.app">
    <title>Fudly Partner v21.1</title>
    
    <!-- Config –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ -->
    <script src="config.js"></script>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Lucide –∏–∫–æ–Ω–∫–∏ -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Modular CSS Architecture -->
    <link rel="stylesheet" href="styles/variables.css?v=21.1">
    <link rel="stylesheet" href="styles/base.css?v=21.1">
    <link rel="stylesheet" href="styles/header.css?v=21.1">
    <!-- ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ 8 CSS —Ñ–∞–π–ª–æ–≤ -->
</head>
<body>
    <!-- ============================================ -->
    <!-- HEADER - –®–∞–ø–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –º–∞–≥–∞–∑–∏–Ω–µ -->
    <!-- ============================================ -->
    <header class="app-header">
        <div class="header-content">
            <div class="store-info">
                <div class="store-avatar">
                    <i data-lucide="store"></i>
                </div>
                <div class="store-details">
                    <h1 id="storeName">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                    <div class="store-status">
                        <div class="status-dot"></div>
                        <span>–û—Ç–∫—Ä—ã—Ç–æ</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="refreshAll()">
                    <i data-lucide="refresh-cw"></i>
                </button>
            </div>
        </div>
    </header>
    
    <!-- ============================================ -->
    <!-- MAIN CONTENT - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <!-- ============================================ -->
    <main class="main-content">
        <div id="app-content">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </main>
    
    <!-- ============================================ -->
    <!-- BOTTOM NAVIGATION - –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <!-- ============================================ -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="showPage('products')">
            <i data-lucide="package"></i>
            <span>–¢–æ–≤–∞—Ä—ã</span>
        </button>
        <button class="nav-item" onclick="showPage('orders')">
            <i data-lucide="shopping-bag"></i>
            <span>–ó–∞–∫–∞–∑—ã</span>
            <span class="badge" id="newOrdersBadge" style="display:none">0</span>
        </button>
        <button class="nav-item" onclick="showPage('stats')">
            <i data-lucide="bar-chart-2"></i>
            <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
        </button>
        <button class="nav-item" onclick="showPage('settings')">
            <i data-lucide="settings"></i>
            <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </button>
    </nav>
    
    <!-- ============================================ -->
    <!-- JAVASCRIPT - –í–°–Ø –ª–æ–≥–∏–∫–∞ –≤–Ω—É—Ç—Ä–∏ HTML -->
    <!-- ============================================ -->
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentStore = null;
        let products = [];
        let orders = [];
        let stats = null;
        
        // API Base URL –∏–∑ config.js –∏–ª–∏ meta tag
        const API_BASE = window.PARTNER_API_BASE || 
                        document.querySelector('meta[name="api-base"]').content;
        
        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Initializing Fudly Partner Panel...');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
            if (window.Telegram?.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                tg.enableClosingConfirmation();
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
                applyTelegramTheme(tg);
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            await loadInitialData();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–æ–≤
            showPage('products');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∫–æ–Ω–∫–∏
            lucide.createIcons();
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            startPeriodicRefresh();
        });
        
        // ============================================
        // API FUNCTIONS
        // ============================================
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE}/api/partner${endpoint}`;
            
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º Telegram initData –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            if (window.Telegram?.WebApp?.initData) {
                headers['X-Telegram-Init-Data'] = window.Telegram.WebApp.initData;
            }
            
            try {
                const response = await fetch(url, {
                    ...options,
                    headers
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Request failed:', error);
                showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
                throw error;
            }
        }
        
        // ============================================
        // PRODUCTS PAGE
        // ============================================
        function renderProductsPage() {
            const content = document.getElementById('app-content');
            
            content.innerHTML = `
                <div class="page-header">
                    <h2>–ú–æ–∏ —Ç–æ–≤–∞—Ä—ã</h2>
                    <button class="btn-primary" onclick="showAddProductModal()">
                        <i data-lucide="plus"></i>
                        –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
                    </button>
                </div>
                
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-lucide="package"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-label">–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</span>
                            <span class="stat-value">${products.length}</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i data-lucide="check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-label">–í –Ω–∞–ª–∏—á–∏–∏</span>
                            <span class="stat-value">
                                ${products.filter(p => p.quantity > 0).length}
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
                <div class="products-list" id="productsList">
                    ${products.length > 0 
                        ? products.map(product => renderProductCard(product)).join('')
                        : '<div class="empty-state">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä!</div>'
                    }
                </div>
            `;
            
            lucide.createIcons();
        }
        
        function renderProductCard(product) {
            const discountPercent = Math.round(
                (1 - product.discount_price / product.original_price) * 100
            );
            
            return `
                <div class="product-card">
                    ${product.photo ? `
                        <img src="${product.photo}" alt="${product.title}" class="product-image">
                    ` : `
                        <div class="product-image-placeholder">
                            <i data-lucide="image"></i>
                        </div>
                    `}
                    
                    <div class="product-info">
                        <h3 class="product-title">${product.title}</h3>
                        <div class="product-price">
                            <span class="current-price">${product.discount_price} —Å—É–º</span>
                            <span class="original-price">${product.original_price} —Å—É–º</span>
                            <span class="discount-badge">-${discountPercent}%</span>
                        </div>
                        <div class="product-meta">
                            <span class="quantity ${product.quantity === 0 ? 'out-of-stock' : ''}">
                                <i data-lucide="package"></i>
                                ${product.quantity} —à—Ç
                            </span>
                            <span class="category">${getCategoryName(product.category)}</span>
                        </div>
                    </div>
                    
                    <div class="product-actions">
                        <button class="btn-icon" onclick="editProduct(${product.id})">
                            <i data-lucide="edit"></i>
                        </button>
                        <button class="btn-icon btn-danger" onclick="deleteProduct(${product.id})">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ============================================
        // ORDERS PAGE
        // ============================================
        function renderOrdersPage() {
            const content = document.getElementById('app-content');
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É
            const grouped = {
                pending: orders.filter(o => o.status === 'pending'),
                preparing: orders.filter(o => o.status === 'preparing'),
                ready: orders.filter(o => o.status === 'ready'),
                completed: orders.filter(o => o.status === 'completed')
            };
            
            content.innerHTML = `
                <div class="page-header">
                    <h2>–ó–∞–∫–∞–∑—ã</h2>
                </div>
                
                <!-- –¢–∞–±—ã —Å—Ç–∞—Ç—É—Å–æ–≤ -->
                <div class="tabs">
                    <button class="tab-btn active" onclick="filterOrders('all')">
                        –í—Å–µ (${orders.length})
                    </button>
                    <button class="tab-btn" onclick="filterOrders('pending')">
                        –ù–æ–≤—ã–µ (${grouped.pending.length})
                    </button>
                    <button class="tab-btn" onclick="filterOrders('preparing')">
                        –í —Ä–∞–±–æ—Ç–µ (${grouped.preparing.length})
                    </button>
                    <button class="tab-btn" onclick="filterOrders('ready')">
                        –ì–æ—Ç–æ–≤—ã (${grouped.ready.length})
                    </button>
                </div>
                
                <!-- –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ -->
                <div class="orders-list" id="ordersList">
                    ${orders.length > 0
                        ? orders.map(order => renderOrderCard(order)).join('')
                        : '<div class="empty-state">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>'
                    }
                </div>
            `;
            
            lucide.createIcons();
        }
        
        function renderOrderCard(order) {
            return `
                <div class="order-card" onclick="viewOrderDetails(${order.id})">
                    <div class="order-header">
                        <div class="order-number">–ó–∞–∫–∞–∑ #${order.id}</div>
                        <div class="order-status status-${order.status}">
                            ${getStatusText(order.status)}
                        </div>
                    </div>
                    
                    <div class="order-info">
                        <div class="order-customer">
                            <i data-lucide="user"></i>
                            ${order.customer_name || '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å'}
                        </div>
                        <div class="order-time">
                            <i data-lucide="clock"></i>
                            ${formatDateTime(order.created_at)}
                        </div>
                    </div>
                    
                    <div class="order-items">
                        ${order.items.map(item => `
                            <div class="order-item">
                                ${item.photo ? `
                                    <img src="${item.photo}" class="order-item-image">
                                ` : ''}
                                <span>${item.title} x${item.quantity}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="order-footer">
                        <div class="order-total">
                            <span>–ò—Ç–æ–≥–æ:</span>
                            <span class="total-amount">${order.total_amount} —Å—É–º</span>
                        </div>
                        <div class="order-type">
                            ${order.order_type === 'pickup' ? 'üèÉ –°–∞–º–æ–≤—ã–≤–æ–∑' : 'üöó –î–æ—Å—Ç–∞–≤–∫–∞'}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ============================================
        // ORDER ACTIONS
        // ============================================
        async function acceptOrder(orderId) {
            try {
                showLoading('–ü—Ä–∏–Ω–∏–º–∞–µ–º –∑–∞–∫–∞–∑...');
                
                await apiRequest(`/orders/${orderId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'preparing' })
                });
                
                showSuccess('–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!');
                await loadOrders();
                closeModal();
            } catch (error) {
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑');
            }
        }
        
        async function markOrderReady(orderId) {
            try {
                await apiRequest(`/orders/${orderId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'ready' })
                });
                
                showSuccess('–ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ!');
                await loadOrders();
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            }
        }
        
        async function completeOrder(orderId) {
            try {
                await apiRequest(`/orders/${orderId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'completed' })
                });
                
                showSuccess('–ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
                await loadOrders();
                closeModal();
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞');
            }
        }
        
        // ============================================
        // STATS PAGE - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        // ============================================
        function renderStatsPage() {
            const content = document.getElementById('app-content');
            
            content.innerHTML = `
                <div class="page-header">
                    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    <select id="statsPeriod" onchange="loadStats(this.value)">
                        <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                        <option value="week" selected>–ù–µ–¥–µ–ª—è</option>
                        <option value="month">–ú–µ—Å—è—Ü</option>
                    </select>
                </div>
                
                <!-- –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-lucide="shopping-bag"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-label">–ó–∞–∫–∞–∑–æ–≤</span>
                            <span class="stat-value">${stats?.orders_count || 0}</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i data-lucide="dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-label">–í—ã—Ä—É—á–∫–∞</span>
                            <span class="stat-value">
                                ${formatMoney(stats?.revenue || 0)}
                            </span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i data-lucide="trending-up"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</span>
                            <span class="stat-value">
                                ${formatMoney(stats?.avg_order || 0)}
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- –ì—Ä–∞—Ñ–∏–∫ –∑–∞–∫–∞–∑–æ–≤ -->
                <div class="chart-container">
                    <h3>–ó–∞–∫–∞–∑—ã –ø–æ –¥–Ω—è–º</h3>
                    <canvas id="ordersChart"></canvas>
                </div>
                
                <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã -->
                <div class="popular-products">
                    <h3>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</h3>
                    <div class="products-list">
                        ${stats?.popular_items?.map(item => `
                            <div class="product-stat">
                                <span class="product-name">${item.title}</span>
                                <span class="product-sales">${item.count} –ø—Ä–æ–¥–∞–∂</span>
                            </div>
                        `).join('') || '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>'}
                    </div>
                </div>
            `;
            
            // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫
            if (stats?.daily_orders) {
                renderOrdersChart(stats.daily_orders);
            }
            
            lucide.createIcons();
        }
        
        function renderOrdersChart(dailyOrders) {
            const ctx = document.getElementById('ordersChart');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyOrders.map(d => d.date),
                    datasets: [{
                        label: '–ó–∞–∫–∞–∑—ã',
                        data: dailyOrders.map(d => d.count),
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showSuccess(message) {
            // Telegram haptic feedback
            window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('success');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast
            showToast(message, 'success');
        }
        
        function showError(message) {
            window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('error');
            showToast(message, 'error');
        }
        
        function formatMoney(amount) {
            return new Intl.NumberFormat('ru-RU').format(amount) + ' —Å—É–º';
        }
        
        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('ru-RU', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:**
- ‚úÖ **Single-file application** - –≤—Å—ë –≤ –æ–¥–Ω–æ–º HTML (–ª–µ–≥–∫–æ –¥–µ–ø–ª–æ–∏—Ç—å)
- ‚úÖ **No build step** - –Ω–µ –Ω—É–∂–µ–Ω webpack/vite
- ‚úÖ **–ú–æ–¥—É–ª—å–Ω—ã–π CSS** - 11 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö CSS —Ñ–∞–π–ª–æ–≤
- ‚úÖ **Vanilla JS** - –±–µ–∑ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤ (–±—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
- ‚úÖ **Telegram integration** - –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram WebApp API

---

### `js/api.js` - API –∫–ª–∏–µ–Ω—Ç

```javascript
/**
 * API client –¥–ª—è Partner Panel.
 * –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ backend –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç –º–æ–¥—É–ª—å.
 */

const API_BASE = window.PARTNER_API_BASE || 'https://fudly-bot-production.up.railway.app';

class PartnerAPI {
    constructor() {
        this.baseURL = `${API_BASE}/api/partner`;
    }
    
    async request(endpoint, options = {}) {
        const url = `${this.baseURL}${endpoint}`;
        
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers
        };
        
        // Telegram authentication
        if (window.Telegram?.WebApp?.initData) {
            headers['X-Telegram-Init-Data'] = window.Telegram.WebApp.initData;
        }
        
        const response = await fetch(url, {
            ...options,
            headers
        });
        
        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }
        
        return await response.json();
    }
    
    // Products API
    async getProducts() {
        return await this.request('/products');
    }
    
    async createProduct(data) {
        return await this.request('/products', {
            method: 'POST',
            body: JSON.stringify(data)
        });
    }
    
    async updateProduct(id, data) {
        return await this.request(`/products/${id}`, {
            method: 'PUT',
            body: JSON.stringify(data)
        });
    }
    
    async deleteProduct(id) {
        return await this.request(`/products/${id}`, {
            method: 'DELETE'
        });
    }
    
    // Orders API
    async getOrders() {
        return await this.request('/orders');
    }
    
    async updateOrderStatus(id, status) {
        return await this.request(`/orders/${id}/status`, {
            method: 'PUT',
            body: JSON.stringify({ status })
        });
    }
    
    // Stats API
    async getStats(period = 'week') {
        return await this.request(`/stats?period=${period}`);
    }
}

const api = new PartnerAPI();
```

---

### `styles/variables.css` - Design System

```css
/**
 * Design System Variables
 * –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞–º–∏, –æ—Ç—Å—Ç—É–ø–∞–º–∏, —à—Ä–∏—Ñ—Ç–∞–º–∏
 */

:root {
    /* Colors */
    --primary: #4CAF50;
    --primary-hover: #45a049;
    --danger: #F44336;
    --warning: #FF9800;
    --info: #2196F3;
    --success: #4CAF50;
    
    --bg-primary: #FFFFFF;
    --bg-secondary: #F5F7FA;
    --bg-tertiary: #E8EBF0;
    
    --text-primary: #111312;
    --text-secondary: #6B7280;
    --text-tertiary: #9CA3AF;
    
    --border-color: #E5E7EB;
    --border-radius: 12px;
    --border-radius-lg: 16px;
    
    /* Spacing */
    --spacing-xs: 4px;
    --spacing-sm: 8px;
    --spacing-md: 16px;
    --spacing-lg: 24px;
    --spacing-xl: 32px;
    
    /* Typography */
    --font-family: 'Onest', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-size-xs: 12px;
    --font-size-sm: 14px;
    --font-size-base: 16px;
    --font-size-lg: 18px;
    --font-size-xl: 24px;
    
    /* Shadows */
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
    --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
    
    /* Transitions */
    --transition: all 0.2s ease;
}
```

---

### Deployment –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**`vercel.json` - Vercel deployment**

```json
{
  "buildCommand": "bash build.sh",
  "outputDirectory": ".",
  "cleanUrls": true,
  "trailingSlash": false,
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "X-XSS-Protection",
          "value": "1; mode=block"
        }
      ]
    }
  ]
}
```

**`build.sh` - Build script**

```bash
#!/bin/bash
# Partner Panel build script

echo "Building partner panel..."

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º config.js —Å API base
echo "window.PARTNER_API_BASE='${PARTNER_API_BASE:-https://fudly-bot-production.up.railway.app}';" > config.js

# –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –≤ index.html –¥–ª—è cache busting
VERSION=$(date +%s)
sed -i "s/?v=[0-9]*/?v=$VERSION/g" index.html

echo "‚úÖ Build complete! Version: $VERSION"
```

---

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Partner Panel

**1. Single Page Application –±–µ–∑ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤**
- –í—Å—è –ª–æ–≥–∏–∫–∞ –≤ –æ–¥–Ω–æ–º HTML —Ñ–∞–π–ª–µ
- –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (~100-200ms)
- –ù–µ –Ω—É–∂–µ–Ω build process

**2. Modular CSS Architecture**
- 11 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö CSS —Ñ–∞–π–ª–æ–≤
- –õ–µ–≥–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ —Ä–∞—Å—à–∏—Ä—è—Ç—å
- Cache busting —á–µ—Ä–µ–∑ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

**3. Real-time updates**
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫)
- WebSocket support (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
- Push notifications —á–µ—Ä–µ–∑ Telegram

**4. Responsive Design**
- –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤—ë—Ä—Å—Ç–∫–∞ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –∏ –ø–ª–∞–Ω—à–µ—Ç–æ–≤
- Touch-friendly –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Telegram —Ç–µ–º–∏–∑–∞—Ü–∏–∏

**5. Performance Optimizations**
- Lazy loading –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- CSS –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- API response caching
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ dependencies

---

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Partner Panel

**User Flow:**

```
1. –ü—Ä–æ–¥–∞–≤–µ—Ü –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±–æ—Ç–∞ ‚Üí "üè™ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
2. Telegram –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç WebApp ‚Üí index.html –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
3. JavaScript –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:
   - Telegram.WebApp.ready()
   - –ó–∞–≥—Ä—É–∑–∫–∞ initData –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
   - API –∑–∞–ø—Ä–æ—Å –∫ /api/partner/products
4. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–æ–≤
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
6. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ API
7. Backend –æ–±–Ω–æ–≤–ª—è–µ—Ç –ë–î
8. –ü–æ–∫—É–ø–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–æ—Ç–µ
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–∞–∫–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:**
- ‚úÖ –ù–µ –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- ‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- ‚úÖ –í—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram (haptic feedback, theme colors)

---

## üìÇ –ü–ê–ü–ö–ê `tests/` - –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Unit, integration –∏ E2E —Ç–µ—Å—Ç—ã –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞.

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** 30+ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤, –ø–æ–∫—Ä—ã—Ç–∏–µ ~25-30%

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
- `pytest` - —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `pytest-asyncio` - –¥–ª—è async —Ç–µ—Å—Ç–æ–≤
- `pytest-cov` - coverage reporting

### –¢–∏–ø—ã —Ç–µ—Å—Ç–æ–≤

#### Unit —Ç–µ—Å—Ç—ã - –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**`test_database.py` (213 —Å—Ç—Ä–æ–∫) - –¢–µ—Å—Ç—ã –ë–î**

```python
"""Unit —Ç–µ—Å—Ç—ã –¥–ª—è database –º–æ–¥—É–ª–µ–π."""

import pytest
from database import Database

class TestDatabaseSQLite:
    """–¢–µ—Å—Ç—ã –¥–ª—è SQLite –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏."""
    
    @pytest.fixture
    def db(self):
        """–°–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é –ë–î –¥–ª—è —Ç–µ—Å—Ç–∞."""
        import tempfile
        fd, path = tempfile.mkstemp(suffix=".db")
        os.close(fd)
        
        db_instance = Database(path)
        yield db_instance
        
        # Cleanup
        os.remove(path)
    
    def test_get_user_returns_dict(self, db):
        """–¢–µ—Å—Ç —á—Ç–æ get_user –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç dict."""
        user_id = 123456789
        db.add_user(user_id, "testuser")
        
        user = db.get_user(user_id)
        
        # Assertions
        assert isinstance(user, dict)
        assert user.get("user_id") == user_id
        assert "role" in user
        assert "city" in user
    
    def test_get_user_nonexistent(self, db):
        """–¢–µ—Å—Ç —á—Ç–æ get_user –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ."""
        user = db.get_user(999999999)
        assert user is None
    
    def test_create_booking_atomic(self, db):
        """–¢–µ—Å—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è."""
        # Setup
        user_id = 111
        db.add_user(user_id, "test")
        
        store_id = db.add_store(user_id, "Test Store", "–¢–∞—à–∫–µ–Ω—Ç", "Addr", "")
        offer_id = db.add_offer(store_id, "Test Offer", "", 10000, 7000, 5)
        
        # Act: —Å–æ–∑–¥–∞—ë–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        ok, booking_id, code, error = db.create_booking_atomic(
            offer_id, user_id, quantity=2
        )
        
        # Assert
        assert ok is True
        assert booking_id is not None
        assert code is not None
        assert error is None
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ quantity —É–º–µ–Ω—å—à–∏–ª–æ—Å—å
        offer = db.get_offer(offer_id)
        assert offer['quantity'] == 3  # –ë—ã–ª–æ 5, –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª–∏ 2
```

**–ó–∞–ø—É—Å–∫:**
```bash
pytest tests/test_database.py -v
```

---

**`test_services.py` - –¢–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤**

```python
"""–¢–µ—Å—Ç—ã –¥–ª—è business logic —Å–µ—Ä–≤–∏—Å–æ–≤."""

from app.services.offer_service import OfferService

def test_offer_service_list_hot_offers():
    """–¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –≥–æ—Ä—è—á–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π."""
    # Mock database
    class MockDB:
        def get_hot_offers(self, city, limit, offset):
            return [
                {
                    "id": 1,
                    "title": "Test Offer",
                    "original_price": 10000,
                    "discount_price": 7000,
                    "store_name": "Test Store"
                }
            ]
    
    db = MockDB()
    service = OfferService(db)
    
    # Act
    result = service.list_hot_offers("–¢–∞—à–∫–µ–Ω—Ç", limit=10)
    
    # Assert
    assert len(result.items) == 1
    assert result.items[0].title == "Test Offer"
    assert result.items[0].discount_percent == 30
```

---

#### Integration —Ç–µ—Å—Ç—ã - –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

**`test_integration.py` - Integration tests**

```python
"""–¢–µ—Å—Ç—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏."""

import pytest
from app.core.bootstrap import build_application

@pytest.mark.asyncio
async def test_create_order_flow():
    """
    –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ flow —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞:
    1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É
    2. –°–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑
    3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ—Å—Ç–∞—Ç–∫–∏ —É–º–µ–Ω—å—à–∏–ª–∏—Å—å
    4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–∑–¥–∞–ª–∏—Å—å –∑–∞–ø–∏—Å–∏
    """
    # Setup
    bot, dp, db, cache = build_application(test_settings)
    
    # –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    user_id = 12345
    store_id = db.create_store(...)
    offer_id = db.add_offer(store_id, ..., quantity=10)
    
    # Act: —Å–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑
    from app.services.unified_order_service import UnifiedOrderService
    service = UnifiedOrderService(db, bot)
    
    result = await service.create_order(
        user_id=user_id,
        offers=[{"offer_id": offer_id, "quantity": 2}],
        order_type="pickup"
    )
    
    # Assert
    assert result.success is True
    assert result.order_id is not None
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏
    offer = db.get_offer(offer_id)
    assert offer['quantity'] == 8  # –ë—ã–ª–æ 10, –∑–∞–∫–∞–∑–∞–ª–∏ 2
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ order_items
    items = db.get_order_items(result.order_id)
    assert len(items) == 1
    assert items[0]['quantity'] == 2
```

---

#### E2E —Ç–µ—Å—Ç—ã - End-to-End user flows

**`test_e2e_booking_flow.py` - E2E booking**

```python
"""
E2E —Ç–µ—Å—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞.
"""

import pytest
from aiogram.types import Message, User
from unittest.mock import AsyncMock, MagicMock

@pytest.mark.asyncio
async def test_full_booking_flow():
    """
    –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ flow –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:
    1. /start
    2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    3. –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
    4. –í—ã–±–æ—Ä —Ç–æ–≤–∞—Ä–∞
    5. –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    6. –ü–æ–ª—É—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    """
    # Setup
    bot = AsyncMock()
    db = create_test_db()
    
    # Mock message
    message = MagicMock(spec=Message)
    message.from_user = User(id=123, first_name="Test", is_bot=False)
    
    # Step 1: /start
    from handlers.common.start import cmd_start
    await cmd_start(message, db=db, user=None)
    
    # Verify: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    assert bot.send_message.called
    
    # Step 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    # ... –∏–º–∏—Ç–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π
    
    # Step 3: –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤
    from handlers.customer.offers.hot_offers import show_hot_offers
    await show_hot_offers(message, db=db, user=test_user, cache=None)
    
    # Step 4: –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    # ... –∏–º–∏—Ç–∏—Ä—É–µ–º callback —Å offer_id
    
    # Verify: –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ
    bookings = db.get_user_bookings(123)
    assert len(bookings) == 1
```

---

#### Security —Ç–µ—Å—Ç—ã

**`test_security.py` - Security tests**

```python
"""–¢–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."""

from app.core.security import InputValidator, RateLimiter

def test_input_validator_sanitize_xss():
    """–¢–µ—Å—Ç –∑–∞—â–∏—Ç—ã –æ—Ç XSS."""
    validator = InputValidator()
    
    malicious = '<script>alert("XSS")</script>'
    sanitized = validator.sanitize_text(malicious)
    
    # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ
    assert '<script>' not in sanitized
    assert '&lt;script&gt;' in sanitized


def test_rate_limiter():
    """–¢–µ—Å—Ç rate limiting."""
    limiter = RateLimiter(max_requests=3, window=60)
    user_id = 12345
    
    # –ü–µ—Ä–≤—ã–µ 3 –∑–∞–ø—Ä–æ—Å–∞ OK
    assert limiter.check_rate_limit(user_id) is True
    assert limiter.check_rate_limit(user_id) is True
    assert limiter.check_rate_limit(user_id) is True
    
    # 4-–π –∑–∞–ø—Ä–æ—Å –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
    assert limiter.check_rate_limit(user_id) is False


def test_phone_validation():
    """–¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞."""
    validator = InputValidator()
    
    assert validator.validate_phone("+998901234567") is True
    assert validator.validate_phone("998901234567") is True
    assert validator.validate_phone("invalid") is False
    assert validator.validate_phone("123") is False
```

---

#### Performance —Ç–µ—Å—Ç—ã

**`test_booking_race_condition.py` - Race condition tests**

```python
"""
–¢–µ—Å—Ç race conditions –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö.
"""

import asyncio
import pytest

@pytest.mark.asyncio
async def test_concurrent_bookings_no_overselling():
    """
    –¢–µ—Å—Ç —á—Ç–æ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö
    –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ç–æ–≤–∞—Ä–∞ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç overselling.
    """
    db = create_test_db()
    
    # –°–æ–∑–¥–∞—ë–º —Ç–æ–≤–∞—Ä —Å quantity=1
    offer_id = db.add_offer(..., quantity=1)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º 10 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
    async def try_book(user_id):
        ok, booking_id, code, error = db.create_booking_atomic(
            offer_id, user_id, quantity=1
        )
        return ok
    
    results = await asyncio.gather(*[
        try_book(user_id=i) for i in range(10)
    ])
    
    # Assert: —Ç–æ–ª—å–∫–æ –û–î–ò–ù —É—Å–ø–µ—à–Ω—ã–π!
    successful = sum(results)
    assert successful == 1
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º quantity
    offer = db.get_offer(offer_id)
    assert offer['quantity'] == 0  # –í—Å—ë –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ
```

---

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã
pytest

# –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º
pytest --cov=app --cov=handlers --cov-report=html

# –¢–æ–ª—å–∫–æ unit —Ç–µ—Å—Ç—ã
pytest tests/test_*.py -k "not e2e"

# –¢–æ–ª—å–∫–æ E2E —Ç–µ—Å—Ç—ã
pytest tests/test_e2e_*.py

# Verbose —Ä–µ–∂–∏–º
pytest -v

# –° –ª–æ–≥–∞–º–∏
pytest -s
```

---

## üìÇ –ü–ê–ü–ö–ê `migrations/` - –ú–ò–ì–†–ê–¶–ò–ò –ë–î

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** SQL —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ö–∞–∂–¥–∞—è –º–∏–≥—Ä–∞—Ü–∏—è - –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª. –ù—É–º–µ—Ä–∞—Ü–∏—è: v22, v23, v24, ...

### –ü—Ä–∏–º–µ—Ä—ã –º–∏–≥—Ä–∞—Ü–∏–π

#### `v25_add_message_tracking.sql` - Tracking message IDs

```sql
-- ============================================
-- Migration v25: Add message tracking fields
-- ============================================
-- Date: 2025-12-21
-- Purpose: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è message_id —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
--          –ü–æ–∑–≤–æ–ª—è–µ—Ç –†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤—ã—Ö
--          –£–º–µ–Ω—å—à–∞–µ—Ç —Å–ø–∞–º, —É–ª—É—á—à–∞–µ—Ç UX
-- ============================================

-- –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –≤ orders
ALTER TABLE orders ADD COLUMN IF NOT EXISTS customer_message_id BIGINT;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS seller_message_id BIGINT;

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX IF NOT EXISTS idx_orders_customer_msg 
ON orders(customer_message_id) 
WHERE customer_message_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_orders_seller_msg 
ON orders(seller_message_id) 
WHERE seller_message_id IS NOT NULL;

-- Verification query:
-- SELECT 
--   COUNT(*) as total_orders,
--   COUNT(customer_message_id) as with_customer_msg,
--   COUNT(seller_message_id) as with_seller_msg
-- FROM orders;
```

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:**
- –†–∞–Ω—å—à–µ: –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ ‚Üí –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Å–ø–∞–º!)
- –¢–µ–ø–µ—Ä—å: —Å–æ—Ö—Ä–∞–Ω—è–µ–º message_id ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –û–î–ù–û –æ–±–Ω–æ–≤–ª—è—é—â–µ–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ 5 —Ä–∞–∑–Ω—ã—Ö

---

#### `v24_migrate_bookings.sql` - Unified orders

```sql
-- ============================================
-- Migration v24: Migrate bookings to unified orders
-- ============================================
-- Date: 2025-12-18
-- Purpose: –û–±—ä–µ–¥–∏–Ω–∏—Ç—å bookings –∏ orders –≤ –µ–¥–∏–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
--          –£–ø—Ä–æ—â–∞–µ—Ç –ª–æ–≥–∏–∫—É, —É–±–∏—Ä–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
-- ============================================

-- 1. –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –≤ orders –¥–ª—è pickup
ALTER TABLE orders ADD COLUMN IF NOT EXISTS pickup_time VARCHAR(20);
ALTER TABLE orders ADD COLUMN IF NOT EXISTS booking_code VARCHAR(20);

-- 2. –ú–∏–≥—Ä–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ bookings –≤ orders
INSERT INTO orders (
    user_id, 
    store_id, 
    total_amount, 
    status, 
    order_type,
    pickup_time,
    booking_code,
    created_at
)
SELECT 
    b.user_id,
    o.store_id,
    o.discount_price * b.quantity as total_amount,
    CASE 
        WHEN b.status = 'active' THEN 'pending'
        WHEN b.status = 'confirmed' THEN 'preparing'
        WHEN b.status = 'completed' THEN 'completed'
        WHEN b.status = 'cancelled' THEN 'cancelled'
        ELSE 'pending'
    END as status,
    'pickup' as order_type,
    b.pickup_time,
    b.booking_code,
    b.created_at
FROM bookings b
JOIN offers o ON b.offer_id = o.offer_id
WHERE b.status NOT IN ('expired');

-- 3. –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ bookings
CREATE TABLE IF NOT EXISTS bookings_archive AS 
SELECT * FROM bookings;

-- 4. –û—á–∏—â–∞–µ–º bookings (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
-- TRUNCATE TABLE bookings;
```

---

#### `v23_add_performance_indexes.sql` - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

```sql
-- ============================================
-- Migration v23: Add performance indexes
-- ============================================
-- Purpose: –£—Å–∫–æ—Ä–∏—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
-- ============================================

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è get_hot_offers (—Å–∞–º—ã–π —á–∞—Å—Ç—ã–π –∑–∞–ø—Ä–æ—Å)
CREATE INDEX IF NOT EXISTS idx_offers_city_quantity 
ON offers(store_id, quantity) 
WHERE quantity > 0;

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è JOIN —Å stores
CREATE INDEX IF NOT EXISTS idx_stores_city_status 
ON stores(city, status) 
WHERE status = 'approved';

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CREATE INDEX IF NOT EXISTS idx_orders_user_status 
ON orders(user_id, status, created_at DESC);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX IF NOT EXISTS idx_offers_title_gin 
ON offers USING gin(to_tsvector('russian', title));

-- Verify performance:
-- EXPLAIN ANALYZE 
-- SELECT * FROM offers o 
-- JOIN stores s ON o.store_id = s.store_id 
-- WHERE s.city = '–¢–∞—à–∫–µ–Ω—Ç' AND o.quantity > 0;
```

**Impact:**
- –î–æ: `get_hot_offers` –≤—ã–ø–æ–ª–Ω—è–ª—Å—è 150-200ms
- –ü–æ—Å–ª–µ: 10-15ms
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í 15 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ!

---

### –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
# –ß–µ—Ä–µ–∑ psql
psql $DATABASE_URL -f migrations/v25_add_message_tracking.sql

# –ß–µ—Ä–µ–∑ Python —Å–∫—Ä–∏–ø—Ç
python apply_v25_migration.py

# –ß–µ—Ä–µ–∑ Railway CLI
railway run psql < migrations/v25_add_message_tracking.sql
```

---

## üìÇ –ü–ê–ü–ö–ê `tasks/` - BACKGROUND WORKERS

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏.

### `booking_expiry_worker.py` (284 —Å—Ç—Ä–æ–∫–∏) - –ò—Å—Ç–µ—á–µ–Ω–∏–µ –±—Ä–æ–Ω–µ–π

```python
"""
Background worker –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.

–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
1. –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ë–î
2. –ù–∞—Ö–æ–¥–∏—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å expiry_time –≤ –ø—Ä–æ—à–ª–æ–º
3. –ó–∞ 1 —á–∞—Å –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç reminder
4. –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è - –æ—Ç–º–µ–Ω—è–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç quantity
"""

import asyncio
import logging
from aiogram import Bot

logger = logging.getLogger(__name__)

async def start_booking_expiry_worker(db, bot: Bot):
    """
    –ó–∞–ø—É—Å—Ç–∏—Ç—å worker (–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª).
    
    Args:
        db: Database instance
        bot: aiogram Bot –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    """
    check_interval = 30  # –ú–∏–Ω—É—Ç –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
    
    logger.info(f"üöÄ Booking expiry worker started (interval: {check_interval}m)")
    
    while True:
        try:
            # ============================================
            # 1. Reminders (–∑–∞ 1 —á–∞—Å –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è)
            # ============================================
            
            with db.get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT booking_id, user_id, booking_code
                    FROM bookings
                    WHERE reminder_sent = 0
                      AND expiry_time IS NOT NULL
                      AND status = 'pending'
                      AND expiry_time > NOW()
                      AND expiry_time <= NOW() + INTERVAL '1 hour'
                """)
                
                reminders = cursor.fetchall()
                
                for row in reminders:
                    booking_id = row['booking_id']
                    user_id = row['user_id']
                    booking_code = row['booking_code']
                    
                    try:
                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                        await bot.send_message(
                            user_id,
                            f"‚è∞ <b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!</b>\n\n"
                            f"–ë—Ä–æ–Ω—å {booking_code} –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 1 —á–∞—Å.\n"
                            f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑ –≤–æ–≤—Ä–µ–º—è!",
                            parse_mode="HTML"
                        )
                        
                        # –û—Ç–º–µ—á–∞–µ–º —á—Ç–æ reminder –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
                        db.mark_reminder_sent(booking_id)
                        
                        logger.info(f"‚úÖ Reminder sent for booking {booking_id}")
                    
                    except Exception as e:
                        logger.error(f"Failed to send reminder: {e}")
            
            # ============================================
            # 2. Expiry (–∏—Å—Ç—ë–∫—à–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
            # ============================================
            
            with db.get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT booking_id, user_id, offer_id, quantity, booking_code
                    FROM bookings
                    WHERE status = 'pending'
                      AND expiry_time IS NOT NULL
                      AND expiry_time <= NOW()
                """)
                
                expired = cursor.fetchall()
                
                for row in expired:
                    booking_id = row['booking_id']
                    user_id = row['user_id']
                    offer_id = row['offer_id']
                    quantity = row['quantity']
                    booking_code = row['booking_code']
                    
                    try:
                        # –û—Ç–º–µ–Ω—è–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                        db.cancel_booking(booking_id)
                        
                        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º quantity –≤ offer
                        db.update_offer_quantity(offer_id, quantity)
                        
                        # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        await bot.send_message(
                            user_id,
                            f"‚ùå <b>–ë—Ä–æ–Ω—å –∏—Å—Ç–µ–∫–ª–∞</b>\n\n"
                            f"–ë—Ä–æ–Ω—å {booking_code} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞.\n"
                            f"–¢–æ–≤–∞—Ä –≤–µ—Ä–Ω—É–ª—Å—è –≤ –ø—Ä–æ–¥–∞–∂—É.",
                            parse_mode="HTML"
                        )
                        
                        logger.info(
                            f"‚úÖ Expired booking {booking_id}: "
                            f"cancelled, {quantity} returned to offer {offer_id}"
                        )
                    
                    except Exception as e:
                        logger.error(f"Failed to expire booking: {e}")
            
            # ============================================
            # 3. Sleep –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
            # ============================================
            
            await asyncio.sleep(check_interval * 60)
        
        except Exception as e:
            logger.error(f"Booking expiry worker error: {e}")
            await asyncio.sleep(300)  # 5 –º–∏–Ω—É—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
```

**–ó–∞–ø—É—Å–∫:** Worker –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ `bot.py` –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º asyncio task:

```python
# bot.py
from tasks.booking_expiry_worker import start_booking_expiry_worker

# –ó–∞–ø—É—Å–∫–∞–µ–º worker –≤ —Ñ–æ–Ω–µ
asyncio.create_task(start_booking_expiry_worker(db, bot))

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
await dp.start_polling(bot)
```

---

### `rating_reminder_worker.py` - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ–± –æ—Ç–∑—ã–≤–∞—Ö

```python
"""
Worker –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤.

–õ–æ–≥–∏–∫–∞:
- –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç rating
"""

async def start_rating_reminder_worker(db, bot):
    """–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–∫–∞–∑—ã –±–µ–∑ –æ—Ç–∑—ã–≤–æ–≤."""
    
    while True:
        try:
            # –ù–∞—Ö–æ–¥–∏–º –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã –±–µ–∑ —Ä–µ–π—Ç–∏–Ω–≥–∞ (24+ —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥)
            orders = db.execute("""
                SELECT order_id, user_id
                FROM orders
                WHERE status = 'completed'
                  AND rating_id IS NULL
                  AND completed_at <= NOW() - INTERVAL '24 hours'
                  AND reminded_about_rating = 0
            """)
            
            for order in orders:
                try:
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                    await bot.send_message(
                        order['user_id'],
                        f"‚≠ê –û—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–∑—ã–≤ –æ –∑–∞–∫–∞–∑–µ #{order['order_id']}!\n"
                        "–í–∞—à–µ –º–Ω–µ–Ω–∏–µ –≤–∞–∂–Ω–æ –¥–ª—è –Ω–∞—Å.",
                        reply_markup=rating_keyboard(order['order_id'])
                    )
                    
                    # –û—Ç–º–µ—á–∞–µ–º —á—Ç–æ –Ω–∞–ø–æ–º–Ω–∏–ª–∏
                    db.mark_rating_reminded(order['order_id'])
                
                except Exception as e:
                    logger.error(f"Failed to send rating reminder: {e}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑ –≤ –¥–µ–Ω—å
            await asyncio.sleep(86400)
        
        except Exception as e:
            logger.error(f"Rating reminder worker error: {e}")
            await asyncio.sleep(3600)
```

---

## üìÇ –ü–ê–ü–ö–ê `scripts/` - –£–¢–ò–õ–ò–¢–´

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è.

### –ü—Ä–∏–º–µ—Ä—ã —Å–∫—Ä–∏–ø—Ç–æ–≤

#### `check_db_structure.py` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ö–µ–º—ã –ë–î

```bash
python scripts/check_db_structure.py

# Output:
# ‚úÖ Tables: 12
# ‚úÖ Indexes: 45
# ‚úÖ Foreign keys: OK
# ‚ö†Ô∏è Missing index on orders(user_id)
```

#### `smoke_test_pickup.py` - Smoke test

```bash
python scripts/smoke_test_pickup.py

# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
# - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
# - –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
# - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
# - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```

#### `migrate.py` - –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π

```python
"""–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π."""

import os
import psycopg

DATABASE_URL = os.environ["DATABASE_URL"]

def run_migration(filename: str):
    """–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é."""
    with open(f"migrations/{filename}") as f:
        sql = f.read()
    
    with psycopg.connect(DATABASE_URL) as conn:
        conn.execute(sql)
    
    print(f"‚úÖ Applied: {filename}")

if __name__ == "__main__":
    run_migration("v25_add_message_tracking.sql")
```

---

## üéØ –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢ –ü–†–û–ï–ö–¢

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (High-Level)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ                                 ‚îÇ
             ‚ñº                                 ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  Telegram Bot  ‚îÇ                ‚îÇ   Mini App       ‚îÇ
    ‚îÇ    (aiogram)   ‚îÇ                ‚îÇ   (React+Vite)   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ                                 ‚îÇ
             ‚îÇ                                 ‚îÇ
             ‚ñº                                 ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ              BACKEND (bot.py)                       ‚îÇ
    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
    ‚îÇ  ‚îÇ   Handlers   ‚îÇ‚Üí ‚îÇ   Services   ‚îÇ‚Üí ‚îÇ   Repos  ‚îÇ ‚îÇ
    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ   PostgreSQL (Railway) ‚îÇ
                 ‚îÇ   + Redis (Cache)      ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### User Flow Examples

#### 1Ô∏è‚É£ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –∑–∞–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–≤–∞—Ä (Pickup)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: /start
   ‚îú‚îÄ‚Üí Handler: handlers/common/start.py
   ‚îú‚îÄ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞: –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω?
   ‚îî‚îÄ‚Üí –ï—Å–ª–∏ –¥–∞: –ø–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "üî• –ì–æ—Ä—è—á–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è"
   ‚îú‚îÄ‚Üí Handler: handlers/customer/offers/hot_offers.py
   ‚îú‚îÄ‚Üí Service: app/services/offer_service.py
   ‚îú‚îÄ‚Üí Cache: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞ (5 –º–∏–Ω—É—Ç)
   ‚îú‚îÄ‚Üí DB: database_pg_module/mixins/offers.py ‚Üí get_hot_offers()
   ‚îî‚îÄ‚Üí Response: —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ñ–æ—Ç–æ –∏ —Ü–µ–Ω–∞–º–∏

3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –Ω–∞–∂–∏–º–∞–µ—Ç –Ω–∞ —Ç–æ–≤–∞—Ä
   ‚îú‚îÄ‚Üí Handler: offer_detail_callback
   ‚îú‚îÄ‚Üí Service: offer_service.get_offer_details()
   ‚îî‚îÄ‚Üí Response: –ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è + –∫–Ω–æ–ø–∫–∞ "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å"

4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "üõí –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å"
   ‚îú‚îÄ‚Üí Handler: handlers/bookings/create.py
   ‚îú‚îÄ‚Üí FSM: –Ω–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –≤—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è)
   ‚îî‚îÄ‚Üí State: CreateBooking.quantity

5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: —É–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ "2"
   ‚îú‚îÄ‚Üí Handler: process_quantity
   ‚îú‚îÄ‚Üí FSM: —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
   ‚îî‚îÄ‚Üí State: CreateBooking.pickup_time

6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: —É–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Ä–µ–º—è "18:00"
   ‚îú‚îÄ‚Üí Handler: process_pickup_time
   ‚îú‚îÄ‚Üí Service: UnifiedOrderService.create_order()
   ‚îú‚îÄ‚Üí DB Transaction:
   ‚îÇ   ‚îú‚îÄ INSERT INTO orders
   ‚îÇ   ‚îú‚îÄ INSERT INTO order_items
   ‚îÇ   ‚îî‚îÄ UPDATE offers SET quantity = quantity - 2
   ‚îú‚îÄ‚Üí Notifications:
   ‚îÇ   ‚îú‚îÄ –ü–æ–∫—É–ø–∞—Ç–µ–ª—é: "‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω!"
   ‚îÇ   ‚îî‚îÄ –ü—Ä–æ–¥–∞–≤—Ü—É: "üÜï –ù–æ–≤—ã–π –∑–∞–∫–∞–∑!"
   ‚îî‚îÄ‚Üí Response: –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞, QR –∫–æ–¥

7. –ü—Ä–æ–¥–∞–≤–µ—Ü: "‚úÖ –ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑"
   ‚îú‚îÄ‚Üí Handler: handlers/seller/order_management.py
   ‚îú‚îÄ‚Üí Service: UnifiedOrderService.update_order_status()
   ‚îú‚îÄ‚Üí DB: UPDATE orders SET status = 'preparing'
   ‚îî‚îÄ‚Üí Notification –ø–æ–∫—É–ø–∞—Ç–µ–ª—é: "üë®‚Äçüç≥ –í–∞—à –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤–∏—Ç—Å—è!"

8. –ü—Ä–æ–¥–∞–≤–µ—Ü: "‚úÖ –ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ"
   ‚îú‚îÄ‚Üí Status: ready ‚Üí completed
   ‚îî‚îÄ‚Üí Notification: "‚úÖ –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤! –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞–±—Ä–∞—Ç—å"

9. –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –ø—Ä–∏—Ö–æ–¥–∏—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç QR –∫–æ–¥
   ‚îî‚îÄ‚Üí –ü—Ä–æ–¥–∞–≤–µ—Ü: —Å–∫–∞–Ω–∏—Ä—É–µ—Ç ‚Üí –∑–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω
```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~30 —Å–µ–∫—É–Ω–¥ –æ—Ç –≤—ã–±–æ—Ä–∞ –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î:** ~10-15

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–µ—à–∞:** –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –±–µ—Ä—ë—Ç—Å—è –∏–∑ –∫–µ—à–∞ ‚Üí 1 –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ 3

---

#### 2Ô∏è‚É£ –ü—Ä–æ–¥–∞–≤–µ—Ü —Å–æ–∑–¥–∞—ë—Ç —Ç–æ–≤–∞—Ä

```
1. –ü—Ä–æ–¥–∞–≤–µ—Ü: "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä"
   ‚îú‚îÄ‚Üí Handler: handlers/seller/create_offer.py
   ‚îú‚îÄ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω?
   ‚îî‚îÄ‚Üí FSM: CreateOffer.title

2. –ü—Ä–æ–¥–∞–≤–µ—Ü: –≤–≤–æ–¥–∏—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ "–°–≤–µ–∂–∏–π —Ö–ª–µ–±"
   ‚îî‚îÄ‚Üí FSM: CreateOffer.category

3. –ü—Ä–æ–¥–∞–≤–µ—Ü: –≤—ã–±–∏—Ä–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é "–•–ª–µ–±–æ–±—É–ª–æ—á–Ω—ã–µ"
   ‚îî‚îÄ‚Üí FSM: CreateOffer.original_price

4. –ü—Ä–æ–¥–∞–≤–µ—Ü: –≤–≤–æ–¥–∏—Ç —Ü–µ–Ω—É "5000"
   ‚îî‚îÄ‚Üí FSM: CreateOffer.discount_price

5. –ü—Ä–æ–¥–∞–≤–µ—Ü: –≤–≤–æ–¥–∏—Ç —Å–∫–∏–¥–∫—É "3500"
   ‚îú‚îÄ‚Üí Validation: discount_price < original_price ‚úì
   ‚îî‚îÄ‚Üí FSM: CreateOffer.quantity

6. –ü—Ä–æ–¥–∞–≤–µ—Ü: –≤–≤–æ–¥–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ "10"
   ‚îî‚îÄ‚Üí FSM: CreateOffer.photo

7. –ü—Ä–æ–¥–∞–≤–µ—Ü: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ –∏–ª–∏ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å"
   ‚îú‚îÄ‚Üí Handler: process_photo
   ‚îú‚îÄ‚Üí Repository: offer_repository.add_offer()
   ‚îú‚îÄ‚Üí DB: INSERT INTO offers
   ‚îú‚îÄ‚Üí Cache: –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è hot_offers
   ‚îî‚îÄ‚Üí Response: "‚úÖ –¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω!"

8. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
   ‚îî‚îÄ‚Üí –¢–æ–≤–∞—Ä –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ "–ì–æ—Ä—è—á–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è"
```

---

### Deployment Flow

```
1. Developer: git push
   ‚îî‚îÄ‚Üí GitHub: push event

2. Railway: auto-deploy triggered
   ‚îú‚îÄ‚Üí Build: Dockerfile
   ‚îú‚îÄ‚Üí Install: requirements.txt
   ‚îú‚îÄ‚Üí Run: python bot.py
   ‚îî‚îÄ‚Üí Health check: /health endpoint

3. Bot starts:
   ‚îú‚îÄ‚Üí Load .env from Railway variables
   ‚îú‚îÄ‚Üí Create connection pool (5-20 connections)
   ‚îú‚îÄ‚Üí Initialize Redis cache
   ‚îú‚îÄ‚Üí Register handlers
   ‚îú‚îÄ‚Üí Set webhook: https://fudly-bot.railway.app/webhook
   ‚îî‚îÄ‚Üí Start background workers

4. Production:
   ‚îî‚îÄ‚Üí Bot ready to receive messages
```

---

### Performance Characteristics

**Response times:**
- –ü—Ä–æ—Å—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã (/start, /help): 50-100ms
- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ (cached): 100-200ms
- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ (uncached): 300-500ms
- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞: 200-400ms
- –ü–æ–∏—Å–∫: 300-600ms

**Database:**
- Connection pool: 5-20 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –°—Ä–µ–¥–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ~8 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- Peak load: ~15 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

**Caching:**
- Hit rate: ~70% (hot offers, user profiles)
- TTL: 5 –º–∏–Ω—É—Ç (hot offers), 1 —á–∞—Å (user profiles)

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–†–û–ï–ö–¢–ê

### –†–∞–∑–º–µ—Ä –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã

```
Python files:           268 —Ñ–∞–π–ª–æ–≤
Total lines:            ~50,000 —Å—Ç—Ä–æ–∫
- bot.py:               887 —Å—Ç—Ä–æ–∫
- handlers/:            ~8,000 —Å—Ç—Ä–æ–∫
- app/:                 ~15,000 —Å—Ç—Ä–æ–∫
- database_pg_module/:  ~10,000 —Å—Ç—Ä–æ–∫
- tests/:               ~8,000 —Å—Ç—Ä–æ–∫

JavaScript files:       ~80 —Ñ–∞–π–ª–æ–≤ (webapp)
Total lines:            ~12,000 —Å—Ç—Ä–æ–∫

SQL migrations:         12 —Ñ–∞–π–ª–æ–≤
Documentation:          70+ markdown —Ñ–∞–π–ª–æ–≤
```

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** 9/10 ‚≠ê
- Clean Architecture
- Separation of Concerns
- SOLID principles

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** 8/10 ‚≠ê
- Input validation ‚úÖ
- HTTPS only ‚úÖ
- Rate limiting ‚úÖ
- Telegram auth ‚úÖ
- ‚ùå –ù–µ—Ç encryption –¥–ª—è sensitive data

**Performance:** 8/10 ‚≠ê
- Connection pooling ‚úÖ
- Redis caching ‚úÖ
- Database indexes ‚úÖ
- ‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ N+1 queries

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** 7/10 ‚≠ê
- Coverage: ~25-30%
- 30+ test files
- Unit + Integration + E2E
- ‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** 9/10 ‚≠ê
- README ‚úÖ
- API docs ‚úÖ
- Inline comments ‚úÖ
- Architecture diagrams ‚úÖ

---

## üéì –ß–¢–û –ù–£–ñ–ù–û –ó–ù–ê–¢–¨ –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö–£

### –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–µ–∫—Ç–æ–º –Ω—É–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å:

**Backend (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):**
- Python 3.11+ (async/await, type hints)
- aiogram 3.x (Telegram Bot API)
- PostgreSQL (SQL, transactions, indexes)
- FastAPI (REST API)
- Pytest (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

**Frontend (–¥–ª—è webapp):**
- React 18 (hooks, context)
- React Router
- Axios
- Telegram Mini Apps API

**DevOps:**
- Docker (Dockerfile, docker-compose)
- Railway (deployment)
- Git (version control)

**Databases:**
- PostgreSQL (primary)
- Redis (caching, optional)

### –ì–¥–µ —á—Ç–æ –∏—Å–∫–∞—Ç—å

**–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É –±–æ—Ç–∞:**
‚Üí `handlers/common/` –∏–ª–∏ `handlers/customer/`

**–ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É:**
‚Üí `app/services/`

**–ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å SQL –∑–∞–ø—Ä–æ—Å:**
‚Üí `database_pg_module/mixins/`

**–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å API endpoint:**
‚Üí `app/api/`

**–ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É:**
‚Üí `app/keyboards/`

**–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î:**
‚Üí `migrations/v{–Ω–æ–º–µ—Ä}_–æ–ø–∏—Å–∞–Ω–∏–µ.sql`

**–ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å frontend:**
‚Üí `webapp/src/`

**–û—à–∏–±–∫–∞ –≤ production:**
‚Üí –°–º–æ—Ç—Ä–µ—Ç—å Sentry –∏–ª–∏ `railway logs`

---

## üöÄ –î–ê–õ–¨–ù–ï–ô–®–ï–ï –†–ê–ó–í–ò–¢–ò–ï

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã (Roadmap)

**High Priority:**
1. ‚¨ÜÔ∏è –£–≤–µ–ª–∏—á–∏—Ç—å test coverage –¥–æ 60%+
2. üîí –î–æ–±–∞–≤–∏—Ç—å encryption –¥–ª—è sensitive data
3. ‚ö° –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å N+1 queries
4. üìä –î–æ–±–∞–≤–∏—Ç—å monitoring (Grafana + Prometheus)

**Medium Priority:**
5. üåê –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
6. üí≥ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Click/Payme –ø–ª–∞—Ç–µ–∂–µ–π
7. üì± Push notifications
8. ü§ñ AI-powered —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**Low Priority:**
9. üìà Advanced analytics –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–æ–≤
10. üé® –¢–µ–º–∏–∑–∞—Ü–∏—è webapp
11. üó∫Ô∏è –ö–∞—Ä—Ç—ã (Yandex Maps)

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

Fudly Bot - —ç—Ç–æ –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π production-ready –ø—Ä–æ–µ–∫—Ç —Å:

‚úÖ **–ß–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π** (Clean Architecture)
‚úÖ **–í—ã—Å–æ–∫–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º –∫–æ–¥–∞** (type hints, docstrings)
‚úÖ **–•–æ—Ä–æ—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é** (connection pool, caching)
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é** (validation, rate limiting)
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å—é** (microservices-ready architecture)
‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å—é** (unit, integration, E2E tests)
‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å—é** (70+ markdown —Ñ–∞–π–ª–æ–≤)

–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫:
- Production deployment ‚úÖ
- Scaling –¥–æ —Ç—ã—Å—è—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚úÖ
- –î–æ–±–∞–≤–ª–µ–Ω–∏—é –Ω–æ–≤—ã—Ö features ‚úÖ
- Onboarding –Ω–æ–≤—ã—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ ‚úÖ

**–í–µ—Ä—Å–∏—è:** 2.0.0
**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 28 –¥–µ–∫–∞–±—Ä—è 2025
**–ê–≤—Ç–æ—Ä:** AI Assistant

---

*–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è –ø–æ–º–æ—â–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –≤ –ø–æ–Ω–∏–º–∞–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞. –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã - –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ maintainer'–∞–º –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ issue –≤ GitHub.*